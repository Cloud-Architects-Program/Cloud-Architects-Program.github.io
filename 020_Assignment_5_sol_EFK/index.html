
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>020 Assignment 5 sol EFK - YCIT020</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-install-elasticsearch-and-kibana" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="YCIT020" class="md-header__button md-logo" aria-label="YCIT020" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            YCIT020
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              020 Assignment 5 sol EFK
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="YCIT020" class="md-nav__button md-logo" aria-label="YCIT020" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    YCIT020
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        YCIT020
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_3_Terraform_Fundamentals/" class="md-nav__link">
        Lab 3 Terraform Fundamentals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_4_Traffic_control/" class="md-nav__link">
        Lab 4 Traffic Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_5_EFK/" class="md-nav__link">
        Lab 5 EFK Stack
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_Production_GKE/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_sol_Production_GKE/" class="md-nav__link">
        Assignment2 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_sol_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_Helm_Foundation/" class="md-nav__link">
        Assignmen4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_sol_Helm_Foundation/" class="md-nav__link">
        Assignmen4 Sol
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        YCIT019
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_2_Docker_basics/" class="md-nav__link">
        Lab 2 Docker Basics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_3_Advanced_Docker/" class="md-nav__link">
        Lab 3 Advanced Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_4_Docker_Images/" class="md-nav__link">
        Lab 4 Managing Docker Images
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_5_Docker_Compose/" class="md-nav__link">
        Lab 5 Docker Compose
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_6_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Lab 6 Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_7_Kubernetes_Concepts/" class="md-nav__link">
        Lab 7 Kubernetes Concepts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_8_Kubernetes_Features/" class="md-nav__link">
        Lab 8 Kubernetes Features
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_9_Kubernetes_Scaling/" class="md-nav__link">
        Lab 9 Kubernetes Autoscaling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Lab 10 Kubernetes Networking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Lab 11 Kubernetes Storage
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Assignment1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Assignment1 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Assignment2 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Assignment3 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4/" class="md-nav__link">
        Assignment4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Assignment4 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5/" class="md-nav__link">
        Assignment5
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5_solution/" class="md-nav__link">
        Assignment5 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6/" class="md-nav__link">
        Assignment6
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Assignment6 - Solution
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#11-elasticsearch-installation" class="md-nav__link">
    1.1 Elasticsearch Installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-kibana-installation" class="md-nav__link">
    1.2 Kibana installation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-fluentd-installation" class="md-nav__link">
    1.3 Fluentd installation
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <p>Lab 5 - Logging with EFK Stack</p>
<p>In a complicated distributed system such as Kubernetes, we will have different logs for different components, and extracting insights from logs can be a daunting task. The EFK stack (ElasticSearch, FluentD, Kibana) can help make this task easier.
In this Lab, we are going to deploy EFK stack.
Deploy robot-shop app that emits logs to stdout in JSON format.
We will then deploy Cloud Native FluentD logging agent and configure <strong>Input Plugin</strong> /var/log/containers folder
(location used by docker daemon on a Kubernetes node to store stdout from running containers)
and <code>tail</code> <a href="https://docs.fluentd.org/v0.12/articles/in_tail">Input Plugin</a>.
And configure FluentD <strong>Output Plugin</strong> <code>host</code> and <code>logstash_prefix</code> to  send to logs to ElastackSearch,
under <code>logstash-*</code> prefix.</p>
<p><strong>Objective:</strong></p>
<ul>
<li>Install Elasticsearch and Kibanna</li>
<li>Deploy online boutique Application</li>
<li>Install and Configure FluentD</li>
<li>Configure ElasticSearch with FluentD</li>
</ul>
<h1 id="1-install-elasticsearch-and-kibana">1 Install Elasticsearch and Kibana<a class="headerlink" href="#1-install-elasticsearch-and-kibana" title="Permanent link">&para;</a></h1>
<h2 id="11-elasticsearch-installation">1.1 Elasticsearch Installation<a class="headerlink" href="#11-elasticsearch-installation" title="Permanent link">&para;</a></h2>
<p>Create a Kubernetes Cluster in your lab environment. Make sure cluster has nodes with 4 cores each. </p>
<p>Create a new namespace for EFK stack:</p>
<div class="codehilite"><pre><span></span><code>kubectl create ns efk
</code></pre></div>

<p>Install Elasticsearch using Helm:</p>
<div class="codehilite"><pre><span></span><code>helm repo add elastic https://helm.elastic.co
helm install elasticsearch elastic/elasticsearch -n efk
</code></pre></div>

<p>Check the status of deployment:</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods --namespace=efk -l app=elasticsearch-master -w
</code></pre></div>

<h2 id="12-kibana-installation">1.2 Kibana installation<a class="headerlink" href="#12-kibana-installation" title="Permanent link">&para;</a></h2>
<p>Deploy Kibana with Helm:</p>
<div class="codehilite"><pre><span></span><code>helm install kibana elastic/kibana -n efk
</code></pre></div>

<p>Set up port forwarding for temporary access to Kibanna:</p>
<div class="codehilite"><pre><span></span><code>kubectl -n efk port-forward deployment/kibana-kibana 5601
</code></pre></div>

<p>Access Kibana from your browser at <code>http://localhost:5601</code> or from cloud shell <code>Web Preview</code> (Make sure the port number matches)</p>
<p>For permanant access to Kibana, modify the service type form <code>ClusterIP</code> to <code>LoadBalancer</code>:</p>
<div class="codehilite"><pre><span></span><code>kubectl -n efk patch svc kibana-kibana -p &#39;{&quot;spec&quot;: {&quot;type&quot;: &quot;LoadBalancer&quot;}}&#39;
</code></pre></div>

<h2 id="13-fluentd-installation">1.3 Fluentd installation<a class="headerlink" href="#13-fluentd-installation" title="Permanent link">&para;</a></h2>
<p>Deploy Fluentd with Helm:</p>
<div class="codehilite"><pre><span></span><code>helm repo add fluent https://fluent.github.io/helm-charts
helm repo update
helm install fluentd fluent/fluentd -n efk
</code></pre></div>

<h1 id="2-view-logs-from-kibana">2 View Logs from Kibana<a class="headerlink" href="#2-view-logs-from-kibana" title="Permanent link">&para;</a></h1>
<p>Locate Kibana Public IP </p>
<div class="codehilite"><pre><span></span><code>kubectl get svc  -n efk | grep kibana
</code></pre></div>

<p>Launch the Kibana web interface</p>
<div class="codehilite"><pre><span></span><code>http://&lt;Public_IP&gt;:5601
</code></pre></div>

<p>You should see your Kibana interface
<img alt="alt text" src="../images/kibana_validation.png" /></p>
<p>Click on Discover in the left-hand navigation menu.
<img alt="alt text" src="../images/kibana_discover.png" /></p>
<p>Create an index pattern. Use <code>fluentd*</code> as the index pattern name. More documentation can be found <a href="https://www.elastic.co/guide/en/kibana/7.14/index-patterns.html">here</a>
<img alt="alt text" src="../images/kibana_index.png" /></p>
<p>Next, configure which field Kibana will use to filter log data by time. In the dropdown, select the <code>@timestamp</code> field, and hit <code>Create index pattern</code>.</p>
<p>Now, Click on Discover again, you should see logs from your Kubernetes cluster. 
Try different filters, see how you can navigate logs and find valuable information about the cluster. </p>
<h1 id="3-deploy-a-sample-application">3 Deploy a sample application<a class="headerlink" href="#3-deploy-a-sample-application" title="Permanent link">&para;</a></h1>
<p>Deploy microservices application <code>online boutique</code>. </p>
<p>Create Namespace <code>onlineboutique</code></p>
<div class="codehilite"><pre><span></span><code>kubectl create ns onlineboutique
</code></pre></div>

<p>Deploy Microservice application</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f https://raw.githubusercontent.com/Cloud-Architects-Program/microservices-demo/main/release/kubernetes-manifests.yaml -n onlineboutique
</code></pre></div>

<p>Verify Deployment</p>
<div class="codehilite"><pre><span></span><code>kubectl get all -n onlineboutique
</code></pre></div>

<h1 id="4-configure-fluentd-for-specific-logs">4 Configure Fluentd for specific logs<a class="headerlink" href="#4-configure-fluentd-for-specific-logs" title="Permanent link">&para;</a></h1>
<p>In many cases, you only need your applications' logs being sent to your logging stack. To achieve this, Fluentd should be configured to only intake specific logs so that no resources are wasted.</p>
<p>Review <code>sources</code> configuration</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 01_sources.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  01_sources.conf: |-
    &lt;source&gt;
      @type tail
      @id in_tail_container_logs
      @label @KUBERNETES
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      &lt;parse&gt;
        @type multi_format
        &lt;pattern&gt;
          format json
          time_key time
          time_type string
          time_format &quot;%Y-%m-%dT%H:%M:%S.%NZ&quot;
          keep_time_key false
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format regexp
          expression /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr)( (.))? (?&lt;log&gt;.*)$/
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>id</code>: A unique identifier to reference this source. This can be used for further filtering and routing of structured log data</p>
<p><code>type</code>: Inbuilt directive understood by fluentd. In this case, “tail” instructs fluentd to gather data by tailing logs from a given location. Another example is “http” which instructs fluentd to collect data by using GET on http endpoint. </p>
<p><code>path</code>: Specific to type “tail”. Instructs fluentd to collect all logs under /var/log/containers directory. This is the location used by docker daemon on a Kubernetes node to store stdout from running containers</p>
<p><code>pos_file</code>: Used as a checkpoint. In case the fluentd process restarts, it uses the position from this file to resume log data collection</p>
<p><code>tag</code>: A custom string for matching source to destination/filters. fluentd matches source/destination tags to route log data</p>
</div>
<p><strong>Step 2</strong> Review <code>Filter</code> configuration</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 03_dispatch.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  02_filters.conf: |-
    &lt;label @KUBERNETES&gt;
      &lt;match kubernetes.var.log.containers.fluentd**&gt;
        @type relabel
        @label @FLUENT_LOG
      &lt;/match&gt;


      &lt;filter kubernetes.**&gt;
        @type kubernetes_metadata
        @id filter_kube_metadata
        skip_labels false
        skip_container_metadata false
        skip_namespace_metadata true
        skip_master_url true
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @DISPATCH
      &lt;/match&gt;
</code></pre></div>

<p><strong>Step 3</strong> Review <code>Dispatch</code> configuration</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 03_dispatch.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre></div>

<p><strong>Step 4</strong> Review <code>Output Plugin</code> configuration</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A10 04_outputs.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  04_outputs.conf: |-
    &lt;label @OUTPUT&gt;
      &lt;match **&gt;
        @type elasticsearch
        host &quot;elasticsearch-master&quot;
        port 9200
        path &quot;&quot;
        user elastic
        password changeme
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>match</code>: tag indicates a destination. It is followed by a regular expression for matching the source. In this case, we want to capture all logs and send them to Elasticsearch, so simply use **</p>
<p><code>type</code>: Supported output plugin identifier. In this case, we are using ElasticSearch which is a built-in plugin of fluentd.</p>
<p><code>host/port</code>: ElasticSearch host/port. Credentials can be configured as well, but not shown here.</p>
</div>
<p>To configure Fluentd to only send one namespace's logs to elasticsearch, modify <code>03_dispatch.conf</code> so that only log files that matches <code>onlineboutique</code> namespace is labeled to be sent:</p>
<div class="codehilite"><pre><span></span><code>  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre></div>

<p><code>&lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;</code> will filter out logs with <code>_onlineboutique_</code>. This configuration will only relabel the logs that matches the configuration as <code>@OUTPUT</code>. As specified in <code>04_outputs.conf</code>, only logs labelled as <code>@OUTPUT</code> will be sent to elasticsearch. </p>
<p>Note that this is not the only way to configure fluentd to send one namespace's logs. </p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>