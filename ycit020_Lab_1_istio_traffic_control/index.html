
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Istio Traffic Control - Canary Deployments - YCIT020</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#istio-traffic-control-canary-deployments" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="YCIT020" class="md-header__button md-logo" aria-label="YCIT020" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            YCIT020
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Istio Traffic Control - Canary Deployments
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="YCIT020" class="md-nav__button md-logo" aria-label="YCIT020" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    YCIT020
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        YCIT020
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_3_Terraform_Fundamentals/" class="md-nav__link">
        Lab 3 Terraform Fundamentals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_4_Traffic_control/" class="md-nav__link">
        Lab 4 Traffic Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_5_EFK/" class="md-nav__link">
        Lab 5 EFK Stack
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_Production_GKE/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_sol_Production_GKE/" class="md-nav__link">
        Assignment2 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_sol_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_Helm_Foundation/" class="md-nav__link">
        Assignmen4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_sol_Helm_Foundation/" class="md-nav__link">
        Assignmen4 Sol
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        YCIT019
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_2_Docker_basics/" class="md-nav__link">
        Lab 2 Docker Basics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_3_Advanced_Docker/" class="md-nav__link">
        Lab 3 Advanced Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_4_Docker_Images/" class="md-nav__link">
        Lab 4 Managing Docker Images
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_5_Docker_Compose/" class="md-nav__link">
        Lab 5 Docker Compose
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_6_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Lab 6 Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_7_Kubernetes_Concepts/" class="md-nav__link">
        Lab 7 Kubernetes Concepts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_8_Kubernetes_Features/" class="md-nav__link">
        Lab 8 Kubernetes Features
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_9_Kubernetes_Scaling/" class="md-nav__link">
        Lab 9 Kubernetes Autoscaling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Lab 10 Kubernetes Networking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Lab 11 Kubernetes Storage
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Assignment1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Assignment1 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Assignment2 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Assignment3 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4/" class="md-nav__link">
        Assignment4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Assignment4 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5/" class="md-nav__link">
        Assignment5
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5_solution/" class="md-nav__link">
        Assignment5 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6/" class="md-nav__link">
        Assignment6
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Assignment6 - Solution
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-create-a-cluster-and-deploy-istio" class="md-nav__link">
    0 Create a Cluster and Deploy Istio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-deploy-an-application" class="md-nav__link">
    1 Deploy an Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-allow-traffic-to-online-boutique-application" class="md-nav__link">
    1 Allow Traffic to Online Boutique Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-canary-deployments-with-istio" class="md-nav__link">
    2 Canary Deployments with Istio
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="istio-traffic-control-canary-deployments">Istio Traffic Control - Canary Deployments<a class="headerlink" href="#istio-traffic-control-canary-deployments" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Install Istio</li>
<li>Deploy an application and enable automatic sidecar injection</li>
<li>Deploy a canary service and use Istio to route some traffic to the new service</li>
</ul>
<h2 id="0-create-a-cluster-and-deploy-istio">0 Create a Cluster and Deploy Istio<a class="headerlink" href="#0-create-a-cluster-and-deploy-istio" title="Permanent link">&para;</a></h2>
<p>Follow the steps in the assignment to create a GKE cluster and deploy Istio</p>
<h2 id="1-deploy-an-application">1 Deploy an Application<a class="headerlink" href="#1-deploy-an-application" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Get the source code for a sample application. For this lab, we will use the Online Boutique sample app.</p>
<div class="codehilite"><pre><span></span><code>cd ~
git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
</code></pre></div>

<p><strong>Step 2</strong> Create a namespace <code>online-boutique</code> for example</p>
<div class="codehilite"><pre><span></span><code>kubectl create namespace online-boutique
</code></pre></div>

<p><strong>Step 3</strong> Enable automatic sidecar injection for the online-boutique namespace</p>
<div class="codehilite"><pre><span></span><code>kubectl label namespace online-boutique istio-injection=enabled --overwrite
</code></pre></div>

<p><strong>Step 4</strong> Deploy the application by creating the kubernetes manifests</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f ./release/kubernetes-manifests.yaml -n online-boutique
</code></pre></div>

<p><strong>Step 5</strong> Watch the pods and verify that all pods were started successfully with the sidecar injected</p>
<div class="codehilite"><pre><span></span><code>watch kubectl get pods -n online-boutique
</code></pre></div>

<h2 id="1-allow-traffic-to-online-boutique-application">1 Allow Traffic to Online Boutique Application<a class="headerlink" href="#1-allow-traffic-to-online-boutique-application" title="Permanent link">&para;</a></h2>
<p>In order for traffic to flow to the frontend of the application, we need to create an ingress gateway and a virtual service attached to it.</p>
<p>In the istio-manifest directory, we already have the required resources to accomplish this:
* frontend-gateway.yaml: configures the Ingressgateway and the virtualService to allow external traffic into the mesh and route it to the frontend serivce
* frontend.yaml: defines another virtual service to be used by our load generator to make sure traffic directed to the frontend from within the mesh stays internal, and doesn't go through the gateway.
*  Whitelist-egress-googleapis.yaml: Used to whitelist various google APIs used by services within the mesh.</p>
<p><strong>Step 1</strong> Apply the istio manifests</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f ./istio-manifests -n online-boutique
</code></pre></div>

<p><strong>Step 2</strong> Get the external IP address of the ingress gateway and check the application</p>
<div class="codehilite"><pre><span></span><code>kubectl get -n istio-system service istio-ingressgateway
</code></pre></div>

<h2 id="2-canary-deployments-with-istio">2 Canary Deployments with Istio<a class="headerlink" href="#2-canary-deployments-with-istio" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Patch the Recommendation service deployment to give it a <code>production</code> label</p>
<div class="codehilite"><pre><span></span><code>kubectl patch deployment -n online-boutique recommendationservice --type=&#39;json&#39; -p=&#39;[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/template/metadata/labels/version&quot;, &quot;value&quot;: &quot;production&quot;}]&#39;
</code></pre></div>

<p><strong>Step 2</strong> Check the labels on the deployment</p>
<div class="codehilite"><pre><span></span><code>kubectl get pod -n online-boutique recommendationservice --show-labels
</code></pre></div>

<p><strong>Step 3</strong> Create a DestinationRule that defines two subsets <code>production</code> and <code>canary</code></p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: recommendationservice
  namespace: online-boutique
spec:
  host: recommendationservice
  subsets:
  - name: production
    labels:
      version: production
  - name: canary
    labels:
      version: canary
EOF
</code></pre></div>

<p><strong>Step 4</strong> Make a change to the Recommendation service</p>
<div class="codehilite"><pre><span></span><code>cd ~/microservices-demo
sed -i &#39;s/max_responses = 5/max_responses = 2/g&#39; \
   src/recommendationservice/recommendation_server.py
</code></pre></div>

<p><strong>Step 5</strong> Build a new version of the image</p>
<div class="codehilite"><pre><span></span><code>PROJECT_ID=$(gcloud config list --format &quot;value(core.project)&quot;)

docker build -t \
  gcr.io/${PROJECT_ID}/microservices_demo/recommendationservice:canary \
  src/recommendationservice
</code></pre></div>

<p><strong>Step 6</strong> Push the image to GCR</p>
<div class="codehilite"><pre><span></span><code>docker push gcr.io/${PROJECT_ID}/microservices_demo/recommendationservice:canary
</code></pre></div>

<p><strong>Step 7</strong> Deploy the canary version of the Recommendation service</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: recommendationservice
    version: canary
  name: recommendationservice-canary
  namespace: online-boutique
spec:
  replicas: 1
  selector:
    matchLabels:
      app: recommendationservice
      version: canary
  template:
    metadata:
      labels:
        app: recommendationservice
        version: canary
    spec:
      containers:
      - env:
        - name: PORT
          value: &quot;8080&quot;
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: productcatalogservice:3550
        - name: ENABLE_PROFILER
          value: &quot;0&quot;
        image: gcr.io/${PROJECT_ID}/microservices_demo/recommendationservice:canary
        imagePullPolicy: Always
        livenessProbe:
          exec:
            command:
            - /bin/grpc_health_probe
            - -addr=:8080
          failureThreshold: 3
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        name: server
        ports:
        - containerPort: 8080
          protocol: TCP
        readinessProbe:
          exec:
            command:
            - /bin/grpc_health_probe
            - -addr=:8080
          failureThreshold: 3
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 200m
            memory: 450Mi
          requests:
            cpu: 100m
            memory: 220Mi
EOF
</code></pre></div>

<p><strong>Step 8</strong> Deploy a virtual service to direct 20% of the traffic to the canary version</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendationservice
  namespace: online-boutique
spec:
  hosts:
  - recommendationservice
  http:
  - route:
    - destination:
        host: recommendationservice
        port:
          number: 8080
        subset: production
      weight: 80
    - destination:
        host: recommendationservice
        port:
          number: 8080
        subset: canary 
      weight: 20
EOF
</code></pre></div>

<p><strong>Step 9</strong> Refresh the page for one of the products where recommendations are shown multiple times, and notice how most of the time you get 5 recommendations while if 20% of the time you get only 2 recommendations.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>