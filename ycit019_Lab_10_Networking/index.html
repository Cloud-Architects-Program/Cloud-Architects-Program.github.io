<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Module 10 Lab - Kubernetes Networking - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="dropdown-item">Module 2 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="../020_Lab_4_Traffic_control/" class="dropdown-item">Module 8 Traffic Management</a>
</li>
            
<li>
    <a href="../020_Lab_5_EFK/" class="dropdown-item">Module 9 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Module 10 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Module 10 Monitoring with GMP</a>
</li>
            
<li>
    <a href="../020_Lab_9_GitOps/" class="dropdown-item">Module 11 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">MOdule 12 Serverless Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="dropdown-item">Module 2</a>
</li>
            
<li>
    <a href="../020_Module_3_Assignment_Production_GKE/" class="dropdown-item">Module 3</a>
</li>
            
<li>
    <a href="../020_Module_4_Assignment_Production_GKE/" class="dropdown-item">Module 4</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_Module_5_Lab_Docker_basics/" class="dropdown-item">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="../ycit019_Module_9_Kubernetes_Features/" class="dropdown-item">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="dropdown-item">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../ycit019_Module_10_Kubernetes_Scaling/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ycit019_Lab_11_Storage/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#k8s-networking" class="nav-link">K8s Networking</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#0-create-gke-cluster" class="nav-link">0 Create GKE Cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#1-network-policy" class="nav-link">1. Network Policy</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-ingress" class="nav-link">2. Ingress</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="k8s-networking">K8s Networking<a class="headerlink" href="#k8s-networking" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Kubernetes <code>Network Policy</code></li>
<li>Run applications and expose them via service via <code>Ingress</code> resource.</li>
</ul>
<h2 id="0-create-gke-cluster">0 Create GKE Cluster<a class="headerlink" href="#0-create-gke-cluster" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<pre class="codehilite"><code>gcloud services enable container.googleapis.com
</code></pre>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<pre class="codehilite"><code>gcloud container clusters create k8s-networking \
--zone us-central1-c \
--enable-network-policy \
--num-nodes 2
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To use GKE Ingress, you must have the HTTP(S) Load Balancing add-on enabled. GKE clusters have HTTP(S) Load Balancing enabled by default;</p>
</div>
<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME          LOCATION       MASTER_VERSION   MASTER_IP      MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS
k8s-scaling  us-central1-c  1.19.9-gke.1400  34.121.222.83  e2-medium     1.19.9-gke.1400  2          RUNNING
</code></pre>

<p><strong>Step 3</strong> Authenticate to the cluster.</p>
<pre class="codehilite"><code>gcloud container clusters get-credentials k8s-networking --zone us-central1-c
</code></pre>

<h2 id="1-network-policy">1. Network Policy<a class="headerlink" href="#1-network-policy" title="Permanent link">&para;</a></h2>
<h3 id="11-basic-policy-demo">1.1 Basic Policy Demo<a class="headerlink" href="#11-basic-policy-demo" title="Permanent link">&para;</a></h3>
<p>This guide will deploy pods in a Kubernetes Namespaces. Let’s create the
Namespace object for this guide.</p>
<p><strong>Step 1</strong> Create <code>policy-demo</code> Namespace:</p>
<pre class="codehilite"><code>kubectl create ns policy-demo
</code></pre>

<p><strong>Step 2</strong> Than create a <code>policy-demo</code> nginx deployment in <code>policy-demo</code>
namespace:</p>
<pre class="codehilite"><code>kubectl create deployment --namespace=policy-demo nginx --replicas=2 --image=nginx
</code></pre>

<p>Then create a <code>policy-demo</code> service:</p>
<pre class="codehilite"><code>kubectl expose --namespace=policy-demo deployment nginx --port=80
</code></pre>

<p><strong>Step 3</strong> Ensure  nginx service is accessible. In order to do that
create <code>busybox</code> pod and try to access the <code>nginx</code> service.</p>
<pre class="codehilite"><code>kubectl run --namespace=policy-demo access --rm -ti --image busybox /bin/sh
</code></pre>

<p>Output: </p>
<pre class="codehilite"><code>Waiting for pod `policy-demo/access-472357175-y0m47` to be running, status is
Pending, pod ready: false
</code></pre>

<p>If you don't see a command prompt, try pressing enter.</p>
<pre class="codehilite"><code>/ # wget -q nginx -O -
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>You should see a response from <code>nginx</code>. Great! Our service is accessible.
You can exit the Pod now.</p>
</div>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Pods in a given namespace can be accessed by anyone.</p>
</div>
<p><strong>Step 4</strong> Now let’s turn <code>on</code> isolation in our policy-demo Namespace.
Calico will then prevent connections to pods in this Namespace.
In order for Calico to prevent connection to pods in a namespace, we first need
to enable network isolation in the namespace by creating following <code>NetworkPolicy</code>:</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: default-deny
  namespace: policy-demo
spec:
  podSelector:
    matchLabels: {}
EOF
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Current Lab is using Calico v3.0. Older versions of Calico
(2.1 and prior) used namespace annotation to deny all traffic.</p>
</div>
<p><strong>Step 5</strong> Verify that all access to the nginx Service is blocked.
We can see the effect by trying to access the Service again.</p>
<p>In order to do that, run a <code>busybox</code> deployment and try to access the <code>nginx</code>
service.</p>
<pre class="codehilite"><code>kubectl run --namespace=policy-demo access --rm -ti --image busybox /bin/sh
</code></pre>

<pre class="codehilite"><code>Waiting for pod policy-demo/access-472357175-y0m47 to be running, status is
Pending, pod ready: false
</code></pre>

<p>If you don't see a command prompt, try pressing enter.</p>
<pre class="codehilite"><code>/ # wget -q --timeout=5 nginx -O -
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p><code>download timed out</code></p>
</div>
<p>The request should time out after 5 seconds. By enabling isolation on the
Namespace, we’ve prevented access to the Service.</p>
<p><strong>Step 6</strong> Allow Access using a NetworkPolicy</p>
<p>Now, let’s enable access to the nginx Service using a NetworkPolicy.
This will allow incoming connections from our access Pod, but not from anywhere
else.</p>
<p>Create a network policy <code>access-nginx</code> with the following contents:</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: access-nginx
  namespace: policy-demo
spec:
  podSelector:
    matchLabels:
      app: nginx
  ingress:
    - from:
      - podSelector:
          matchLabels:
            run: access
EOF
</code></pre>

<div class="admonition notice">
<p class="admonition-title">Notice</p>
<p>The NetworkPolicy allows traffic from Pods with the label <code>run: access</code> to Pods with the label <code>app: nginx</code>. The labels are automatically added by kubectl and are based on the name of the resource.</p>
</div>
<p><strong>Step 7:</strong> We should now be able to access the Service from the <code>access</code> Pod.</p>
<p>In order to check that create <code>busybox</code> deployment and try to access the <code>nginx</code>
Service.</p>
<pre class="codehilite"><code>kubectl run --namespace=policy-demo access --rm -ti --image busybox /bin/sh
</code></pre>

<pre class="codehilite"><code>Waiting for pod policy-demo/access-472357175-y0m47 to be running, status is
Pending, pod ready: false
</code></pre>

<p>If you don't see a command prompt, try pressing enter.</p>
<pre class="codehilite"><code>/ # wget -q --timeout=5 nginx -O -
</code></pre>

<p><strong>Step 8</strong> Without closing a prompt to a container, open a new terminal and run</p>
<pre class="codehilite"><code>kubectl get pods --show-labels -n policy-demo 
</code></pre>

<p><strong>Output:</strong> </p>
<pre class="codehilite"><code>NAME                     READY   STATUS    RESTARTS   AGE   LABELS
access                   1/1     Running   0          5s    run=access
nginx-6799fc88d8-5r64l   1/1     Running   0          17m   app=nginx,pod-template-hash=6799fc88d8
nginx-6799fc88d8-dbtgk   1/1     Running   0          17m   app=nginx,pod-template-hash=6799fc88d8
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We can see the Labels <code>run=access</code> and <code>app=nginx</code>, that has been defined in Network Policy.</p>
</div>
<p><strong>Step 9</strong> However, we still cannot access the Service from a Pod without the
label <code>run: access:</code></p>
<p>Once again run <code>busybox</code> deployment and try to access the <code>nginx</code> service.</p>
<pre class="codehilite"><code>kubectl run --namespace=policy-demo cant-access --rm -ti --image busybox /bin/sh
</code></pre>

<pre class="codehilite"><code>Waiting for pod policy-demo/cant-access-472357175-y0m47 to be running, status
is Pending, pod ready: false
</code></pre>

<p>If you don't see a command prompt, try pressing enter.</p>
<pre class="codehilite"><code>/ # wget -q --timeout=5 nginx -O -
wget: download timed out
/ #
</code></pre>

<p><strong>Step 9</strong> You can clean up the demo by deleting the demo Namespace:</p>
<pre class="codehilite"><code>kubectl delete ns policy-demo
</code></pre>

<h3 id="12-demo-stars-policy">1.2 (Demo) Stars Policy<a class="headerlink" href="#12-demo-stars-policy" title="Permanent link">&para;</a></h3>
<h4 id="121-deploy-3-tier-app">1.2.1 Deploy 3 tier-app<a class="headerlink" href="#121-deploy-3-tier-app" title="Permanent link">&para;</a></h4>
<p>Let's Deploy 3 tier-app: UI, frontend and backend service, as well as a client
service.  And configures network policy on each service.</p>
<p><strong>Step 1</strong> Deploy <code>Stars</code> Namespace and <code>management-ui</code> apps inside it:</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
---
kind: Namespace
apiVersion: v1
metadata:
  name: stars
---
apiVersion: v1
kind: Namespace
metadata:
  name: management-ui
  labels:
    role: management-ui
---
apiVersion: v1
kind: Service
metadata:
  name: management-ui
  namespace: management-ui
spec:
  type: LoadBalancer
  ports:
  - port: 9001
    targetPort: 9001
  selector:
    role: management-ui
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: management-ui
  labels:
    role: management-ui
  namespace: management-ui
spec:
  selector:
    matchLabels:
      role: management-ui
  replicas: 1
  template:
    metadata:
      labels:
        role: management-ui
    spec:
      containers:
      - name: management-ui
        image: calico/star-collect:v0.1.0
        imagePullPolicy: Always
        ports:
        - containerPort: 9001
EOF
</code></pre>

<p><strong>Step 2</strong> Deploy <code>backend</code> application inside of the  <code>stars</code> Namespace:</p>
<p>Backend:</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: stars
spec:
  ports:
  - port: 6379
    targetPort: 6379
  selector:
    role: backend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  labels:
    role: backend
  namespace: stars
spec:
  selector:
    matchLabels:
      role: backend
  replicas: 1
  template:
    metadata:
      labels:
        role: backend
    spec:
      containers:
      - name: backend
        image: calico/star-probe:v0.1.0
        imagePullPolicy: Always
        command:
        - probe
        - --http-port=6379
        - --urls=http://frontend.stars:80/status,http://backend.stars:6379/status,http://client.client:9000/status
        ports:
        - containerPort: 6379
EOF
</code></pre>

<p><strong>Step 3</strong> Deploy <code>frontend</code> application inside of the <code>stars</code> Namespace:</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: stars
spec:
  ports:
  - port: 80
    targetPort: 80
  selector:
    role: frontend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  labels:
    role: frontend
  namespace: stars
spec:
  selector:
    matchLabels:
      role: frontend
  replicas: 1
  template:
    metadata:
      labels:
        role: frontend
    spec:
      containers:
      - name: frontend
        image: calico/star-probe:v0.1.0
        imagePullPolicy: Always
        command:
        - probe
        - --http-port=80
        - --urls=http://frontend.stars:80/status,http://backend.stars:6379/status,http://client.client:9000/status
        ports:
        - containerPort: 80
EOF
</code></pre>

<p><strong>Step 4</strong> Finally deploy <code>client</code> application inside of the <code>client</code> Namespace:</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
kind: Namespace
apiVersion: v1
metadata:
  name: client
  labels:
    role: client
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client
  labels:
    role: client
  namespace: client
spec:
  selector:
    matchLabels:
      role: client
  replicas: 1
  template:
    metadata:
      labels:
        role: client
    spec:
      containers:
      - name: client
        image: calico/star-probe:v0.1.0
        imagePullPolicy: Always
        command:
        - probe
        - --urls=http://frontend.stars:80/status,http://backend.stars:6379/status
        ports:
        - containerPort: 9000
---
apiVersion: v1
kind: Service
metadata:
  name: client
  namespace: client
spec:
  ports:
  - port: 9000
    targetPort: 9000
  selector:
    role: client
EOF
</code></pre>

<p><strong>Step 5</strong> Wait for all the pods to enter <code>Running</code> state.</p>
<pre class="codehilite"><code>kubectl get pods --all-namespaces --watch
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It may take several minutes to download the necessary Docker images for this
demo.</p>
</div>
<p><strong>Step 6</strong> Locate LoadBalancer IP:</p>
<pre class="codehilite"><code>kubectl get svc -n management-ui
</code></pre>

<p><strong>Step 9</strong> Open UI in you browser <code>http://EXTERNAL-IP:9001</code> in a browser.</p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Once all the pods are started, they should have full connectivity. You can see
this by visiting the UI.  Each service is represented by a single node in the
graph.</p>
<ul>
<li><code>backend</code> -&gt; Node "B"</li>
<li><code>frontend</code> -&gt; Node "F"</li>
<li><code>client</code> -&gt; Node "C"</li>
</ul>
</div>
<h4 id="122-enable-isolation">1.2.2 Enable isolation<a class="headerlink" href="#122-enable-isolation" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Enable isolation</p>
<p>Running the following commands will prevent all Ingress access to the frontend, backend,
and client Services located in namespaces <code>starts</code> and <code>client</code></p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: default-deny
  namespace: stars
spec:
  podSelector:
    matchLabels: {}
  ingress: []
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: default-deny
  namespace: client
spec:
  podSelector:
    matchLabels: {}
  policyTypes:
  - Ingress
EOF
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Now that we've enabled isolation, the UI can no longer access the pods, and
so they will no longer show up in the UI.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You need to Refresh web-browser to see result.</p>
</div>
<p><strong>Step 2</strong> Allow apps from <code>stars</code> and <code>client</code> namespace access <code>UI</code> service via <code>NetworkPolicy</code> rules:</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  namespace: stars
  name: allow-ui
spec:
  podSelector:
   matchLabels: {}
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              role: management-ui
---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  namespace: client
  name: allow-ui
spec:
  podSelector:
   matchLabels: {}
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              role: management-ui
EOF
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>refresh the UI - it should now show the Services, but they
should not be able to access each other any more.</p>
</div>
<p><strong>Step 4</strong> Create the <code>NetworkPolicy</code> to allow traffic from the
frontend to the backend.</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  namespace: stars
  name: backend-policy
spec:
  podSelector:
    matchLabels:
      role: backend
  ingress:
    - from:
        - podSelector:
            matchLabels:
              role: frontend
      ports:
        - protocol: TCP
          port: 6379
EOF
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Refresh the UI.  You should see the following:</p>
<ul>
<li>The frontend can now access the backend (on TCP port 80 only).</li>
<li>The backend cannot access the frontend at all.</li>
<li>The client cannot access the frontend, nor can it access the backend.</li>
</ul>
</div>
<p><strong>Step 5</strong> Expose the frontend service to the <code>client</code> namespace.</p>
<pre class="codehilite"><code>kubectl create -f - &lt;&lt;EOF
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  namespace: stars
  name: frontend-policy
spec:
  podSelector:
    matchLabels:
      role: frontend
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              role: client
      ports:
        - protocol: TCP
          port: 80
EOF
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>We isolated our app using <code>NetworkPolicy</code> ingress rules so that:</p>
<ul>
<li>The client can now access the frontend, but not the backend.</li>
<li>Neither the frontend nor the backend can initiate connections to the client.</li>
<li>The frontend can still access the backend.</li>
</ul>
</div>
<h4 id="123-cleanup">1.2.3 Cleanup<a class="headerlink" href="#123-cleanup" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> You can clean up the demo by deleting the demo Namespaces:</p>
<pre class="codehilite"><code>kubectl delete ns client stars management-ui
</code></pre>

<h2 id="2-ingress">2. Ingress<a class="headerlink" href="#2-ingress" title="Permanent link">&para;</a></h2>
<p>In GKE, Ingress is implemented using Cloud Load Balancing. In other words, when yiu create an Ingress resource in your cluster, GKE creates an <code>HTTP(S)</code> LB for you and configure it.
In this lab, we will create a fanout Ingress with two backends for two verisons of the <code>hello-app</code> application.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to experiment with a different type of Ingress, you can install <code>Nginx Controller</code> using Helm. You can also follow these [instructions]
(https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md).</p>
</div>
<h3 id="21-deploy-an-application">2.1 Deploy an Application<a class="headerlink" href="#21-deploy-an-application" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Deploy the web application version 1, and its service</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; web-service-v1.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-v1
  namespace: default
spec:
  selector:
    matchLabels:
      run: web
      version: v1
  template:
    metadata:
      labels:
        run: web
        version: v1
    spec:
      containers:
      - image: gcr.io/google-samples/hello-app:1.0
        imagePullPolicy: IfNotPresent
        name: web
        ports:
        - containerPort: 8080
          protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: web-v1
  namespace: default
spec:
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    run: web
    version: v1
  type: NodePort
EOF
</code></pre>

<p><strong>Step 2</strong> Apply the resources to the cluster</p>
<pre class="codehilite"><code>kubectl apply -f web-service-v1.yaml
</code></pre>

<p><strong>Step 3</strong> Deploy the web application version 2, and its service</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; web-service-v2.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-v2
  namespace: default
spec:
  selector:
    matchLabels:
      run: web
      version: v2
  template:
    metadata:
      labels:
        run: web
        version: v2
    spec:
      containers:
      - image: gcr.io/google-samples/hello-app:2.0
        imagePullPolicy: IfNotPresent
        name: web
        ports:
        - containerPort: 8080
          protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: web-v2
  namespace: default
spec:
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    run: web
    version: v2
  type: NodePort
EOF
</code></pre>

<p><strong>Step 4</strong> Apply the resources to the cluster</p>
<pre class="codehilite"><code>kubectl apply -f web-service-v2.yaml
</code></pre>

<p><strong>Step 5</strong> Take a look at the pods created and view their IPs</p>
<pre class="codehilite"><code>kubectl get pod -o wide
</code></pre>

<p><strong>Step 6</strong> Take a look at the endpoints created and notice how they match the IP for the Pods in the matching service.</p>
<pre class="codehilite"><code>kubectl get ep
</code></pre>

<h3 id="22-creating-single-service-ingress-rule">2.2 Creating Single Service Ingress rule<a class="headerlink" href="#22-creating-single-service-ingress-rule" title="Permanent link">&para;</a></h3>
<p>Let's expose our web-v1 service using Ingress!</p>
<p><strong>Step 1</strong> To start, let's create an Ingress resource that directs traffic to v1 of the <code>web</code> Service</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; single-svc-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: single-svc-ingress
spec:
  defaultBackend:
    service:
      name: web-v1
      port:
        number: 8080
EOF
</code></pre>

<p>This manifest defines a <code>Single Service Ingress rule</code>, which makes sure all HTTP requests
that will hit the external IP for the Cloud LB created for the Ingress, will be proxied to the <code>web-v1</code> service on port <code>8080</code>.</p>
<p><strong>Step 2</strong> Create the Ingress resource</p>
<pre class="codehilite"><code>kubectl apply -f single-svc-ingress.yaml
</code></pre>

<p><strong>Step 3</strong>  Verify Ingress Resource</p>
<pre class="codehilite"><code>kubectl get ing
</code></pre>

<p><strong>Output</strong></p>
<pre class="codehilite"><code>NAME                 CLASS    HOSTS   ADDRESS          PORTS   AGE
single-svc-ingress   &lt;none&gt;   *       34.117.137.144   80      110s
</code></pre>

<p>Notice that the Ingress controllers and load balancers may take a minute or two to allocate an IP address.</p>
<p>Bingo!</p>
<p><strong>Step 4</strong> descirbe the Ingress object created and notice the Google Cloud LB resources created.</p>
<pre class="codehilite"><code>kubectl describe ing single-svc-ingress
</code></pre>

<p>Notice that you might need to give it some time to get a similar output to what I have below.
<strong>Output:</strong></p>
<pre class="codehilite"><code>Name:             single-svc-ingress
Namespace:        default
Address:          34.117.137.144
Default backend:  web-v1:8080 (10.32.0.10:8080)
Rules:
  Host        Path  Backends
  ----        ----  --------
  *           *     web-v1:8080 (10.32.0.10:8080)
Annotations:  ingress.kubernetes.io/backends: {&quot;k8s-be-30059--a2b52ac0331abe29&quot;:&quot;HEALTHY&quot;}
              ingress.kubernetes.io/forwarding-rule: k8s2-fr-8rwy2qu4-default-single-svc-ingress-74hvjigm
              ingress.kubernetes.io/target-proxy: k8s2-tp-8rwy2qu4-default-single-svc-ingress-74hvjigm
              ingress.kubernetes.io/url-map: k8s2-um-8rwy2qu4-default-single-svc-ingress-74hvjigm
Events:
  Type    Reason     Age                  From                     Message
  ----    ------     ----                 ----                     -------
  Normal  Sync       10m                  loadbalancer-controller  UrlMap &quot;k8s2-um-8rwy2qu4-default-single-svc-ingress-74hvjigm&quot; created
  Normal  Sync       10m                  loadbalancer-controller  TargetProxy &quot;k8s2-tp-8rwy2qu4-default-single-svc-ingress-74hvjigm&quot; created
  Normal  Sync       10m                  loadbalancer-controller  ForwardingRule &quot;k8s2-fr-8rwy2qu4-default-single-svc-ingress-74hvjigm&quot; created
  Normal  IPChanged  10m                  loadbalancer-controller  IP is now 34.117.137.144
  Normal  Sync       4m27s (x6 over 11m)  loadbalancer-controller  Scheduled for sync
</code></pre>

<p><strong>Step 5</strong> Access deployed app via Ingress by navigating to the public IP of the ingress, which we got in step 3.</p>
<p><strong>Step 6</strong> Finally execute the following command to cleanup the ingress.</p>
<pre class="codehilite"><code>kubectl delete -f single-svc-ingress.yaml
</code></pre>

<h3 id="23-simple-fanout">2.3 Simple fanout<a class="headerlink" href="#23-simple-fanout" title="Permanent link">&para;</a></h3>
<p>Let's explore more sophisticated Ingress rules. This time we going to deploy <code>Simple fanout</code>type that allows for exposing multiple services on same host, but via different paths.
This type is very handy when you running in CloudProvider and want to cut cost
on creating LoadBalancers for each of you application. Or when running on
prem. and it's required to expose multiple services via same host.</p>
<p><strong>Step 1</strong> Let's start by a simple fanout with one service. Notice that we are not using a <code>hostname</code> here as for this lab, we don't want to go through setting up DNS. If you have a DNS setup, you can try with an actual <code>hostname</code>. Just make sure to update you DNS records with the Ingress external IP.</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; fanout-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
 name: fanout-ingress
spec:
  rules:
  - http:
      paths:
      - path: /v1
        pathType: ImplementationSpecific
        backend:
          service:
            name: web-v1
            port:
              number: 8080
EOF
</code></pre>

<p><strong>Step 2</strong> Create the Ingress resource</p>
<pre class="codehilite"><code>kubectl apply -f fanout-ingress.yaml
</code></pre>

<p><strong>Step 3</strong>  Verify Ingress Resource</p>
<pre class="codehilite"><code>kubectl get ing fanout-ingress
</code></pre>

<p><strong>Step 4</strong> Verify that you can navigate to http://INGRESS_PUBLIC_IP/v1 and get the following</p>
<pre class="codehilite"><code>Hello, world!
Version: 1.0.0
</code></pre>

<p><strong>Step 5</strong> Verify that ingress is returning <code>default backend - 404</code> page in a browser.</p>
<p>Open the browser with public_ip:</p>
<pre class="codehilite"><code>http://INGRESS_PUBLIC_IP/test
</code></pre>

<p><strong>Step 6</strong> On your own modify the Ingress resource to add a second path so when we navigate to  <code>http://INGRESS_PUBLIC_IP/v2</code> users will get routed to <code>web-v2</code></p>
<p><strong>Step 7</strong> Delete the demo
Finally execute the following command to cleanup the application and ingress.</p>
<pre class="codehilite"><code>kubectl delete -f fanout-ingress.yaml
kubectl apply -f web-service-v1.yaml
kubectl apply -f web-service-v2.yaml
</code></pre>

<h3 id="24-cleaning-up">2.4 Cleaning Up<a class="headerlink" href="#24-cleaning-up" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Delete the cluster</p>
<pre class="codehilite"><code>gcloud container clusters delete k8s-networking
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
