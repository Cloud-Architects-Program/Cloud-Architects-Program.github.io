<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Module 9 Lab - Kubernetes Features - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="dropdown-item">Module 2 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="../020_Lab_4_Traffic_control/" class="dropdown-item">Module 8 Traffic Management</a>
</li>
            
<li>
    <a href="../020_Lab_5_EFK/" class="dropdown-item">Module 9 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Module 10 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Module 10 Monitoring with GMP</a>
</li>
            
<li>
    <a href="../020_Lab_9_GitOps/" class="dropdown-item">Module 11 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">MOdule 12 Serverless Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="dropdown-item">Module 2</a>
</li>
            
<li>
    <a href="../020_Module_3_Assignment_Production_GKE/" class="dropdown-item">Module 3</a>
</li>
            
<li>
    <a href="../020_Module_4_Assignment_Production_GKE.md" class="dropdown-item">Module 4</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_Module_5_Lab_Docker_basics/" class="dropdown-item">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="dropdown-item">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="../ycit019_Lab_10_Networking/" class="dropdown-item">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ycit019_Module_10_Kubernetes_Scaling/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#0-create-gke-cluster" class="nav-link">0 Create GKE Cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#1-kubernetes-features" class="nav-link">1 Kubernetes Features</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#11-using-liveness-probes" class="nav-link">1.1 Using Liveness Probes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#12-using-configmaps" class="nav-link">1.2 Using ConfigMaps</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#13-using-secrets" class="nav-link">1.3 Using Secrets</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#14-jobs" class="nav-link">1.4 Jobs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#15-cron-jobs" class="nav-link">1.5 Cron Jobs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#16-daemon-set" class="nav-link">1.6 Daemon Set</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#17-cleaning-up" class="nav-link">1.7 Cleaning Up</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>Lab 8 Kubernetes Features</p>
<p><strong>Objective</strong></p>
<ul>
<li>Use Liveness Probes to healthcheck you application while it is running</li>
<li>Learn about secrets and configmaps</li>
<li>Deploy a Daemonset and jobs</li>
</ul>
<h2 id="0-create-gke-cluster">0 Create GKE Cluster<a class="headerlink" href="#0-create-gke-cluster" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enbale the Google Kubernetes Engine API.</p>
<pre class="codehilite"><code>gcloud services enable container.googleapis.com
</code></pre>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<pre class="codehilite"><code>gcloud container clusters create k8s-features \
--zone us-central1-c \
--num-nodes 2
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME          LOCATION       MASTER_VERSION   MASTER_IP      MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS
k8s-features  us-central1-c  1.19.9-gke.1400  34.121.222.83  e2-medium     1.19.9-gke.1400  2          RUNNING
</code></pre>

<p><strong>Step 3</strong> Authenticate to the cluster.</p>
<pre class="codehilite"><code>gcloud container clusters get-credentials k8s-features --zone us-central1-c
</code></pre>

<h1 id="1-kubernetes-features">1 Kubernetes Features<a class="headerlink" href="#1-kubernetes-features" title="Permanent link">&para;</a></h1>
<h2 id="11-using-liveness-probes">1.1 Using Liveness Probes<a class="headerlink" href="#11-using-liveness-probes" title="Permanent link">&para;</a></h2>
<p>Many applications running for long periods of time eventually transition to
broken states, and cannot recover except by being restarted. Kubernetes p
rovides liveness probes to detect and remedy such situations.</p>
<p>As we already discussed Kubernetes provides 3 types of <code>Probes</code> to perform
Liveness checks:</p>
<ul>
<li>HTTP GET</li>
<li>EXEC</li>
<li>tcpSocket</li>
</ul>
<p>In below example we are going to use HTTP GET probe for a Pod that runs a container
based on the <code>gcr.io/google_containers/liveness</code> image.</p>
<p><strong> Step 1</strong> Create <code>http-liveness.yaml</code> manifest with below content:</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; http-liveness.yaml
apiVersion: v1
kind: Pod
metadata:
  labels:
    test: liveness
  name: liveness-http
spec:
  containers:
  - name: liveness
    image: gcr.io/google_containers/liveness
    args:
    - /server
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
        httpHeaders:
        - name: X-Custom-Header
          value: Awesome
      initialDelaySeconds: 3
      periodSeconds: 3
EOF
</code></pre>

<p>Based on the manifest, we can see that the Pod has a single Container.
The <code>periodSeconds</code> field specifies that the kubelet should perform a liveness
probe every 3 seconds. The <code>initialDelaySeconds</code> field tells the kubelet that it
should wait 3 seconds before performing the first probe. To perform a probe, the
kubelet sends an HTTP GET request to the server that is running in the Container
and listening on port 8080. If the handler for the server's <code>/healthz</code> path
returns a success code, the kubelet considers the Container to be alive and
healthy. If the handler returns a failure code, the kubelet kills the Container
and restarts it.</p>
<p>Any code greater than or equal to 200 and less than 400 indicates success. Any
other code indicates failure.</p>
<p>Full code for for a reference in  <a href="https://github.com/kubernetes/kubernetes/blob/master/test/images/liveness/server.go">server.go</a>.</p>
<p>For the first 10 seconds that the Container is alive, the <code>/healthz</code> handler
returns a status of 200. After that, the handler returns a status of 500.</p>
<pre class="codehilite"><code class="language-go">http.HandleFunc(&quot;/healthz&quot;, func(w http.ResponseWriter, r *http.Request) {
    duration := time.Now().Sub(started)
    if duration.Seconds() &gt; 10 {
        w.WriteHeader(500)
        w.Write([]byte(fmt.Sprintf(&quot;error: %v&quot;, duration.Seconds())))
    } else {
        w.WriteHeader(200)
        w.Write([]byte(&quot;ok&quot;))
    }
})
</code></pre>

<p>The kubelet starts performing health checks 3 seconds after the Container starts.
So the first couple of health checks will succeed. But after 10 seconds, the health
checks will fail, and the kubelet will kill and restart the Container.</p>
<p><strong>Step 2</strong> Let's create a Pod and see how HTTP liveness check works:</p>
<pre class="codehilite"><code class="language-shell">kubectl create -f http-liveness.yaml
</code></pre>

<p><strong>Step 3</strong> Monitor the Pod</p>
<pre class="codehilite"><code>watch kubectl get pod
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>After 10 seconds Pods has beed restarted.</p>
</div>
<p>Exit the shell session by using ctrl+c</p>
<p><strong>Step 4</strong> Verify status of the Pod and review the Events happened after restart</p>
<pre class="codehilite"><code class="language-shell">kubectl describe pod liveness-http
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Pod events shows that liveness probes have failed and the Container has been restarted.</p>
</div>
<p><strong>Step 5</strong> Clean up</p>
<pre class="codehilite"><code>kubectl delete -f http-liveness.yaml
</code></pre>

<h2 id="12-using-configmaps">1.2 Using ConfigMaps<a class="headerlink" href="#12-using-configmaps" title="Permanent link">&para;</a></h2>
<p>In Kubernetes ConfigMaps could be use in several cases:</p>
<ul>
<li>Storing configuration values as key-values in ConfigMap and referencing them
  in a Pod as environment variables</li>
<li>Storing configurations as a file inside of ConfigMap and referencing it in
  a Pod as a Volume</li>
</ul>
<p>Let's try second option and deploy nginx pod while storing its config in a ConfigMap.</p>
<p><strong>Step 1</strong> Create nginx <code>my-nginx-config.conf</code> config file as below:</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; my-nginx-config.conf
server {
  listen              80;
  server_name         www.cloudnative.tech;

  gzip on;
  gzip_types text/plain application/xml;

  location / {
    root   /usr/share/nginx/html;
    index  index.html index.htm;
  }
}
EOF
</code></pre>

<p><strong>Step 2</strong> Create ConfigMap from this file</p>
<pre class="codehilite"><code>kubectl create configmap nginxconfig --from-file=my-nginx-config.conf
</code></pre>

<p><strong>Step 3</strong> Review the ConfigMap</p>
<pre class="codehilite"><code>kubectl describe cm nginxconfig
</code></pre>

<p><strong>Result:</strong></p>
<pre class="codehilite"><code>  ```
  Name:     nginxconfig
  Namespace:    default
  Labels:       &lt;none&gt;
  Annotations:  &lt;none&gt;

  Data
  ====
  my-nginx-config.conf:
  ----
  server {
    listen              80;
    server_name         _;

    gzip off;
    gzip_types text/plain application/xml;

    location / {
      root   /usr/share/nginx/html;
      index  index.html index.htm;
    }
  }

  Events:   &lt;none&gt;
  ```
</code></pre>

<p><strong>Step 4</strong> Create Nginx Pod <code>website.yaml</code> file, where ConfigMap referenced as a Volume</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; website.yaml
apiVersion: v1
kind: Pod
metadata:
  name: website
spec:
  containers:
  - image: nginx:alpine
    name: website
    volumeMounts:
    - name: html
      mountPath: /usr/share/nginx/html
      readOnly: false
    - name: config
      mountPath: /etc/nginx/conf.d
      readOnly: true
  volumes:
  - name: html
    emptyDir: {}
  - name: config
    configMap:
      name: nginxconfig
EOF
</code></pre>

<p><strong>Step 5</strong> Deploy Nginx Pod <code>website.yaml</code></p>
<pre class="codehilite"><code>kubectl apply -f website.yaml
</code></pre>

<p>You can expose a service as we usually do with NodePort or LoadBalancer or by using the port-forward technicque in the next step</p>
<p><strong>Step 6</strong> Open second <code>SSH</code> terminal by pressing "+" icon in the cloud shell and run following command</p>
<pre class="codehilite"><code>kubectl port-forward website 8080:80
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>This opens a tunnel and expose our application on port '80' to localhost:8080.</p>
</div>
<p><strong>Step 7</strong> Test that website is running
Navigate back to the first terminal tab and run the following</p>
<pre class="codehilite"><code>curl localhost:8080
</code></pre>

<p><strong>Result:</strong></p>
<pre class="codehilite"><code>  ```
  &lt;html&gt;
  &lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
  &lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
  &lt;hr&gt;&lt;center&gt;nginx/1.21.0&lt;/center&gt;
  &lt;/body&gt;
  &lt;/html&gt;
  ```
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>You've just learned how to use ConfigMaps.</p>
</div>
<p>You can also use the <code>preview</code> feature with the console</p>
<p><strong>Step 8</strong> start a shell in the pod by using <code>exec</code></p>
<pre class="codehilite"><code>kubectl exec website -it -- sh
</code></pre>

<p>Your terminal now should have <code>/#</code></p>
<p><strong>Step 9</strong> view the content of the folder where we added the volume</p>
<pre class="codehilite"><code>ls /etc/nginx/conf.d
</code></pre>

<p><strong>Step 10</strong> check the content of the file in that folder and notice that it's the same as the config file for nginx we mounted.</p>
<pre class="codehilite"><code>cat /etc/nginx/conf.d/my-nginx-config.conf
</code></pre>

<p><strong>Step 11</strong> Exit the shell</p>
<pre class="codehilite"><code>exit
</code></pre>

<p>Make sure you're back to the cloud shell terminal.</p>
<h2 id="13-using-secrets">1.3 Using Secrets<a class="headerlink" href="#13-using-secrets" title="Permanent link">&para;</a></h2>
<h3 id="131-kubernetes-secrets">1.3.1 Kubernetes Secrets<a class="headerlink" href="#131-kubernetes-secrets" title="Permanent link">&para;</a></h3>
<p>Kubernetes secrets allow users to define sensitive information outside of containers and expose that information to containers through environment variables as well as files within Pods. In this section we will declare and create secrets to hold our database connection information that will be used by Wordpress to connect to its backend database.</p>
<p><strong>Step 1</strong> Open up two terminal windows. We will use one window to generate encoded strings that will contain our sensitive data. The other window will be used to create the secrets YAML declaration.</p>
<p><strong>Step 2</strong> In the first terminal window, execute the following commands to encode our strings:</p>
<pre class="codehilite"><code>echo -n &quot;admin&quot; | base64
echo -n &quot;t0p-Secret&quot; | base64
</code></pre>

<p><strong>Step 3</strong> create the secret. For this lab, we added the encoded values for you. Feel free to change the username and password, and replace the values in the file below:</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; app-secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: app-secret
type: Opaque
data:
  username: YWRtaW4=
  password: dDBwLVNlY3JldA==
EOF
</code></pre>

<p><strong>Step 4</strong> Create the secret:</p>
<pre class="codehilite"><code>kubectl create -f app-secrets.yaml
</code></pre>

<p><strong>Step 5</strong> Verify secret creation and get details:</p>
<pre class="codehilite"><code>kubectl get secrets
</code></pre>

<p><strong>Step 6</strong> Get details of this secret:</p>
<pre class="codehilite"><code>kubectl describe secrets/app-secrets
</code></pre>

<p><strong>Result:</strong></p>
<pre class="codehilite"><code>Name:         app-secret
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  Opaque

Data
====
password:  10 bytes
username:  5 bytes
</code></pre>

<p><strong>Step 7</strong> Create a pod that will reference the secret as a volume.
Use either nano or vim to create secret-pod.yaml, and copy the following to it</p>
<pre class="codehilite"><code>apiVersion: v1
kind: Pod
metadata:
  name: secret-test-pod
spec:
  containers:
    - name: test-container
      image: alpine
      command: [&quot;/bin/sh&quot;, &quot;-ec&quot;, &quot;export LOGIN=$(cat /etc/secret-volume/username);export PWD=$(cat /etc/secret-volume/password);while true; do echo hello $LOGIN your password is $PWD; sleep 10; done&quot;]
      volumeMounts:
          - name: secret-volume
            mountPath: /etc/secret-volume
  volumes:
    - name: secret-volume
      secret:
        secretName: app-secret
  restartPolicy: Never
</code></pre>

<p><strong>Step 8</strong> View the logs of the pod.</p>
<pre class="codehilite"><code>kubectl logs secret-test-pod
</code></pre>

<p>Notice how we were able to pull the content of the secret using a command. Not very secure, right?</p>
<p><strong>Step 9</strong> Delete both the pod and the secret</p>
<pre class="codehilite"><code>kubectl delete pod secret-test-pod
kubectl delete secret app-secret
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Secrets has been created and they not visiable when you view them via
<code>kubectl describe</code> This does not make Kubernetes secrets secure as we have experienced. Additonal measures need to be in place to protect secrets.</p>
</div>
<h2 id="14-jobs">1.4 Jobs<a class="headerlink" href="#14-jobs" title="Permanent link">&para;</a></h2>
<p>A Job creates one or more pods and ensures that a specified number of them successfully complete. A job keeps track of successful completion of a pod. When the specified number of pods have successfully completed, the job itself is complete. The job will start a new pod if the pod fails or is deleted due to hardware failure. A successful completion of the specified number of pods means the job is complete.</p>
<p>This is different from a replica set or a deployment which ensures that a certain number of pods are always running. So if a pod in a replica set or deployment terminates, then it is restarted again. This makes replica set or deployment as long-running processes. This is well suited for a web server, such as NGINX. But a job is completed if the specified number of pods successfully completes. This is well suited for tasks that need to run only once. For example, a job may convert an image format from one to another. Restarting this pod in replication controller would not only cause redundant work but may be harmful in certain cases.</p>
<p>Jobs are complementary to Replica Set. A Replica Set manages pods which are not expected to terminate (e.g. web servers), and a Job manages pods that are expected to terminate (e.g. batch jobs).</p>
<h3 id="141-non-parallel-job">1.4.1 Non-parallel Job<a class="headerlink" href="#141-non-parallel-job" title="Permanent link">&para;</a></h3>
<p>Only one pod per job is started, unless the pod fails. Job is complete as soon as the pod terminates successfully.</p>
<p>Use the image "busybox" and have it sleep for 10 seconds and then complete.
Run your job to be sure it works.</p>
<p><strong>Step 1</strong> Create a Job Manifest</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; busybox.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: busybox
spec:
  template:
    spec:
      containers:
      - name: busybox
        image: busybox
        command: [&quot;sleep&quot;, &quot;20&quot;]
      restartPolicy: Never
EOF
</code></pre>

<p><strong>Step 2</strong> Run a Job</p>
<pre class="codehilite"><code>kubectl create -f busybox.yaml
</code></pre>

<p><strong>Step 3</strong> Look at the job:</p>
<pre class="codehilite"><code>kubectl get jobs
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME      DESIRED   SUCCESSFUL   AGE
busybox    1         0            0s
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>The output shows that the job is not successful yet.</p>
</div>
<p><strong>Step 4</strong> Watch the pod status</p>
<pre class="codehilite"><code>kubectl get -w pods
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME         READY     STATUS    RESTARTS   AGE
busybox-lk49x   1/1       Running   0          7s
busybox-lk49x   0/1       Completed   0         24s
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>It starts with pod for the job is <code>Running</code>.
Then pod successfully exits after a few seconds and shows the <code>Completed</code> status.</p>
</div>
<p><strong>Step 5</strong> Watch the job status again:</p>
<pre class="codehilite"><code>kubectl get jobs
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME      COMPLETIONS   DURATION   AGE
busybox   1/1           21s        1m
</code></pre>

<p><strong>Step 6</strong> Delete a Job</p>
<pre class="codehilite"><code>kubectl delete -f busybox.yaml
</code></pre>

<h3 id="142-parallel-job">1.4.2 Parallel Job<a class="headerlink" href="#142-parallel-job" title="Permanent link">&para;</a></h3>
<p>Non-parallel jobs run only one pod per job. This API is used to run multiple pods in parallel for the job. The number of pods to complete is defined by <code>.spec.completions</code> attribute in the configuration file. The number of pods to run in parallel is defined by <code>.spec.parallelism</code> attribute in the configuration file. The default value for both of these attributes is 1.</p>
<p>The job is complete when there is one successful pod for each value in the range in 1 to <code>.spec.completions</code>. For that reason, it is also called as <em>fixed completion count</em> job.</p>
<p><strong>Step 1</strong> Create a Job Manifest</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; job-parallel.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: wait
spec:
  completions: 6
  parallelism: 2
  template:
    metadata:
      name: wait
    spec:
      containers:
      - name: wait
        image: ubuntu
        command: [&quot;sleep&quot;,  &quot;10&quot;]
      restartPolicy: Never
EOF
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This job specification is similar to the non-parallel job specification above.
However it has two new attributes added: <code>.spec.completions</code> and <code>.spec.parallelism</code>.
This means the job will be complete when six pods have successfully completed.
A maximum of two pods will run in parallel at a given time.</p>
</div>
<p><strong>Step 2</strong> Create a parallel job using the command:</p>
<pre class="codehilite"><code>kubectl apply -f job-parallel.yaml
</code></pre>

<p><strong>Step 3</strong> Watch the status of the job as shown:</p>
<pre class="codehilite"><code>kubectl get -w jobs
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME   COMPLETIONS   DURATION   AGE
wait   0/6           6s         6s
wait   1/6           12s        12s
wait   2/6           12s        12s
wait   3/6           24s        24s
wait   4/6           24s        24s
wait   5/6           36s        36s
wait   6/6           36s        36s
</code></pre>

<div class="admonition results">
<p class="admonition-title">Results</p>
<p>The output shows that 2 pods are created about every 12 seconds.</p>
</div>
<p><strong>Step 4</strong>  In another terminal window, watch the status of pods created:</p>
<pre class="codehilite"><code>kubectl get -w pods -l job-name=wait
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME         READY   STATUS      RESTARTS   AGE
wait-5blwm   0/1     Completed   0          17s
wait-stmk4   0/1     Completed   0          17s
wait-ts6xt   1/1     Running     0          5s
wait-xlhl6   1/1     Running     0          5s
wait-xlhl6   0/1     Completed   0          12s
wait-rq6z5   0/1     Pending     0          0s
wait-ts6xt   0/1     Completed   0          12s
wait-rq6z5   0/1     Pending     0          0s
wait-rq6z5   0/1     ContainerCreating   0          0s
wait-f85bj   0/1     Pending             0          0s
wait-f85bj   0/1     Pending             0          0s
wait-f85bj   0/1     ContainerCreating   0          0s
wait-rq6z5   1/1     Running             0          2s
wait-f85bj   1/1     Running             0          2s
wait-f85bj   0/1     Completed           0          12s
wait-rq6z5   0/1     Completed           0          12s
</code></pre>

<p><strong>Step 6</strong> Once the job is completed, you can get the list of completed pods</p>
<pre class="codehilite"><code>kubectl get pods -l job-name=wait
</code></pre>

<p>Result:</p>
<pre class="codehilite"><code>NAME         READY   STATUS      RESTARTS   AGE
wait-5blwm   0/1     Completed   0          2m55s
wait-f85bj   0/1     Completed   0          2m31s
wait-rq6z5   0/1     Completed   0          2m31s
wait-stmk4   0/1     Completed   0          2m55s
wait-ts6xt   0/1     Completed   0          2m43s
wait-xlhl6   0/1     Completed   0          2m43s
</code></pre>

<p><strong>Step 5</strong> Similarly, <code>kubectl get jobs</code> shows the status of the job after it
has completed:</p>
<pre class="codehilite"><code>kubectl get jobs
</code></pre>

<p>Result:</p>
<pre class="codehilite"><code>NAME   COMPLETIONS   DURATION   AGE
wait   6/6           36s        3m54s
</code></pre>

<p><strong>Step 6</strong> Deleting a job deletes all the pods as well. Delete the job as:</p>
<pre class="codehilite"><code>kubectl delete -f job-parallel.yaml
</code></pre>

<h2 id="15-cron-jobs">1.5 Cron Jobs<a class="headerlink" href="#15-cron-jobs" title="Permanent link">&para;</a></h2>
<p>A Cron Job is a job that runs on a given schedule, written in Cron format.
There are two primary use cases:</p>
<ul>
<li>Run jobs once at a specified point in time</li>
<li>Repeatedly at a specified point in time</li>
</ul>
<h3 id="151-create-cron-job">1.5.1 Create Cron Job<a class="headerlink" href="#151-create-cron-job" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Create <code>CronJob</code> manifest that prints the current timestamp and the
message "<code>Hello World</code>" every minute.</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; cronjob.yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: &quot;*/1 * * * *&quot;
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: hello-cronpod
        spec:
          containers:
          - name: hello
            image: busybox
            args:
            - /bin/sh
            - -c
            - date; echo Hello World!
          restartPolicy: OnFailure
EOF
</code></pre>

<p><strong>Step 2</strong> Create the Cron Job as shown in the command:</p>
<pre class="codehilite"><code>kubectl create -f cronjob.yaml
</code></pre>

<p><strong>Step 3</strong> Watch the status of the job as shown:</p>
<pre class="codehilite"><code>kubectl get -w cronjobs
</code></pre>

<p><strong>Output</strong>:</p>
<pre class="codehilite"><code>NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
hello   */1 * * * *   False     0        &lt;none&gt;          6s
hello   */1 * * * *   False     1        5s              39s
hello   */1 * * * *   False     0        15s             49s
hello   */1 * * * *   False     1        5s              99s
hello   */1 * * * *   False     0        15s             109s
hello   */1 * * * *   False     1        6s              2m40s
hello   */1 * * * *   False     0        16s             2m50s
</code></pre>

<p><strong>Step 4</strong> In another terminal window, watch the status of pods created:</p>
<pre class="codehilite"><code>kubectl get -w pods -l app=hello-cronpod
</code></pre>

<p><strong>Output</strong>:</p>
<pre class="codehilite"><code>NAME                     READY   STATUS      RESTARTS   AGE
hello-1622584020-kc46c   0/1     Completed   0          118s
hello-1622584080-c2pcq   0/1     Completed   0          58s
hello-1622584140-hxnv2   0/1     Pending     0          0s
hello-1622584140-hxnv2   0/1     Pending     0          0s
hello-1622584140-hxnv2   0/1     ContainerCreating   0          0s
hello-1622584140-hxnv2   1/1     Running             0          1s
hello-1622584140-hxnv2   0/1     Completed           0          2s
</code></pre>

<p><strong>Step 5</strong> Get logs from one of the pods:</p>
<pre class="codehilite"><code>kubectl logs hello-1622584140-hxnv2
</code></pre>

<p><strong>Output</strong>:</p>
<pre class="codehilite"><code>Tue Jun  1 21:49:07 UTC 2021
Hello World!
</code></pre>

<p><strong>Step 6</strong> Delete Cron Job</p>
<pre class="codehilite"><code>kubectl delete -f cronjob.yaml
</code></pre>

<h2 id="16-daemon-set">1.6 Daemon Set<a class="headerlink" href="#16-daemon-set" title="Permanent link">&para;</a></h2>
<p>Daemon Set ensures that a copy of the pod runs on a selected set of nodes.
By default, all nodes in the cluster are selected. A selection critieria may be
specified to select a limited number of nodes.</p>
<p>As new nodes are added to the cluster, pods are started on them. As nodes are
removed, pods are removed through garbage collection.</p>
<p>The following is an example DaemonSet that runs a Prometheus exporter container
that used for collecting machine metrics from each node.</p>
<p><strong>Step 1</strong> Create a DaemonSet manifest</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: prometheus-daemonset
spec:
  selector:
    matchLabels:
      tier: monitoring
      name: prometheus-exporter
  template:
    metadata:
      labels:
        tier: monitoring
        name: prometheus-exporter
    spec:
      containers:
      - name: prometheus
        image: prom/node-exporter
        ports:
        - containerPort: 80
EOF
</code></pre>

<p><strong>Step 2</strong>  Run the following command to create the ReplicaSet and pods:</p>
<pre class="codehilite"><code>kubectl create -f daemonset.yaml --record
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>--record</code> flag will track changes made through each revision.</p>
</div>
<p><strong>Step 3</strong> Get basic details about the DaemonSet:</p>
<pre class="codehilite"><code>kubectl get daemonsets/prometheus-daemonset
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME                   DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE-SELECTOR   AGE
prometheus-daemonset   1         1         1         1            1           &lt;none&gt;          5s
</code></pre>

<p><strong>Step 4</strong> Get more details about the DaemonSet:</p>
<pre class="codehilite"><code>kubectl describe daemonset/prometheus-daemonset
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Name:           prometheus-daemonset
Selector:       name=prometheus-exporter,tier=monitoring
Node-Selector:  &lt;none&gt;
Labels:         &lt;none&gt;
Annotations:    deprecated.daemonset.template.generation: 1
                kubernetes.io/change-cause: kubectl create --filename=daemonset.yaml --record=true
Desired Number of Nodes Scheduled: 2
Current Number of Nodes Scheduled: 2
Number of Nodes Scheduled with Up-to-date Pods: 2
Number of Nodes Scheduled with Available Pods: 2
Number of Nodes Misscheduled: 0
Pods Status:  2 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:  name=prometheus-exporter
           tier=monitoring
  Containers:
   prometheus:
    Image:        prom/node-exporter
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Events:
  Type    Reason            Age    From                  Message
  ----    ------            ----   ----                  -------
  Normal  SuccessfulCreate  9m     daemonset-controller  Created pod: prometheus-daemonset-f4xl2
  Normal  SuccessfulCreate  2m18s  daemonset-controller  Created pod: prometheus-daemonset-w596z
</code></pre>

<p><strong>Step 5</strong> Get pods in the DaemonSet:</p>
<pre class="codehilite"><code>kubectl get pods -l name=prometheus-exporter
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME                         READY   STATUS    RESTARTS   AGE
prometheus-daemonset-f4xl2   1/1     Running   0          8m27s
prometheus-daemonset-w596z   1/1     Running   0          105s
</code></pre>

<p><strong>Step 6</strong> Verify that the Prometheus pod was successfully deployed to the cluster nodes:</p>
<pre class="codehilite"><code>kubectl get pods -o wide
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME                         READY   STATUS    RESTARTS   AGE     IP          NODE                                          NOMINATED NODE   READINESS GATES
prometheus-daemonset-f4xl2   1/1     Running   0          6m51s   10.0.0.19   gke-k8s-features-default-pool-73e09df7-m2lf   &lt;none&gt;           &lt;none&gt;
prometheus-daemonset-w596z   1/1     Running   0          9s      10.0.1.2    gke-k8s-features-default-pool-73e09df7-k7hj   &lt;none&gt;           &lt;none&gt;
</code></pre>

<div class="admonition notes">
<p class="admonition-title">Notes</p>
<p>It is possible to Limit DaemonSets to specific nodes
by changing the <code>spec.template.spec</code> to include a <code>nodeSelector</code> to matche <code>node</code> label.</p>
</div>
<p><strong>Step 7</strong>  Delete a DaemonSet</p>
<pre class="codehilite"><code>kubectl delete -f daemonset.yaml
</code></pre>

<h2 id="17-cleaning-up">1.7 Cleaning Up<a class="headerlink" href="#17-cleaning-up" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Delete the cluster</p>
<pre class="codehilite"><code>gcloud container clusters delete k8s-concepts
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
