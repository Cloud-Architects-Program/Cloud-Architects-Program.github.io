
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Istio Traffic Control - Canary Deployments - Cloud Native University</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#istio-traffic-control-canary-deployments" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Native University" class="md-header__button md-logo" aria-label="Cloud Native University" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Native University
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Istio Traffic Control - Canary Deployments
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Native University" class="md-nav__button md-logo" aria-label="Cloud Native University" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Native University
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        YCIT020
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_3_Terraform_Fundamentals/" class="md-nav__link">
        Lab 3 Terraform Fundamentals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_4_Traffic_control/" class="md-nav__link">
        Lab 4 Traffic Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_5_EFK/" class="md-nav__link">
        Lab 5 EFK Stack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_6_Prometheus/" class="md-nav__link">
        Lab 6 Monitoring with Prometheus
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_9_GitOps/" class="md-nav__link">
        Lab 9 GitOps with Flux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_10_cloudrun/" class="md-nav__link">
        Lab 10 Serverless Cloud Run
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_Production_GKE/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_sol_Production_GKE/" class="md-nav__link">
        Assignment2 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_sol_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_Helm_Foundation/" class="md-nav__link">
        Assignmen4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_sol_Helm_Foundation/" class="md-nav__link">
        Assignmen4 Sol
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        YCIT019
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_2_Docker_basics/" class="md-nav__link">
        Lab 2 Docker Basics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_3_Advanced_Docker/" class="md-nav__link">
        Lab 3 Advanced Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_4_Docker_Images/" class="md-nav__link">
        Lab 4 Managing Docker Images
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_5_Docker_Compose/" class="md-nav__link">
        Lab 5 Docker Compose
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_6_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Lab 6 Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_7_Kubernetes_Concepts/" class="md-nav__link">
        Lab 7 Kubernetes Concepts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_8_Kubernetes_Features/" class="md-nav__link">
        Lab 8 Kubernetes Features
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_9_Kubernetes_Scaling/" class="md-nav__link">
        Lab 9 Kubernetes Autoscaling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Lab 10 Kubernetes Networking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Lab 11 Kubernetes Storage
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Assignment1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Assignment1 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Assignment2 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Assignment3 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4/" class="md-nav__link">
        Assignment4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Assignment4 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5/" class="md-nav__link">
        Assignment5
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5_solution/" class="md-nav__link">
        Assignment5 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6/" class="md-nav__link">
        Assignment6
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Assignment6 - Solution
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisite-please-skip-if-already-done" class="md-nav__link">
    Prerequisite (Please Skip if already done)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-deploy-istio-using-custom-resources" class="md-nav__link">
    1  Deploy Istio using Custom Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-deploy-an-micorservices-application" class="md-nav__link">
    2 Deploy an Micorservices Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-allow-traffic-to-online-boutique-application" class="md-nav__link">
    3 Allow Traffic to Online Boutique Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-canary-deployments-with-istio" class="md-nav__link">
    4 Canary Deployments with Istio
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-cleanup" class="md-nav__link">
    5 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="istio-traffic-control-canary-deployments">Istio Traffic Control - Canary Deployments<a class="headerlink" href="#istio-traffic-control-canary-deployments" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Install Istio</li>
<li>Deploy an application and enable automatic sidecar injection</li>
<li>Deploy a canary service and use Istio to route some traffic to the new service</li>
</ul>
<h2 id="prerequisite-please-skip-if-already-done">Prerequisite (Please Skip if already done)<a class="headerlink" href="#prerequisite-please-skip-if-already-done" title="Permanent link">&para;</a></h2>
<p>Scale-up cluster back to 3 nodes and Update VPC firewall rules to enable <code>auto-injection</code> and the <code>istioctl version</code> and <code>istioctl ps</code> commands.</p>
<p>References:</p>
<ol>
<li><a href="https://cloud.google.com/service-mesh/v1.7/docs/private-cluster-open-port">Opening ports on a private cluster</a></li>
<li>Istio deployment on <a href="https://istio.io/latest/docs/setup/platform-setup/gke/">GKE Private Clusters</a></li>
</ol>
<p><strong>Step 1:</strong> Locate Terraform Configuration directory.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
</code></pre></div>

<p><strong>Step 2:</strong> Configure GKE Cluster to Scale back to <code>1</code> node per zone in a region.</p>
<div class="codehilite"><pre><span></span><code>edit terraform.tfvars
</code></pre></div>

<p>And set <code>gke_pool_node_count</code>   = "1"</p>
<p><strong>(Skip if already installed Istio on this cluster) Step 3:</strong>  Create new firewall rule for source range (master-ipv4-cidr) of the cluster, that will open required ports for Istio installation:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; istio_firewall.tf
resource &quot;google_compute_firewall&quot; &quot;istio_specific&quot; {
  name =   format(&quot;allow-istio-in-privategke-%s-%s-%s&quot;, var.org, var.product, var.environment)
  network = google_compute_network.vpc_network.self_link
  source_ranges = [&quot;172.16.0.0/28&quot;]
  allow {
    protocol = &quot;tcp&quot;
    ports = [&quot;10250&quot;, &quot;443&quot;, &quot;15017&quot;, &quot;15014&quot;, &quot;8080&quot;]
  }
}
EOF
</code></pre></div>

<p><strong>Step 4:</strong> Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p><strong>Step 5:</strong> Scale up GKE Cluster Node Pool and update firewall rules for required range:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>GKE Clusters has been scalled to 3 nodes and has firewall rules opened</p>
</div>
<p><strong>Step 6:</strong> Verify firewall rule:</p>
<div class="codehilite"><pre><span></span><code>gcloud compute firewall-rules list --filter=&quot;name~allow-istio-in-privategke*&quot;
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                                            NETWORK                   DIRECTION  PRIORITY  ALLOW                                           DENY  DISABLED
allow-istio-in-privategke-$student-notepad-dev  vpc-$student-notepad-dev  INGRESS    1000      tcp:10250,tcp:443,tcp:15017,tcp:15014,tcp:8080        False
</code></pre></div>

<h2 id="1-deploy-istio-using-custom-resources">1  Deploy Istio using Custom Resources<a class="headerlink" href="#1-deploy-istio-using-custom-resources" title="Permanent link">&para;</a></h2>
<p>This installation guide uses the istioctl command line tool to provide rich customization of the Istio control plane and of the sidecars for the Istio data plane.</p>
<p>Download and extract the latest release:</p>
<div class="codehilite"><pre><span></span><code>curl -L https://istio.io/downloadIstio | sh -
cd istio-1.11.0
export PATH=$PWD/bin:$PATH
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>The above command will fetch Istio packages and untar them in the same folder.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Istio installation directory contains:</p>
<ul>
<li><code>bin</code> directory contains <code>istioctl</code> client binary</li>
<li><code>manifests</code> Installation Profiles, configurations and Helm Charts</li>
<li><code>samples</code> directory contains sample applications deployment</li>
<li><code>tools</code>  directory contains auto-completion tooling and etc.</li>
</ul>
</div>
<p><strong>Step 2</strong> Deploy Istio Custom Resource Definitions (CRDs)</p>
<p>Istio extends Kubernetes using Custom Resource Definitions (CRDs). 
CRDs allow registration of new/non-default Kubernetes resources. When Istio CRDs are deployed, Istio’s objects are registered as Kubernetes objects, providing a highly integrated experience with 
Kubernetes as a deployment platform and thus allowing Kubernetes to store configuration of Istio features such as routing, security and telemetry and etc.</p>
<p>We going to install using using <code>demo</code> configuration profile. The <code>demo</code> configuration profile allows to experiment with most of Istio features with modest resource requirements. 
Since it enables high levels of tracing and access logging, it is not suitable for production use cases.</p>
<div class="codehilite"><pre><span></span><code>export STATIC_IP=&lt;set your Static IP&gt;
</code></pre></div>

<div class="codehilite"><pre><span></span><code>istioctl install --set profile=demo --set values.gateways.istio-ingressgateway.loadBalancerIP=$STATIC_IP
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>✔ Istio core installed
✔ Istiod installed
✔ Egress gateways installed
✔ Ingress gateways installed
✔ Installation complete
Thank you for installing Istio 1.11.  Please take a few minutes to tell us about your install/upgrade experience!  
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Wait a few seconds for the CRDs to be committed in the Kubernetes API-server.</p>
</div>
<p><strong>Step 3</strong> Verify Istio CRDs successfully applied to Kubernetes Cluster.</p>
<div class="codehilite"><pre><span></span><code>kubectl get crds | grep istio
</code></pre></div>

<h2 id="2-deploy-an-micorservices-application">2 Deploy an Micorservices Application<a class="headerlink" href="#2-deploy-an-micorservices-application" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Get the source code for a sample application. For this lab, we will use the Online Boutique sample app.</p>
<div class="codehilite"><pre><span></span><code>cd ~
git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
cd microservices-demo 
</code></pre></div>

<p><strong>Step 2</strong> Create a namespace <code>online-boutique</code> for example</p>
<div class="codehilite"><pre><span></span><code>kubectl create namespace online-boutique
</code></pre></div>

<p><strong>Step 3</strong> Enable automatic sidecar injection for the online-boutique namespace</p>
<div class="codehilite"><pre><span></span><code>kubectl label namespace online-boutique istio-injection=enabled --overwrite
kubectl config set-context --current --namespace=online-boutique
</code></pre></div>

<p><strong>Step 4</strong> Deploy the application by creating the kubernetes manifests</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f ./release/kubernetes-manifests.yaml -n online-boutique
</code></pre></div>

<p><strong>Step 5</strong> Watch the pods and verify that all pods were started successfully with the sidecar injected</p>
<div class="codehilite"><pre><span></span><code>watch kubectl get pods -n online-boutique
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                                     READY   STATUS    RESTARTS   AGE
adservice-5844cffbd4-h7lkk               2/2     Running   0          84s
cartservice-fdc659ddc-fzmn9              2/2     Running   0          86s
checkoutservice-64db75877d-hk25l         2/2     Running   0          88s
currencyservice-9b7cdb45b-9xzhl          2/2     Running   0          85s
emailservice-64d98b6f9d-v44rm            2/2     Running   0          89s
frontend-76ff9556-p62g9                  2/2     Running   0          87s
loadgenerator-589648f87f-4dfkp           2/2     Running   0          85s
paymentservice-65bdf6757d-zd4w4          2/2     Running   0          87s
productcatalogservice-5cd47f8cc8-c6hdn   2/2     Running   0          86s
recommendationservice-b75687c5b-clcbt    2/2     Running   0          88s
redis-cart-74594bd569-9gpjt              2/2     Running   0          84s
shippingservice-778554994-ttwf2          2/2     Running   0          85s
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Pods Started with sidecar auto-injected</p>
</div>
<h2 id="3-allow-traffic-to-online-boutique-application">3 Allow Traffic to Online Boutique Application<a class="headerlink" href="#3-allow-traffic-to-online-boutique-application" title="Permanent link">&para;</a></h2>
<p>In order for traffic to flow to the frontend of the application, we need to create an ingress gateway and a virtual service attached to it.</p>
<p><strong>Step 1</strong> Apply the istio manifests to configure the Istio <code>Gateway</code>:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; frontend-gateway.yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: frontend-gateway
spec:
  selector:
    istio: ingressgateway # use Istio default gateway implementation
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;*&quot;
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f frontend-gateway.yaml
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Gateway resource important fields:</p>
<ul>
<li><code>name</code> - name of gateway</li>
<li><code>spec.selector.istio</code> - which gateway to use (can be several)</li>
<li><code>spec.servers</code> - defines which hosts will use this gateway proxy</li>
<li><code>spec.servers.port.number</code> - ports to expose</li>
<li><code>spec.servers.port.host</code> - host(s) for this port</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this point our gateway is listening for request that match any host  on port 80 and it's accessible on the public internet.</p>
</div>
<p>Check the created gateway:</p>
<div class="codehilite"><pre><span></span><code>kubectl get gateway
kubectl get gateway -o yaml
</code></pre></div>

<p>Check the Envoy listeners been created:</p>
<div class="codehilite"><pre><span></span><code>export INGRESS_POD=$(kubectl get pods -n istio-system | grep &#39;ingress&#39; |awk &#39;{ print $1}&#39;)
istioctl proxy-config listener $INGRESS_POD  -n istio-system
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>HTTP port correctly exposed correctly</p>
</div>
<p>Verify what Ingress Gateway spec.selector.istio selects for use:</p>
<div class="codehilite"><pre><span></span><code>kubectl get pod --selector=&quot;istio=ingressgateway&quot; --all-namespaces
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>istio-ingressgateway-xxx pod in istio-system (our edge envoy pod) will proxy traffic further to Kubernetes services.</p>
</div>
<p>Try to connect to the Istio Ingress IP:</p>
<div class="codehilite"><pre><span></span><code>curl -v $STATIC_IP
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>It's returning 404 error.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've create gateway resource that is listening for request that match any host on port 80 and it's accessible on the public internet, 
however it's returning 404 error because once the gateway receives the request it doesn't know where it needs to send it.</p>
</div>
<p><strong>Step 2</strong> Apply the istio manifests to configure <code>VirtualService</code> to allow external traffic into the mesh and route it to the frontend service</p>
<p>When traffic comes into the <code>gateway</code>, it is required to get it to a specific service within the <code>service</code> mesh and to do that, we’ll use the <code>VirtualService</code> resource.</p>
<p>In Istio, a <code>VirtualService</code> defines the rules that control how requests for a service are routed within an Istio service mesh. For instance, a <code>VirtualService</code> can route requests to different versions of a <code>service</code>, 
Requests can be routed based on the request source and destination, HTTP paths and header field and weights associated with individual service versions. 
As well as use advanced routing properties such as retries, request timeouts, circuit braking, fault injection and etc.</p>
<p>export STUDENT=ayrat</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; frontend-vs.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend-ingress
spec:
  hosts:
  - &quot;$STUDENT.cloud-montreal.ca&quot;
  gateways:
  - frontend-gateway
  http:
  - route:
    - destination:
        host: frontend
        port:
          number: 80
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f frontend-vs.yaml
</code></pre></div>

<p>Acquire <code>frontend</code> app URL:</p>
<div class="codehilite"><pre><span></span><code>kubectl get virtualservices
</code></pre></div>

<p>Access <code>frontend</code> app URL from your browser:</p>
<p>!!! success We can access <code>frontend</code> web app via Istio Ingress Gateway</p>
<ul>
<li>frontend.yaml: defines another virtual service to be used by our load generator to make sure traffic directed to the frontend from within the mesh stays internal, and doesn't go through the gateway.</li>
<li>Whitelist-egress-googleapis.yaml: Used to whitelist various google APIs used by services within the mesh.</li>
</ul>
<p><strong>Step 3</strong> Defines another <code>Virtualservice</code> to be used by our load generator to make sure traffic directed to the frontend from within the mesh stays internal, 
and doesn't go through the gateway.</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; frontend-load-vs.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend
spec:
  hosts:
  - &quot;frontend.default.svc.cluster.local&quot;
  http:
  - route:
    - destination:
        host: frontend
        port:
          number: 80
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f frontend-load-vs.yaml
</code></pre></div>

<p><strong>Step 4</strong> Create <code>ServiceEntry</code> custom resource to allow access to external APIs <code>googleapis.com</code> and GCE metadata service <code>metadata.google.internal</code> that app is using:</p>
<p>Because all outbound traffic from an Istio-enabled pod is redirected to its sidecar proxy by default, accessibility of URLs outside of the cluster depends on the configuration of the proxy. 
By default, Istio configures the Envoy proxy to passthrough requests for unknown services. 
Although this provides a convenient way to get started with Istio, configuring stricter control is usually preferable in production scenarios.</p>
<p>Istio has an option, <code>global.outboundTrafficPolicy.mode</code>, that configures the sidecar handling of external services, that is, those services that are not defined in Istio’s internal service registry. 
If this option is set to <code>ALLOW_ANY</code>, the Istio proxy lets calls to unknown services pass through. If the option is set to <code>REGISTRY_ONLY</code>, 
then the Istio proxy blocks any host without an HTTP service or service entry defined within the mesh.</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; allow-egress-googleapis.yaml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: allow-egress-googleapis
spec:
  hosts:
  - &quot;accounts.google.com&quot; # Used to get token
  - &quot;*.googleapis.com&quot;
  ports:
  - number: 80
    protocol: HTTP
    name: http
  - number: 443
    protocol: HTTPS
    name: https
---
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: allow-egress-google-metadata
spec:
  hosts:
  - metadata.google.internal
  addresses:
  - 169.254.169.254 # GCE metadata server
  ports:
  - number: 80
    name: http
    protocol: HTTP
  - number: 443
    name: https
    protocol: HTTPS
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f allow-egress-googleapis.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get serviceentries  
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p><code>ServiceEntry</code> resource inserts an entry into Istio’s service registry which makes explicit that clients within the mesh are allowed to call a <code>metadata.google.internal</code>, <code>accounts.google.com</code>, <code>*.googleapis.com</code> regardless the namespaces</p>
</div>
<h2 id="4-canary-deployments-with-istio">4 Canary Deployments with Istio<a class="headerlink" href="#4-canary-deployments-with-istio" title="Permanent link">&para;</a></h2>
<p>We going to deploy a new version of <code>recommendationservice</code> with <code>canary</code> label.</p>
<p>Once we’ve deployed the new version, we can start releasing it gradually by routing 20% of all incoming requests to the latest version, while the rest of the requests (98%) still goes to the existing version.</p>
<p><strong>Step 1</strong> Patch the Recommendation service deployment to give it a <code>production</code> label</p>
<div class="codehilite"><pre><span></span><code>kubectl patch deployment -n online-boutique recommendationservice --type=&#39;json&#39; -p=&#39;[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/template/metadata/labels/version&quot;, &quot;value&quot;: &quot;production&quot;}]&#39;
</code></pre></div>

<p><strong>Step 2</strong> Check the labels on the deployment</p>
<div class="codehilite"><pre><span></span><code>export RECOMMMENDATIONSERVICE=$(kubectl get pods | grep &#39;recommendationservice&#39; |awk &#39;{ print $1}&#39;)
kubectl get pod -n online-boutique $RECOMMMENDATIONSERVICE --show-labels
</code></pre></div>

<p><strong>Step 3</strong> Create a DestinationRule that defines two subsets <code>production</code> and <code>canary</code></p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt;  destinationrule-recommendation.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: recommendationservice
  namespace: online-boutique
spec:
  host: recommendationservice
  subsets:
  - name: production
    labels:
      version: production
  - name: canary
    labels:
      version: canary
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f  destinationrule-recommendation.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get destinationrules
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We've defined DestinationRule with 2 subsets.</p>
</div>
<p><strong>Step 4</strong> Make a change to the <code>Recommendation</code> service and by modifying it's <code>max_responses</code> parameter.</p>
<div class="codehilite"><pre><span></span><code>cd ~/microservices-demo
ls
cat src/recommendationservice/Dockerfile
</code></pre></div>

<div class="codehilite"><pre><span></span><code>sed -i &#39;s/max_responses = 5/max_responses = 2/g&#39; \
   src/recommendationservice/recommendation_server.py
</code></pre></div>

<p><strong>Step 5</strong> Build a new version of the image</p>
<div class="codehilite"><pre><span></span><code>PROJECT_ID=$(gcloud config list --format &quot;value(core.project)&quot;)

docker build -t \
  gcr.io/${PROJECT_ID}/microservices_demo/recommendationservice:canary \
  src/recommendationservice
</code></pre></div>

<p><strong>Step 6</strong> Push the image to GCR</p>
<div class="codehilite"><pre><span></span><code>docker push gcr.io/${PROJECT_ID}/microservices_demo/recommendationservice:canary
</code></pre></div>

<p><strong>Step 7</strong> Deploy the canary version of the Recommendation service:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt;  recommendation-deployment-vcanary.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: recommendationservice
    version: canary
  name: recommendationservice-canary
  namespace: online-boutique
spec:
  replicas: 1
  selector:
    matchLabels:
      app: recommendationservice
      version: canary
  template:
    metadata:
      labels:
        app: recommendationservice
        version: canary
    spec:
      containers:
      - env:
        - name: PORT
          value: &quot;8080&quot;
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: productcatalogservice:3550
        - name: ENABLE_PROFILER
          value: &quot;0&quot;
        image: gcr.io/$PROJECT_ID/microservices_demo/recommendationservice:canary
        imagePullPolicy: Always
        livenessProbe:
          exec:
            command:
            - /bin/grpc_health_probe
            - -addr=:8080
          failureThreshold: 3
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        name: server
        ports:
        - containerPort: 8080
          protocol: TCP
        readinessProbe:
          exec:
            command:
            - /bin/grpc_health_probe
            - -addr=:8080
          failureThreshold: 3
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 200m
            memory: 450Mi
          requests:
            cpu: 100m
            memory: 220Mi
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f recommendation-deployment-vcanary.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get deploy | grep recommendationservice 
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>2 versions of <code>recommendationservice</code> has been deployed</p>
</div>
<p><strong>Step 8</strong> Create a virtual service to direct 20% of the traffic to the <code>canary</code> version</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt;  vs-recommendation.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendationservice
  namespace: online-boutique
spec:
  hosts:
  - recommendationservice
  http:
  - route:
    - destination:
        host: recommendationservice
        port:
          number: 8080
        subset: production
      weight: 80
    - destination:
        host: recommendationservice
        port:
          number: 8080
        subset: canary 
      weight: 20
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f vs-recommendation.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get VirtualService
</code></pre></div>

<p><strong>Step 9</strong> Refresh the page for one of the products where recommendations are shown multiple times, and notice how most of the time you get 5 recommendations while if 20% of the time you get only 2 recommendations.</p>
<h2 id="5-cleanup">5 Cleanup<a class="headerlink" href="#5-cleanup" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Uninstall Istio</p>
<div class="codehilite"><pre><span></span><code>istioctl manifest generate --set profile=demo | kubectl delete --ignore-not-found=true -f -
kubectl delete namespace istio-system
 kubectl delete namespace online-boutique
</code></pre></div>

<p><strong>Step 2</strong> Resize GKE Cluster to <code>0</code> nodes, to avoid charges:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
</code></pre></div>

<div class="codehilite"><pre><span></span><code>edit terraform.tfvars
</code></pre></div>

<p>And set <code>gke_pool_node_count</code>   = "0"</p>
<p><strong>Step 3:</strong> Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p><strong>Step 4:</strong> Shutdown all Nodes in GKE Cluster Node Pool:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<div class="codehilite"><pre><span></span><code>!!! result
    GKE Clusters has been scale down to 0 nodes.
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>