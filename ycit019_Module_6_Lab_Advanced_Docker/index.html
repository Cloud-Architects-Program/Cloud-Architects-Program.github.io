
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://cloud-architects-program.github.io/ycit019_Module_6_Lab_Advanced_Docker/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>ycit019 Module 6 Lab Advanced Docker - Cloud Architecture</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prepare-lab-environment" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Architecture" class="md-header__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Architecture
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ycit019 Module 6 Lab Advanced Docker
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Cloud-Architects-Program/assignment" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Architecture" class="md-nav__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Architecture
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Cloud-Architects-Program/assignment" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Cloud Native Administrator
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Cloud Native Administrator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Module 5 - Docker Basics
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Module 5 - Docker Basics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../presentation5.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Presentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Module_5_Lab_Docker_basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Labs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../assignment5_dockerbas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Assignment
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quiz_5_dockerbas/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quizzes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../add_mat_docker_basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Additional Materials
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../glossary_docker_basic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prepare-lab-environment" class="md-nav__link">
    <span class="md-ellipsis">
      Prepare Lab Environment
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-persistant-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      1 Persistant Volumes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1 Persistant Volumes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-storage-driver" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 Storage driver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-persisting-data-using-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Persisting Data Using Volumes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 Persisting Data Using Volumes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-create-and-manage-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 Create and manage volumes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-start-a-container-with-a-volume" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 Start a container with a volume
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-distributing-docker-images-with-container-registry" class="md-nav__link">
    <span class="md-ellipsis">
      2 Distributing Docker images with Container Registry
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2 Distributing Docker images with Container Registry">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-create-dockerfile" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 Create DOCKERFILE
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-build-a-docker-image" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 Build a Docker image
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 Build a Docker image">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#122-publish-docker-image-to-docker-hub" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 Publish Docker Image to Docker Hub
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-pushing-images-to-gcrio" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.3 Pushing images to gcr.io
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-pushing-images-to-local-repository" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.3 Pushing images to Local Repository
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-follow-docker-best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      3 Follow Docker Best Practices
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3 Follow Docker Best Practices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-inspecting-dockerfiles-with-dockle" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Inspecting Dockerfiles with dockle
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-scan-images-with-trivy" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Scan images with Trivy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-docker-compose" class="md-nav__link">
    <span class="md-ellipsis">
      4 Docker Compose
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4 Docker Compose">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-deploy-guestbook-app-with-compose" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Deploy Guestbook app with Compose
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<p>Lab 4 Managing Docker Images</p>
<p><strong>Objective:</strong></p>
<ul>
<li>Docker Storage</li>
<li>Learn to build docker images using Dockerfiles.</li>
<li>Store images in Docker Hub</li>
<li>Learn alternative registry solutions (GCR)</li>
</ul>
<h2 id="prepare-lab-environment">Prepare Lab Environment<a class="headerlink" href="#prepare-lab-environment" title="Permanent link">&para;</a></h2>
<p>This lab can be executed in you GCP Cloud Environment using Google Cloud Shell.</p>
<p>Open the Google Cloud Shell by clicking on the icon on the top right of the screen:</p>
<p><img alt="alt text" src="../images/cloud_shell.png" title="Google Cloud Shell" /></p>
<p>Once opened, you can use it to run the instructions for this lab.</p>
<h2 id="1-persistant-volumes">1 Persistant Volumes<a class="headerlink" href="#1-persistant-volumes" title="Permanent link">&para;</a></h2>
<h3 id="11-storage-driver">1.1 Storage driver<a class="headerlink" href="#11-storage-driver" title="Permanent link">&para;</a></h3>
<p>We've discussed several Storage drivers (graphdrivers) during the class.
Let's find out what graphdriver is running in our Lab environment.</p>
<div class="codehilite"><pre><span></span><code>docker info | grep  Storage
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Storage Driver: overlay2
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Our Classroom is running <code>auoverlay2fs</code> storage driver.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Systems runnng Ubuntu or Debian ,going to run <code>overlay2</code> storage driver by
default. Prior to that it was  <code>aufs</code> storage driver</p>
</div>
<h3 id="12-persisting-data-using-volumes">1.2 Persisting Data Using Volumes<a class="headerlink" href="#12-persisting-data-using-volumes" title="Permanent link">&para;</a></h3>
<p>Docker Volumes are created and assigned when containers are started. Data
Volumes allow you to map a host directory to a container for sharing data.</p>
<p>This mapping is bi-directional. It allows data stored on the host to be accessed
from within the container. It also means data saved by the process inside the
container is persisted on the host.</p>
<h4 id="121-create-and-manage-volumes">1.2.1  Create and manage volumes<a class="headerlink" href="#121-create-and-manage-volumes" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Create a volume:</p>
<div class="codehilite"><pre><span></span><code>docker volume create --name my-vol
</code></pre></div>

<p><strong>Step 2</strong> List volumes:</p>
<div class="codehilite"><pre><span></span><code>docker volume ls
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Output:
local               my-vol
</code></pre></div>

<p><strong>Step 3</strong> Inspect a volume:</p>
<div class="codehilite"><pre><span></span><code>docker volume inspect my-vol
</code></pre></div>

<div class="codehilite"><pre><span></span><code>[
    {
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Labels&quot;: {},
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,
        &quot;Name&quot;: &quot;my-vol&quot;,
        &quot;Options&quot;: {},
        &quot;Scope&quot;: &quot;local&quot;
    }
]
</code></pre></div>

<p><strong>Step 3</strong> Add some data to the <code>Mountpoint</code> of the volume:</p>
<div class="codehilite"><pre><span></span><code>sudo touch  /var/lib/docker/volumes/my-vol/_data/test_vol
sudo ls  /var/lib/docker/volumes/my-vol/_data/
</code></pre></div>

<p><strong>Step 4</strong> Create a container <code>busybox</code> alpine image and attach created <code>my-vol</code>
volume in to it:</p>
<div class="codehilite"><pre><span></span><code>docker run -it -v my-vol:/world busybox
</code></pre></div>

<div class="codehilite"><pre><span></span><code>/ # ls /world
test_vol
/ #
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Volume is mounted and <code>test_vol</code> file is under <code>/world</code> folder as expected</p>
</div>
<p><strong>Step 5</strong>  Try to delete the volume:</p>
<div class="codehilite"><pre><span></span><code>docker volume rm  my-vol
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Error response from daemon: unable to remove volume: remove my-vol: volume is in use - [6ef3055b516b306847150af8fcea796c02cd90578967802ac29c39d3a2c90102]
</code></pre></div>

<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Deleting container that is attached is not permited. However you can
delete with <code>-f</code> option</p>
</div>
<p><strong>Step 5</strong>  Busybox container stopped, howerver it is not deleted.
Let's locate stopped <code>busybox</code> container and delete it:</p>
<div class="codehilite"><pre><span></span><code>docker ps -a | grep busybox
</code></pre></div>

<div class="codehilite"><pre><span></span><code>docker rm $docker_id
</code></pre></div>

<p><strong>Step 6</strong> You can now delete <code>my-vol</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Volume is still avaiable if needed to be reattached any time</p>
</div>
<div class="codehilite"><pre><span></span><code>docker volume ls
docker volume rm my-vol
docker volume ls
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Volumes can be craeted and managed separately from containers.</p>
</div>
<h4 id="122-start-a-container-with-a-volume">1.2.2 Start a container with a volume<a class="headerlink" href="#122-start-a-container-with-a-volume" title="Permanent link">&para;</a></h4>
<p>If you start a container with a volume that does not yet exist, Docker creates
the volume for you.</p>
<p><strong>Step 1</strong> Add a data volume to a container:</p>
<div class="codehilite"><pre><span></span><code>docker run -d -P --name webapp -v /webapp training/webapp python app.py
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Command started a new container and created a new volume inside the
container at /webapp.</p>
</div>
<p><strong>Step 2</strong> Locate the volume on the host using the docker inspect command:</p>
<div class="codehilite"><pre><span></span><code> docker inspect webapp | grep -A9 Mounts
 ```
 **Output:**
 ```       &quot;Mounts&quot;: [
            {
                &quot;Type&quot;: &quot;volume&quot;,
                &quot;Name&quot;: &quot;39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d&quot;,
                &quot;Source&quot;: &quot;/var/lib/docker/volumes/39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d/_data&quot;,
                &quot;Destination&quot;: &quot;/webapp&quot;,
                &quot;Driver&quot;: &quot;local&quot;,
                &quot;Mode&quot;: &quot;&quot;,
                &quot;RW&quot;: true,
                &quot;Propagation&quot;: &quot;&quot;
</code></pre></div>

<p><strong>Step 3</strong> List container</p>
<div class="codehilite"><pre><span></span><code>docker volume ls
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>DRIVER              VOLUME NAME
local               39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d
</code></pre></div>

<p><strong>Step 5</strong> Alternatively, you can specify a host directory you want to use as a data
volume:</p>
<div class="codehilite"><pre><span></span><code>mkdir db

docker run -d --name db -v ~/db:/db training/postgres
</code></pre></div>

<p><strong>Step 2</strong> Start an interactive session in the db container and create a new
file in the /db directory:</p>
<div class="codehilite"><pre><span></span><code>docker exec -it db bash
</code></pre></div>

<p>Type inside docker containers console:</p>
<div class="codehilite"><pre><span></span><code>root@9a7a4fbcc929:/# cd /db

root@9a7a4fbcc929:/db# touch hello_from_db_container

root@9a7a4fbcc929:/db# exit
</code></pre></div>

<p><strong>Step 4</strong> Check that the local db directory contains the new file:</p>
<div class="codehilite"><pre><span></span><code>ls db
hello_from_db_container
</code></pre></div>

<p><strong>Step 5</strong> Check that the data volume is persistent. Remove the db container:</p>
<div class="codehilite"><pre><span></span><code>docker rm -f db
</code></pre></div>

<p><strong>Step 6</strong> Create the db container again:</p>
<div class="codehilite"><pre><span></span><code>docker run -d --name db -v ~/db:/db training/postgres
</code></pre></div>

<p><strong>Step 7</strong> Check that its /db directory contains the hello_from_db_container
file:</p>
<div class="codehilite"><pre><span></span><code>docker exec -it db bash
</code></pre></div>

<p>Run commands inside container:</p>
<div class="codehilite"><pre><span></span><code>root@47a60c01590e:/# ls /db
hello_from_db_container
root@47a60c01590e:/# exit
</code></pre></div>

<h1 id="2-distributing-docker-images-with-container-registry">2 Distributing Docker images with Container Registry<a class="headerlink" href="#2-distributing-docker-images-with-container-registry" title="Permanent link">&para;</a></h1>
<p>In the previous modules, we learned how to use Docker images
to run Docker containers. Docker images that we used have been downloaded from
the Docker Hub, a Docker image registry maintained by Docker Inc. In this section we will create a
simple web application from scratch. We will use Flask
(<a href="http://flask.pocoo.org/">http://flask.pocoo.org/</a>), a microframework for
Python. Our application for each request will display a random picture from the
defined set.</p>
<p>In the next session we will create all necessary files for our application,
build docker image and then push to Docker Hub and Quay.</p>
<p>The code for this application is also available in GitHub:</p>
<div class="codehilite"><pre><span></span><code>https://github.com/Cloud-Architects-Program/ycit019_2022/tree/main/Module5/flask-app
</code></pre></div>

<h2 id="11-create-dockerfile">1.1 Create DOCKERFILE<a class="headerlink" href="#11-create-dockerfile" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Clone git repo on you laptop:</p>
<div class="codehilite"><pre><span></span><code>git clone https://github.com/Cloud-Architects-Program/ycit019_2022
cd ~/ycit019_2022/Module5/flask-app/
git pull
</code></pre></div>

<p><strong>Step 2</strong> In this directory, we see following files:</p>
<div class="codehilite"><pre><span></span><code>flask-app/
    Dockerfile
    app.py
    requirements.txt
    templates/
        index.html
</code></pre></div>

<p><strong>Step 3</strong> Let’s review file app.py with the following content:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># list of cat images</span>
<span class="n">images</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;https://media.giphy.com/media/mlvseq9yvZhba/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/13CoXDiaCcCoyk/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/LtVXu5s7KwlK8/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/PekRU0CYIpXS8/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/11quO2C07Sh2oM/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/12HZukMBlutpoQ/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/1HKaikaFqDt7i/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/v6aOjy0Qo1fIA/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/12bjQ7uASAaCKk/giphy.gif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://media.giphy.com/media/HFcl9uhuCqzGU/giphy.gif&quot;</span>
<span class="p">]</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Step 4</strong> Below is the content of requirements.txt file:</p>
<div class="codehilite"><pre><span></span><code>Flask==2.0.0
</code></pre></div>

<p><strong>Step 5</strong> Under directory templates observe index.html with the following
content:</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">&gt;</span>
<span class="w">      </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">background</span><span class="p">:</span><span class="w"> </span><span class="kc">black</span><span class="p">;</span>
<span class="w">        </span><span class="k">color</span><span class="p">:</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nt">div</span><span class="p">.</span><span class="nc">container</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">max-width</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="kt">px</span><span class="w"> </span><span class="kc">auto</span><span class="p">;</span>
<span class="w">        </span><span class="k">border</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="kt">px</span><span class="w"> </span><span class="kc">solid</span><span class="w"> </span><span class="kc">white</span><span class="p">;</span>
<span class="w">        </span><span class="k">padding</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="kt">px</span><span class="p">;</span>
<span class="w">        </span><span class="k">text-align</span><span class="p">:</span><span class="w"> </span><span class="kc">center</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nt">h4</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">text-transform</span><span class="p">:</span><span class="w"> </span><span class="kc">uppercase</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>Cat Gif of the day<span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{{url}}&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>

<p><strong>Step 6</strong> Let’s review content of the Dockerfile:</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Official Python Alpine Base image using Simple Tags</span>
<span class="c"># Image contains Python 3 and pip pre-installed, so no need to install them</span>

<span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9.5-alpine3.12</span>

<span class="c"># Specify Working directory</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/usr/src/app</span>

<span class="c"># COPY requirements.txt /usr/src/app/</span>
<span class="k">COPY</span><span class="w"> </span>requirements.txt<span class="w"> </span>./

<span class="c"># Install Python Flask used by the Python app</span>
<span class="k">RUN</span><span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>-r<span class="w"> </span>requirements.txt

<span class="c"># Copy files required for the app to run</span>
<span class="k">COPY</span><span class="w"> </span>app.py<span class="w"> </span>./
<span class="k">COPY</span><span class="w"> </span>templates/index.html<span class="w"> </span>./templates/

<span class="c"># Make a record that the port number the container should be expose is:</span>
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">5000</span>

<span class="c"># run the application</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;./app.py&quot;</span><span class="p">]</span>
</code></pre></div>

<h2 id="12-build-a-docker-image">1.2 Build a Docker image<a class="headerlink" href="#12-build-a-docker-image" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Now let’s build our Docker image. In the command below, replace
<Docker-hub-user-name> with your user name. This user name should be the same as you
created when you registered on Docker Hub. Because we will publish our build
image in the next step to your own Docker Hub.</p>
<div class="codehilite"><pre><span></span><code>docker build -t &lt;Docker-hub-user-name&gt;/myfirstapp .
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Image has been buit </p>
</div>
<p><strong>Step 2</strong> Where is your built image? It’s in your machine’s local Docker image
registry, you can check that your image exists with command below:</p>
<div class="codehilite"><pre><span></span><code>docker images
</code></pre></div>

<p><strong>Step 3</strong> Now run a container in a background and expose a standard HTTP port
(80), which is redirected to the container’s port 5000:</p>
<div class="codehilite"><pre><span></span><code>docker run -dp 8080:5000 --name myfirstapp &lt;Docker-hub-user-name&gt;/myfirstapp
</code></pre></div>

<p><strong>Step 4</strong> Now that we've launched the application containers, let's try to test the web
application locally.</p>
<p>You should be able to access the application at Google Cloud <code>Web Preview</code> Console:</p>
<p><img alt="alt text" src="../images/web_preview.png" title="Web Preview" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Web Preview using port <code>8080</code> by default. If you application using other port, you can edit this as needed.</p>
</div>
<p><strong>Step 5</strong> Stop the container and remove it:</p>
<div class="codehilite"><pre><span></span><code>docker rm -f myfirstapp
</code></pre></div>

<h3 id="122-publish-docker-image-to-docker-hub">1.2.2 Publish Docker Image to Docker Hub<a class="headerlink" href="#122-publish-docker-image-to-docker-hub" title="Permanent link">&para;</a></h3>
<p>One of the most popular way to share and work with you images is to push
them to the Docker Hub.</p>
<p><strong>Docker Hub</strong> is a <a href="https://hub.docker.com/explore/">registry</a>
of Docker images. You can think of the registry as a directory of all available
Docker images.</p>
<p><strong>Step 1 (Optional)</strong> If you don’t have a Docker account, sign up for one
<a href="https://hub.docker.com/">here</a>. Make a note of your username and password.</p>
<p><strong>Step 2</strong> Log in to your local machine.</p>
<div class="codehilite"><pre><span></span><code>docker login
</code></pre></div>

<p><strong>Step 3</strong> Now, publish your image to docker Hub.</p>
<div class="codehilite"><pre><span></span><code>docker push &lt;Docker-hub-user-name&gt;/myfirstapp
</code></pre></div>

<p><strong>Step 4</strong> Login to <a href="https://hub.docker.com">https://hub.docker.com</a> and verify
simage and tags.</p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Image been pushed and can be observed in Docker Hub, with the <strong>tag</strong> latest.</p>
</div>
<p><strong>Step 5</strong> It is also possible to specify a custom tag for image prior to push
it to the registry</p>
<p>Note Image Tag of the created <code>myfirstapp</code>:</p>
<div class="codehilite"><pre><span></span><code>docker images
</code></pre></div>

<p>Modify <code>$docker_image_tag</code> with <code>myfirstapp:v1</code> image tag value:</p>
<div class="codehilite"><pre><span></span><code>docker tag $docker_image_tag &lt;Docker-hub-user-name&gt;/myfirstapp:v1
docker push &lt;Docker-hub-user-name&gt;/myfirstapp:v1
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Image been pushed and can be observed in Docker Hub. You can now
observe 2 docker image one with the <strong>tag</strong> latest and another with tag v1</p>
</div>
<p><strong>Step 6</strong> You can now <strong>pull</strong> or <strong>run</strong> specified <strong>Docker images</strong> from any
other location where docker engine is installed with following commands:</p>
<div class="codehilite"><pre><span></span><code>docker pull &lt;Docker-hub-user-name&gt;/myfirstapp:latest

docker pull &lt;Docker-hub-user-name&gt;/myfirstapp:v1
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Images stored locally</p>
</div>
<div class="codehilite"><pre><span></span><code>docker images
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>myfirstapp       v1       f50f9524513f    1 hour ago   22 MB

myfirstapp       latest   f50f9524513f    1 hour ago   22 MB
</code></pre></div>

<p>Finally run images with specific tag:</p>
<div class="codehilite"><pre><span></span><code>docker run &lt;Docker-hub-user-name&gt;/myfirstapp:v1
</code></pre></div>

<h3 id="123-pushing-images-to-gcrio">1.2.3 Pushing images to gcr.io<a class="headerlink" href="#123-pushing-images-to-gcrio" title="Permanent link">&para;</a></h3>
<p>In a similar manner we need to tag the image to prepare it to be pushed to gcr.io. We just need to change the registry, which is for gcr.io formatted as gcr.io/PROJECT_ID.</p>
<p><strong>Step 1</strong> Get the Project ID:</p>
<div class="codehilite"><pre><span></span><code>PROJECT_ID=$(gcloud config get-value project)
</code></pre></div>

<p><strong>Step 2</strong> Enable the required APIs:</p>
<div class="codehilite"><pre><span></span><code>gcloud services enable containerregistry.googleapis.com
</code></pre></div>

<p><strong>Step 3</strong> Tag the image:</p>
<p>Modify <code>$docker_image_tag</code> with <code>myfirstapp:v1</code> image tag value:</p>
<div class="codehilite"><pre><span></span><code>docker tag $docker_image_tag gcr.io/${PROJECT_ID}/myfirstapp:v1
</code></pre></div>

<p>Push the image to gcr.io:</p>
<div class="codehilite"><pre><span></span><code>docker push gcr.io/${PROJECT_ID}/myfirstapp:v1
</code></pre></div>

<p><strong>Step 4</strong>  Login to GCP console -&gt; Container Registry -&gt; Images</p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Docker images has been pushed to GCR registry</p>
</div>
<h3 id="123-pushing-images-to-local-repository">1.2.3 Pushing images to Local Repository<a class="headerlink" href="#123-pushing-images-to-local-repository" title="Permanent link">&para;</a></h3>
<p>First, we need to spin up a local docker registry. This could be a use case if you want to deploy basic registry On-Prem.
This registry will luck security features such as Authentication, SSL, scanning.
If you interested to use Enterprise ready solution On-Prem consider: Jfrog Artifactory, RedHa's Clair, Docker Enterprise or
open source CNCF project Harbor.</p>
<p><strong>Step 1</strong> Deploy local registry</p>
<div class="codehilite"><pre><span></span><code>docker run -d -p 5000:5000 --name registry registry:2.7.1
</code></pre></div>

<p><strong>Step 2</strong> In order to upload an image to a registry, we need to tag it properly</p>
<p>Modify <code>$docker_image_tag</code> with <code>myfirstapp:v1</code> image tag value:</p>
<div class="codehilite"><pre><span></span><code>docker tag $docker_image_tag localhost:5000/myfirstapp:v1
</code></pre></div>

<p><strong>Step 3</strong> Now that we have an image tagged correctly, we can push it to our local registry</p>
<div class="codehilite"><pre><span></span><code>docker push localhost:5000/myfirstapp:v1
</code></pre></div>

<p><strong>Step 4</strong> Let’s now delete the local image, and pull it again from the local registry</p>
<p>To delete the image, we need to first remove the container that depends on that image.
Run <code>docker ps</code> and get the Container_ID for the container that uses  myfirstapp:v1
Kill and delete that container by running the following command, but make sure to replace CONTAINER_ID, with the actual ID.</p>
<div class="codehilite"><pre><span></span><code>docker rm CONTAINER_ID
</code></pre></div>

<p>Result: The command will print back the container ID, which is an indication it was successful.</p>
<p><strong>Step 5</strong> Run docker images to validate</p>
<div class="codehilite"><pre><span></span><code>docker images
</code></pre></div>

<p><strong>Step 6</strong> Now we can delete the docker image</p>
<div class="codehilite"><pre><span></span><code>docker rmi localhost:5000/myfirstapp:v1
</code></pre></div>

<p><strong>Step 7</strong> Although the image is deleted locally, it is still in the registry and we can pull it back, or use it to deploy containers.</p>
<div class="codehilite"><pre><span></span><code>docker run -dp 8080:5000 --name myfirstapp localhost:5000/myfirstapp:v1
</code></pre></div>

<p>Run <code>docker images</code> again to check how the image is available locally again.</p>
<div class="codehilite"><pre><span></span><code>docker images
</code></pre></div>

<p><strong>Step 8 Cleanup:</strong></p>
<div class="codehilite"><pre><span></span><code>docker rm -f myfirstapp
</code></pre></div>

<h1 id="3-follow-docker-best-practices">3 Follow Docker Best Practices<a class="headerlink" href="#3-follow-docker-best-practices" title="Permanent link">&para;</a></h1>
<h2 id="31-inspecting-dockerfiles-with-dockle">3.1 Inspecting Dockerfiles with <code>dockle</code><a class="headerlink" href="#31-inspecting-dockerfiles-with-dockle" title="Permanent link">&para;</a></h2>
<p><code>Dockle</code> - Container Image Linter for Security, Helping build the Best-Practice Docker Image, Easy to start</p>
<p><code>Dockle</code> helps you:</p>
<ul>
<li>Build Best Practice Docker images</li>
<li>Build secure Docker images</li>
<li>Checkpoints includes CIS Benchmarks</li>
</ul>
<p><strong>Step 1</strong>  Install Dockle</p>
<div class="codehilite"><pre><span></span><code>$ VERSION=$(
 curl --silent &quot;https://api.github.com/repos/goodwithtech/dockle/releases/latest&quot; | \
 grep &#39;&quot;tag_name&quot;:&#39; | \
 sed -E &#39;s/.*&quot;v([^&quot;]+)&quot;.*/\1/&#39; \
) &amp;&amp; curl -L -o dockle.deb https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.deb
$ sudo dpkg -i dockle.deb &amp;&amp; rm dockle.deb
</code></pre></div>

<p><strong>Step 2</strong> Experiment with existing applications we've created in the class:</p>
<div class="codehilite"><pre><span></span><code>$ dockle [YOUR_IMAGE_NAME]
</code></pre></div>

<p>e.g.</p>
<div class="codehilite"><pre><span></span><code>dockle archy/myfirstapp
</code></pre></div>

<p>output:</p>
<div class="codehilite"><pre><span></span><code>WARN    - CIS-DI-0001: Create a user for the container
    * Last user should not be root
WARN    - DKL-DI-0006: Avoid latest tag
    * Avoid &#39;latest&#39; tag
INFO    - CIS-DI-0005: Enable Content trust for Docker
    * export DOCKER_CONTENT_TRUST=1 before docker pull/build
INFO    - CIS-DI-0006: Add HEALTHCHECK instruction to the container image
    * not found HEALTHCHECK statement
INFO    - DKL-LI-0003: Only put necessary files
    * Suspicious directory : tmp
</code></pre></div>

<h2 id="32-scan-images-with-trivy">3.2 Scan images with <a href="https://aquasecurity.github.io/trivy/v0.18.0/">Trivy</a><a class="headerlink" href="#32-scan-images-with-trivy" title="Permanent link">&para;</a></h2>
<p>Trivy (tri pronounced like trigger, vy pronounced like envy) is a simple and comprehensive vulnerability scanner for containers and other artifacts. A software vulnerability is a glitch, flaw, or weakness present in the software or in an Operating System. Trivy detects vulnerabilities of OS packages (Alpine, RHEL, CentOS, etc.) and application dependencies (Bundler, Composer, npm, yarn, etc.). Trivy is easy to use. Just install the binary and you're ready to scan. All you need to do for scanning is to specify a target such as an image name of the container.</p>
<p><strong>Step 1</strong>  Install Trivy</p>
<div class="codehilite"><pre><span></span><code>sudo apt-get install wget apt-transport-https gnupg lsb-release
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy
</code></pre></div>

<p><strong>Step 2</strong> Specify an image name (and a tag).</p>
<div class="codehilite"><pre><span></span><code>$ trivy image [YOUR_IMAGE_NAME]
</code></pre></div>

<p>For example:</p>
<div class="codehilite"><pre><span></span><code>$ trivy image python:3.4-alpine
</code></pre></div>

<div class="codehilite"><pre><span></span><code>2019-05-16T01:20:43.180+0900    INFO    Updating vulnerability database...
2019-05-16T01:20:53.029+0900    INFO    Detecting Alpine vulnerabilities...

python:3.4-alpine3.9 (alpine 3.9.2)
===================================
Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 1, HIGH: 0, CRITICAL: 0)

+---------+------------------+----------+-------------------+---------------+--------------------------------+
| LIBRARY | VULNERABILITY ID | SEVERITY | INSTALLED VERSION | FIXED VERSION |             TITLE              |
+---------+------------------+----------+-------------------+---------------+--------------------------------+
| openssl | CVE-2019-1543    | MEDIUM   | 1.1.1a-r1         | 1.1.1b-r1     | openssl: ChaCha20-Poly1305     |
|         |                  |          |                   |               | with long nonces               |
+---------+------------------+----------+-------------------+---------------+--------------------------------+
</code></pre></div>

<p><strong>Step 3</strong>  Explore local images in your environment. </p>
<h1 id="4-docker-compose">4 Docker Compose<a class="headerlink" href="#4-docker-compose" title="Permanent link">&para;</a></h1>
<p>In this module, will guide you through the process of building a multi-container
application using docker compose. The application code is available at GitHub: <a href="https://github.com/Cloud-Architects-Program/ycit019_2022">https://github.com/Cloud-Architects-Program/ycit019_2022</a></p>
<h2 id="41-deploy-guestbook-app-with-compose">4.1 Deploy Guestbook app with Compose<a class="headerlink" href="#41-deploy-guestbook-app-with-compose" title="Permanent link">&para;</a></h2>
<p>Let’s build another application. This time we going to create famous Guestbook
application.</p>
<p>Guestbook consists of three services. A redis-master node, a set of redis-slave
that can be scaled and find the redis-master via its DNS name. And a PHP frontend
that exposes itself on port 80. The resulting application allows you to leave
short messages which are stored in the redis cluster.</p>
<p><strong>Step 1</strong> Change directory to the guestbook</p>
<div class="codehilite"><pre><span></span><code>cd ~/ycit019_2022/Module6/guestbook/
ls
</code></pre></div>

<p><strong>Step 2</strong> Let’s review the docker-guestbook.yml file</p>
<div class="codehilite"><pre><span></span><code>version: &quot;2&quot;

services:
 redis-master:
   image: gcr.io/google_containers/redis:e2e
   ports:
     - &quot;6379&quot;
 redis-slave:
   image: gcr.io/google_samples/gb-redisslave:v1
   ports:
     - &quot;6379&quot;
   environment:
     - GET_HOSTS_FROM=dns
 frontend:
   image: gcr.io/google-samples/gb-frontend:v4
   ports:
     - &quot;80:80&quot;
   environment:
     - GET_HOSTS_FROM=dns
</code></pre></div>

<p><strong>Step 3</strong> Let’s run docker-guestbook.yml with compose</p>
<div class="codehilite"><pre><span></span><code>export LD_LIBRARY_PATH=/usr/local/lib
docker-compose -f docker-guestbook.yml up -d
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Creating network &quot;examples_default&quot; with the default driver
Creating examples_redis-slave_1
Creating examples_frontend_1
Creating examples_redis-master_1
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>-d</code> -  Detached mode: Run containers in the background, print new container names.</p>
<p><code>-f</code> -  Specify an alternate compose file (default: docker-compose.yml)</p>
</div>
<p><strong>Step 4</strong> Check that all containers are running:</p>
<div class="codehilite"><pre><span></span><code>docker ps
</code></pre></div>

<div class="codehilite"><pre><span></span><code>CONTAINER ID        IMAGE                                    COMMAND
d1006d1beee5        gcr.io/google-samples/gb-frontend:v4     &quot;apache2-foreground&quot;
fb3a15fde23f        gcr.io/google_containers/redis:e2e       &quot;redis-server /etc...&quot;
326b94d4cdd7        gcr.io/google_samples/gb-redisslave:v1   &quot;/entrypoint.sh /b...&quot;
</code></pre></div>

<p><strong>Step 5</strong>  Test the application locally</p>
<p>Now that we've launched the application containers, let's try to test the web
application locally.</p>
<p>You should be able to access the application at Google Cloud <code>Web Preview</code> Console:</p>
<p><img alt="alt text" src="../images/web_preview.png" title="Web Preview" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Web Preview using port <code>8080</code> by default. If you application using other port, you can edit this as needed.</p>
</div>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Nice you now have compose stuck up and running!</p>
</div>
<p><strong>Step 6</strong> Cleanup environment:</p>
<div class="codehilite"><pre><span></span><code>docker-compose -f docker-guestbook.yml down
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Stopping guestbook_frontend_1 ... done
Stopping guestbook_redis-master_1 ... done
Stopping guestbook_redis-slave_1 ... done
Removing guestbook_frontend_1 ... done
Removing guestbook_redis-master_1 ... done
Removing guestbook_redis-slave_1 ... done
Removing network guestbook_default
</code></pre></div>

<div class="admonition congratulations">
<p class="admonition-title">Congratulations</p>
<p>You are now docker expert!
We were able to start microservices application with docker compose.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've learned how to use docker-compose v2.</p>
<p>In the assignement you will be using docker-compose v3</p>
<p>Read the Docker-Compose <a href="https://docs.docker.com/compose/compose-file/">documentation</a> on new syntax.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>