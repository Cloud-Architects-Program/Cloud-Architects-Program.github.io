<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Module 9 Part 2 Lab Kubernetes Autoscaling - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Lab_3_Terraform_Fundamentals/" class="dropdown-item">Lab 3 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="../020_Lab_4_Traffic_control/" class="dropdown-item">Lab 4 Traffic Management</a>
</li>
            
<li>
    <a href="../020_Lab_5_EFK/" class="dropdown-item">Lab 5 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Lab 6 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Lab 6 Monitoring with GMP</a>
</li>
            
<li>
    <a href="../020_Lab_9_GitOps/" class="dropdown-item">Lab 9 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">Lab 10 Serverless Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Assignment_2_Production_GKE/" class="dropdown-item">Assignment2</a>
</li>
            
<li>
    <a href="../020_Assignment_3_Terraform_GCP_Foundation/" class="dropdown-item">Assignment3</a>
</li>
            
<li>
    <a href="../020_Assignment_4_Helm_Foundation/" class="dropdown-item">Assignmen4</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_Module_5_Lab_Docker_basics/" class="dropdown-item">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="../ycit019_Module_9_Kubernetes_Features/" class="dropdown-item">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="../ycit019_Lab_10_Networking/" class="dropdown-item">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../ycit019_Module_9_Kubernetes_Features/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ycit019_Lab_10_Networking/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#1-kubernetes-autoscaling" class="nav-link">1 Kubernetes Autoscaling</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#0-create-gke-cluster" class="nav-link">0 Create GKE Cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#11-resource-and-limits" class="nav-link">1.1 Resource and Limits</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#12-creating-a-horizontal-pod-autoscaler-based-on-cpu-usage" class="nav-link">1.2 Creating a Horizontal Pod Autoscaler based on CPU usage</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#13-scale-size-of-pods-with-vertical-pod-autoscaling" class="nav-link">1.3 Scale size of pods with Vertical Pod Autoscaling</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#17-cleaning-up" class="nav-link">1.7 Cleaning Up</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="1-kubernetes-autoscaling">1 Kubernetes Autoscaling<a class="headerlink" href="#1-kubernetes-autoscaling" title="Permanent link">&para;</a></h1>
<p><strong>Objective</strong></p>
<ul>
<li>Resource &amp; Limits</li>
<li>Scheduling</li>
<li>HPA</li>
<li>VPA</li>
<li>Cluster Autoscaling</li>
<li>Node Auto provisioning (NAP)</li>
</ul>
<h2 id="0-create-gke-cluster">0 Create GKE Cluster<a class="headerlink" href="#0-create-gke-cluster" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<pre class="codehilite"><code>gcloud services enable container.googleapis.com
</code></pre>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<pre class="codehilite"><code>gcloud container clusters create k8s-scaling \
--zone us-central1-c \
--enable-vertical-pod-autoscaling \
--num-nodes 2
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME          LOCATION       MASTER_VERSION   MASTER_IP      MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS
k8s-scaling  us-central1-c  1.19.9-gke.1400  34.121.222.83  e2-medium     1.19.9-gke.1400  2          RUNNING
</code></pre>

<p><strong>Step 3</strong> Authenticate to the cluster.</p>
<pre class="codehilite"><code>gcloud container clusters get-credentials k8s-scaling --zone us-central1-c
</code></pre>

<h2 id="11-resource-and-limits">1.1 Resource and Limits<a class="headerlink" href="#11-resource-and-limits" title="Permanent link">&para;</a></h2>
<p><strong>Step 1:</strong> Inspecting a node’s capacity</p>
<pre class="codehilite"><code>kubectl describe nodes | grep -A15  Capacity:
</code></pre>

<p>The output shows two sets of amounts related to the available resources on the node: the node’s capacity and allocatable resources. The capacity represents the total resources of a node, which may not all be available to pods. Certain resources may be reserved for Kubernetes and/or system components. The Scheduler bases its decisions only on the allocatable resource amounts.</p>
<p><strong>Step 2:</strong> Show metrics for a given node</p>
<pre class="codehilite"><code>kubectl top nodes
kubectl top pods -n kube-system
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>CPU and Memory information is available for pods and node through the metrics API.</p>
</div>
<p><strong>Step 3</strong> Create a <code>deployment</code> <code>best_effort.yaml</code> as showed below.
This is regular deployment with  <code>resources</code> configured</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; best_effort.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubia
spec:
  selector:
    matchLabels:
      app: kubia
  replicas: 3
  template:
    metadata:
      name: kubia
      labels:
        app: kubia
    spec:
      containers:
      - image: luksa/kubia:v1
        name: nodejs
EOF
</code></pre>

<p><strong>Step 4</strong> Deploy application</p>
<pre class="codehilite"><code>kubectl create -f best_effort.yaml
</code></pre>

<p><strong>Step 5</strong> Verify what is the QOS for this pod:</p>
<pre class="codehilite"><code>kubectl describe pods  | grep QoS
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>If you don't specify request/limits K8s provides <code>Best Effort</code> QOS</p>
</div>
<p><strong>Step 6</strong> Cleanup</p>
<pre class="codehilite"><code>kubectl delete -f best_effort.yaml
</code></pre>

<p><strong>Step 7</strong> Create a <code>deployment</code> <code>guaranteed.yaml</code> as showed below.
This is regular deployment with  <code>resources</code> configured</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; guaranteed.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubia
spec:
  selector:
    matchLabels:
      app: kubia
  replicas: 3
  template:
    metadata:
      name: kubia
      labels:
        app: kubia
    spec:
      containers:
      - image: luksa/kubia:v1
        name: nodejs
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 100m
            memory: 200Mi
EOF
</code></pre>

<p><strong>Step 8</strong> Deploy application</p>
<pre class="codehilite"><code>kubectl create -f guaranteed.yaml
</code></pre>

<p><strong>Step 9</strong> Verify what is the QOS for this pod:</p>
<pre class="codehilite"><code>kubectl describe pods  | grep QoS
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>If you request = limits K8s provides <code>guaranteed</code> QOS</p>
</div>
<p><strong>Step 10</strong> Cleanup</p>
<pre class="codehilite"><code>kubectl delete -f guaranteed.yaml
</code></pre>

<p><strong>Step 11</strong> Create a <code>deployment</code> <code>burstable.yaml</code> as showed below.
This is regular deployment with  <code>resources</code> configured</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; burstable.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubia
spec:
  selector:
    matchLabels:
      app: kubia
  replicas: 3
  template:
    metadata:
      name: kubia
      labels:
        app: kubia
    spec:
      containers:
      - image: luksa/kubia:v1
        name: nodejs
        resources:
          requests:
            cpu: 3000
EOF
</code></pre>

<p><strong>Step 12</strong> Deploy application</p>
<pre class="codehilite"><code>kubectl create -f burstable.yaml
</code></pre>

<p><strong>Step 13</strong> Verify what is the QOS for this pod:</p>
<pre class="codehilite"><code>kubectl describe pods  | grep QoS
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>If you specify <code>request &gt; or &lt; limits</code>  K8s provides <code>Burstable</code> QOS</p>
</div>
<p><strong>Step 14</strong>  Check status of the Pods </p>
<pre class="codehilite"><code>kubectl get pods
</code></pre>

<div class="admonition pending">
<p class="admonition-title">Pending</p>
<p>Why the deployment failed ???</p>
</div>
<p><strong>Step 15</strong> Cleanup</p>
<pre class="codehilite"><code>kubectl delete -f burstable.yaml
</code></pre>

<h2 id="12-creating-a-horizontal-pod-autoscaler-based-on-cpu-usage">1.2 Creating a Horizontal Pod Autoscaler based on CPU usage<a class="headerlink" href="#12-creating-a-horizontal-pod-autoscaler-based-on-cpu-usage" title="Permanent link">&para;</a></h2>
<p>Prerequisites: Ensure metrics api is running in your cluster.</p>
<pre class="codehilite"><code>kubectl get pod -n kube-system
</code></pre>

<p>Check the status of <code>metrics-server-*****</code> pod status. It should be <code>Running</code></p>
<pre class="codehilite"><code>kubectl top nodes
kubectl top pods -n kube-system
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>CPU and Memory information is available for pods and node through the metrics API.</p>
</div>
<p>Let’s create a horizontal pod autoscaler now and configure it to scale pods
based on their CPU utilization.</p>
<p><strong>Step 1</strong> Create a <code>deployment.yaml</code> as showed below.
This is regular deployment with  <code>resources</code> configured</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF &gt; deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kubia
spec:
  selector:
    matchLabels:
      app: kubia
  replicas: 3
  template:
    metadata:
      name: kubia
      labels:
        app: kubia
    spec:
      containers:
      - image: luksa/kubia:v1
        name: nodejs
        resources:
          requests:
            cpu: 100m
EOF
</code></pre>

<p><strong>Step 2</strong> Deploy application</p>
<pre class="codehilite"><code>kubectl create -f deployment.yaml
</code></pre>

<p><strong>Step 3</strong> After creating the deployment, to enable horizontal autoscaling of its pods, you need to create a HorizontalPodAutoscaler (HPA) object and point it to the deployment.</p>
<pre class="codehilite"><code>kubectl autoscale deployment kubia --cpu-percent=30 --min=1 --max=5
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This creates the HPA object for us and sets the deployment called <code>kubia</code> as the scaling target. We’re setting the target CPU utilization of the pods to 30% and specifying the minimum and maximum number of replicas. The autoscaler will thus constantly keep adjusting the number of replicas to keep their CPU utilization around 30%, but it will never scale down to less than 1 or scale up to more than 5 replicas.</p>
</div>
<p><strong>Step 4</strong> Verify definition of the Horizontal Pod Autoscaler resource to gain a better understanding of it:</p>
<pre class="codehilite"><code>kubectl get hpa kubia -o yaml
</code></pre>

<p><strong>Result:</strong></p>
<pre class="codehilite"><code>apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
...
spec:
  maxReplicas: 5
  minReplicas: 1
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: kubia
  targetCPUUtilizationPercentage: 30
status:
  currentReplicas: 0
  desiredReplicas: 0
</code></pre>

<p><strong>Step 5</strong> Take a closer look at the HPA and notice that it is still not ready to do the autoscaling.</p>
<pre class="codehilite"><code>kubectl describe hpa kubia
</code></pre>

<p><strong>Results</strong></p>
<pre class="codehilite"><code>Events:
  Type     Reason                        Age                   From                       Message
  ----     ------                        ----                  ----                       -------
  Warning  FailedGetResourceMetric       2m29s                 horizontal-pod-autoscaler  unable to get metrics for resource cpu: no metrics returned from resource metrics API
  Warning  FailedComputeMetricsReplicas  2m29s                 horizontal-pod-autoscaler  failed to compute desired number of replicas based on listed metrics for Deployment/default/kubia: invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: unable to get metrics for resource cpu: no metrics returned from resource metrics API
  Warning  FailedGetResourceMetric       118s (x3 over 2m14s)  horizontal-pod-autoscaler  did not receive metrics for any ready pods
  Warning  FailedComputeMetricsReplicas  118s (x3 over 2m14s)  horizontal-pod-autoscaler  failed to compute desired number of replicas based on listed metrics for Deployment/default/kubia: invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: did not receive metrics for any ready pods
</code></pre>

<p>Given that historical data is not available yet, you will see the above in the events section.</p>
<p>Give it a minute or so and try again. Eventually, you will see the following in the <code>Events</code> section.</p>
<pre class="codehilite"><code>  Normal   SuccessfulRescale             41s                    horizontal-pod-autoscaler  New size: 1; reason: All metrics below target
</code></pre>

<p>If you take a look at the <code>kubia</code> deployment, you will see it was scaled down from 3 pods to 1 pod.</p>
<p><strong>Step 6</strong> Create a service</p>
<pre class="codehilite"><code>kubectl expose deployment kubia --port=80 --target-port=8080
</code></pre>

<p><strong>Step 7</strong> Start another terminal session and run:</p>
<pre class="codehilite"><code>watch -n 1 kubectl get hpa,deployment
</code></pre>

<p><strong>Step 8</strong> Generate load to the Application</p>
<pre class="codehilite"><code>kubectl run -it --rm --restart=Never loadgenerator --image=busybox \
-- sh -c &quot;while true; do wget -O - -q http://kubia.default; done&quot;
</code></pre>

<p><strong>Step 9</strong> Observe autoscaling
In the other terminal you will start noticing that the deployment is being scaled up.</p>
<p><strong>Step 10</strong> Terminate both sessions by pressing <code>Ctrl+c</code></p>
<h2 id="13-scale-size-of-pods-with-vertical-pod-autoscaling">1.3 Scale size of pods with Vertical Pod Autoscaling<a class="headerlink" href="#13-scale-size-of-pods-with-vertical-pod-autoscaling" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Verify that Vertical Pod Autoscaling has already been enabled on the cluster. We enabled VPA when we created the cluster, by using <code>--enable-vertical-pod-autoscaling</code>. This command can be handy if you want to check VPA on an existing cluster.</p>
<pre class="codehilite"><code>gcloud container clusters describe k8s-scaling --zone us-central1-c | grep ^verticalPodAutoscaling -A 1
</code></pre>

<p><strong>Step 2</strong> Apply the hello-server deployment to your cluster</p>
<pre class="codehilite"><code>kubectl create deployment hello-server --image=gcr.io/google-samples/hello-app:2.0
</code></pre>

<p><strong>Step 3</strong> Ensure the deployment was successfully created</p>
<pre class="codehilite"><code>kubectl get deployment hello-server
</code></pre>

<p><strong>Step 4</strong> Assign a CPU resource request of 100m to the deployment</p>
<pre class="codehilite"><code>kubectl set resources deployment hello-server --requests=cpu=100m
</code></pre>

<p><strong>Step 5</strong> Inspect the container specifics of the <code>hello-server</code> pods, find <code>Requests</code> section, and notice that this pod is currently requesting the 450m CPU we assigned.</p>
<pre class="codehilite"><code>kubectl describe pod hello-server | sed -n &quot;/Containers:$/,/Conditions:/p&quot;
</code></pre>

<p><strong>Output</strong></p>
<pre class="codehilite"><code>Containers:
  hello-app:
    Image:      gcr.io/google-samples/hello-app:2.0
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Requests:
      cpu:        100m
    Environment:  &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-rw2gr (ro)
Conditions:
Containers:
  hello-app:
    Container ID:   containerd://e9bb428186f5d6a6572e81a5c0a9c37118fd2855f22173aa791d8429f35169a6
    Image:          gcr.io/google-samples/hello-app:2.0
    Image ID:       gcr.io/google-samples/hello-app@sha256:37e5287945774f27b418ce567cd77f4bbc9ef44a1bcd1a2312369f31f9cce567
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Running
      Started:      Wed, 09 Jun 2021 11:34:15 +0000
    Ready:          True
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-rw2gr (ro)
Conditions:
</code></pre>

<p><strong>Step 6</strong> Create a manifest for you Vertical Pod Autoscale</p>
<pre class="codehilite"><code>cat &lt;&lt; EOF &gt; hello-vpa.yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: hello-server-vpa
spec:
  targetRef:
    apiVersion: &quot;apps/v1&quot;
    kind:       Deployment
    name:       hello-server
  updatePolicy:
    updateMode: &quot;Off&quot;
EOF
</code></pre>

<p><strong>Step 7</strong> Apply the manifest for <code>hello-vpa</code></p>
<pre class="codehilite"><code>kubectl apply -f hello-vpa.yaml
</code></pre>

<p><strong>Step 8</strong> Wait a minute, and then view the VerticalPodAutoscaler</p>
<pre class="codehilite"><code>kubectl describe vpa hello-server-vpa
</code></pre>

<p><strong>Step 9</strong> Locate the "Container Recommendations" at the end of the output from the <code>describe</code> command. If you don't see it, wait a little longer and try the previous command again. When it appears, you'll see several different recommendation types, each with values for CPU and memory:</p>
<ul>
<li>Lower Bound: this is the lower bound number VPA looks at for triggering a resize. If your pod utilization goes below this, VPA will delete the pod and scale it down.</li>
<li>Target: this is the value VPA will use when resizing the pod.</li>
<li>Uncapped Target: if no minimum or maximum capacity is assigned to the VPA, this will be the target utilization for VPA.</li>
<li>Upper Bound: this is the upper bound number VPA looks at for triggering a resize. If your pod utilization goes above this, VPA will delete the pod and scale it up.</li>
</ul>
<p>Notice that the VPA is recommending new values for CPU instead of what we set, and also giving you a suggested number for how much memory should be requested. We can at this point manually apply these suggestions, or allow VPA to apply them.</p>
<p><strong>Step 10</strong> Update the manifest to set the policy to Auto and apply the configuration</p>
<pre class="codehilite"><code>sed -i 's/Off/Auto/g' hello-vpa.yaml
kubectl apply -f hello-vpa.yaml
</code></pre>

<p>In order to resize a pod, Vertical Pod Autoscaler will need to delete that pod and recreate it with the new size. By default, to avoid downtime, VPA will not delete and resize the last active pod. Because of this, you will need at least 2 replicas to see VPA make any changes.</p>
<p><strong>Step 11</strong> Scale hello-server deployment to 2 replicas:</p>
<pre class="codehilite"><code>kubectl scale deployment hello-server --replicas=2
</code></pre>

<p><strong>Step 12</strong> Watch your pods</p>
<pre class="codehilite"><code>kubectl get pods -w
</code></pre>

<p><strong>Step 13</strong> The VPA should have resized your pods in the hello-server deployment. Inspect your pods:</p>
<pre class="codehilite"><code>kubectl describe pod hello-server | sed -n &quot;/Containers:$/,/Conditions:/p&quot;
</code></pre>

<h2 id="17-cleaning-up">1.7 Cleaning Up<a class="headerlink" href="#17-cleaning-up" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Delete the cluster</p>
<pre class="codehilite"><code>gcloud container clusters delete k8s-scaling
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
