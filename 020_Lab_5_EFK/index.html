<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Module 9 EFK Stack - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="dropdown-item">Module 2 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="../020_Lab_4_Traffic_control/" class="dropdown-item">Module 8 Traffic Management</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Module 9 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Module 10 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Module 10 Monitoring with GMP</a>
</li>
            
<li>
    <a href="../020_Lab_9_GitOps/" class="dropdown-item">Module 11 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">Module 12 SERVERLESS Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="dropdown-item">Module 2</a>
</li>
            
<li>
    <a href="../020_Module_3_Assignment_Production_GKE/" class="dropdown-item">Module 3</a>
</li>
            
<li>
    <a href="../020_Module_4_Assignment_Production_GKE/" class="dropdown-item">Module 4</a>
</li>
            
<li>
    <a href="../020_Module_6_Assignment_Helm_Foundation/" class="dropdown-item">Module 6</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_Module_5_Lab_Docker_basics/" class="dropdown-item">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="../ycit019_Module_9_Kubernetes_Features/" class="dropdown-item">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="dropdown-item">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="../ycit019_Lab_10_Networking/" class="dropdown-item">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../020_Lab_4_Traffic_control/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../020_Lab_6_Prometheus/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#lab-5-logging-with-efk-stack" class="nav-link">Lab 5 Logging with EFK Stack</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#0-create-regional-gke-cluster-on-gcp" class="nav-link">0 Create Regional GKE Cluster on GCP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#1-install-elasticsearch-kibana-fluentd-helm-charts" class="nav-link">1 Install Elasticsearch, Kibana, Fluentd Helm Charts</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-configure-kibana-and-create-index" class="nav-link">2 Configure Kibana and Create Index:</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3-deploy-onlineboutique-application" class="nav-link">3 Deploy onlineboutique application</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#4-observe-onlineboutique-logs" class="nav-link">4 Observe onlineboutique logs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#5-review-fluentd-configuration" class="nav-link">5 Review Fluentd configuration</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#6-configure-fluentd-to-specific-logs" class="nav-link">6 Configure Fluentd to specific logs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#7-cleanup" class="nav-link">7 Cleanup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lab-5-logging-with-efk-stack">Lab 5 Logging with EFK Stack<a class="headerlink" href="#lab-5-logging-with-efk-stack" title="Permanent link">&para;</a></h1>
<p>In a complicated distributed system such as Kubernetes, we will have different logs for different components, and extracting insights from logs can be a daunting task. The EFK stack (ElasticSearch, FluentD, Kibana) can help make this task easier.
In this Lab, we are going to deploy EFK stack.</p>
<p>Deploy <code>online-boutique</code> app that emits logs to stdout in JSON format.</p>
<p>We will then deploy Cloud Native FluentD logging agent and configure:</p>
<ul>
<li>
<p><strong>source</strong> directive (input) that will use logs from <code>/var/log/containers</code> folder (location used by docker daemon on a Kubernetes node to store stdout from running containers).  This events will be tailed read from text file using  <code>in_tail</code> <a href="https://docs.fluentd.org/input/tail">Input Plugin</a>. And parsed using <code>multi_format</code> plugin.</p>
</li>
<li>
<p><strong>filter</strong> directive that will use <a href="https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter">kubernetes metadata</a> plugin to add metadata to the log and parse all kubernetes logs in specific format.</p>
</li>
<li>
<p><strong>match</strong> directive (output) that will use <code>out_elasticsearch</code> Output Plugin and send all logs to ElasticSearch
under <code>fluentd-*</code> prefix.</p>
</li>
</ul>
<p><strong>Objective:</strong></p>
<ul>
<li>Install Elasticsearch and Kibanna</li>
<li>Deploy online boutique Application</li>
<li>Install and Configure FluentD</li>
<li>Configure ElastackSearch with FluentD</li>
</ul>
<h2 id="0-create-regional-gke-cluster-on-gcp">0 Create Regional GKE Cluster on GCP<a class="headerlink" href="#0-create-regional-gke-cluster-on-gcp" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<pre class="codehilite"><code>gcloud services enable container.googleapis.com
</code></pre>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<pre class="codehilite"><code>gcloud container clusters create k8s-efk-lab \
--region us-central1 \
--enable-ip-alias \
--enable-network-policy \
--num-nodes 1 \
--machine-type &quot;e2-standard-4&quot; \
--release-channel stable
</code></pre>

<pre class="codehilite"><code>gcloud container clusters get-credentials k8s-efk-lab --region us-central1
</code></pre>

<h2 id="1-install-elasticsearch-kibana-fluentd-helm-charts">1 Install Elasticsearch, Kibana, Fluentd Helm Charts<a class="headerlink" href="#1-install-elasticsearch-kibana-fluentd-helm-charts" title="Permanent link">&para;</a></h2>
<h3 id="11-elasticsearch-installation">1.1 Elasticsearch Installation<a class="headerlink" href="#11-elasticsearch-installation" title="Permanent link">&para;</a></h3>
<p>Create a new namespace for EFK stack:</p>
<pre class="codehilite"><code>kubectl create ns efk
</code></pre>

<p>Install Elasticsearch using Helm:</p>
<pre class="codehilite"><code>helm repo add elastic https://helm.elastic.co
helm install elasticsearch elastic/elasticsearch -n efk
</code></pre>

<p>Check the status of deployment:</p>
<pre class="codehilite"><code>kubectl get pods --namespace=efk -l app=elasticsearch-master -w
</code></pre>

<h3 id="12-kibana-installation">1.2 Kibana installation<a class="headerlink" href="#12-kibana-installation" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> Create custom Kibana configuration, that will allow to expose Kibana Dashboard:</p>
<pre class="codehilite"><code>cat &lt;&lt; EOF&gt;&gt; kibana_values.yaml
service:
  type: LoadBalancer
EOF
</code></pre>

<pre class="codehilite"><code>cat kibana_values.yaml  
</code></pre>

<p>Make sure values are correct</p>
<p><strong>Step 3:</strong> Deploy Kibana Ingress Charts with custom parameters in <code>efk</code> namespace:</p>
<pre class="codehilite"><code>helm install kibana elastic/kibana -n efk --values kibana_values.yaml
</code></pre>

<pre class="codehilite"><code>helm list -n efk
</code></pre>

<!-- 
Set up port forwarding for temporary access to Kibanna:


<pre class="codehilite"><code>kubectl port-forward deployment/kibana-kibana 5601 -n efk
</code></pre>



Access Kibana from your browser at `http://localhost:5601` or from cloud shell `Web Preview` (Make sure the port number matches)

For permanent access to Kibana, modify the service type form `ClusterIP` to `LoadBalancer`:


<pre class="codehilite"><code>kubectl patch svc kibana-kibana -p '{&quot;spec&quot;: {&quot;type&quot;: &quot;LoadBalancer&quot;}}'
</code></pre>


-->

<p>Access Kibana from your browser using <code>LoadBalancer</code> IP on port 5601:</p>
<pre class="codehilite"><code>kubectl get svc -n efk
</code></pre>

<h3 id="13-fluentd-installation">1.3 Fluentd installation<a class="headerlink" href="#13-fluentd-installation" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> Create custom Fluentd configuration, below snippet is updating existing <code>configmap</code> with some parameters:</p>
<pre class="codehilite"><code>cat &lt;&lt; EOF&gt;&gt; fluentd_values.yaml
fileConfigs:
# here we read the logs from Docker's containers and parse them
  01_sources.conf: |-
    ## logs from podman
    &lt;source&gt;
      @type tail
      @id in_tail_container_logs
      @label @KUBERNETES
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      &lt;parse&gt;
        @type multi_format
        &lt;pattern&gt;
          format json
          time_key time
          time_type string
          time_format &quot;%Y-%m-%dT%H:%M:%S.%NZ&quot;
          keep_time_key true
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format regexp
          expression /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr)( (.))? (?&lt;log&gt;.*)$/
          time_format '%Y-%m-%dT%H:%M:%S.%NZ'
          keep_time_key true
        &lt;/pattern&gt;
      &lt;/parse&gt;
      emit_unmatched_lines true
    &lt;/source&gt;

# we use kubernetes metadata plugin to add metadata to the log
  02_filters.conf: |-
    &lt;label @KUBERNETES&gt;
      &lt;match kubernetes.var.log.containers.fluentd**&gt;
        @type relabel
        @label @FLUENT_LOG
      &lt;/match&gt;

      # &lt;match kubernetes.var.log.containers.**_kube-system_**&gt;
      #   @type null
      #   @id ignore_kube_system_logs
      # &lt;/match&gt;

      &lt;filter kubernetes.**&gt;
        @type kubernetes_metadata
        @id filter_kube_metadata
        skip_labels false
        skip_container_metadata false
        skip_namespace_metadata true
        skip_master_url true
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @DISPATCH
      &lt;/match&gt;
    &lt;/label&gt;
 # We filtering what logs will be send
  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
# we send the logs to Elasticsearch
  04_outputs.conf: |-
    &lt;label @OUTPUT&gt;
      &lt;match **&gt;
        @type elasticsearch
        host &quot;elasticsearch-master&quot;
        port 9200
        path &quot;&quot;
        user elastic
        password changeme
      &lt;/match&gt;
    &lt;/label&gt;
EOF
</code></pre>

<p><strong>Step 2:</strong> Deploy <code>Fluentd</code> Chart with custom parameters in <code>efk</code> namespace:</p>
<p>Deploy <code>Fluentd</code> with Helm:</p>
<pre class="codehilite"><code>helm repo add fluent https://fluent.github.io/helm-charts
helm repo update
helm install fluentd fluent/fluentd -n efk --values fluentd_values.yaml
</code></pre>

<h2 id="2-configure-kibana-and-create-index">2 Configure Kibana and Create Index:<a class="headerlink" href="#2-configure-kibana-and-create-index" title="Permanent link">&para;</a></h2>
<p>Kibana requires an index pattern to access the Elasticsearch data that you want to explore.
An index pattern selects the data to use and allows you to define properties of the fields.</p>
<p>In our case we configured <code>fluentd</code> index, that should be populated at <code>Elasticsearch</code></p>
<p><strong>Step 1:</strong> Locate Kibana URL:</p>
<pre class="codehilite"><code>kubectl get svc -n efk
</code></pre>

<p><strong>Step 2:</strong> Launch the Kibana web interface:</p>
<pre class="codehilite"><code>loadbalancer_ip:5601
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You should see your Kibana interface</p>
</div>
<p><img alt="alt text" src="../images/kibana_validation.png" /></p>
<p><strong>Step 3:</strong> Update Kibana Configuration to support <code>time</code> Meta fields:</p>
<p>In UI Go to: Management - Stack Management:</p>
<p><img alt="alt text" src="../images/kibana_mgm.jpg" /></p>
<p><strong>Step 4:</strong> Then Kibana - Advanced Setting:</p>
<p><img alt="alt text" src="../images/kibana_advanced.png" /></p>
<p><strong>Step 5:</strong> Find field: <code>Meta fields</code>, and add <code>time</code> field as following:</p>
<p><img alt="alt text" src="../images/kibana_meta.jpg" /></p>
<p><strong>Step 7:</strong> Create an index pattern. </p>
<p>In UI  Click: Discover (under analytics)</p>
<p><img alt="alt text" src="../images/kibana_anal_discover.png" /></p>
<p><img alt="alt text" src="../images/kibana_discover.png" /></p>
<p>Click <code>Create Index Pattern</code> button.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>alternative path: <code>Management - Stack Management -&gt; Kibana Index Patterns</code></p>
</div>
<p><strong>Step 8:</strong> In <code>Create index pattern</code> window. Type inside <code>Index pattern name</code>: <code>fluentd*</code> as the index pattern name. More documentation can be found <a href="https://www.elastic.co/guide/en/kibana/7.14/index-patterns.html">here</a></p>
<p><img alt="alt text" src="../images/kibana_index.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Your index pattern matches 1 source</p>
</div>
<pre class="codehilite"><code>Click Next Step &gt;
</code></pre>

<p><strong>Step 9:</strong> Configure which field <code>Kibana</code> will use to filter log data by time. In the dropdown, select the <code>@time</code> field, and hit <code>Create index pattern</code>.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Our ElasticSearch and Kibana fully configured. You should be able now see some cluster logs in Kibana.</p>
</div>
<p><strong>Step 10:</strong> View Kibana Logs from our GKE cluster:</p>
<p>In UI  Click: Discover (under analytics)</p>
<pre class="codehilite"><code>In Query search field paste: `kubernetes.namespace_name: kube-system`
In Range field paste: Select last 15 minutes
Click Refresh
</code></pre>

<p><img alt="alt text" src="../images/kibana_query.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>you can see logs from <code>kube-system</code> namespace</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can save you Query for future use</p>
</div>
<h2 id="3-deploy-onlineboutique-application">3 Deploy onlineboutique application<a class="headerlink" href="#3-deploy-onlineboutique-application" title="Permanent link">&para;</a></h2>
<p>Deploy microservices application <code>onlineboutique</code>:</p>
<p>Create Namespace <code>onlineboutique</code></p>
<pre class="codehilite"><code>kubectl create ns onlineboutique
</code></pre>

<p>Deploy Microservice application</p>
<pre class="codehilite"><code>git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
cd microservices-demo
</code></pre>

<pre class="codehilite"><code>kubectl apply -f ./release/kubernetes-manifests.yaml -n onlineboutique
</code></pre>

<p>Verify Deployment:</p>
<pre class="codehilite"><code>kubectl get pods -n onlineboutique
</code></pre>

<h2 id="4-observe-onlineboutique-logs">4 Observe <code>onlineboutique</code> logs<a class="headerlink" href="#4-observe-onlineboutique-logs" title="Permanent link">&para;</a></h2>
<p><strong>Step 1:</strong> First let's review the logs using <code>kubectl logs</code> command locally on the cluster.
We going to check <code>paymentservice</code> pod logs</p>
<pre class="codehilite"><code>export PAYMENTSERVICE_POD=$(kubectl get pods -n onlineboutique | grep paymentservice |awk '{ print $1}')
kubectl logs $PAYMENTSERVICE_POD -n onlineboutique
</code></pre>

<p><strong>Step 2:</strong> Now let's review Kibana Logs from our GKE cluster on <code>onlineboutique</code> namespace:</p>
<pre class="codehilite"><code>In Query search field paste: `kubernetes.namespace_name: onlineboutique`
In Range field paste: Select last 15 minutes
Click Refresh
</code></pre>

<p><img alt="alt text" src="../images/kibana_query.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We can see all logs from <code>onlineboutique</code> namespace</p>
</div>
<p><strong>Step 2:</strong> Now let's review Kibana Logs from <code>paymentservice</code> pod only</p>
<p>echo $PAYMENTSERVICE_POD</p>
<pre class="codehilite"><code>In Query search field paste: `kubernetes.namespace_name: onlineboutique`
In Range field paste: Select last 15 minutes
Click Refresh
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Developers should not have access to Kubernetes CLI, however they can get access to Observability tools like Kibana to allow them troubleshooting!</p>
</div>
<h2 id="5-review-fluentd-configuration">5 Review <code>Fluentd</code> configuration<a class="headerlink" href="#5-review-fluentd-configuration" title="Permanent link">&para;</a></h2>
<p>In some cases, you want to filter logs from only your applications to be seen by your team. To achieve this, Fluentd should be configured to only intake specific logs so that no resources are wasted. </p>
<p>Review <code>sources</code> configuration:</p>
<pre class="codehilite"><code>kubectl get configmap -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 01_sources.conf
</code></pre>

<pre class="codehilite"><code>  01_sources.conf: |-
    &lt;source&gt;
      @type tail
      @id in_tail_container_logs
      @label @KUBERNETES
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      &lt;parse&gt;
        @type multi_format
        &lt;pattern&gt;
          format json
          time_key time
          time_type string
          time_format &quot;%Y-%m-%dT%H:%M:%S.%NZ&quot;
          keep_time_key false
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format regexp
          expression /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr)( (.))? (?&lt;log&gt;.*)$/
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>id</code>: A unique identifier to reference this source. This can be used for further filtering and routing of structured log data</p>
<p><code>type</code>: Inbuilt directive understood by fluentd. In this case, “tail” instructs fluentd to gather data by tailing logs from a given location. Another example is “http” which instructs fluentd to collect data by using GET on http endpoint. </p>
<p><code>path</code>: Specific to type “tail”. Instructs fluentd to collect all logs under /var/log/containers directory. This is the location used by docker daemon on a Kubernetes node to store stdout from running containers</p>
<p><code>pos_file</code>: Used as a checkpoint. In case the fluentd process restarts, it uses the position from this file to resume log data collection</p>
<p><code>tag</code>: A custom string for matching source to destination/filters. fluentd matches source/destination tags to route log data</p>
</div>
<p><strong>Step 2</strong> Review <code>Filter</code> configuration</p>
<pre class="codehilite"><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 03_dispatch.conf
</code></pre>

<pre class="codehilite"><code>  02_filters.conf: |-
    &lt;label @KUBERNETES&gt;
      &lt;match kubernetes.var.log.containers.fluentd**&gt;
        @type relabel
        @label @FLUENT_LOG
      &lt;/match&gt;


      &lt;filter kubernetes.**&gt;
        @type kubernetes_metadata
        @id filter_kube_metadata
        skip_labels false
        skip_container_metadata false
        skip_namespace_metadata true
        skip_master_url true
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @DISPATCH
      &lt;/match&gt;
</code></pre>

<p><strong>Step 3</strong> Review <code>Dispatch</code> configuration</p>
<pre class="codehilite"><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 03_dispatch.conf
</code></pre>

<pre class="codehilite"><code>  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre>

<p><strong>Step 4</strong> Review <code>Output Plugin</code> configuration</p>
<pre class="codehilite"><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A10 04_outputs.conf
</code></pre>

<pre class="codehilite"><code>  04_outputs.conf: |-
    &lt;label @OUTPUT&gt;
      &lt;match **&gt;
        @type elasticsearch
        host &quot;elasticsearch-master&quot;
        port 9200
        path &quot;&quot;
        user elastic
        password changeme
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>match</code>: tag indicates a destination. It is followed by a regular expression for matching the source. In this case, we want to capture all logs and send them to Elasticsearch, so simply use **</p>
<p><code>type</code>: Supported output plugin identifier. In this case, we are using ElasticSearch which is a built-in plugin of fluentd.</p>
<p><code>host/port</code>: ElasticSearch host/port. Credentials can be configured as well, but not shown here.</p>
</div>
<h2 id="6-configure-fluentd-to-specific-logs">6 Configure <code>Fluentd</code> to specific logs<a class="headerlink" href="#6-configure-fluentd-to-specific-logs" title="Permanent link">&para;</a></h2>
<p>Let's configure Fluentd to only send <code>onlineboutique</code> namespace logs to elasticsearch:</p>
<p><strong>Step 1:</strong> Modify helm <code>fluentd_values.yaml</code> values file for <code>03_dispatch.conf</code> config so that only log files that matches <code>onlineboutique</code> namespace is labeled to be sent:</p>
<pre class="codehilite"><code>cd ../
edit fluentd_values.yaml
</code></pre>

<p>Replace line under <code>03_dispatch.conf: |-</code> config:</p>
<pre class="codehilite"><code>&lt;match **&gt; # Send all logs
</code></pre>

<p>To: </p>
<pre class="codehilite"><code>&lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;
</code></pre>

<p>So it looks as following:</p>
<pre class="codehilite"><code>  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre>

<p><code>&lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;</code> will filter out logs with <code>_onlineboutique_</code>. This configuration will only relabel the logs that matches the configuration as <code>@OUTPUT</code>. As specified in <code>04_outputs.conf</code>, only logs labelled as <code>@OUTPUT</code> will be sent to elasticsearch. </p>
<p>Note that this is not the only way to configure fluentd to send one namespace's logs. </p>
<p><strong>Step 2:</strong> Install helm diff plugin</p>
<pre class="codehilite"><code>helm plugin install https://github.com/databus23/helm-diff
</code></pre>

<p><strong>Step 3:</strong> Verify diff</p>
<pre class="codehilite"><code>helm diff upgrade fluentd fluent/fluentd -n efk  --values fluentd_values.yaml
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>-       &lt;match **&gt;
+       &lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;
</code></pre>

<p><strong>Step 4:</strong> Update fluentd <code>configmap</code> via Helm Upgrade</p>
<pre class="codehilite"><code>helm upgrade fluentd fluent/fluentd -n efk  --values fluentd_values.yaml
</code></pre>

<p><strong>Step 5:</strong> Observe that fluentd stop sending logs for other namespaces than <code>_onlineboutique_</code></p>
<pre class="codehilite"><code>In Query search field paste: `kubernetes.namespace_name: kube-system`
In Range field paste: Select last 15 minute
Click Refresh
</code></pre>

<p><img alt="alt text" src="../images/kibana_query.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>No more <code>kube-system</code> logs send to the ElasticSearch and hence Kibana can't display them.
However we can see all historical logs!!! Prior we disabled the logging for all namespaces.</p>
</div>
<h2 id="7-cleanup">7 Cleanup<a class="headerlink" href="#7-cleanup" title="Permanent link">&para;</a></h2>
<p>Uninstall Helm Charts:</p>
<pre class="codehilite"><code>helm uninstall fluentd -n efk
helm uninstall kibana -n efk
helm uninstall elasticsearch -n efk
</code></pre>

<p>Delete GKE cluster:</p>
<pre class="codehilite"><code>gcloud container clusters delete k8s-efk-lab --region us-central1
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
