
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Deploy Applications on Kubernetes - Cloud Native University</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#deploy-applications-on-kubernetes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Native University" class="md-header__button md-logo" aria-label="Cloud Native University" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Native University
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Deploy Applications on Kubernetes
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Native University" class="md-nav__button md-logo" aria-label="Cloud Native University" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Native University
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        YCIT020
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_3_Terraform_Fundamentals/" class="md-nav__link">
        Lab 3 Terraform Fundamentals
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_4_Traffic_control/" class="md-nav__link">
        Lab 4 Traffic Management
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_5_EFK/" class="md-nav__link">
        Lab 5 EFK Stack
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_6_Prometheus/" class="md-nav__link">
        Lab 6 Monitoring with Prometheus
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_9_GitOps/" class="md-nav__link">
        Lab 9 GitOps with Flux
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Lab_10_cloudrun/" class="md-nav__link">
        Lab 10 Serverless Cloud Run
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_Production_GKE/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_2_sol_Production_GKE/" class="md-nav__link">
        Assignment2 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_3_sol_Terraform_GCP_Foundation/" class="md-nav__link">
        Assignment3 Sol
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_Helm_Foundation/" class="md-nav__link">
        Assignmen4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Assignment_4_sol_Helm_Foundation/" class="md-nav__link">
        Assignmen4 Sol
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        YCIT019
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_2_Docker_basics/" class="md-nav__link">
        Lab 2 Docker Basics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_3_Advanced_Docker/" class="md-nav__link">
        Lab 3 Advanced Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_4_Docker_Images/" class="md-nav__link">
        Lab 4 Managing Docker Images
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_5_Docker_Compose/" class="md-nav__link">
        Lab 5 Docker Compose
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_6_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Lab 6 Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_7_Kubernetes_Concepts/" class="md-nav__link">
        Lab 7 Kubernetes Concepts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_8_Kubernetes_Features/" class="md-nav__link">
        Lab 8 Kubernetes Features
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_9_Kubernetes_Scaling/" class="md-nav__link">
        Lab 9 Kubernetes Autoscaling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Lab 10 Kubernetes Networking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Lab 11 Kubernetes Storage
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Assignment1
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Assignment1 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Assignment2
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Assignment2 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Assignment3
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Assignment3 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4/" class="md-nav__link">
        Assignment4
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Assignment4 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5/" class="md-nav__link">
        Assignment5
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass5_solution/" class="md-nav__link">
        Assignment5 - Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6/" class="md-nav__link">
        Assignment6
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Assignment6 - Solution
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#31-externalize-web-application-configuration" class="md-nav__link">
    3.1 Externalize Web Application Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#32-build-new-docker-image-for-your-frontend-application" class="md-nav__link">
    3.2 Build new Docker image for your frontend application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#33-run-and-test-new-docker-image-locally" class="md-nav__link">
    3.3 Run and test new Docker image locally
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#34-publish-new-image" class="md-nav__link">
    3.4 Publish New Image
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#35-create-a-secret" class="md-nav__link">
    3.5 Create a Secret
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#36-create-a-volume-for-mysql" class="md-nav__link">
    3.6 Create a Volume for Mysql
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#36-create-mysql-deployment" class="md-nav__link">
    3.6 Create Mysql deployment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#35-create-configmap-and-resources-and-probes-to-mysql" class="md-nav__link">
    3.5 Create ConfigMap and Resources and Probes to MySQL
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="deploy-applications-on-kubernetes">Deploy Applications on Kubernetes<a class="headerlink" href="#deploy-applications-on-kubernetes" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Review process of creating K8s:<ul>
<li>Secrets</li>
<li>ConfigMaps</li>
<li>Persistent Volumes (PV)</li>
<li>Persisten Volume Claims (PVC)</li>
<li>Jobs</li>
<li>CronJobs</li>
<li>HPA</li>
</ul>
</li>
</ul>
<p>Externalize Web Application Configuration</p>
<h2 id="31-externalize-web-application-configuration">3.1 Externalize Web Application Configuration<a class="headerlink" href="#31-externalize-web-application-configuration" title="Permanent link">&para;</a></h2>
<p>Let’s make some minor modifications to the web application to externalize its configuration, and make it easier to manage and update at deployment time.</p>
<p><strong>Step 1:</strong> Move config file outside compiled application</p>
<p>First, let’s move the web application’s configuration into a folder outside the main compilation path</p>
<div class="codehilite"><pre><span></span><code>cd ~/k8scanada/
git pull
</code></pre></div>

<div class="codehilite"><pre><span></span><code>mkdir $HOME/k8scanada/Assignment3/gowebapp/config
cp $HOME/k8scanada/Assignment3/gowebapp/code/config/config.json \
$HOME/k8scanada/Assignment3/gowebapp/config
rm -rf $HOME/k8scanada/Assignment3/gowebapp/code/config/
</code></pre></div>

<p><strong>Step 2:</strong> Modify app to support setting DB password through environment
variable. Next, let’s make a minor modification to the Go application code to allow setting the DB password through an environment variable. This will make it easier to dynamically inject this value at deployment time.</p>
<p>Use a text editor to modify:</p>
<div class="codehilite"><pre><span></span><code>vim $HOME/k8scanada/Assignment3/gowebapp/code/vendor/app/shared/database/database.go
</code></pre></div>

<ul>
<li>Add an import for the <code>os</code> package at line 8. After making this change, your imports list will look like the following:</li>
</ul>
<div class="codehilite"><pre><span></span><code>import (
  &quot;encoding/json&quot;
  &quot;fmt&quot;
  &quot;log&quot;
  &quot;time&quot;
  &quot;os&quot;

  &quot;github.com/boltdb/bolt&quot;
  _ &quot;github.com/go-sql-driver/mysql&quot; // MySQL driver
  &quot;github.com/jmoiron/sqlx&quot;
  &quot;gopkg.in/mgo.v2&quot;
)
</code></pre></div>

<ul>
<li>Add the following code at line 89 after var err error :</li>
</ul>
<div class="codehilite"><pre><span></span><code>// Check for MySQL Password environment variable and update configuration if present
if os.Getenv(&quot;DB_PASSWORD&quot;) != &quot;&quot; {
    d.MySQL.Password = os.Getenv(&quot;DB_PASSWORD&quot;)
}
</code></pre></div>

<h2 id="32-build-new-docker-image-for-your-frontend-application">3.2 Build new Docker image for your frontend application<a class="headerlink" href="#32-build-new-docker-image-for-your-frontend-application" title="Permanent link">&para;</a></h2>
<p><strong>Step 1:</strong> Update Dockerfile for your frontend application</p>
<div class="codehilite"><pre><span></span><code>FROM golang:1.16.4

LABEL maintainer &quot;student@mcgill.ca&quot;
LABEL gowebapp &quot;v1&quot;

EXPOSE 80

ENV GO111MODULE=auto
ENV GOPATH=/go
ENV PASSWORD=rootpasswd

COPY /code $GOPATH/src/gowebapp/

WORKDIR $GOPATH/src/gowebapp/

RUN go get &amp;&amp; go install

VOLUME $GOPATH/src/gowebapp/config

ENTRYPOINT $GOPATH/bin/gowebapp
</code></pre></div>

<p>Step 2: Build updated <code>gowebapp</code> Docker image locally</p>
<div class="codehilite"><pre><span></span><code>cd $HOME/k8scanada/Assignment3/gowebapp/
</code></pre></div>

<p>Build the gowebapp image locally. Make sure to include “.“ at the end. Notice the new version label.</p>
<div class="codehilite"><pre><span></span><code>docker build -t gowebapp:v2 .
</code></pre></div>

<h2 id="33-run-and-test-new-docker-image-locally">3.3 Run and test new Docker image locally<a class="headerlink" href="#33-run-and-test-new-docker-image-locally" title="Permanent link">&para;</a></h2>
<p>Before deploying to Kubernetes, let’s test the updated gowebapp Docker image locally, to ensure that the frontend and backend containers run and integrate properly.</p>
<p><strong>Step 1:</strong> Launch frontend and backend containers</p>
<p>First, we launch the backend database container, using a previously created Docker image, as it will take a bit longer to startup, and the frontend container depends on it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Update user-name with command below with you docker-hub id</p>
</div>
<div class="codehilite"><pre><span></span><code>docker run --net gowebapp --name gowebapp-mysql --hostname \
gowebapp-mysql -d -e MYSQL_ROOT_PASSWORD=cloudops user-name/gowebapp-mysql:v1
</code></pre></div>

<p><strong>Step 2:</strong> Now launch a frontend container using the updated gowebapp image, mapping the container port 80 - where the web application is exposed - to port 30005 on the host machine. Notice how we're mapping a host volume into the container for configuration, and setting a container environment variable with the
MySQL DB password:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Update user-name with command below with you docker-hub id</p>
</div>
<div class="codehilite"><pre><span></span><code>docker run -p 30005:80 \
-v $HOME/k8scanada/Assignment3/gowebapp/config:/go/src/gowebapp/config \
-e DB_PASSWORD=cloudops --net gowebapp -d --name gowebapp \
--hostname gowebapp user-name/gowebapp:v2
</code></pre></div>

<p>Now that we’ve launched the application containers, let’s try to test the web application locally. You should be able to access the application at http://Public_IP:30005.</p>
<p><strong>Step 3:</strong> Create an account and login. Write something on your Notepad and save it. This will verify that the application is working and properly integrates with the backend database container.</p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>By externalizing application configuration, you have made it easier to manage and modify your application configuration at deployment time. This will be very helpful as we deploy our applications to Kubernetes</p>
</div>
<h2 id="34-publish-new-image">3.4 Publish New Image<a class="headerlink" href="#34-publish-new-image" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong>  We built the second version of gowebapp from the last exercise and
tested it locally. Now we can tag and push gowebapp:v2 to private repository.</p>
<div class="codehilite"><pre><span></span><code>docker tag gowebapp:v2 &lt;user-name&gt;/gowebapp:v2
docker push &lt;user-name&gt;/gowebapp:v2
</code></pre></div>

<h2 id="35-create-a-secret">3.5 Create a Secret<a class="headerlink" href="#35-create-a-secret" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Create a secret for the MySQL password</p>
<div class="codehilite"><pre><span></span><code>kind: Secret
apiVersion: v1
metadata:
  name: mysql
type: Opaque
data:
  password: cm9vdHBhc3N3ZA==
</code></pre></div>

<h2 id="36-create-a-volume-for-mysql">3.6 Create a Volume for Mysql<a class="headerlink" href="#36-create-a-volume-for-mysql" title="Permanent link">&para;</a></h2>
<p><strong>Step 1:</strong> Dynamically provisioning Persistent Volume</p>
<p>Define a Persistent Volume Claim object to use with MySQL in a file named pvc.yaml under
<code>$HOME/k8scanada/Assignment3/deploy</code>.</p>
<p>In this case, we are not explicitly defining a Persistent Volume (pv) object for this PVC to use.  This approach is more portable than explicitly defining and hard-wiring volume types.</p>
<p>Please see reference for PVC creation here:
https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims</p>
<div class="codehilite"><pre><span></span><code>cd $HOME/k8scanada/Assignment3/deploy
vim pvc.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysqlpvc
  labels:
    run: gowebapp-mysql
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
</code></pre></div>

<p><strong>Step 2:</strong> Create PVC object</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f pvc.yaml --record
</code></pre></div>

<p><strong>Step 3:</strong> View your PVC metadata</p>
<div class="codehilite"><pre><span></span><code>kubectl get pvc mysqlpvc
kubectl describe pv
</code></pre></div>

<h2 id="36-create-mysql-deployment">3.6 Create Mysql deployment<a class="headerlink" href="#36-create-mysql-deployment" title="Permanent link">&para;</a></h2>
<p>Create Mysql deployment using Secrets, liveness, readiness, resources, limits
and Persistent Volume.</p>
<p><strong>Step 1</strong>  Update <code>gowebapp-mysql-deployment.yaml</code> under
<code>$HOME/k8scanada/Assignment3/deploy</code></p>
<div class="codehilite"><pre><span></span><code>vim $HOME/k8scanada/Assignment3/deploy/gowebapp-mysql-deployment.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: gowebapp-mysql
  labels:
    run: gowebapp-mysql
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        run: gowebapp-mysql
    spec:
      containers:
      - env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql
              key: password
        image: archyufa/gowebapp-mysql:v1
        name: gowebapp-mysql
        ports:
        - containerPort: 3306
        livenessProbe:
          tcpSocket:
            port: 3306
          initialDelaySeconds: 30
          timeoutSeconds: 2
        readinessProbe:
          tcpSocket:
            port: 3306
          initialDelaySeconds: 25
          timeoutSeconds: 2
        resources:
          requests:
            cpu: 256m
            memory: 256Mi
          limits:
            cpu: 512m
            memory: 512Mi
        volumeMounts:
        - mountPath: /var/lib/mysql
          name: mysql
      volumes:
        - name: mysql
          persistentVolumeClaim:
            claimName: mysqlpvc
</code></pre></div>

<p><strong>Step 2</strong>  Start the rolling upgrade and record the command used in the rollout history:</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f gowebapp-mysql-deployment.yaml --record
</code></pre></div>

<p><strong>Step 3</strong> Verify that rollout was successful</p>
<div class="codehilite"><pre><span></span><code>kubectl rollout status deploy gowebapp-mysql
</code></pre></div>

<p><strong>Step 4</strong> Get rollout history</p>
<div class="codehilite"><pre><span></span><code>kubectl rollout history deploy gowebapp-mysql
</code></pre></div>

<p><strong>Step 5</strong> Get rollout history</p>
<div class="codehilite"><pre><span></span><code>kubectl rollout history deploy gowebapp-mysql
</code></pre></div>

<p><strong>Step 6</strong>  Get rollout history details for specific revision (use number show in output to previous command) Notice the value for MYSQL_ROOT_PASSWORD</p>
<div class="codehilite"><pre><span></span><code>kubectl rollout history deploy gowebapp-mysql \
--revision=&lt;latest_version_number&gt;
</code></pre></div>

<h2 id="35-create-configmap-and-resources-and-probes-to-mysql">3.5 Create ConfigMap and Resources and Probes to MySQL<a class="headerlink" href="#35-create-configmap-and-resources-and-probes-to-mysql" title="Permanent link">&para;</a></h2>
<p><strong>Step 1:</strong> create ConfigMap for gowebapp's config.json file</p>
<div class="codehilite"><pre><span></span><code>kubectl create configmap gowebapp --from-file=webapp-config-json=/home/cca-user/k8scanada/Assignment3/gowebapp/config/config.json
kubectl describe configmap gowebapp
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The entire file contents from config.json are stored under the key <code>webapp-config-json</code></p>
</div>
<p><strong>Step 2:</strong> Update <code>gowebapp-deployment.yaml</code> under <code>/home/cca-user/k8scanada/Assignment3/deploy</code></p>
<p>In this exercise, we will add liveness/readiness probes to our deployments, as well as resource limits. For more information, see here:
https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/
https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/</p>
<div class="codehilite"><pre><span></span><code>apiVersion: apps/v1
kind: Deployment
metadata:
   name: gowebapp
   labels:
     run: gowebapp
spec:
   replicas: 2
   selector:
     matchLabels:
       run: gowebapp
   template:
     metadata:
       labels:
         run: gowebapp
     spec:
       containers:
       - env:
         - name: DB_PASSWORD
           valueFrom:
             secretKeyRef:
               name: mysql
              key: password
         image: &lt;#TODO_user-name&gt;/gowebapp:v1
         name: gowebapp
         ports:
           - containerPort: 80
         livenessProbe:
           httpGet:
             path: /register
             port: 80
           initialDelaySeconds: 15
           timeoutSeconds: 5
         readinessProbe:
           httpGet:
             path: /register
             port: 80
           initialDelaySeconds: 25
           timeoutSeconds: 5
         resources:
           request:
             cpu: 200m
             memory: 128Mi
           limits:
             cpu: 250m
             memory: 256Mi
         volumeMounts:
           - name: config-volume
             mountPath: /go/src/gowebapp/config
       volumes:
       - name: config-volume
         configMap:
           name: gowebapp
           items:
           - key: webapp-config-json
             path: config.json
</code></pre></div>

<div class="codehilite"><pre><span></span><code> kubectl apply -f gowebapp-deployment.yaml --record
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>This will start the rolling upgrade and record the command used in the rollout history</p>
</div>
<p><strong>Step 3:</strong> Verify that rollout was successful</p>
<div class="codehilite"><pre><span></span><code>kubectl rollout status deploy gowebapp
</code></pre></div>

<p><strong>Step 4:</strong> Get rollout history</p>
<div class="codehilite"><pre><span></span><code>kubectl rollout history deploy gowebapp
</code></pre></div>

<p><strong>Step 5:</strong> Get rollout history details for specific revision (use number show in output to previous command)</p>
<div class="codehilite"><pre><span></span><code>kubectl rollout history deploy gowebapp --revision=&lt;latest_version_number
</code></pre></div>

<p><strong>Step 6:</strong> Access your application: &lt;http://VM_Public_IP:NodePort. Register for
an account, login and use the Notepad.</p>
<p>If you need to lookup the VM_Public_IP for your environment, use the
 following command:</p>
<p><code>kubectl get svc gowebapp -o wide</code></p>
<p>## 3.6 Define a Job to purge data from the web application database</p>
<p>Create a Job object definition in a file called reset-db.yaml which connects to the MySQL database and deletes all the data from the note and user tables. Replace the TODOs below with the missing elements of
the definition. If you need more help, refer to:
https://kubernetes.io/docs/concepts/workloads/controllers/jobs-run-to-completion</p>
<p><strong>Step 1:</strong> Create job <code>reset-db.yaml</code> under <code>/home/cca-user/k8scanada/Assignment3/deploy</code></p>
<div class="codehilite"><pre><span></span><code>vim reset-db.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>apVersion: batch/v1
kind: Job
metadata:
  name: reset-db
  labels:
    run: reset-db
spec:
  activeDeadlineSeconds: 10
  template:
    metadata:
      name: reset-db
    spec:
      restartPolicy: OnFailure
      containers:
      - name: database-cleaner
        image: mysql:5.6
        env:
        - name: DB_USER
          value: root
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql
              key: password
        - name: DB_HOST
          value: gowebapp-mysql
        - name: DB
          value: gowebapp
        command:
        - /bin/sh
        args:
        - -c
        - mysql -h $(DB_HOST) -u $(DB_USER) -p$(DB_PASSWORD) $(DB) -e &#39;delete from note; delete from user;&#39;
</code></pre></div>

<p><strong>Step 2:</strong>  Create the Job in Kubernetes</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f reset-db.yaml --record
</code></pre></div>

<p><strong>Step 3:</strong>  View Job metadata and status
The job should run and complete immediately.</p>
<div class="codehilite"><pre><span></span><code>kubectl get job reset-db
kubectl describe job reset-db
</code></pre></div>

<p><strong>Step 4:</strong> Verify that data has been deleted
Open the web application at http://Public_IP:NodePort and verify that the accounts and notes you created above no longer exist.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>