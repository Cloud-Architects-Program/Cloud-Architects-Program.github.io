<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Module 5 Lab - Docker Basics - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="dropdown-item">Module 2 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="../020_Lab_4_Traffic_control/" class="dropdown-item">Module 8 Traffic Management</a>
</li>
            
<li>
    <a href="../020_Lab_5_EFK/" class="dropdown-item">Module 9 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Module 10 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Module 10 Monitoring with GMP</a>
</li>
            
<li>
    <a href="../020_Lab_9_GitOps/" class="dropdown-item">Module 11 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">Module 12 SERVERless Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="dropdown-item">Module 2</a>
</li>
            
<li>
    <a href="../020_Module_3_Assignment_Production_GKE/" class="dropdown-item">Module 3</a>
</li>
            
<li>
    <a href="../020_Module_4_Assignment_Production_GKE/" class="dropdown-item">Module 4</a>
</li>
            
<li>
    <a href="../020_Module_6_Assignment_Helm_Foundation/" class="dropdown-item">Module 6</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="../ycit019_Module_9_Kubernetes_Features/" class="dropdown-item">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="dropdown-item">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="../ycit019_Lab_10_Networking/" class="dropdown-item">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../020_Module_6_Assignment_Helm_Foundation/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ycit019_Module_6_Lab_Advanced_Docker/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#module-5-lab-docker-basics" class="nav-link">Module 5 Lab Docker basics</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#1-setup-environment-and-install-docker" class="nav-link">1 Setup Environment and Install Docker</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-working-with-docker-cli" class="nav-link">2 Working with Docker CLI</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3-building-images-with-dockerfile" class="nav-link">3 Building Images with DockerFile</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#4-docker-networking" class="nav-link">4 Docker Networking</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="module-5-lab-docker-basics">Module 5 Lab Docker basics<a class="headerlink" href="#module-5-lab-docker-basics" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Practice to run Docker containers</li>
<li>Learn to build docker images using Dockerfiles</li>
<li>Learn Docker Networking</li>
</ul>
<h2 id="1-setup-environment-and-install-docker">1 Setup Environment and Install Docker<a class="headerlink" href="#1-setup-environment-and-install-docker" title="Permanent link">&para;</a></h2>
<h3 id="11-create-an-instance-with-gcloud">1.1 Create an instance with gcloud<a class="headerlink" href="#11-create-an-instance-with-gcloud" title="Permanent link">&para;</a></h3>
<p>Rather than using the Google Cloud Console to create a virtual machine instance, you can use the command line tool <code>gcloud</code>, which is pre-installed in <a href="https://cloud.google.com/developer-shell/#how_do_i_get_started">Google Cloud Shell</a>. Cloud Shell is a Debian-based virtual machine loaded with all the development tools you’ll need (gcloud, git, and others) and offers a persistent 5GB home directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to try this on your own machine in the future, read the <a href="https://cloud.google.com/sdk/gcloud/">gcloud command line</a> tool guide.</p>
</div>
<p>Open the Google Cloud Shell by clicking on the icon on the top right of the screen:</p>
<p><img alt="alt text" src="../images/cloud_shell.png" title="Google Cloud Shell" /></p>
<p>Once opened, you can create a new virtual machine instance from the command line by using <code>gcloud</code> (feel free to use another zone closer to you):</p>
<p><strong>Step 1</strong> Create a new virtual machine instance on GCE</p>
<pre class="codehilite"><code>gcloud config set project &lt;set_you_project_id&gt;
</code></pre>

<pre class="codehilite"><code>gcloud compute instances create docker-nginx --zone us-central1-c
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Created [...docker-nginx].
NAME     ZONE           MACHINE_TYPE  PREEMPTIBLE INTERNAL_IP EXTERNAL_IP    STATUS
docker-nginx  us-central1-c  n1-standard-1             10.240.X.X  X.X.X.X        RUNNING
</code></pre>

<p>The instance created has these default values:
- The latest Debian 10 (buster) image.
- The n1-standard-1 machine type.
- A root persistent disk with the same name as the instance; the disk is automatically attached to the instance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can set the default region and zones that <code>gcloud</code> uses if you are always working within one region/zone and you don’t want to append the --<code>zone</code> flag every time. Do this by running these commands:</p>
<p><code>gcloud config set compute/zone ...
gcloud config set compute/region ...</code></p>
</div>
<p><strong>Step 2</strong> SSH into your instance using <code>gcloud</code> as well. </p>
<pre class="codehilite"><code>gcloud compute ssh docker-nginx --zone us-central1-c
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>WARNING: The public SSH key file for gcloud does not exist.
WARNING: The private SSH key file for gcloud does not exist.
WARNING: You do not have an SSH key for gcloud.
WARNING: [/usr/bin/ssh-keygen] will be executed to generate a key.
This tool needs to create the directory 
[/home/gcpstaging306_student/.ssh] before being able to generate SSH 
Keys.
</code></pre>

<p>Now you’ll type <code>Y</code> to continue.</p>
<pre class="codehilite"><code>Do you want to continue? (Y/n)
</code></pre>

<p><strong>Enter</strong> through the passphrase section to leave the passphrase empty. </p>
<pre class="codehilite"><code>Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase)
</code></pre>

<h3 id="12-install-docker-engine">1.2 Install Docker Engine<a class="headerlink" href="#12-install-docker-engine" title="Permanent link">&para;</a></h3>
<p>We need to first set up the Docker repository. To set up the repository:</p>
<p><strong>Step 1</strong> Update the <code>apt</code> package index:</p>
<pre class="codehilite"><code>sudo apt-get update
</code></pre>

<p><strong>Step 2</strong> Then install packages to allow “apt” to use a repository over HTTPS:</p>
<pre class="codehilite"><code>sudo apt-get install \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release
</code></pre>

<p><strong>Step 3</strong>  Add Docker’s official GPG key:</p>
<pre class="codehilite"><code>curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
</code></pre>

<p><strong>Step 4</strong> Set up the stable repository</p>
<pre class="codehilite"><code>echo \
  &quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \
  $(lsb_release -cs) stable&quot; | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</code></pre>

<p><strong>Step 5</strong> Install Docker Engine:</p>
<pre class="codehilite"><code>sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io
</code></pre>

<p><strong>Step 6</strong> Verify Docker Version has been deployed:</p>
<pre class="codehilite"><code>docker version
</code></pre>

<p>Verify what is the latest Docker <a href="https://docs.docker.com/engine/release-notes/">release</a></p>
<p><strong>Step 6</strong> Confirm that your installation was successful by running Hello World! Container.</p>
<pre class="codehilite"><code>sudo docker run hello-world
</code></pre>

<p><strong>Step 7</strong> If it is successful, you will see the following output:</p>
<pre class="codehilite"><code>Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
b8dfde127a29: Pull complete
Digest: sha256:f2266cbfc127c960fd30e76b7c792dc23b588c0db76233517e1891a4e357d519
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.
</code></pre>

<p><strong>Step 8</strong>  Exit from <code>VM</code></p>
<pre class="codehilite"><code>exit
</code></pre>

<p><strong>Step 9</strong>  Delete <code>VM Instance</code> to avoid extra cost:</p>
<pre class="codehilite"><code>gcloud compute instances delete docker-nginx --zone us-central1-c
</code></pre>

<p>Now you’ll type <code>Y</code> to continue.</p>
<pre class="codehilite"><code>Do you want to continue? (Y/n)
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Now you know how to deploy Docker on Linux VM. </p>
</div>
<div class="admonition task">
<p class="admonition-title">Task</p>
<p>Find out how to deploy Docker on Mac or Windows?</p>
</div>
<h2 id="2-working-with-docker-cli">2 Working with Docker CLI<a class="headerlink" href="#2-working-with-docker-cli" title="Permanent link">&para;</a></h2>
<h3 id="21-show-running-containers">2.1 Show running containers<a class="headerlink" href="#21-show-running-containers" title="Permanent link">&para;</a></h3>
<p>Going forward we going to run Docker commands directly from Google Cloud Console.
This is possible because Docker is installed on Cloud Console VM for you convenience.</p>
<p>Open the Google Cloud Shell by clicking on the icon on the top right of the screen:</p>
<p><img alt="alt text" src="../images/cloud_shell.png" title="Google Cloud Shell" /></p>
<p>Once opened, you can use it to run the instructions for this lab.</p>
<p><strong>Step 1</strong> Create a docker container <code>hello-world</code>:</p>
<pre class="codehilite"><code>docker run hello-world
</code></pre>

<p><strong>Step 2</strong> Run docker ps to show running containers:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>The output shows that there are no running containers at the moment.</p>
</div>
<p><strong>Step 2</strong> Use the command docker <code>ps -a</code> to list all containers including the ones has
been stopped:</p>
<pre class="codehilite"><code>docker ps -a
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>CONTAINER ID IMAGE       COMMAND  CREATED        STATUS             PORTS  NAMES
6e6db2a24a8e hello-world &quot;/hello&quot; 15 minutes ago Exited (0) 15 min  dreamy_nobel
</code></pre>

<p>Review the collumns <code>CONTAINER ID</code>, <code>STATUS</code>, <code>COMMAND</code>, <code>PORTS</code>, <code>NAMES</code>.</p>
<p>In the previous section we started one container and the command docker <code>ps -a</code>
shows it as <code>Exited</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can name your own containers with --name when you use docker run. If
you do not provide a name, Docker will generate a random one like the one
you have.</p>
</div>
<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Why Docker names are random? How docker containers named?</p>
</div>
<p><strong>Step 3</strong> Let’s run the command <code>docker images</code> to show all the images on your
local system:</p>
<pre class="codehilite"><code>docker images
</code></pre>

<p>As you see, there is only one image that was downloaded from the Docker Hub.</p>
<h3 id="23-specify-a-container-main-process">2.3 Specify a container main process<a class="headerlink" href="#23-specify-a-container-main-process" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Let’s run our own "hello world" container. For that we will use the
official <a href="https://hub.docker.com/_/ubuntu/">Ubuntu image</a>:</p>
<pre class="codehilite"><code>docker run ubuntu /bin/echo 'Hello world'
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Unable to find image 'ubuntu:latest' locally
latest: Pulling from library/ubuntu
...
Status: Downloaded newer image for ubuntu:latest
Hello world
</code></pre>

<p>As you see, Docker downloaded the image ubuntu because it was not on the local
machine.</p>
<p><strong>Step 2</strong> Let’s run the command <code>docker images</code> again:</p>
<pre class="codehilite"><code>docker images
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>REPOSITORY          TAG                 IMAGE ID            CREATED        SIZE
ubuntu              latest              42118e3df429        11 days ago  124.8 MB
hello-world         latest              c54a2cc56cbb        4 weeks ago  1.848 kB
</code></pre>

<p><strong>Step 3</strong> If you run the same "hello world" container again, Docker will use a
local copy of the image:</p>
<pre class="codehilite"><code>docker run ubuntu /bin/echo 'Hello world'
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Hello world
</code></pre>

<div class="admonition question">
<p class="admonition-title">Question</p>
<p>Compare Ubuntu Docker image with ISO image or with Cloud VM image.</p>
<ul>
<li>Why the size is so different ?</li>
</ul>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Pulling docker images from Docker Hub takes sometime. This time depends on:</p>
<ul>
<li>How large is the image?</li>
<li>How fast is the network to Internet ?</li>
</ul>
<p>However, it is still much faster than booting traditional OS with Ubuntu
on VM.</p>
<p>If image already pulled on local host it takes fraction of a second to start
a container.</p>
<p>Running application in docker containers considered as a best practice
for running CI/CD pipelines as it considerably faster than using VMs and
reduce time for deploying a test environments.</p>
</div>
<h3 id="23-specify-an-image-version">2.3 Specify an image version<a class="headerlink" href="#23-specify-an-image-version" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> As you see, Docker has downloaded the ubuntu:latest image. You can
see Ubuntu version by running the following command:</p>
<pre class="codehilite"><code>docker run ubuntu /bin/cat /etc/issue.net
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Ubuntu 22.04 LTS
</code></pre>

<p>Let’s say you need a previous Ubuntu LTS release. In this case, you can specify
the version you need:</p>
<pre class="codehilite"><code>docker run ubuntu:14.04 /bin/cat /etc/issue.net
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Unable to find image 'ubuntu:14.04' locally
14.04: Pulling from library/ubuntu
...
Status: Downloaded newer image for ubuntu:14.04
Ubuntu 14.04.4 LTS
</code></pre>

<p><strong>Step 2</strong> The <code>docker images</code> command should show that we have 3 Ubuntu
images downloaded locally:</p>
<pre class="codehilite"><code>docker images
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              latest              42118e3df429        11 days ago         124.8 MB
ubuntu              14.04               0ccb13bf1954        11 days ago         188 MB
hello-world         latest              c54a2cc56cbb        4 weeks ago         1.848 kB
</code></pre>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Running CI/CD pipeline with Docker using <code>latest</code> tag
considered as a Bad Practice.</p>
<p>Instead consider using:</p>
<ul>
<li>Versioning</li>
<li><code>SHA</code> tagging.</li>
</ul>
</div>
<h3 id="24-run-an-interactive-container">2.4 Run an interactive container<a class="headerlink" href="#24-run-an-interactive-container" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Let’s use the <code>ubuntu</code> image to run an <em>interactive</em> bash session and
inspect what is running inside our docker image.</p>
<p>To achive that we going to use  <code>-i</code> and <code>-t</code> flags.</p>
<p>The  <code>-i</code> is shorthand for <code>--interactive</code>, which instructs Docker to keep
<code>stdin</code> open so that we can send commands to the sprocess.</p>
<p>The <code>-t</code> flag is short for <code>--tty</code> and allocates a <code>pseudo-TTY</code> or terminal
inside of the session.</p>
<pre class="codehilite"><code>docker run -it ubuntu /bin/bash
root@17d8bdeda98e:/#
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We get a  bash shell prompt inside of the container.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Bash prompt is not availabe for all docker images.</p>
</div>
<p><strong>Step 2</strong> Let's print the system information of the latest <code>Ubuntu</code> image:</p>
<pre class="codehilite"><code>root@17d8bdeda98e:/#  uname -a
Linux 17d8bdeda98e 3.19.0-31-generic ...
</code></pre>

<p><strong>Step 3</strong> Let's verify what Ubuntu version is run by <code>latest</code> image of ubuntu:</p>
<pre class="codehilite"><code>root@17d8bdeda98e:/#  lsb_release -a
bash: lsb_release: command not found
</code></pre>

<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Why the standard Ubuntu command that checks version of OS is not working as
expeced ?</p>
</div>
<p><strong>Step 4</strong> Let's verify Ubuntu version using alternative way by checking
<code>/etc/lsb-release</code> file.</p>
<pre class="codehilite"><code>root@8cbcbd0fe8d2:/# cat /etc/lsb-release
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=16.04
DISTRIB_CODENAME=xenial
DISTRIB_DESCRIPTION=&quot;Ubuntu 16.04.3 LTS&quot;
</code></pre>

<p><strong>Step 5</strong> Let's compare the number of executable binaries availabe inside of
the docker image versus Cloud VM that we running our class environment. First,
run <code>ls</code> command on  <code>/bin</code> and <code>/usr/bin</code> directories inside of the running
ubuntu container as well as <code>dpkg --list</code> command that shows total number of
installed packages:</p>
<pre class="codehilite"><code>root@8cbcbd0fe8d2:/# ls /bin | wc -l
294
root@8cbcbd0fe8d2:/# ls /usr/bin | wc -l
xx
root@eb11cd0b4106:/# dpkg --list | wc -l
xx
</code></pre>

<p><strong>Step 6</strong> Use the <code>exit</code> command or press <code>Ctrl-D</code> to exit the interactive
bash session back to Cloud VM.</p>
<pre class="codehilite"><code>root@eb11cd0b4106:/# exit
</code></pre>

<p><strong>Step 7</strong> Now run <code>ls</code> command on <code>/bin</code> and <code>/usr/bin</code> directories on Cloud VM
that we using as our class environment:</p>
<pre class="codehilite"><code>cca-user@userx-docker-vm:~$ ls /bin | wc -l
1173
cca-user@userx-docker-vm:~$ ls /usr/bin | wc -l
660
cca-user@userx-docker-vm:~$ dpkg --list | wc -l
463
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Official Docker container has much less binaries and packages installed vs
Ubuntu Cloud Image.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Some of the use cases running docker containers in <code>interactive mode</code> are:</p>
<ul>
<li>Troubleshooting containerized applications</li>
<li>Deploying and running containerized application on the existing
production systems without affecting it.</li>
</ul>
<p>We've also learned that an official Docker "minimal" ubuntu image, does not
include <code>lsb_release</code> command, as well as many other commands and packages
that can be found in <a href="https://www.ubuntu.com/download/server">Official Ubuntu ISO image</a>.
The docker images are ment to contain only required <em>core system</em> commands
and functions to make Images as light as possible.
That say you can still install required packages using <code>apt-get install</code>,
however this may increase size of docker image considerably.</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>While Docker <code>Ubuntu</code> image we used so far or Docker <code>Centos</code> image are
very familiar to users and can be good starting point for learning docker
containers. Using them in production or development considered as a Bad
Practice.</p>
<p>This is due those images still considered as <code>heavy</code> and potentially
contain a lot more valnurabilities compare to specialized images.</p>
<p>To reduce image pull time from docker hub and follow the best secuirity
practices consider using specialized images that works well with you
underlining code (Node image for NodeJS applications and etc.).
Examples of specialized images are:</p>
<ul>
<li>Alpine Linux</li>
<li>Node</li>
<li>Atomic</li>
</ul>
<p>In fact, not so long ago all the <a href="https://github.com/docker-library/official-images/tree/master/library">official Docker Images</a>
in Docker-Hub <a href="https://www.brianchristner.io/docker-is-moving-to-alpine-linux/">has been moved</a>
to use <a href="https://www.alpinelinux.org/">Alpine Image</a>.</p>
</div>
<p><strong>Step 8</strong> Finally let’s check that when the shell process has finished, the
container stops:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<h3 id="25-run-a-container-in-a-background">2.5 Run a container in a background<a class="headerlink" href="#25-run-a-container-in-a-background" title="Permanent link">&para;</a></h3>
<p>Now we know how to connect to running container and execute commands in it.
However in most cases you just want run a container in a <em>background</em> so it can
do a specific action.</p>
<p><strong>Step 1</strong> Run a container in a background using the <code>-d</code> command line argument:</p>
<pre class="codehilite"><code>docker run -d ubuntu /bin/sh -c &quot;while true; do date; echo hello world; sleep 1; done&quot;
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Command should return the container ID.</p>
</div>
<p><strong>Step 2</strong> Let’s use the <code>docker ps</code> command to see running containers:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<pre class="codehilite"><code> CONTAINER ID IMAGE  COMMAND                  CREATED        STATUS  PORTS NAMES
ac231579e57f ubuntu &quot;/bin/sh -c 'while tr&quot;   1 minute ago   Up 11 minute  evil_golick
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Container id is going to  be different in your case</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Instead of using full <code>container-id</code> when building commands, it is possible
simply type first few characters of container-id, to make things nice and
easy.</p>
</div>
<p><strong>Step 3</strong> Let’s use <code>container-id</code> to show the container standard output:</p>
<pre class="codehilite"><code>docker logs &lt;container-id&gt;
</code></pre>

<pre class="codehilite"><code>Thu Jan 26 00:23:45 UTC 2017
hello world
Thu Jan 26 00:23:46 UTC 2017
hello world
Thu Jan 26 00:23:47 UTC 2017
hello world
...
</code></pre>

<p>As you can see, in the <code>docker ps</code> command output, the auto generated container
name is <code>evil_golick</code> (your container can have a different name).</p>
<p><strong>Step 4</strong> Now, instead of using docker <code>contaier-id</code> use container name to
show the container standard output:</p>
<pre class="codehilite"><code>docker logs &lt;name&gt;
</code></pre>

<pre class="codehilite"><code>Thu Jan 26 00:23:51 UTC 2017
hello world
Thu Jan 26 00:23:52 UTC 2017
hello world
Thu Jan 26 00:23:53 UTC 2017
hello world
...
</code></pre>

<p><strong>Step 5</strong> Finally, let’s stop our container:</p>
<pre class="codehilite"><code>docker stop &lt;name&gt;
</code></pre>

<p><strong>Step 6</strong> Check, that there are no running containers:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p><code>docker logs</code> is a very usefull command to troubleshoot containers,
and going to be used very often both for Docker and Kubernertes
troubleshooting.</p>
</div>
<h3 id="26-accessing-containers-from-the-internet">2.6 Accessing Containers from the Internet<a class="headerlink" href="#26-accessing-containers-from-the-internet" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Let’s run a simple web application. We will use the existing image
training/webapp, which contains a Python Flask application:</p>
<pre class="codehilite"><code>docker run -d -P training/webapp python app.py
</code></pre>

<pre class="codehilite"><code>...
Status: Downloaded newer image for training/webapp:latest
6e88f42d3d853762edcbfe1fe73fdc5c48865275bc6df759b83b0939d5bd2456
</code></pre>

<p>In the command above we specified the main process (python app.py), the <code>-d</code>
command line argument, which tells Docker to run the container in the
background. The <code>-P</code> command line argument tells Docker to map any required
network ports inside our container to our host. This allows us to access the web
application in the container.</p>
<p><strong>Step 2</strong> Use the <code>docker ps</code> command to list running containers:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<pre class="codehilite"><code>CONTAINER ID IMAGE           COMMAND         CREATED       STATUS       PORTS                   NAMES
6e88f42d3d85 training/webapp &quot;python app.py&quot; 3 minutes ago Up 3 minutes 0.0.0.0:32768-&gt;5000/tcp determined_torvalds
</code></pre>

<p>The PORTS column contains the mapped ports. In our case, Docker has exposed port
5000 (the default Python Flask port) on port 32768 (can be different in your
case).</p>
<p><strong>Step 3</strong> The <code>docker port</code> command shows the exposed port. We will use the
container name (determined_torvalds in the example above, it can be different in
your case):</p>
<pre class="codehilite"><code>docker port &lt;name&gt; 5000
0.0.0.0:32768
</code></pre>

<p><strong>Step 4</strong> Let’s check that we can access the web application exposed port:</p>
<pre class="codehilite"><code>curl http://localhost:&lt;port&gt;/
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p><code>Hello world!</code></p>
</div>
<p><strong>Step 5</strong> Let’s stop our web application for now:</p>
<pre class="codehilite"><code>docker stop &lt;name&gt;
</code></pre>

<p><strong>Step 6</strong> We want to manually specify the local port to expose (-p argument).
Let’s use the standard HTTP port 8080. We also want to specify the container name
(--name argument):</p>
<pre class="codehilite"><code>docker run -d -p 8080:5000 --name webapp training/webapp python app.py
</code></pre>

<p><strong>Step 7</strong> Let’s check that the port 8080 is exposed:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<pre class="codehilite"><code>CONTAINER ID IMAGE           COMMAND         CREATED       STATUS       PORTS                NAMES
249476631f7d training/webapp &quot;python app.py&quot; 1 minute  ago Up 1 minute  0.0.0.0:80-&gt;5000/tcp webapp
</code></pre>

<pre class="codehilite"><code>curl http://localhost/
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p><code>Hello world!</code></p>
</div>
<p><strong>Step 4</strong> Now that we've launched the application containers, let's try to test the web
application locally.</p>
<p>You should be able to access the application at Google Cloud <code>Web Preview</code> Console:</p>
<p><img alt="alt text" src="../images/web_preview.png" title="Web Preview" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Web Preview using port <code>8080</code> by default. If you application using other port, you can edit this as needed.</p>
</div>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Our web-app can be accessed from Internet!</p>
</div>
<h3 id="27-restart-a-container">2.7 Restart a container<a class="headerlink" href="#27-restart-a-container" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Let’s stop the container with web application:</p>
<pre class="codehilite"><code>docker stop webapp
</code></pre>

<p>The main process inside of the container will receive SIGTERM, and after a grace
period, SIGKILL.</p>
<p><strong>Step 2</strong> You can start the container later using the <code>docker start</code> command:</p>
<pre class="codehilite"><code>docker start webapp
</code></pre>

<p><strong>Step 3</strong> Check that the web application works:</p>
<p><img alt="alt text" src="../images/web_preview.png" title="Web Preview" /></p>
<p><strong>Step 4</strong> You also can restart the running container using the docker restart
command.</p>
<pre class="codehilite"><code>docker restart webapp
</code></pre>

<p><strong>Step 4</strong>  Run <code>docker ps</code> command and check  <code>STATUS</code> field:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<pre class="codehilite"><code>CONTAINER ID    IMAGE             COMMAND           CREATED           STATUS              
6e400179070f    training/webapp   &quot;python app.py&quot;   25 minutes ago    Up 3 seconds
</code></pre>

<h3 id="28-ensuring-container-uptime">2.8 Ensuring Container Uptime<a class="headerlink" href="#28-ensuring-container-uptime" title="Permanent link">&para;</a></h3>
<p>Docker considers any containers to exit with a non-zero exit code to have
crashed. By default a crashed container will remain stopped.</p>
<p><strong>Step 1</strong> Start the container that outputs a message and then exits with code 1
to simulate a crash.</p>
<pre class="codehilite"><code>docker run -d --name restart-default scrapbook/docker-restart-example
</code></pre>

<pre class="codehilite"><code>docker ps -a | grep restart-default
</code></pre>

<pre class="codehilite"><code>CONTAINER ID  IMAGE                             CREATED       STATUS               NAMES
c854289d2f39  scrapbook/docker-restart-example  5 seconds ago Exited 3 sec ago    restart-default
$ docker logs restart-default
Sun Sep 17 20:34:55 UTC 2017 Booting up...
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Container crushed and exited.</p>
</div>
<p>However, there are several ways to ensure that you container up and running even
if it’s restarts.</p>
<p><strong>Step 2</strong> The option <code>--restart=on-failure</code>: allows you to say how many times
Docker should try again:</p>
<pre class="codehilite"><code>docker run -d --name restart-3 --restart=on-failure:3 scrapbook/docker-restart-example
</code></pre>

<pre class="codehilite"><code>docker logs restart-3
</code></pre>

<pre class="codehilite"><code>Thu Apr 20 14:01:27 UTC 2017 Booting up...
Thu Apr 20 14:01:28 UTC 2017 Booting up...
Thu Apr 20 14:01:29 UTC 2017 Booting up...
Thu Apr 20 14:01:31 UTC 2017 Booting up...
</code></pre>

<p><strong>Step 3</strong> Finally, Docker can always restart a failed container. In this case,
Docker will keep trying until the container is explicitly told to stop.</p>
<pre class="codehilite"><code>docker run -d --name restart-always --restart=always scrapbook/docker-restart-example
docker logs restart-always
</code></pre>

<p><strong>Step 4</strong>  After sometime stop running docker container, as it will be keep
failing and starting again:</p>
<pre class="codehilite"><code>docker stop restart-always
</code></pre>

<h3 id="29-inspect-a-container">2.9 Inspect a container<a class="headerlink" href="#29-inspect-a-container" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> You can use the <code>docker inspect</code> command to see the configuration and
status information for the specified container:</p>
<pre class="codehilite"><code>docker inspect webapp
</code></pre>

<pre class="codehilite"><code>[
    {
        &quot;Id&quot;: &quot;249476631f7d...&quot;,
        &quot;Created&quot;: &quot;2016-08-02T23:42:56.932135327Z&quot;,
        &quot;Path&quot;: &quot;python&quot;,
        &quot;Args&quot;: [
            &quot;app.py&quot;
        ],
        &quot;State&quot;: {
            &quot;Status&quot;: &quot;running&quot;,
            &quot;Running&quot;: true,
            &quot;Paused&quot;: false,
            &quot;Restarting&quot;: false,
            &quot;OOMKilled&quot;: false,
            &quot;Dead&quot;: false,
            &quot;Pid&quot;: 16055,
            &quot;ExitCode&quot;: 0,
            &quot;Error&quot;: &quot;&quot;,
            ...
</code></pre>

<p><strong>Step 2</strong> You can specify a filter (-f command line argument) to show only
specific elements. For example:</p>
<pre class="codehilite"><code>docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' webapp
</code></pre>

<pre class="codehilite"><code>172.17.0.2
</code></pre>

<p>The command returns the IP address of the container.</p>
<h3 id="210-interacting-with-containers">2.10 Interacting with containers<a class="headerlink" href="#210-interacting-with-containers" title="Permanent link">&para;</a></h3>
<p>In some cases using <code>docker log</code> is not enough to undertand issues and you
want to login inside of running VM. Also sometimes you package you applicaiton
and in order to run it you need to login inside of container and execute and
leave it running in background. Below provded few ways to interacting with
containers that can help to achive descrined use cases.</p>
<h3 id="2101-detach-from-interactive-container">2.10.1 Detach from Interactive container<a class="headerlink" href="#2101-detach-from-interactive-container" title="Permanent link">&para;</a></h3>
<p>In Module, <code>1.4 Run an interactive container</code> we run an <code>Ubuntu</code> container with
<code>-it</code> flag and able directly login inside of the container to interact with it,
however after we exited contianer using <code>Ctrl-D</code> or <code>exit</code> command container
stopped. However you can exit from <code>Interactive mode</code> without stoping
a container. Let's demonstrate how this works:</p>
<p><strong>Step 1</strong> Start Ubunu container in interactive  mode:</p>
<pre class="codehilite"><code>docker run -it ubuntu /bin/bash
</code></pre>

<p><strong>Step 2</strong> Run <code>watch date</code> command inside running container in order to exit
<code>date</code> command every 2 seconds.</p>
<pre class="codehilite"><code>root@1d688a9f4ed4:/# watch date
</code></pre>

<p><strong>Step 3</strong> Detach from a container and leave it running using the
<code>CTRL-p</code> <code>CTRL-q</code> key sequence.</p>
<p><strong>Step 4</strong> Verify that Ubuntu container is still running:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<pre class="codehilite"><code>CONTAINER ID  IMAGE   COMMAND      CREATED        STATUS        NAMES
1d688a9f4ed4  ubuntu  &quot;/bin/bash&quot;  1 minutes ago  Up 1 minutes  admiring_lovelace
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Great you were able to detach from Docker container without stopping it,
while it is executing a process in it.
What about attaching back to container ?</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code>CTRL-p</code> <code>CTRL-q</code>  sequence key only works if docker contaienr started
with <code>-it</code> command!</p>
</div>
<h3 id="2112-attach-to-a-container">2.11.2 Attach to a container<a class="headerlink" href="#2112-attach-to-a-container" title="Permanent link">&para;</a></h3>
<p>Now let's get back and <code>attach</code> to our running Ubuntu image. For that
docker provides <code>docker attach</code> command.</p>
<pre class="codehilite"><code>docker attach &lt;container name&gt;
</code></pre>

<pre class="codehilite"><code>Every 2.0s: date                                                                                                                    Mon Sep 18 00:08:57 2017
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p><code>docker attach</code> attaches your contairs terminal’s standard input, output,
and error (or any combination of the 3) to a running container. This allows
you to view its ongoing output or to control it interactively, as though
the commands were running directly in your terminal.</p>
</div>
<h3 id="2113-execute-a-process-in-a-container">2.11.3 Execute a process in a container<a class="headerlink" href="#2113-execute-a-process-in-a-container" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Let verify if webapp container is still running</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<pre class="codehilite"><code>CONTAINER ID IMAGE           COMMAND         CREATED       STATUS       PORTS                NAMES
249476631f7d training/webapp &quot;python app.py&quot; 1 minute  ago Up 1 minute  0.0.0.0:80-&gt;5000/tcp webapp
</code></pre>

<p>If not running start it with following command: <code>$ docker run -d -p 80:5000 --name webapp training/webapp python app.py</code>
other wise skip to <strong>next step</strong>.</p>
<p><strong>Step 2</strong> Use the docker exec command to execute a command in the running
container. For example:</p>
<pre class="codehilite"><code>docker exec webapp ps aux
</code></pre>

<pre class="codehilite"><code>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.2  0.0  52320 17384 ?        Ss   00:11   0:00 python app.py
root        26  0.0  0.0  15572  2104 ?        Rs   00:12   0:00 ps aux
</code></pre>

<p>The same command with the <code>-it</code> command line argument can be used to run an
interactive session in the container:</p>
<pre class="codehilite"><code>docker exec -it webapp bash
root@249476631f7d:/opt/webapp# ps auxw
ps auxw
</code></pre>

<pre class="codehilite"><code>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0  52320 17384 ?        Ss   00:11   0:00 python app.py
root        32  0.0  0.0  18144  3064 ?        Ss   00:14   0:00 bash
root        47  0.0  0.0  15572  2076 ?        R+   00:16   0:00 ps auxw
</code></pre>

<p><strong>Step 2</strong> Use the <code>exit</code> command or press <code>Ctrl-D</code> to exit the interactive bash
session:</p>
<pre class="codehilite"><code>root@249476631f7d:/opt/webapp# exit
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p><code>docker exec</code> is one of the most usefull docker commands used for
troubleshooting containers.</p>
</div>
<h3 id="212-copy-files-tofrom-container">2.12 Copy files to/from container<a class="headerlink" href="#212-copy-files-tofrom-container" title="Permanent link">&para;</a></h3>
<p>The <code>docker cp</code> command allows you to copy files from the container to the local
machine or from the local file system to the container. This command works for
a running or stopped container.</p>
<p><strong>Step 1</strong> Let’s copy the container’s app.py file to the local machine:</p>
<pre class="codehilite"><code>docker cp webapp:/opt/webapp/app.py .
</code></pre>

<p><strong>Step 2</strong> Edit the local app.py file. For example, change the line return
'Hello '+provider+'!' to return 'Hello '+provider+'!!!'. Copy the modified file
back and restart the container:</p>
<pre class="codehilite"><code>docker cp app.py webapp:/opt/webapp/

docker restart webapp
</code></pre>

<p><strong>Step 3</strong> Check that the modified web application works::</p>
<pre class="codehilite"><code>curl http://localhost/
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>`Hello world!!!``</p>
</div>
<h3 id="212-remove-containers">2.12 Remove containers<a class="headerlink" href="#212-remove-containers" title="Permanent link">&para;</a></h3>
<p>Now let's clean up the environment and at the same time learn how delete
containers.</p>
<p>Step 1 First list running containers:</p>
<pre class="codehilite"><code>docker ps
</code></pre>

<pre class="codehilite"><code>CONTAINER ID IMAGE           COMMAND         CREATED       STATUS       PORTS                NAMES
81c4c66baaf9 training/webapp &quot;python app.py&quot; 1 minute  ago Up 1 minute  0.0.0.0:80-&gt;5000/tcp webapp
</code></pre>

<p>Step 2 Than try to delete running container using <code>docker rm &lt;container_id&gt;</code></p>
<pre class="codehilite"><code>docker rm $container_id
</code></pre>

<pre class="codehilite"><code>Error response from daemon: You cannot remove a running container 81c4c66baaf9. Stop the container before attempting removal or force remove.
</code></pre>

<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Docker containers needs to be first stopped or deleted using <code>--force</code> flag.</p>
</div>
<pre class="codehilite"><code>docker rm $container_id -f
</code></pre>

<p>Alternatively, you can run <code>stop</code> and <code>rm</code> in sequence:</p>
<pre class="codehilite"><code>docker stop 81c4c66baaf9
docker rm 81c4c66baaf9
</code></pre>

<h2 id="3-building-images-with-dockerfile">3 Building Images with DockerFile<a class="headerlink" href="#3-building-images-with-dockerfile" title="Permanent link">&para;</a></h2>
<p>In the previous modules, we learned how to use Docker images
to run Docker containers. Docker images that we used have been downloaded from
the Docker Hub, a Docker image registry maintained by Docker Inc. In this section we will create a
simple web application from scratch. We will use Flask
(<a href="http://flask.pocoo.org/">http://flask.pocoo.org/</a>), a microframework for
Python. Our application for each request will display a random picture from the
defined set.</p>
<p>The code for this application is also available in GitHub:</p>
<pre class="codehilite"><code>https://github.com/Cloud-Architects-Program/ycit019_2022/tree/main/Module5/flask-app
</code></pre>

<h3 id="31-overview-dockerfile-creation">3.1 Overview DOCKERFILE Creation<a class="headerlink" href="#31-overview-dockerfile-creation" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Clone git repo on you laptop:</p>
<pre class="codehilite"><code>git clone https://github.com/Cloud-Architects-Program/ycit019_2022
cd ~/ycit019/Module5/flask-app/
</code></pre>

<p><strong>Step 2</strong> In this directory, we see following files:</p>
<pre class="codehilite"><code>flask-app/
    Dockerfile
    app.py
    requirements.txt
    templates/
        index.html
</code></pre>

<p><strong>Step 3</strong> Let’s review file app.py with the following content:</p>
<pre class="codehilite"><code class="language-python">from flask import Flask, render_template
import random

app = Flask(__name__)

# list of cat images
images = [
    &quot;https://media.giphy.com/media/mlvseq9yvZhba/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/13CoXDiaCcCoyk/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/LtVXu5s7KwlK8/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/PekRU0CYIpXS8/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/11quO2C07Sh2oM/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/12HZukMBlutpoQ/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/1HKaikaFqDt7i/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/v6aOjy0Qo1fIA/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/12bjQ7uASAaCKk/giphy.gif&quot;,
    &quot;https://media.giphy.com/media/HFcl9uhuCqzGU/giphy.gif&quot;
]

@app.route('/')
def index():
    url = random.choice(images)
    return render_template('index.html', url=url)

if __name__ == &quot;__main__&quot;:
    app.run(host=&quot;0.0.0.0&quot;)
</code></pre>

<p><strong>Step 4</strong> Below is the content of requirements.txt file:</p>
<pre class="codehilite"><code>Flask==2.0.0
</code></pre>

<p><strong>Step 5</strong> Under directory templates observe index.html with the following
content:</p>
<pre class="codehilite"><code class="language-html">&lt;html&gt;
  &lt;head&gt;
    &lt;style type=&quot;text/css&quot;&gt;
      body {
        background: black;
        color: white;
      }
      div.container {
        max-width: 500px;
        margin: 100px auto;
        border: 20px solid white;
        padding: 10px;
        text-align: center;
      }
      h4 {
        text-transform: uppercase;
      }
    &lt;/style&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div class=&quot;container&quot;&gt;
      &lt;h4&gt;Cat Gif of the day&lt;/h4&gt;
      &lt;img src=&quot;{{url}}&quot; /&gt;
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p><strong>Step 6</strong> Let’s review content of the Dockerfile:</p>
<pre class="codehilite"><code class="language-docker"># Official Python Alpine Base image using Simple Tags
# Image contains Python 3 and pip pre-installed, so no need to install them

FROM python:3.9.5-alpine3.12

# Specify Working directory
WORKDIR /usr/src/app

# COPY requirements.txt /usr/src/app/
COPY requirements.txt ./

# Install Python Flask used by the Python app
RUN pip install --no-cache-dir -r requirements.txt

# Copy files required for the app to run
COPY app.py ./
COPY templates/index.html ./templates/

# Make a record that the port number the container should be expose is:
EXPOSE 5000

# run the application
CMD [&quot;python&quot;, &quot;./app.py&quot;]
</code></pre>

<h3 id="32-build-a-docker-image">3.2 Build a Docker image<a class="headerlink" href="#32-build-a-docker-image" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Now let’s build our Docker image. In the command below, replace
<user-name> with your user name. This user name should be the same as you
created when you registered on Docker Hub.</p>
<pre class="codehilite"><code>docker build -t &lt;user-name&gt;/myfirstapp .
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Image has been buit </p>
</div>
<p><strong>Step 2</strong> Where is your built image? It’s in your machine’s local Docker image
registry, you can check that your image exists with command below:</p>
<pre class="codehilite"><code>docker images
</code></pre>

<p><strong>Step 3</strong> Now run a container in a background and expose a standard HTTP port
(80), which is redirected to the container’s port 5000:</p>
<pre class="codehilite"><code>docker run -dp 8080:5000 --name myfirstapp &lt;user-name&gt;/myfirstapp
</code></pre>

<p><strong>Step 4</strong> Now that we've launched the application containers, let's try to test the web
application locally.</p>
<p>You should be able to access the application at Google Cloud <code>Web Preview</code> Console:</p>
<p><img alt="alt text" src="../images/web_preview.png" title="Web Preview" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Web Preview using port <code>8080</code> by default. If you application using other port, you can edit this as needed.</p>
</div>
<p><strong>Step 5</strong> Stop the container and remove it:</p>
<pre class="codehilite"><code>docker rm -f myfirstapp
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've learned a lot of docker commands which are very handy to know both
when using Docker and Kubernetes. Next we will learn how to create Docker networks.</p>
</div>
<h2 id="4-docker-networking">4 Docker Networking<a class="headerlink" href="#4-docker-networking" title="Permanent link">&para;</a></h2>
<h3 id="41-docker-networking-basics">4.1 Docker Networking Basics<a class="headerlink" href="#41-docker-networking-basics" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> The Docker Network Command
The <code>docker network</code> command is the main command for configuring and managing container networks. Run the <code>docker network</code> command from the first terminal.</p>
<pre class="codehilite"><code class="language-term1">docker network
</code></pre>

<pre class="codehilite"><code>Usage:  docker network COMMAND

Manage networks

Options:
      --help   Print usage

Commands:
  connect     Connect a container to a network
  create      Create a network
  disconnect  Disconnect a container from a network
  inspect     Display detailed information on one or more networks
  ls          List networks
  prune       Remove all unused networks
  rm          Remove one or more networks

Run 'docker network COMMAND --help' for more information on a command.
</code></pre>

<p>The command output shows how to use the command as well as all of the <code>docker
network</code> sub-commands. As you can see from the output, the <code>docker network</code>
command allows you to create new networks, list existing networks, inspect
networks, and remove networks. It also allows you to connect and disconnect
containers from networks.</p>
<p><strong>Step 2</strong> Run a <code>docker network ls</code> command to view existing container networks
on the current Docker host.</p>
<pre class="codehilite"><code class="language-term1">docker network ls
</code></pre>

<pre class="codehilite"><code>NETWORK ID          NAME                DRIVER              SCOPE
3430ad6f20bf        bridge              bridge              local
a7449465c379        host                host                local
06c349b9cc77        none                null                local
</code></pre>

<p>The output above shows the container networks that are created as part of a
standard installation of Docker.</p>
<p>New networks that you create will also show up in the output of the
<code>docker network ls</code> command.</p>
<p>You can see that each network gets a unique <code>ID</code> and <code>NAME</code>. Each network is
also associated with a single driver. Notice that the "bridge" network and the
"host" network have the same name as their respective drivers.</p>
<p><strong>Step 3:</strong> The <code>docker network inspect</code> command is used to view network
configuration details. These details include; name, ID, driver, IPAM driver,
subnet info, connected containers, and more.</p>
<p>Use <code>docker network inspect &lt;network&gt;</code> to view configuration details of the
container networks on your Docker host. The command below shows the details of
the network called <code>bridge</code>.</p>
<pre class="codehilite"><code class="language-term1">docker network inspect bridge
</code></pre>

<pre class="codehilite"><code>[
    {
        &quot;Name&quot;: &quot;bridge&quot;,
        &quot;Id&quot;: &quot;3430ad6f20bf1486df2e5f64ddc93cc4ff95d81f59b6baea8a510ad500df2e57&quot;,
        &quot;Created&quot;: &quot;2017-04-03T16:49:58.6536278Z&quot;,
        &quot;Scope&quot;: &quot;local&quot;,
        &quot;Driver&quot;: &quot;bridge&quot;,
        &quot;EnableIPv6&quot;: false,
        &quot;IPAM&quot;: {
            &quot;Driver&quot;: &quot;default&quot;,
            &quot;Options&quot;: null,
            &quot;Config&quot;: [
                {
                    &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,
                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;
                }
            ]
        },
        &quot;Internal&quot;: false,
        &quot;Attachable&quot;: false,
        &quot;Containers&quot;: {},
        &quot;Options&quot;: {
            &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,
            &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,
            &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,
            &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,
            &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,
            &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;
        },
        &quot;Labels&quot;: {}
    }
]
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The syntax of the <code>docker network inspect</code> command is <code>docker network
inspect &lt;network&gt;</code>, where <code>&lt;network&gt;</code> can be either network name or
network ID. In the example above we are showing the configuration details
for the network called "bridge". Do not confuse this with the "bridge"
driver.</p>
</div>
<p><strong>Step 4</strong> Now, list Docker supported network driver plugins. For that run
<code>docker info</code> command, that  shows a lot of interesting information about a
Docker installation.</p>
<p>Run the <code>docker info</code> command and locate the list of network plugins.</p>
<pre class="codehilite"><code class="language-term1">docker info
</code></pre>

<pre class="codehilite"><code>Containers: 0
 Running: 0
 Paused: 0
 Stopped: 0
Images: 0
Server Version: 17.03.1-ee-3
Storage Driver: aufs
&lt;Snip&gt;
Plugins:
 Volume: local
 Network: bridge host macvlan null overlay
Swarm: inactive
Runtimes: runc
&lt;Snip&gt;
</code></pre>

<p>The output above shows the <strong>bridge</strong>, <strong>host</strong>,<strong>macvlan</strong>, <strong>null</strong>, and
<strong>overlay</strong> drivers.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've quickly reviewed available docker networking commands as well as
found what drivers current docker setup supports.</p>
</div>
<h3 id="42-default-bridge-network">4.2 Default bridge network<a class="headerlink" href="#42-default-bridge-network" title="Permanent link">&para;</a></h3>
<p>Every clean installation of Docker comes with a pre-built network called
<strong>Default bridge network</strong>. Let's explore in more details how it works.</p>
<p><strong>Step 1</strong> Verify this with the <code>docker network ls</code>.</p>
<pre class="codehilite"><code class="language-term1">docker network ls
</code></pre>

<pre class="codehilite"><code>NETWORK ID          NAME                DRIVER              SCOPE
3430ad6f20bf        bridge              bridge              local
a7449465c379        host                host                local
06c349b9cc77        none                null                local
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>The output above shows that the <strong>bridge</strong> network is associated with the
<em>bridge</em> driver. It's important to note that the network and the driver are
connected, but they are not the same. In this example the network and the
driver have the same name - but they are not the same thing!</p>
<p>The output above also shows that the <strong>bridge</strong> network is scoped locally.
This means that the network only exists on this Docker host. This is true
of all networks using the <em>bridge</em> driver - the <em>bridge</em> driver provides
single-host networking.</p>
</div>
<p>All networks created with the <em>bridge</em> driver are based on a Linux bridge
(a.k.a. a virtual switch).</p>
<p><strong>Step 5</strong> Start webapp in Default bridge network</p>
<pre class="codehilite"><code>docker run -d -p 80:5000 --name webapp training/webapp python app.py
</code></pre>

<p><strong>Step 6</strong> Check that the webapp and db containers are running:</p>
<p><strong>Command:</strong></p>
<pre class="codehilite"><code class="language-term1">docker ps
</code></pre>

<h3 id="43-user-defined-private-networks">4.3 User-defined Private Networks<a class="headerlink" href="#43-user-defined-private-networks" title="Permanent link">&para;</a></h3>
<p>So far we’ve learned how Docker networking works with <strong>Docker default bridge
network</strong>. With the introduction of user-defined networking in Docker 1.9, it
is now possible to create <strong>multiple Docker bridges</strong> to allow network
segregation within the same host or <strong>multi-host networking</strong> to allow
communicate Docker containers between hosts.</p>
<p>The commands are available through the Docker Engine CLI are:</p>
<pre class="codehilite"><code>docker network create
docker network connect
docker network ls
docker network rm
docker network disconnect
docker network inspect
</code></pre>

<p>Let's demonstrate how to create a custom bridge network.</p>
<p><strong>Step 1</strong> By default, Docker runs containers in the bridge network. You may
want to isolate one or more containers in a separate network. Let’s create a
new network:</p>
<pre class="codehilite"><code>docker network create my-network \
-d bridge \
--subnet 172.19.0.0/16
</code></pre>

<p>The <code>-d</code> bridge command line argument specifies the bridge network driver and
the <code>--subnet</code> command line argument specifies the network segment in CIDR
format. If you do not specify a subnet when creating a network, then Docker
assigns a subnet automatically, so it is a good idea to specify a subnet to
avoid potential conflicts with the existing networks.</p>
<p>Below are some other options that are available with the bridge Driver:</p>
<ul>
<li>
<p>com.docker.network.bridge.enable_ip_masquerade: This instructs the Docker
  host to hide or masquerade all containers in this network behind the Docker
  host's interfaces if the container attempts to route off the local host .</p>
</li>
<li>
<p>com.docker.network.bridge.name: This is the name you wish to give to the
  bridge.</p>
</li>
<li>
<p>com.docker.network.bridge.enable_icc: This turns on or off Inter-Container
  Connectivity (ICC) mode for the bridge.</p>
</li>
<li>
<p>com.docker.network.bridge.host_binding_ipv4: This defines the host interface
  that should be used for port binding.</p>
</li>
<li>
<p>com.docker.network.driver.mtu: This sets MTU for containers attached to this
  bridge.</p>
</li>
</ul>
<p><strong>Step 2</strong> To check that the new network is created, execute docker network ls:</p>
<pre class="codehilite"><code>docker network ls
</code></pre>

<pre class="codehilite"><code>NETWORK ID          NAME                DRIVER              SCOPE
d428e49e4869        bridge              bridge              local
0d1f78528cc5        host                host                local
56ef0481820d        my-network          bridge              local
4a07cef84617        none                null                local
</code></pre>

<p><strong>Step 3</strong> Let’s inspect the new network:</p>
<pre class="codehilite"><code>docker network inspect my-network
</code></pre>

<pre class="codehilite"><code>[
    {
        &quot;Name&quot;: &quot;my-network&quot;,
        &quot;Id&quot;: &quot;56ef0481820d...&quot;,
        &quot;Scope&quot;: &quot;local&quot;,
        &quot;Driver&quot;: &quot;bridge&quot;,
        &quot;EnableIPv6&quot;: false,
        &quot;IPAM&quot;: {
            &quot;Driver&quot;: &quot;default&quot;,
            &quot;Options&quot;: {},
            &quot;Config&quot;: [
                {
                    &quot;Subnet&quot;: &quot;172.19.0.0/16&quot;
                }
            ]
        },
        &quot;Internal&quot;: false,
        &quot;Containers&quot;: {},
        &quot;Options&quot;: {},
        &quot;Labels&quot;: {}
    }
]
</code></pre>

<p><strong>Step 4</strong> As expected, there are no containers connected to the my-network.
Let’s recreate the db container in the my-network:</p>
<pre class="codehilite"><code>docker rm -f db
</code></pre>

<pre class="codehilite"><code>docker run -d --network=my-network --name db training/postgres
</code></pre>

<p><strong>Step 5</strong> Inspect the <code>my-network</code>again:</p>
<pre class="codehilite"><code>docker network inspect my-network
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code class="language-..">    &quot;Containers&quot;: {
        &quot;93af62cdab64...&quot;: {
            &quot;Name&quot;: &quot;db&quot;,
            &quot;EndpointID&quot;: &quot;b1e8e314cff0...&quot;,
            &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,
            &quot;IPv4Address&quot;: &quot;172.19.0.2/16&quot;,
            &quot;IPv6Address&quot;: &quot;&quot;
        }
    },
...
</code></pre>

<p>As you see, the <code>db</code> container is connected to the my-network and has 172.19.0.2
address.</p>
<p><strong>Step 6</strong> Let’s start an interactive session in the db container and ping the
IP address of the webapp again:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Quick reminder how to locate webapp ip:</p>
<p><code>docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' webapp</code></p>
</div>
<pre class="codehilite"><code>docker exec -it db bash
</code></pre>

<p>Once inside of container run:</p>
<pre class="codehilite"><code>root@c3afff20019a:/# ping -c 1 172.17.0.3
PING 172.17.0.3 (172.17.0.3) 56(84) bytes of data.

--- 172.17.0.3 ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms
</code></pre>

<p>As expected, the webapp container is no longer accessible from the db container,
because they are connected to different networks.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Using <code>Multi-host networking</code> provides network isolation within a Docker
host via network namepsaces. This is can be used if you want to deploy
different applications on same host for isolation or resource duplicate
prevention.</p>
</div>
<p><strong>Step 7</strong> Let’s connect the webapp container to the my-network:</p>
<pre class="codehilite"><code>docker network connect my-network webapp
</code></pre>

<p><strong>Step 8</strong> Check that the webapp container now is connected to the my-network:</p>
<pre class="codehilite"><code>docker network inspect my-network
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>...
    &quot;Containers&quot;: {
        &quot;62ed4a627356...&quot;: {
            &quot;Name&quot;: &quot;webapp&quot;,
            &quot;EndpointID&quot;: &quot;ae95b0103bbc...&quot;,
            &quot;MacAddress&quot;: &quot;02:42:ac:12:00:03&quot;,
            &quot;IPv4Address&quot;: &quot;172.19.0.3/16&quot;,
            &quot;IPv6Address&quot;: &quot;&quot;
        },
        &quot;93af62cdab64...&quot;: {
            &quot;Name&quot;: &quot;db&quot;,
            &quot;EndpointID&quot;: &quot;b1e8e314cff0...&quot;,
            &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,
            &quot;IPv4Address&quot;: &quot;172.19.0.2/16&quot;,
            &quot;IPv6Address&quot;: &quot;&quot;
        }
    },
...
</code></pre>

<p>The output shows that two containers are connected to the my-network and the
webapp container has 172.19.0.3 address in that network.</p>
<p><strong>Step 9</strong> Check that the webapp container is accessible from the db container
using its new IP address:</p>
<pre class="codehilite"><code>docker exec -it db bash
</code></pre>

<pre class="codehilite"><code>root@c3afff20019a:/# ping -c 1 172.19.0.3
PING 172.19.0.3 (172.19.0.3) 56(84) bytes of data.
64 bytes from 172.19.0.3: icmp_seq=1 ttl=64 time=0.136 ms

--- 172.19.0.3 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.136/0.136/0.136/0.000 ms
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>As expected containers can communicate with each other.</p>
</div>
<p><strong>Step 10</strong> You can now remove the existing container. You should stop the
container before removing it. Alternatively you can use the -f command line
argument:</p>
<pre class="codehilite"><code>docker rm -f webapp
docker rm -f db
docker network rm  my-network
</code></pre>

<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Use below command to delete running containers in <strong>bulk</strong>:</p>
<p><code>docker rm -f $(docker ps -q)</code></p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>It is recommended to use user-defined bridge networks to control which
containers can communicate with each other, and also to enable automatic
DNS resolution of container names to IP addresses</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
