<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>ycit019 Lab 3 Advanced Docker - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="dropdown-item">Module 2 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="../020_Lab_4_Traffic_control/" class="dropdown-item">Module 8 Traffic Management</a>
</li>
            
<li>
    <a href="../020_Lab_5_EFK/" class="dropdown-item">Module 9 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Module 10 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Module 10 Monitoring with GMP</a>
</li>
            
<li>
    <a href="../020_Lab_9_GitOps/" class="dropdown-item">Module 11 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">Module 12 SERVERless Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="dropdown-item">Module 2</a>
</li>
            
<li>
    <a href="../020_Module_3_Assignment_Production_GKE/" class="dropdown-item">Module 3</a>
</li>
            
<li>
    <a href="../020_Module_4_Assignment_Production_GKE/" class="dropdown-item">Module 4</a>
</li>
            
<li>
    <a href="../020_Module_6_Assignment_Helm_Foundation/" class="dropdown-item">Module 6</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_Module_5_Lab_Docker_basics/" class="dropdown-item">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="../ycit019_Module_9_Kubernetes_Features/" class="dropdown-item">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="dropdown-item">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="../ycit019_Lab_10_Networking/" class="dropdown-item">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="2"><a href="#1-docker-networking" class="nav-link">1 Docker Networking</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-level="2"><a href="#2-persistant-volumes" class="nav-link">2 Persistant Volumes</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<p>Lab 3 Docker Networking, Persistence, Monitoring and Logging</p>
<p><strong>Objective:</strong></p>
<ul>
<li>Networks<ul>
<li>Docker basics</li>
<li>User-defined private Networks</li>
</ul>
</li>
<li>Persistence<ul>
<li>Data Volumes</li>
</ul>
</li>
</ul>
<h2 id="1-docker-networking">1 Docker Networking<a class="headerlink" href="#1-docker-networking" title="Permanent link">&para;</a></h2>
<h3 id="11-docker-networking-basics">1.1 Docker Networking Basics<a class="headerlink" href="#11-docker-networking-basics" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> The Docker Network Command
The <code>docker network</code> command is the main command for configuring and managing container networks. Run the <code>docker network</code> command from the first terminal.</p>
<pre class="codehilite"><code class="language-term1">docker network
</code></pre>

<pre class="codehilite"><code>Usage:  docker network COMMAND

Manage networks

Options:
      --help   Print usage

Commands:
  connect     Connect a container to a network
  create      Create a network
  disconnect  Disconnect a container from a network
  inspect     Display detailed information on one or more networks
  ls          List networks
  prune       Remove all unused networks
  rm          Remove one or more networks

Run 'docker network COMMAND --help' for more information on a command.
</code></pre>

<p>The command output shows how to use the command as well as all of the <code>docker
network</code> sub-commands. As you can see from the output, the <code>docker network</code>
command allows you to create new networks, list existing networks, inspect
networks, and remove networks. It also allows you to connect and disconnect
containers from networks.</p>
<p><strong>Step 2</strong> Run a <code>docker network ls</code> command to view existing container networks
on the current Docker host.</p>
<pre class="codehilite"><code class="language-term1">docker network ls
</code></pre>

<pre class="codehilite"><code>NETWORK ID          NAME                DRIVER              SCOPE
3430ad6f20bf        bridge              bridge              local
a7449465c379        host                host                local
06c349b9cc77        none                null                local
</code></pre>

<p>The output above shows the container networks that are created as part of a
standard installation of Docker.</p>
<p>New networks that you create will also show up in the output of the
<code>docker network ls</code> command.</p>
<p>You can see that each network gets a unique <code>ID</code> and <code>NAME</code>. Each network is
also associated with a single driver. Notice that the "bridge" network and the
"host" network have the same name as their respective drivers.</p>
<p><strong>Step 3:</strong> The <code>docker network inspect</code> command is used to view network
configuration details. These details include; name, ID, driver, IPAM driver,
subnet info, connected containers, and more.</p>
<p>Use <code>docker network inspect &lt;network&gt;</code> to view configuration details of the
container networks on your Docker host. The command below shows the details of
the network called <code>bridge</code>.</p>
<pre class="codehilite"><code class="language-term1">docker network inspect bridge
</code></pre>

<pre class="codehilite"><code>[
    {
        &quot;Name&quot;: &quot;bridge&quot;,
        &quot;Id&quot;: &quot;3430ad6f20bf1486df2e5f64ddc93cc4ff95d81f59b6baea8a510ad500df2e57&quot;,
        &quot;Created&quot;: &quot;2017-04-03T16:49:58.6536278Z&quot;,
        &quot;Scope&quot;: &quot;local&quot;,
        &quot;Driver&quot;: &quot;bridge&quot;,
        &quot;EnableIPv6&quot;: false,
        &quot;IPAM&quot;: {
            &quot;Driver&quot;: &quot;default&quot;,
            &quot;Options&quot;: null,
            &quot;Config&quot;: [
                {
                    &quot;Subnet&quot;: &quot;172.17.0.0/16&quot;,
                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;
                }
            ]
        },
        &quot;Internal&quot;: false,
        &quot;Attachable&quot;: false,
        &quot;Containers&quot;: {},
        &quot;Options&quot;: {
            &quot;com.docker.network.bridge.default_bridge&quot;: &quot;true&quot;,
            &quot;com.docker.network.bridge.enable_icc&quot;: &quot;true&quot;,
            &quot;com.docker.network.bridge.enable_ip_masquerade&quot;: &quot;true&quot;,
            &quot;com.docker.network.bridge.host_binding_ipv4&quot;: &quot;0.0.0.0&quot;,
            &quot;com.docker.network.bridge.name&quot;: &quot;docker0&quot;,
            &quot;com.docker.network.driver.mtu&quot;: &quot;1500&quot;
        },
        &quot;Labels&quot;: {}
    }
]
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The syntax of the <code>docker network inspect</code> command is <code>docker network
inspect &lt;network&gt;</code>, where <code>&lt;network&gt;</code> can be either network name or
network ID. In the example above we are showing the configuration details
for the network called "bridge". Do not confuse this with the "bridge"
driver.</p>
</div>
<p><strong>Step 4</strong> Now, list Docker supported network driver plugins. For that run
<code>docker info</code> command, that  shows a lot of interesting information about a
Docker installation.</p>
<p>Run the <code>docker info</code> command and locate the list of network plugins.</p>
<pre class="codehilite"><code class="language-term1">docker info
</code></pre>

<pre class="codehilite"><code>Containers: 0
 Running: 0
 Paused: 0
 Stopped: 0
Images: 0
Server Version: 17.03.1-ee-3
Storage Driver: aufs
&lt;Snip&gt;
Plugins:
 Volume: local
 Network: bridge host macvlan null overlay
Swarm: inactive
Runtimes: runc
&lt;Snip&gt;
</code></pre>

<p>The output above shows the <strong>bridge</strong>, <strong>host</strong>,<strong>macvlan</strong>, <strong>null</strong>, and
<strong>overlay</strong> drivers.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've quickly reviewed available docker networking commands as well as
found what drivers current docker setup supports.</p>
</div>
<h3 id="12-default-bridge-network">1.2 Default bridge network<a class="headerlink" href="#12-default-bridge-network" title="Permanent link">&para;</a></h3>
<p>Every clean installation of Docker comes with a pre-built network called
<strong>Default bridge network</strong>. Let's explore in more details how it works.</p>
<p><strong>Step 1</strong> Verify this with the <code>docker network ls</code>.</p>
<pre class="codehilite"><code class="language-term1">docker network ls
</code></pre>

<pre class="codehilite"><code>NETWORK ID          NAME                DRIVER              SCOPE
3430ad6f20bf        bridge              bridge              local
a7449465c379        host                host                local
06c349b9cc77        none                null                local
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>The output above shows that the <strong>bridge</strong> network is associated with the
<em>bridge</em> driver. It's important to note that the network and the driver are
connected, but they are not the same. In this example the network and the
driver have the same name - but they are not the same thing!</p>
<p>The output above also shows that the <strong>bridge</strong> network is scoped locally.
This means that the network only exists on this Docker host. This is true
of all networks using the <em>bridge</em> driver - the <em>bridge</em> driver provides
single-host networking.</p>
</div>
<p>All networks created with the <em>bridge</em> driver are based on a Linux bridge
(a.k.a. a virtual switch).</p>
<p><strong>Step 5</strong> Start webapp in Default bridge network</p>
<pre class="codehilite"><code>docker run -d -p 80:5000 --name webapp training/webapp python app.py
</code></pre>

<p><strong>Step 6</strong> Check that the webapp and db containers are running:</p>
<p><strong>Command:</strong></p>
<pre class="codehilite"><code class="language-term1">docker ps
</code></pre>

<h3 id="13-user-defined-private-networks">1.3 User-defined Private Networks<a class="headerlink" href="#13-user-defined-private-networks" title="Permanent link">&para;</a></h3>
<p>So far we’ve learned how Docker networking works with <strong>Docker default bridge
network</strong>. With the introduction of user-defined networking in Docker 1.9, it
is now possible to create <strong>multiple Docker bridges</strong> to allow network
segregation within the same host or <strong>multi-host networking</strong> to allow
communicate Docker containers between hosts.</p>
<p>The commands are available through the Docker Engine CLI are:</p>
<pre class="codehilite"><code>docker network create
docker network connect
docker network ls
docker network rm
docker network disconnect
docker network inspect
</code></pre>

<p>Let's demonstrate how to create a custom bridge network.</p>
<p><strong>Step 1</strong> By default, Docker runs containers in the bridge network. You may
want to isolate one or more containers in a separate network. Let’s create a
new network:</p>
<pre class="codehilite"><code>docker network create my-network \
-d bridge \
--subnet 172.19.0.0/16
</code></pre>

<p>The <code>-d</code> bridge command line argument specifies the bridge network driver and
the <code>--subnet</code> command line argument specifies the network segment in CIDR
format. If you do not specify a subnet when creating a network, then Docker
assigns a subnet automatically, so it is a good idea to specify a subnet to
avoid potential conflicts with the existing networks.</p>
<p>Below are some other options that are available with the bridge Driver:</p>
<ul>
<li>
<p>com.docker.network.bridge.enable_ip_masquerade: This instructs the Docker
  host to hide or masquerade all containers in this network behind the Docker
  host's interfaces if the container attempts to route off the local host .</p>
</li>
<li>
<p>com.docker.network.bridge.name: This is the name you wish to give to the
  bridge.</p>
</li>
<li>
<p>com.docker.network.bridge.enable_icc: This turns on or off Inter-Container
  Connectivity (ICC) mode for the bridge.</p>
</li>
<li>
<p>com.docker.network.bridge.host_binding_ipv4: This defines the host interface
  that should be used for port binding.</p>
</li>
<li>
<p>com.docker.network.driver.mtu: This sets MTU for containers attached to this
  bridge.</p>
</li>
</ul>
<p><strong>Step 2</strong> To check that the new network is created, execute docker network ls:</p>
<pre class="codehilite"><code>docker network ls
</code></pre>

<pre class="codehilite"><code>NETWORK ID          NAME                DRIVER              SCOPE
d428e49e4869        bridge              bridge              local
0d1f78528cc5        host                host                local
56ef0481820d        my-network          bridge              local
4a07cef84617        none                null                local
</code></pre>

<p><strong>Step 3</strong> Let’s inspect the new network:</p>
<pre class="codehilite"><code>docker network inspect my-network
</code></pre>

<pre class="codehilite"><code>[
    {
        &quot;Name&quot;: &quot;my-network&quot;,
        &quot;Id&quot;: &quot;56ef0481820d...&quot;,
        &quot;Scope&quot;: &quot;local&quot;,
        &quot;Driver&quot;: &quot;bridge&quot;,
        &quot;EnableIPv6&quot;: false,
        &quot;IPAM&quot;: {
            &quot;Driver&quot;: &quot;default&quot;,
            &quot;Options&quot;: {},
            &quot;Config&quot;: [
                {
                    &quot;Subnet&quot;: &quot;172.19.0.0/16&quot;
                }
            ]
        },
        &quot;Internal&quot;: false,
        &quot;Containers&quot;: {},
        &quot;Options&quot;: {},
        &quot;Labels&quot;: {}
    }
]
</code></pre>

<p><strong>Step 4</strong> As expected, there are no containers connected to the my-network.
Let’s recreate the db container in the my-network:</p>
<pre class="codehilite"><code>docker rm -f db
</code></pre>

<pre class="codehilite"><code>docker run -d --network=my-network --name db training/postgres
</code></pre>

<p><strong>Step 5</strong> Inspect the <code>my-network</code>again:</p>
<pre class="codehilite"><code>docker network inspect my-network
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code class="language-..">    &quot;Containers&quot;: {
        &quot;93af62cdab64...&quot;: {
            &quot;Name&quot;: &quot;db&quot;,
            &quot;EndpointID&quot;: &quot;b1e8e314cff0...&quot;,
            &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,
            &quot;IPv4Address&quot;: &quot;172.19.0.2/16&quot;,
            &quot;IPv6Address&quot;: &quot;&quot;
        }
    },
...
</code></pre>

<p>As you see, the <code>db</code> container is connected to the my-network and has 172.19.0.2
address.</p>
<p><strong>Step 6</strong> Let’s start an interactive session in the db container and ping the
IP address of the webapp again:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Quick reminder how to locate webapp ip:</p>
<p><code>docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' webapp</code></p>
</div>
<pre class="codehilite"><code>docker exec -it db bash
</code></pre>

<p>Once inside of container run:</p>
<pre class="codehilite"><code>root@c3afff20019a:/# ping -c 1 172.17.0.3
PING 172.17.0.3 (172.17.0.3) 56(84) bytes of data.

--- 172.17.0.3 ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms
</code></pre>

<p>As expected, the webapp container is no longer accessible from the db container,
because they are connected to different networks.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Using <code>Multi-host networking</code> provides network isolation within a Docker
host via network namepsaces. This is can be used if you want to deploy
different applications on same host for isolation or resource duplicate
prevention.</p>
</div>
<p><strong>Step 7</strong> Let’s connect the webapp container to the my-network:</p>
<pre class="codehilite"><code>docker network connect my-network webapp
</code></pre>

<p><strong>Step 8</strong> Check that the webapp container now is connected to the my-network:</p>
<pre class="codehilite"><code>docker network inspect my-network
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>...
    &quot;Containers&quot;: {
        &quot;62ed4a627356...&quot;: {
            &quot;Name&quot;: &quot;webapp&quot;,
            &quot;EndpointID&quot;: &quot;ae95b0103bbc...&quot;,
            &quot;MacAddress&quot;: &quot;02:42:ac:12:00:03&quot;,
            &quot;IPv4Address&quot;: &quot;172.19.0.3/16&quot;,
            &quot;IPv6Address&quot;: &quot;&quot;
        },
        &quot;93af62cdab64...&quot;: {
            &quot;Name&quot;: &quot;db&quot;,
            &quot;EndpointID&quot;: &quot;b1e8e314cff0...&quot;,
            &quot;MacAddress&quot;: &quot;02:42:ac:12:00:02&quot;,
            &quot;IPv4Address&quot;: &quot;172.19.0.2/16&quot;,
            &quot;IPv6Address&quot;: &quot;&quot;
        }
    },
...
</code></pre>

<p>The output shows that two containers are connected to the my-network and the
webapp container has 172.19.0.3 address in that network.</p>
<p><strong>Step 9</strong> Check that the webapp container is accessible from the db container
using its new IP address:</p>
<pre class="codehilite"><code>docker exec -it db bash
</code></pre>

<pre class="codehilite"><code>root@c3afff20019a:/# ping -c 1 172.19.0.3
PING 172.19.0.3 (172.19.0.3) 56(84) bytes of data.
64 bytes from 172.19.0.3: icmp_seq=1 ttl=64 time=0.136 ms

--- 172.19.0.3 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.136/0.136/0.136/0.000 ms
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>As expected containers can communicate with each other.</p>
</div>
<p><strong>Step 10</strong> You can now remove the existing container. You should stop the
container before removing it. Alternatively you can use the -f command line
argument:</p>
<pre class="codehilite"><code>docker rm -f webapp
docker rm -f db
docker network rm  my-network
</code></pre>

<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Use below command to delete running containers in <strong>bulk</strong>:</p>
<p><code>docker rm -f $(docker ps -q)</code></p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>It is recommended to use user-defined bridge networks to control which
containers can communicate with each other, and also to enable automatic
DNS resolution of container names to IP addresses</p>
</div>
<h3 id="14-access-containers-from-outside">1.4 Access containers from outside<a class="headerlink" href="#14-access-containers-from-outside" title="Permanent link">&para;</a></h3>
<p>External Access to the Containers can be configured via publishing mechanism.</p>
<p>Docker provides 2 options to publish ports:</p>
<ul>
<li><code>-P</code> flag publishes all exposed ports</li>
<li><code>-p</code> flag allows you to specify specific ports and interfaces to use when
    mapping ports.</li>
</ul>
<p>The <code>-p</code> flag can take several different forms with the syntax looking like this:</p>
<ul>
<li>
<p>Specify the host port and container port:</p>
<p><code>–p &lt;host port&gt;:&lt;container port&gt;</code></p>
</li>
<li>
<p>Specify the host interface, host port, and container port:</p>
<p><code>–p &lt;host IP interface&gt;:&lt;host port&gt;:&lt;container port&gt;</code></p>
</li>
<li>
<p>Specify the host interface, have Docker choose a random host port, and specify
the container port:</p>
<p><code>–p &lt;host IP interface&gt;::&lt;container port&gt;</code></p>
</li>
<li>
<p>Specify only a container port and have Docker use a random host port:</p>
<p><code>–p &lt;container port&gt;</code></p>
</li>
</ul>
<p>Let's test exposing containers. For that let's start a new NGINX container and
map port 8080 on the Docker host to port 80 inside of the container. This means
that traffic that hits the Docker host on port 8080 will be passed on to port
80 inside the container.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you start a new container from the official NGINX image without specifying a
command to run, the container will run a basic web server on port 80.</p>
</div>
<p><strong>Step 1</strong> Start a new container based off the official NGINX image by running <code>docker run --name web1 -d -p 8080:80 nginx</code>.</p>
<pre class="codehilite"><code class="language-term1">docker run --name web1 -d -p 8080:80 nginx
</code></pre>

<pre class="codehilite"><code>Unable to find image 'nginx:latest' locally
latest: Pulling from library/nginx
6d827a3ef358: Pull complete
b556b18c7952: Pull complete
03558b976e24: Pull complete
9abee7e1ef9d: Pull complete
Digest: sha256:52f84ace6ea43f2f58937e5f9fc562e99ad6876e82b99d171916c1ece587c188
Status: Downloaded newer image for nginx:latest
4e0da45b0f169f18b0e1ee9bf779500cb0f756402c0a0821d55565f162741b3e
</code></pre>

<p><strong>Step 2</strong> Review the container status and port mappings by running <code>docker ps</code>.</p>
<pre class="codehilite"><code class="language-term1">docker ps
</code></pre>

<pre class="codehilite"><code>CONTAINER ID   IMAGE   COMMAND                  PORTS                           NAMES
4e0da45b0f16   nginx   &quot;nginx -g 'daemon ...&quot;   443/tcp, 0.0.0.0:8080-&gt;80/tcp   web1
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>The top line shows the new <strong>web1</strong> container running NGINX. Take note of the
command the container is running as well as the port mapping
- <code>0.0.0.0:8080-&gt;80/tcp</code> maps port 8080 on all host interfaces to port 80
inside the <strong>web1</strong> container. This port mapping is what effectively makes the
containers web service accessible from external sources (via the Docker hosts
IP address on port 8080).</p>
</div>
<p><strong>Step 3</strong> Test connectivity to the NGINX web server, by pasting <code>&lt;Public_IP:8080&gt;</code>
of VM to the browser.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order to locate Public IP see the list of VMs.</p>
</div>
<p>Alternatively from inside of VM run <code>curl 127.0.0.1:8080</code> command.</p>
<pre class="codehilite"><code class="language-term1">curl 127.0.0.1:8080
</code></pre>

<pre class="codehilite"><code>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;Snip&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
    &lt;Snip&gt;
&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Both CLI and UI method works!</p>
</div>
<p>If you try and curl the IP address on a different port number it will fail.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Docker provides easy way to expose containers outside of the Docker Node.
This can ber used for connecting containers between each other:</p>
<ul>
<li>Between networks on the same host</li>
<li>Between networks on different host</li>
<li>Accessing containers from outside (e.g web site)</li>
</ul>
<p>However, port mapping is implemented via port address translation (PAT)
unlike in Kubernetes which we learn soon, exposes applications via
service IPs and communicates via POD IPs using (NAT)</p>
</div>
<p><strong>Step 4</strong> Cleanup environment</p>
<pre class="codehilite"><code>docker rm -f $(docker ps -q)
</code></pre>

<h2 id="2-persistant-volumes">2 Persistant Volumes<a class="headerlink" href="#2-persistant-volumes" title="Permanent link">&para;</a></h2>
<h3 id="21-storage-driver">2.1 Storage driver<a class="headerlink" href="#21-storage-driver" title="Permanent link">&para;</a></h3>
<p>We've discussed several Storage drivers (graphdrivers) during the class.
Let's find out what graphdriver is running in our Lab environment.</p>
<pre class="codehilite"><code>docker info | grep  Storage
</code></pre>

<pre class="codehilite"><code>WARNING: No swap limit support
Storage Driver: aufs
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Our Classroom is running <code>aufs</code> storage driver. Not a suprise as we running
our Lab on Ubuntu VM.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Systems runnng Ubuntu or Debian ,going to run <code>aufs</code> graphdriver by
default and will most likely meet the majority of your needs.<br />
In future <code>overlay2</code> may replace <code>aufs</code> stay tunned!</p>
</div>
<h3 id="22-persisting-data-using-volumes">2.2 Persisting Data Using Volumes<a class="headerlink" href="#22-persisting-data-using-volumes" title="Permanent link">&para;</a></h3>
<p>Docker Volumes are created and assigned when containers are started. Data
Volumes allow you to map a host directory to a container for sharing data.</p>
<p>This mapping is bi-directional. It allows data stored on the host to be accessed
from within the container. It also means data saved by the process inside the
container is persisted on the host.</p>
<h4 id="221-create-and-manage-volumes">2.2.1  Create and manage volumes<a class="headerlink" href="#221-create-and-manage-volumes" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Create a volume:</p>
<pre class="codehilite"><code>docker volume create --name my-vol
</code></pre>

<p><strong>Step 2</strong> List volumes:</p>
<pre class="codehilite"><code>docker volume ls
</code></pre>

<pre class="codehilite"><code>Output:
local               my-vol
</code></pre>

<p><strong>Step 3</strong> Inspect a volume:</p>
<pre class="codehilite"><code>docker volume inspect my-vol
</code></pre>

<pre class="codehilite"><code>[
    {
        &quot;Driver&quot;: &quot;local&quot;,
        &quot;Labels&quot;: {},
        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/my-vol/_data&quot;,
        &quot;Name&quot;: &quot;my-vol&quot;,
        &quot;Options&quot;: {},
        &quot;Scope&quot;: &quot;local&quot;
    }
]
</code></pre>

<p><strong>Step 3</strong> Add some data to the <code>Mountpoint</code> of the volume:</p>
<pre class="codehilite"><code>sudo touch  /var/lib/docker/volumes/my-vol/_data/test_vol
sudo ls  /var/lib/docker/volumes/my-vol/_data/
</code></pre>

<p><strong>Step 4</strong> Create a container <code>busybox</code> alpine image and attach created <code>my-vol</code>
volume in to it:</p>
<pre class="codehilite"><code>docker run -it -v my-vol:/world busybox
</code></pre>

<pre class="codehilite"><code>/ # ls /world
test_vol
/ #
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Volume is mounted and <code>test_vol</code> file is under <code>/world</code> folder as expected</p>
</div>
<p><strong>Step 5</strong>  Try to delete the volume:</p>
<pre class="codehilite"><code>docker volume rm  my-vol
</code></pre>

<pre class="codehilite"><code>Error response from daemon: unable to remove volume: remove my-vol: volume is in use - [6ef3055b516b306847150af8fcea796c02cd90578967802ac29c39d3a2c90102]
</code></pre>

<div class="admonition failure">
<p class="admonition-title">Failure</p>
<p>Deleting container that is attached is not permited. However you can
delete with <code>-f</code> option</p>
</div>
<p><strong>Step 5</strong>  Busybox container stopped, howerver it is not deleted.
Let's locate stopped <code>busybox</code> container and delete it:</p>
<pre class="codehilite"><code>docker ps -a | grep busybox
</code></pre>

<pre class="codehilite"><code>docker rm $docker_id
</code></pre>

<p><strong>Step 6</strong> You can now delete <code>my-vol</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Volume is still avaiable if needed to be reattached any time</p>
</div>
<pre class="codehilite"><code>docker volume ls
docker volume rm my-vol
docker volume ls
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Volumes can be craeted and managed separately from containers.</p>
</div>
<h4 id="222-start-a-container-with-a-volume">2.2.2 Start a container with a volume<a class="headerlink" href="#222-start-a-container-with-a-volume" title="Permanent link">&para;</a></h4>
<p>If you start a container with a volume that does not yet exist, Docker creates
the volume for you.</p>
<p><strong>Step 1</strong> Add a data volume to a container:</p>
<pre class="codehilite"><code>docker run -d -P --name webapp -v /webapp training/webapp python app.py
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Command started a new container and created a new volume inside the
container at /webapp.</p>
</div>
<p><strong>Step 2</strong> Locate the volume on the host using the docker inspect command:</p>
<pre class="codehilite"><code> docker inspect webapp | grep -A9 Mounts
 ```
 **Output:**
 ```       &quot;Mounts&quot;: [
            {
                &quot;Type&quot;: &quot;volume&quot;,
                &quot;Name&quot;: &quot;39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d&quot;,
                &quot;Source&quot;: &quot;/var/lib/docker/volumes/39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d/_data&quot;,
                &quot;Destination&quot;: &quot;/webapp&quot;,
                &quot;Driver&quot;: &quot;local&quot;,
                &quot;Mode&quot;: &quot;&quot;,
                &quot;RW&quot;: true,
                &quot;Propagation&quot;: &quot;&quot;
</code></pre>

<p><strong>Step 3</strong> List container</p>
<pre class="codehilite"><code>docker volume ls
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>DRIVER              VOLUME NAME
local               39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d
</code></pre>

<p><strong>Step 5</strong> Alternatively, you can specify a host directory you want to use as a data
volume:</p>
<pre class="codehilite"><code>mkdir db

docker run -d --name db -v ~/db:/db training/postgres
</code></pre>

<p><strong>Step 2</strong> Start an interactive session in the db container and create a new
file in the /db directory:</p>
<pre class="codehilite"><code>docker exec -it db bash
</code></pre>

<p>Type inside docker containers console:</p>
<pre class="codehilite"><code>root@9a7a4fbcc929:/# cd /db

root@9a7a4fbcc929:/db# touch hello_from_db_container

root@9a7a4fbcc929:/db# exit
</code></pre>

<p><strong>Step 4</strong> Check that the local db directory contains the new file:</p>
<pre class="codehilite"><code>ls db
hello_from_db_container
</code></pre>

<p><strong>Step 5</strong> Check that the data volume is persistent. Remove the db container:</p>
<pre class="codehilite"><code>docker rm -f db
</code></pre>

<p><strong>Step 6</strong> Create the db container again:</p>
<pre class="codehilite"><code>docker run -d --name db -v ~/db:/db training/postgres
</code></pre>

<p><strong>Step 7</strong> Check that its /db directory contains the hello_from_db_container
file:</p>
<pre class="codehilite"><code>docker exec -it db bash
</code></pre>

<p>Run commands inside container:</p>
<pre class="codehilite"><code>root@47a60c01590e:/# ls /db
hello_from_db_container
root@47a60c01590e:/# exit
</code></pre>

<h4 id="223-use-a-read-only-volume">2.2.3 Use a read-only volume<a class="headerlink" href="#223-use-a-read-only-volume" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Mounting Volumes gives the container <strong>full read and write access</strong> to the
directory. You can specify <strong>read-only permissions</strong> on the directory by adding
the <strong>permissions :ro</strong> to the mount. If the container attempts to modify data
within the directory it will error.</p>
<pre class="codehilite"><code>docker run -d --name db1 -v ~/db:/db:ro training/postgres
docker exec -it db1 bash
cd db
touch test
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
</div>
<pre class="codehilite"><code>touch: cannot touch 'test': Read-only file system
$ exit
</code></pre>

<p><strong> Step 2</strong> Clean up containers and volumes:</p>
<pre class="codehilite"><code>docker rm -f $(docker ps -q)
docker volume ls
</code></pre>

<div class="admonition output">
<p class="admonition-title">Output</p>
</div>
<pre class="codehilite"><code>DRIVER              VOLUME NAME
local               39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d
</code></pre>

<pre class="codehilite"><code>docker volume rm 39885c52758dcf7516513be2d44a17560e42b6da75aba30bc66d4af41df5384d
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've learned how to manage volumes with containers</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If you Docker host has several Storage plugins configured (e.g. ceph,
gluster) you can specify via <code>--opt type=btrfs, nfs</code> or <code>--driver=glusterfs</code>
during docker volume creation.</p>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
