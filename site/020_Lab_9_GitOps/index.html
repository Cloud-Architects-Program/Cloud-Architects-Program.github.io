<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Module 11 GitOps with Flux - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="dropdown-item">Module 2 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="../020_Lab_4_Traffic_control/" class="dropdown-item">Module 8 Traffic Management</a>
</li>
            
<li>
    <a href="../020_Lab_5_EFK/" class="dropdown-item">Module 9 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Module 10 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Module 10 Monitoring with GMP</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Module 11 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">Module 12 SERVERLESS Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="dropdown-item">Module 2</a>
</li>
            
<li>
    <a href="../020_Module_3_Assignment_Production_GKE/" class="dropdown-item">Module 3</a>
</li>
            
<li>
    <a href="../020_Module_4_Assignment_Production_GKE/" class="dropdown-item">Module 4</a>
</li>
            
<li>
    <a href="../020_Module_6_Assignment_Helm_Foundation/" class="dropdown-item">Module 6</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_Module_5_Lab_Docker_basics/" class="dropdown-item">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="../ycit019_Module_9_Kubernetes_Features/" class="dropdown-item">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="dropdown-item">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="../ycit019_Lab_10_Networking/" class="dropdown-item">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../020_Lab_6_GMP/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../020_Lab_10_cloudrun/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#lab-6-gitops" class="nav-link">Lab 6 GitOps</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#0-create-regional-gke-cluster-on-gcp" class="nav-link">0 Create Regional GKE Cluster on GCP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#1-install-and-configure-flux-with-github-repository" class="nav-link">1 Install and Configure Flux with GitHub Repository</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-cleanup" class="nav-link">2 Cleanup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="lab-6-gitops">Lab 6 GitOps<a class="headerlink" href="#lab-6-gitops" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Install <code>Flux</code></li>
<li>Bootstrap <code>Flux</code> with a new <code>flux-infra</code> repository</li>
<li>Add a <code>GitRepository</code> source type to track the <code>microservices-demo</code>Public application repository which also contains the deployment code. Flux should regularly sync the code from it.</li>
<li>Use the <code>Kustomization</code> Controller to set up automated deployment to the Kubernetes environment. Any changes in the source should be automatically reconciled with the cluster.</li>
</ul>
<h2 id="0-create-regional-gke-cluster-on-gcp">0 Create Regional GKE Cluster on GCP<a class="headerlink" href="#0-create-regional-gke-cluster-on-gcp" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<pre class="codehilite"><code>gcloud services enable container.googleapis.com
</code></pre>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<pre class="codehilite"><code>gcloud container clusters create k8s-gitops-lab \
--region us-central1 \
--enable-ip-alias \
--enable-network-policy \
--num-nodes 1 \
--machine-type &quot;e2-standard-2&quot; \
--release-channel stable
</code></pre>

<pre class="codehilite"><code>gcloud container clusters get-credentials k8s-gitops-lab --region us-central1
</code></pre>

<p><strong>Step 3: (Optional)</strong> Setup kubectx</p>
<pre class="codehilite"><code>sudo apt install kubectx
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>we've installed <code>kubectx</code> + <code>kubens</code>: Power tools for <code>kubectl</code>:
- <code>kubectx</code> helps you switch between clusters back and forth
- <code>kubens</code> helps you switch between Kubernetes namespaces smoothly</p>
</div>
<h2 id="1-install-and-configure-flux-with-github-repository">1 Install and Configure Flux with GitHub Repository<a class="headerlink" href="#1-install-and-configure-flux-with-github-repository" title="Permanent link">&para;</a></h2>
<p>To Install Flux we going to perform following tasks:</p>
<ul>
<li>Create a Personal Access Token on GitHub.</li>
<li>Set up environment variables.</li>
<li>Install flux CLI.</li>
<li>Run pre-flight checks.</li>
<li>Bootstrap the Flux v2 infrastructure.</li>
<li>Validate the Flux installation.</li>
</ul>
<h3 id="11-install-the-flux-cli">1.1 Install the Flux CLI<a class="headerlink" href="#11-install-the-flux-cli" title="Permanent link">&para;</a></h3>
<p>With <code>Bash</code> for macOS and Linux:</p>
<pre class="codehilite"><code>curl -s https://fluxcd.io/install.sh | sudo bash
</code></pre>

<p>Reference: <a href="https://fluxcd.io/docs/get-started/">Get Started with Flux</a></p>
<h3 id="12-configure-a-github-personal-access-token-with-repo-permissions">1.2 Configure a GitHub personal access token with repo permissions.<a class="headerlink" href="#12-configure-a-github-personal-access-token-with-repo-permissions" title="Permanent link">&para;</a></h3>
<p>Follow the GitHub documentation on <a href="https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line">creating a personal access token</a>.</p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You've created <code>GITHUB_TOKEN</code> that will be used to boostrap the Flux</p>
</div>
<h3 id="13-export-your-credentials">1.3 Export your credentials<a class="headerlink" href="#13-export-your-credentials" title="Permanent link">&para;</a></h3>
<p>Export your GitHub personal access token, generated in step 1.2 and <code>github</code> username:</p>
<pre class="codehilite"><code>export GITHUB_TOKEN=&lt;your-token&gt;
export GITHUB_USER=&lt;your-username&gt;
</code></pre>

<h3 id="14-install-flux-into-gke-cluster">1.4 Install Flux into GKE cluster<a class="headerlink" href="#14-install-flux-into-gke-cluster" title="Permanent link">&para;</a></h3>
<p>Run the bootstrap command:</p>
<pre class="codehilite"><code>flux bootstrap github \
  --owner=$GITHUB_USER \
  --repository=flux-infra \
  --branch=main \
  --path=./clusters/dev \
  --personal \
  --log-level=debug \
  --components=source-controller,kustomize-controller,helm-controller
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>✔ repository &quot;https://github.com/archyufa/flux-infra&quot; created
✔ cloned repository
✔ generated component manifests
✔ committed sync manifests to &quot;main&quot; (&quot;6cd871ba49834e8106884f3c8daad2f75c6b341f&quot;)
✔ installed components
✔ reconciled components
✔ configured deploy key &quot;flux-system-main-flux-system-./clusters/dev&quot; for &quot;https://github.com/archyufa/flux-infra&quot;
✔ reconciled source secret
✔ generated sync manifests
✔ committed sync manifests to &quot;main&quot; (&quot;7d0122f2e4e57ada4f88d7a968528879b07b56e8&quot;)
✔ reconciled sync configuration
✔ Kustomization reconciled successfully
✔ helm-controller: deployment ready
✔ kustomize-controller: deployment ready
✔ source-controller: deployment ready
✔ all components are healthy
</code></pre>

<p>Verify Install:</p>
<pre class="codehilite"><code>flux check
</code></pre>

<pre class="codehilite"><code>kubectl get crd | grep flux
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>buckets.source.toolkit.fluxcd.io                 2021-09-08T18:07:34Z
gitrepositories.source.toolkit.fluxcd.io         2021-09-08T18:07:34Z
helmcharts.source.toolkit.fluxcd.io              2021-09-08T18:07:34Z
helmreleases.helm.toolkit.fluxcd.io              2021-09-08T18:07:34Z
helmrepositories.source.toolkit.fluxcd.io        2021-09-08T18:07:35Z
kustomizations.kustomize.toolkit.fluxcd.io       2021-09-08T18:07:35Z
</code></pre>

<pre class="codehilite"><code>kubectl get gitrepositories -n flux-system
</code></pre>

<pre class="codehilite"><code>flux get all
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've <code>flux bootstrap</code> command we've achieved:</p>
<ul>
<li>flux agent components which includes (namespace, CRDs, Sources, Controllers, RBAC) on our cluster<ul>
<li>3 Controllers:</li>
<li>source</li>
<li>kustomize</li>
<li>helm</li>
<li>6 CRDs: </li>
<li>buckets.source</li>
<li>gitrepositories.source</li>
<li>helmcharts.source</li>
<li>helmrepositories.source</li>
<li>helmreleases.helm</li>
<li>kustomizations.kustomize</li>
</ul>
</li>
<li>Created <code>flux-infra</code> Private Github repo with Deploy key</li>
<li><code>flux-infra</code> repo contains flux-infra/clusters/dev/flux-system/ folder</li>
</ul>
</div>
<h3 id="15-deploy-microservices-applications-with-gitops-using-kustomize-controller">1.5 Deploy <code>microservices</code> applications with GitOps using Kustomize Controller<a class="headerlink" href="#15-deploy-microservices-applications-with-gitops-using-kustomize-controller" title="Permanent link">&para;</a></h3>
<p>Create Dev Team Repo that will store Applications Code and Kubernetes Yaml manifests.</p>
<p><strong>Step 1</strong> Fork microservice application</p>
<p>Browse to:</p>
<pre class="codehilite"><code>https://github.com/GoogleCloudPlatform/microservices-demo
</code></pre>

<pre class="codehilite"><code>Click: Fork button
Select: Fork to a different account
</code></pre>

<p><strong>Step 2</strong> Clone Microservices application from you repo using SSH</p>
<pre class="codehilite"><code>cd ~
git clone git@github.com:&lt;your_repo&gt;/microservices-demo.git
cd microservices-demo
</code></pre>

<pre class="codehilite"><code>rm release/istio-manifests.yaml
git add .
git commit -m &quot;removed istio manifests&quot;
git push
</code></pre>

<p><strong>Step 3</strong> Create Namespace <code>onlineboutique</code></p>
<pre class="codehilite"><code>kubectl create ns onlineboutique
</code></pre>

<p><strong>Step 4</strong> Create a source from a public Git repository master branch:</p>
<pre class="codehilite"><code>flux create source git -h
</code></pre>

<pre class="codehilite"><code>flux create source git microservices-demo \
  --url=https://github.com/&lt;your_repo&gt;/microservices-demo-1 \
  --branch=master \
  --interval=30s
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>✚ generating GitRepository source
► applying GitRepository source
✔ GitRepository source created
◎ waiting for GitRepository source reconciliation
✔ GitRepository source reconciliation completed
✔ fetched revision: master/2e55bc94d35d17aa6b690d63353c38718bc31253
</code></pre>

<p>Verify:</p>
<pre class="codehilite"><code>flux get sources git microservices-demo
</code></pre>

<p><strong>Step 5</strong>  Create a <code>Kustomization</code> resource from a source at a given path</p>
<pre class="codehilite"><code>flux create kustomization -h
</code></pre>

<pre class="codehilite"><code>flux create kustomization microservices-demo-dev \
  --source=GitRepository/microservices-demo \
  --path=&quot;./release/&quot; \
  --prune=true \
  --interval=1m \
  --validation=client \
  --target-namespace=onlineboutique
</code></pre>

<pre class="codehilite"><code>kubens onlineboutique
kubectl get pods
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Onlineboutique pods has been deployed with FluxCD via GitOps</p>
</div>
<pre class="codehilite"><code>kubectl get svc
</code></pre>

<p>Access Onlineboutique <code>Frontend</code> via <code>LoadBalancer</code> IP</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've deployed microservices onlineboutique application using GitOps</p>
</div>
<h3 id="16-deploy-opa-gatekeeper-using-helm-controller">1.6 Deploy OPA Gatekeeper using Helm Controller<a class="headerlink" href="#16-deploy-opa-gatekeeper-using-helm-controller" title="Permanent link">&para;</a></h3>
<p>Now let's install OPA Gatekeeper using Helm so that we can apply different Kubernetes Policy and set the guardrails on what's allowed to do on our cluster.</p>
<p><strong>Step 1</strong> Configure <code>Helm</code> repository</p>
<pre class="codehilite"><code>helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm repo update
</code></pre>

<p><strong>Step 2</strong> Install Helm Chart to <code>monitoring</code> namespace</p>
<pre class="codehilite"><code>kubectl create ns gatekeeper
helm install gatekeeper gatekeeper/gatekeeper -n gatekeeper
kubens gatekeeper
kubectl get deploy
</code></pre>

<p><strong>Step 2</strong> Uninstall Gatekeeper</p>
<pre class="codehilite"><code>helm delete gatekeeper
kubectl delete crd -l gatekeeper.sh/system=yes
</code></pre>

<h3 id="17-deploy-opa-gatekeeper-with-gitops-using-helm-controller">1.7 Deploy OPA Gatekeeper with GitOps using Helm Controller<a class="headerlink" href="#17-deploy-opa-gatekeeper-with-gitops-using-helm-controller" title="Permanent link">&para;</a></h3>
<p>Now let's install OPA Gatekeeper via GitOps so that we can apply different Kubernetes Policy and set the guardrails on what's allowed to do on our cluster.</p>
<p><strong>Step 1</strong> Create a source for a public Helm repository:</p>
<pre class="codehilite"><code>flux create source helm -h
</code></pre>

<pre class="codehilite"><code>flux create source helm gatekeeper \
  --url=https://open-policy-agent.github.io/gatekeeper/charts \
  --interval=1m
</code></pre>

<p>Verify:</p>
<pre class="codehilite"><code>flux get sources helm gatekeeper
</code></pre>

<p><strong>Step 5</strong>  Create a <code>HelmRelease</code> with a chart from a HelmRepository source</p>
<pre class="codehilite"><code>flux create hr -h
</code></pre>

<pre class="codehilite"><code>flux create hr gatekeeper \
  --interval=1m \
  --source=HelmRepository/gatekeeper \
  --chart=gatekeeper \
  --target-namespace=gatekeeper \
  --chart-version=&quot;v3.7.0-beta.1&quot;
</code></pre>

<p>Verify:</p>
<pre class="codehilite"><code>flux get hr
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>gatekeeper      True    Release reconciliation succeeded        3.7.0-beta.1    False
</code></pre>

<pre class="codehilite"><code>kubens gatekeeper
kubectl get deploy
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We've deployed Gatekeeper to our GKE cluster. It's time to add some policies!</p>
</div>
<p><strong>Step 5</strong>  Store Flux configurations:</p>
<pre class="codehilite"><code>git clone git@github.com:&lt;your-user&gt;/flux-infra.git
cd flux-infra/clusters/dev/
flux export source git microservices-demo &gt;&gt;  source-microservices-demo.yaml
flux export kustomization microservices-demo-dev &gt;&gt; kustomization-microservices-demo.yaml
flux export source helm gatekeeper &gt;&gt; source-helm-gatekeeper.yaml
flux export hr gatekeeper &gt;&gt; helmrelease-gatekeeper.yaml
cat source-microservices-demo.yaml kustomization-microservices-demo.yaml source-helm-gatekeeper.yaml helmrelease-gatekeeper.yaml
</code></pre>

<pre class="codehilite"><code>git add .
git commit -m &quot;dev cluster flux config&quot;
git push
</code></pre>

<h3 id="18-deploy-and-test-allowedrepos-policy">1.8 Deploy and Test allowedrepos Policy<a class="headerlink" href="#18-deploy-and-test-allowedrepos-policy" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Let's create a <code>policy</code> folder where we going to store our cluster wide policies:</p>
<pre class="codehilite"><code>cd ~
mkdir -p policy/templates
mkdir -p policy/constraints
</code></pre>

<p><strong>Step 2</strong> Download OSS Gatekeeper libraries:</p>
<pre class="codehilite"><code>cd ~
git clone https://github.com/open-policy-agent/gatekeeper-library
</code></pre>

<p><strong>Step 3</strong> Review <code>allowedrepos</code> constraint template:</p>
<pre class="codehilite"><code>cd gatekeeper-library/library/general/allowedrepos
cat template.yaml
cp -r template.yaml ~/policy/templates
</code></pre>

<pre class="codehilite"><code>cd  ~/policy/templates
kubens gatekeeper
kubectl apply -f template.yaml
</code></pre>

<p>Review a <code>ConstraintTemplate</code> CRD and observe created resource:</p>
<pre class="codehilite"><code>kubectl get  ConstraintTemplate
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even if k8sallowedrepos <code>ConstraintTemplate</code> has been deployed in <code>gatekeeper</code> namespace in our case.
The Policy will be applied Cluster Wide.</p>
</div>
<p><strong>Step 3</strong> Let's create a Gatekeeper constraint that will block all Pods, which images are non  <code>gcr.io</code> registries. We first going to test our constraint in a current system and so we going to run it in <code>dryrun</code> enforcementAction mode. We will </p>
<pre class="codehilite"><code>cd  ~/policy/constraints
cat &lt;&lt; EOF&gt;&gt; allowed-repos.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-repos
spec:
  enforcementAction: dryrun
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    excludedNamespaces: [&quot;onlineboutique&quot;]
  parameters:
    repos:
      - &quot;gcr.io&quot;
      - &quot;gke.gcr.io&quot;
      - &quot;k8s.gcr.io&quot;
EOF
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We've added <code>excludedNamespaces</code> clause, as our microservices app has some redis image that is downloaded from dockerhub.</p>
</div>
<pre class="codehilite"><code>kubectl apply -f allowed-repos.yaml
</code></pre>

<pre class="codehilite"><code>kubectl describe K8sAllowedRepos
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Total Violations:  12
  Violations:
    Enforcement Action:  dryrun
    Kind:                Pod
    Message:             container &lt;manager&gt; has an invalid image repo &lt;ghcr.io/fluxcd/helm-controller:v0.11.2&gt;, allowed repos are [&quot;gcr.io&quot;, &quot;gke.gcr.io&quot;]
    Name:                helm-controller-5cbd57f468-cr7ht
    Namespace:           flux-system
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can observe ~12 Violations in our cluster. However since our Enforcement Action is <code>dryrun</code>, non the policy will take effect. </p>
</div>
<pre class="codehilite"><code>kubectl describe K8sAllowedRepos | grep Namespace
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>    Namespace:           flux-system
    Namespace:           flux-system
    Namespace:           flux-system
    Namespace:           gatekeeper
    Namespace:           gatekeeper
    Namespace:           gatekeeper
    Namespace:           gatekeeper
    Namespace:           kube-system
    Namespace:           kube-system
    Namespace:           kube-system
    Namespace:           kube-system
    Namespace:           kube-system
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can observe that all violations are for <code>kube-system</code>, <code>flux-system</code> and <code>gatekeeper</code>.
This is due to they using images from following repos <code>k8s.gcr.io</code>, <code>ghcr.io/fluxcd</code>, <code>openpolicyagent/gatekeeper</code> respectively. To workaround this issue we can add above repo's in trusted listed of repos.
Another alternative is to <code>copy</code> required images to your personal <code>gcr</code> repo using tools like <a href="https://github.com/google/go-containerregistry/blob/main/cmd/gcrane/README.md">crane</a>.</p>
</div>
<p><strong>Step 4</strong> Update K8sAllowedRepos constraint to support trusted registries:</p>
<pre class="codehilite"><code>rm allowed-repos.yaml
cat &lt;&lt; EOF&gt;&gt; allowed-repos.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-repos
spec:
  enforcementAction: dryrun
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    excludedNamespaces: [&quot;onlineboutique&quot;]
  parameters:
    repos:
      - &quot;gcr.io&quot;
      - &quot;gke.gcr.io&quot;
      - &quot;k8s.gcr.io&quot;
      - &quot;ghcr.io/fluxcd&quot;
      - &quot;openpolicyagent/gatekeeper&quot;
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f allowed-repos.yaml
</code></pre>

<pre class="codehilite"><code>kubectl describe K8sAllowedRepos
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All violations has been resolved, however it may take some time until the messages will be cleared in the Events.</p>
</div>
<p><strong>Step 5</strong> Update K8sAllowedRepos constraint and set <code>enforcementAction</code> to <code>deny</code> in order to block all Pods with registry violations:</p>
<pre class="codehilite"><code>rm allowed-repos.yaml
cat &lt;&lt; EOF&gt;&gt; allowed-repos.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-repos
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    excludedNamespaces: [&quot;onlineboutique&quot;]
  parameters:
    repos:
      - &quot;gcr.io&quot;
      - &quot;gke.gcr.io&quot;
      - &quot;k8s.gcr.io&quot;
      - &quot;ghcr.io/fluxcd&quot;
      - &quot;openpolicyagent/gatekeeper&quot;
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f allowed-repos.yaml
</code></pre>

<pre class="codehilite"><code>kubectl describe K8sAllowedRepos
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Total Violations is 0, as expected.</p>
</div>
<p><strong>Step 6</strong> Deploy <code>nginx</code> Pod from dockerhub in <code>default</code> namespace and thus violate our cluster Policy</p>
<pre class="codehilite"><code>kubectl run nginx --image=nginx -n default
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>Error from server ([allowed-repos] container &lt;nginx&gt; has an invalid image repo &lt;nginx&gt;, allowed repos are [&quot;gcr.io&quot;, &quot;gke.gcr.io&quot;, &quot;k8s.gcr.io&quot;, &quot;ghcr.io/fluxcd&quot;, &quot;openpolicyagent/gatekeeper&quot;]): admissionwebhook &quot;validation.gatekeeper.sh&quot; denied the request: [allowed-repos] container &lt;nginx&gt; has an invalid image repo &lt;nginx&gt;, allowed repos are [&quot;gcr.io&quot;, &quot;gke.gcr.io&quot;, &quot;k8s.gcr.io&quot;, &quot;ghcr.io/fluxcd&quot;, &quot;openpolicyagent/gatekeeper&quot;]
</code></pre>

<div class="admonition error">
<p class="admonition-title">Error</p>
<p>Gatekeeper Admission Controller blocked nginx Pod deployment due to it's violating the <code>allowedrepos</code> constraint.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've secured our cluster from deployments of dangerous and unauthorized images</p>
</div>
<h3 id="18-extra-deploy-allowedrepos-with-gitops">1.8  (Extra) Deploy <code>allowedrepos</code> with Gitops<a class="headerlink" href="#18-extra-deploy-allowedrepos-with-gitops" title="Permanent link">&para;</a></h3>
<p>Create Ops/Platform Repo that will store Gatekeeper Policies and Cluster Wide configurations.</p>
<h3 id="19-extra-deploy-notepad-app-helm-chart-with-gitops">1.9 (Extra) Deploy notepad app Helm chart with GitOps<a class="headerlink" href="#19-extra-deploy-notepad-app-helm-chart-with-gitops" title="Permanent link">&para;</a></h3>
<h2 id="2-cleanup">2 Cleanup<a class="headerlink" href="#2-cleanup" title="Permanent link">&para;</a></h2>
<p>You can uninstall Flux with:</p>
<pre class="codehilite"><code>flux delete kustomization microservices-demo-dev
flux delete source git microservices-demo
flux uninstall --namespace=flux-system
</code></pre>

<p>The above command performs the following operations:</p>
<ul>
<li>deletes Flux components (deployments and services)</li>
<li>deletes Flux network policies</li>
<li>deletes Flux RBAC (service accounts, cluster roles and cluster role bindings)</li>
<li>removes the Kubernetes finalizers from Flux custom resources</li>
<li>deletes Flux custom resource definitions and custom resources</li>
<li>deletes the namespace where Flux was installed</li>
</ul>
<p>Delete GKE cluster:</p>
<pre class="codehilite"><code>gcloud container clusters delete k8s-gitops-lab --region us-central1
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
