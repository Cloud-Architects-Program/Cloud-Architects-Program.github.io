
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.3">
    
    
      
        <title>020 Module 6 Assignment Helm Foundation - Cloud Architecture</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#prerequisite" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Architecture" class="md-header__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Architecture
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              020 Module 6 Assignment Helm Foundation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Architecture" class="md-nav__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Architecture
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          YCIT020
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="md-nav__link">
        Module 2 Terraform Fundamentals
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="md-nav__link">
        Module 2 Terraforming GCP Foundation
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          YCIT019
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_5_Lab_Docker_basics/" class="md-nav__link">
        Module 5 Lab - Docker Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="md-nav__link">
        Module 6 Lab - Advanced Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="md-nav__link">
        Module 8 Lab - Kuberenetes Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_9_Kubernetes_Features/" class="md-nav__link">
        Module 9 Lab - Kubernetes Features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="md-nav__link">
        Module 9 Part 2 Lab Kubernetes Autoscaling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Module 10 Lab - Kubernetes Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Module 11 Lab - Kubernetes Storage
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Module 5 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Module 5 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Module 6 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Module 6 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Module 8 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Module 8 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_2022/" class="md-nav__link">
        Module 9 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Module 9 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass7/" class="md-nav__link">
        Module 10 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Module 10 Assignment Solution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prerequisite" class="md-nav__link">
    Prerequisite
  </a>
  
    <nav class="md-nav" aria-label="Prerequisite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#locate-assignment-4" class="md-nav__link">
    Locate Assignment 4
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reserve-static-ip-addresses" class="md-nav__link">
    Reserve Static IP addresses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#commit-to-repository" class="md-nav__link">
    Commit to Repository
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-install-and-configure-helm-client" class="md-nav__link">
    1 Install and Configure Helm Client
  </a>
  
    <nav class="md-nav" aria-label="1 Install and Configure Helm Client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-install-helm-3" class="md-nav__link">
    1.1 Install Helm 3
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-deploy-gke-cluster" class="md-nav__link">
    1.3 Deploy GKE cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-configure-helm" class="md-nav__link">
    1.4 Configure Helm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-basic-helm-chart-installation" class="md-nav__link">
    2 Basic Helm Chart Installation
  </a>
  
    <nav class="md-nav" aria-label="2 Basic Helm Chart Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-searching-chart" class="md-nav__link">
    2.1 Searching Chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-adding-a-chart-repository" class="md-nav__link">
    2.2 Adding a Chart Repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-helm-chart-installation" class="md-nav__link">
    2.3 Helm Chart Installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-advanced-helm-chart-installation" class="md-nav__link">
    3 Advanced Helm Chart Installation
  </a>
  
    <nav class="md-nav" aria-label="3 Advanced Helm Chart Installation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-deploy-nginx-ingress-chart-with-custom-configuration" class="md-nav__link">
    3.2.1 Deploy NGINX Ingress Chart with Custom Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-download-and-inspect-chart-locally" class="md-nav__link">
    3.2.2 Download and inspect Chart locally
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-helm-template" class="md-nav__link">
    3.2.2 Helm Template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#323-dry-runs" class="md-nav__link">
    3.2.3 Dry-Runs
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#324-deploy-drupal-using-nginx-ingress-controller" class="md-nav__link">
    3.2.4 Deploy Drupal using Nginx Ingress Controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-using-set-values-and-upgrading-charts" class="md-nav__link">
    3.2.5  Using  --set values and Upgrading Charts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-listing-releases-history-rollbacks" class="md-nav__link">
    3.2.5  Listing Releases, History, Rollbacks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#325-upgrade-release-with-helm-diff-plugin" class="md-nav__link">
    3.2.5  Upgrade Release with Helm Diff Plugin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#326-install-minio-with-helm" class="md-nav__link">
    3.2.6 Install Minio with Helm
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#327-customize-minio-installation-task" class="md-nav__link">
    3.2.7 Customize Minio Installation Task
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-creating-notepad-helm-charts" class="md-nav__link">
    4 Creating NotePad Helm Charts
  </a>
  
    <nav class="md-nav" aria-label="4 Creating NotePad Helm Charts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-design-gowebapp-mysql-chart" class="md-nav__link">
    4.1 Design gowebapp-mysql chart
  </a>
  
    <nav class="md-nav" aria-label="4.1 Design gowebapp-mysql chart">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#411-create-gowebapp-mysql-chart" class="md-nav__link">
    4.1.1  Create gowebapp-mysql chart
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-design-gowebapp-chart" class="md-nav__link">
    4.2  Design gowebapp chart.
  </a>
  
    <nav class="md-nav" aria-label="4.2  Design gowebapp chart.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#421-create-gowebapp-chart" class="md-nav__link">
    4.2.1  Create gowebapp chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#422-template-the-deployment" class="md-nav__link">
    4.2.2 Template the Deployment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#423-template-the-service" class="md-nav__link">
    4.2.3 Template the Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#424-disable-the-service-account" class="md-nav__link">
    4.2.4 Disable the Service account
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#425-template-the-ingress-resource" class="md-nav__link">
    4.2.5 Template the Ingress Resource
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#425-templatize-the-configmap-resource" class="md-nav__link">
    4.2.5 Templatize the ConfigMap Resource
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#426-deploy-gowebapp" class="md-nav__link">
    4.2.6 Deploy gowebapp
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#427-submit-assignement" class="md-nav__link">
    4.2.7 Submit assignement
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#part-2-wip" class="md-nav__link">
    Part 2 WIP
  </a>
  
    <nav class="md-nav" aria-label="Part 2 WIP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5-chart-repositories" class="md-nav__link">
    5 Chart Repositories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-helmfile" class="md-nav__link">
    6 HelmFile
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-install-istio-on-gke" class="md-nav__link">
    7 Install Istio on GKE
  </a>
  
    <nav class="md-nav" aria-label="7 Install Istio on GKE">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#70-prerequisite" class="md-nav__link">
    7.0 Prerequisite
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#71-deploy-istio-using-custom-resources" class="md-nav__link">
    7.1 Deploy Istio using Custom Resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-deploy-istio-using-istio-operator" class="md-nav__link">
    7.2 Deploy Istio using Istio Operator
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-commit-readme-doc-to-repository-and-share-it-with-instructorteacher" class="md-nav__link">
    8 Commit Readme doc to repository and share it with Instructor/Teacher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-cleanup" class="md-nav__link">
    9 Cleanup
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p>Lab 4 Learning Helm</p>
<p><strong>Objective:</strong></p>
<ul>
<li>Installing and Configuring the Helm Client</li>
<li>Deploy Kubernetes apps with Helm Charts</li>
<li>Learn Helm Commands</li>
<li>Learn Helm Repository</li>
<li>Create Helm chart</li>
<li>Learn Helm Plugins</li>
<li>Learn HelmFile</li>
</ul>
<h2 id="prerequisite">Prerequisite<a class="headerlink" href="#prerequisite" title="Permanent link">&para;</a></h2>
<h3 id="locate-assignment-4">Locate Assignment 4<a class="headerlink" href="#locate-assignment-4" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong>  Clone <code>ycit020</code> repo with Kubernetes manifests, which going to use for our work:</p>
<div class="codehilite"><pre><span></span><code>cd ~/ycit020
# Alternatively: cd ~ &amp; git clone https://github.com/Cloud-Architects-Program/ycit020
git pull
cd ~/ycit020/Assignment4/
ls
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You can see Kubernetes manifests and terraform configs</p>
</div>
<p><strong>Step 1</strong> Go into your personal Google Cloud Source Repository:</p>
<div class="codehilite"><pre><span></span><code>MY_REPO=your_student_id-notepad
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Replace $student_id with your ID</p>
</div>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
</code></pre></div>

<div class="codehilite"><pre><span></span><code>git pull                              # Pull latest code from you repo
</code></pre></div>

<p><strong>Step 3 (Optional)</strong> If you terraform config is not working you can copy working config from <code>Assignment4</code> folder
to your <code>notepad-infrastructure</code> folder.</p>
<p><strong>Step 4</strong> Create structure for Helm Deployments for supporting applications</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
mkdir helm

cat &lt;&lt;EOF&gt; helm/README.md
# Helm Files and values to deploy supporting applications
EOF
</code></pre></div>

<p><strong>Step 5</strong> Copy Assignment 4 <code>deploy_a4</code> folder to your repo:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/
cp -r ~/ycit020/Assignment4/deploy_a4 deploy_ycit020_a4
ls deploy_ycit020_a4
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You should see <code>k8s-manifest</code> folder</p>
</div>
<p><strong>Step 6</strong> Create structure for <code>NotePad</code> Helm Chart locations</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4
mkdir helm

cat &lt;&lt;EOF&gt; helm/README.md
# Helm Chart, HelmFiles and values to deploy `NotePad` application.
EOF
</code></pre></div>

<h3 id="reserve-static-ip-addresses">Reserve Static IP addresses<a class="headerlink" href="#reserve-static-ip-addresses" title="Permanent link">&para;</a></h3>
<p>In the next few assignments we might deploy many applications and so we will require expose them using Ingress.</p>
<p>When you create an Ingress object, you get a stable external IP address that clients can use to access your Services and in turn, your running containers. The IP address is stable in the sense that it lasts for the lifetime of the Ingress object. If you delete your Ingress and create a new Ingress from the same manifest file, you are not guaranteed to get the same external IP address.</p>
<p>We would like to have for each student a  a permanent IP address that stays the same across deleting your Ingress and creating a new one</p>
<p>For that you must reserve a <code>Regional</code> static <code>External</code> IP address and provide it teacher, so we can setup <code>A Record</code> on the DNS for your behalf.</p>
<p>Reference: </p>
<ol>
<li><a href="https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address">Reserving a static external IP address</a></li>
<li>Terraform resource <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_address">google_compute_address</a></li>
</ol>
<p><strong>Step 1:</strong> Create folder for static ip terraform configuration:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/
mkdir ip-infrastructure
</code></pre></div>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The reason we creating a new folder for static_ip creation is because we don't want to destroy or delete this IP throughout our training.</p>
</div>
<p><strong>Step 1:</strong> Create Terraform configuration:</p>
<p>Set you current <code>PROJECT_ID</code> value here:</p>
<div class="codehilite"><pre><span></span><code>export PROJECT_ID=&lt;YOUR_PROJECT_ID&gt;
</code></pre></div>

<p>Declare Provider:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/ip-infrastructure
cat &lt;&lt; EOF&gt;&gt; provider.tf
terraform {
  required_providers {
    google = {
      source  = &quot;hashicorp/google&quot;
      version = &quot;~&gt; 3.70.0&quot;
    }
  }
}
EOF
</code></pre></div>

<p>Configure global address resource:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; static_ip.tf
provider &quot;google&quot; {
  project = var.gcp_project_id
}

resource &quot;google_compute_address&quot; &quot;regional_external_ip&quot; {
  provider      = google
  name          = &quot;static-ingres-ip&quot;
  address_type  = &quot;EXTERNAL&quot;
  region        = &quot;us-central1&quot;
}
EOF
</code></pre></div>

<p>Configure variables:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; variables.tf
variable &quot;gcp_project_id&quot; {
  type        = string
  description = &quot;The GCP Seeding project ID&quot;
  default     = &quot;&quot;
}
EOF
</code></pre></div>

<p>Configure <code>tfvars</code>:</p>
<div class="codehilite"><pre><span></span><code>gcp_project_id = &quot;$PROJECT_ID&quot;
</code></pre></div>

<p>Configure outputs:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; outputs.tf
output &quot;addresses&quot; {
  description = &quot;Global IPv4 address for proxy load balancing to the nearest Ingress controller&quot;
  value       = google_compute_address.regional_external_ip.address
}

output &quot;name&quot; {
  description = &quot;Static IP Name&quot;
  value       = google_compute_address.regional_external_ip.name
}
EOF
</code></pre></div>

<p><strong>Step 2:</strong> Apply Terraform configuration:</p>
<p>Initialize:</p>
<div class="codehilite"><pre><span></span><code>terraform init
</code></pre></div>

<p>Plan and Deploy Infrastructure:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
terraform apply -var-file terraform.tfvars
</code></pre></div>

<p>Set variable:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/ip-infrastructure
export STATIC_IP_ADDRESS=$(terraform output | grep &#39;addresses&#39; |awk &#39;{ print $3}&#39;)
export STATIC_IP_NAME=$(terraform output | grep &#39;name&#39; |awk &#39;{ print $3}&#39;)
</code></pre></div>

<p>Create readme:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; README.md

Generated Static IP for Ingress:

    * Name - $STATIC_IP_NAME # Used Ingress Manifest
    * Address - $STATIC_IP_ADDRESS # Used to Configure DNS A Record
EOF
</code></pre></div>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Add information about your static_ip_address in column 3 under your name in this spreadsheet:
<a href="https://docs.google.com/spreadsheets/d/1XV-wW9Z8KvfWo4io11V_ax2__OImF27Rmlfbyj03T0I/edit?usp=sharing">https://docs.google.com/spreadsheets/d/1XV-wW9Z8KvfWo4io11V_ax2__OImF27Rmlfbyj03T0I/edit?usp=sharing</a></p>
</div>
<p><strong>Step 6</strong> Commit <code>deploy</code> folder using the following Git commands:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
git status
git add .
git commit -m &quot;adding documentation for ycit020 assignment 4&quot;
</code></pre></div>

<h3 id="commit-to-repository">Commit to Repository<a class="headerlink" href="#commit-to-repository" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Commit <code>ip-infrastructure</code> and <code>helm</code> folders using the following Git commands:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
git status 
git add .
git commit -m &quot;Assignement 4&quot;
</code></pre></div>

<p><strong>Step 2</strong> Once you've committed code to the local repository, add its contents to Cloud Source Repositories using the git push command:</p>
<div class="codehilite"><pre><span></span><code>git push origin master
</code></pre></div>

<h2 id="1-install-and-configure-helm-client">1 Install and Configure Helm Client<a class="headerlink" href="#1-install-and-configure-helm-client" title="Permanent link">&para;</a></h2>
<h3 id="11-install-helm-3">1.1 Install Helm 3<a class="headerlink" href="#11-install-helm-3" title="Permanent link">&para;</a></h3>
<p>GCP Cloud Shell comes with many common tools pre-installed including <code>helm</code>.</p>
<p><strong>Step 1:</strong> Verify and validate the version of <code>Helm</code> that is installed:</p>
<div class="codehilite"><pre><span></span><code>helm --version
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>version.BuildInfo{Version:&quot;v3.5.0&quot;}
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Helm 3 is installed</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Until November 2020, two different major versions of Helm were actively maintained. The current stable major version of Helm is version 3. </p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Helm follows a versioning convention known as <a href="https://semver.org/">Semantic Versioning</a> (SemVer). In Semantic Versioning, the version number conveys meaning about what you can expect in the release. Because Helm follows this specification, users can expect certain things out of releases simply by carefully reading the version number. At its core, a semantic version has three numerical components and an optional stability marker (for alphas, betas, and release candidates). Here are some examples:</p>
<ul>
<li>v1.0.0</li>
<li>v3.3.2</li>
</ul>
<p>SemVer represents format of  <code>X.Y.Z</code>, where <code>X</code> is a major version, <code>Y</code> is a minor version and <code>Z</code> is a patch release:</p>
<ul>
<li>
<p>The major release number tends to be incremented infrequently. It indicates that major changes have been made to Helm, and that some of those changes may break compatibility with previous versions. The difference between Helm 2 and Helm 3 is substantial, and there is work necessary to migrate between the versions.</p>
</li>
<li>
<p>The minor release number indicates feature additions. The difference between 3.2.0 and 3.3.0 might be that a few small new features were added. However, there are no breaking changes between versions. (With one caveat: a security fix might necessitate a breaking change, but we announce boldly when that is the case.)</p>
</li>
<li>
<p>The patch release number indicates that only backward compatible bug fixes have been made between this release and the last one. It is always recommended to stay at the latest patch release.</p>
</li>
</ul>
</div>
<p><strong>(OPTIONAL) Step 2:</strong> If you want to use specific version of <code>helm</code> or want to install <code>helm</code> in you local machine (On macOS and Linux,) use following <a href="https://helm.sh/docs/intro/install/#from-script">link</a> to install Helm. </p>
<p>The usual sequence of commands for installing this way is as follows:</p>
<div class="codehilite"><pre><span></span><code>$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
$ chmod 700 get_helm.sh
$ ./get_helm.sh
</code></pre></div>

<p>The preceding commands fetch the latest version of the get_helm.sh script, and then use that to find and install the latest version of Helm 3.</p>
<p>Alternatively, you can download latest binary of you OS choice <a href="https://github.com/helm/helm/releases">here</a>.</p>
<h3 id="13-deploy-gke-cluster">1.3 Deploy GKE cluster<a class="headerlink" href="#13-deploy-gke-cluster" title="Permanent link">&para;</a></h3>
<p>We going to reuse Terraform configuration to deploy our GKE Cluster. And we assume that <code>terraform.tfvars</code> has been properly configured already with required values.</p>
<p><strong>Step 1:</strong> Locate Terraform Configuration directory.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
</code></pre></div>

<p><strong>Step 2:</strong> Initialize Terraform Providers
s</p>
<div class="codehilite"><pre><span></span><code>terraform init
</code></pre></div>

<p><strong>Step 3:</strong>  Increase GKE Node Pool VM size</p>
<div class="codehilite"><pre><span></span><code>edit terraform.tfvars
</code></pre></div>

<p>Update <code>gke_pool_machine_type</code> from <code>e2-small</code> to <code>e2-highcpu-4</code>, to support larger workloads.</p>
<p><strong>Step 4:</strong> Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p><strong>Step 5:</strong> Create GKE Cluster and Node Pool:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<div class="codehilite"><pre><span></span><code>!!! result
    GKE Clusters has been created
</code></pre></div>

<h3 id="14-configure-helm">1.4 Configure Helm<a class="headerlink" href="#14-configure-helm" title="Permanent link">&para;</a></h3>
<p>Helm interacts directly with the Kubernetes API server. For that reason, Helm needs to be able to connect to a Kubernetes cluster. Helm attempts to do this automatically by reading the same configuration files used by <code>kubectl</code>.</p>
<p>Helm will try to find this information by reading the environment variable $KUBECONFIG.</p>
<p><strong>Step 1</strong> Authenticate to the cluster.</p>
<p>export STUDENT_NAME=<YOUR_PROJECT_ID></p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters get-credentials gke-$STUDENT_NAME-notepad-dev --region us-central1 
</code></pre></div>

<p><strong>Step 2</strong> Test that <code>kubectl</code> client connected to GKE cluster:</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>No resources found in default namespace.
</code></pre></div>

<p><strong>Step 3</strong> Test that helm client connected to GKE cluster:</p>
<div class="codehilite"><pre><span></span><code>helm list
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME    NAMESPACE       REVISION        UPDATED STATUS  CHART   APP VERSION
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>As expected there are no Charts has been Installed on our cluster yet</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Helm 3 has been installed and configured to work with our cluster. Let's deploy some charts!</p>
</div>
<h2 id="2-basic-helm-chart-installation">2 Basic Helm Chart Installation<a class="headerlink" href="#2-basic-helm-chart-installation" title="Permanent link">&para;</a></h2>
<h3 id="21-searching-chart">2.1 Searching Chart<a class="headerlink" href="#21-searching-chart" title="Permanent link">&para;</a></h3>
<p>A Helm chart is an package that can be installed into your Kubernetes cluster. During chart development, you will often just work with a chart that is stored on your local system and later pushed to GitHub.</p>
<p>But when it comes to sharing charts, Helm describes a standard format for indexing and sharing information about Helm <code>charts</code>. A Helm chart <code>repository</code> is simply a set of files, reachable over the network, that conforms to the Helm specification for indexing packages.</p>
<p>There are huge number of chart repositories on the internet. The easiest way to find the popular repositories is to use your web browser to navigate to the <a href="https://artifacthub.io/">Artifact Hub</a>. There you will find thousands of Helm charts, each hosted on an appropriate repository.</p>
<div class="admonition deprecation">
<p class="admonition-title">Deprecation</p>
<p>In the past all charts were located and maintained by Helm Kubernetes Community Git repositories,
known as https://github.com/kubernetes/charts, and had 2 types:</p>
<ul>
<li><a href="https://github.com/kubernetes/charts/tree/master/incubator">Stable</a></li>
<li><a href="https://github.com/kubernetes/charts/tree/master/incubator">Incubator</a></li>
</ul>
<p>All the charts were rendered in Web UI via <a href="https://hub.helm.sh">Helm Hub</a> page.</p>
<p>While the central Git Repository to maintain charts was great idea, with fast growing Helm popularity, it become hard to impossible to manage
and maintain it by small group of maintainers, as they had to aprove hundreds of PR per day and frustrating for chart contributors as they had to wait several weeks their PR to be reviewed and approved.</p>
<p>As a result GitHub project for Helm <code>stable</code> and <code>incubator</code> charts as well as [Helm Hub] has been deprecated and archived.
All the charts are now maintained by independent contributors in their subsequent repo's. (e.g vault, is under hashicorp/vault-helm repo)
and the central place to find all active and official Charts can be foind in <a href="https://artifacthub.io/">Artifact Hub</a>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Helm 2 came with a Helm repository installed by default. The <code>stable</code> chart repository was at one time the official source of production-ready Helm charts.
As we discussed above  <code>stable</code> chart repository has been now deprecated.</p>
<p>In Helm 3, there is no <code>default</code> repository. Users are encouraged to use the Artifact Hub to find what they are looking for and then add their preferred repositories.</p>
</div>
<p><strong>Step 1:</strong> Helm provides native way to search charts from CLI in <a href="artifacthub.io">artifacthub.io</a></p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure/helm
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm search hub drupal
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>https://artifacthub.io/packages/helm/bitnami/drupal 10.2.30         9.2.3       One of the most versatile open source content m...
https://artifacthub.io/packages/helm/cetic/drupal   0.1.0           1.16.0      Drupal is a free and open-source web content ma..
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Search is a good way to find existing Helm packages</p>
</div>
<p><strong>Step 2:</strong> Use the link to navigate to Artifact Hub Drupal chart:</p>
<div class="codehilite"><pre><span></span><code>https://artifacthub.io/packages/helm/bitnami/drupal
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Drupal is OSS content management systems that can be installed this days on K8s.</p>
</div>
<p><strong>Result:</strong> The Artifact Page opened with information about the chart, it's parameters and how to use the chart.</p>
<p><strong>Step 3:</strong> Review Github source Code of the chart:</p>
<div class="codehilite"><pre><span></span><code>https://github.com/bitnami/charts/tree/master/bitnami/drupal
</code></pre></div>

<p><strong>Result:</strong> Github page with Drupal Helm Chart itself, where you can browse the <code>templates</code>, <code>values.yaml</code>, <code>Chart.yaml</code> to
understand how this chart is actually working and if you have any issues with the chart this would be the right location to open the issue
or send a PR with new feature if you decide to contribute.</p>
<h3 id="22-adding-a-chart-repository">2.2 Adding a Chart Repository<a class="headerlink" href="#22-adding-a-chart-repository" title="Permanent link">&para;</a></h3>
<p>Once you found a chart, it's logical to install it. However first step you need to do is to add a Chart Repository.</p>
<p><strong>Step 1:</strong> Adding a Helm chart is done with the <code>helm repo add</code> command:</p>
<div class="codehilite"><pre><span></span><code>helm repo add bitnami https://charts.bitnami.com/bitnami
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a href="https://bitnami.com/">Bitnami</a> is company well known to package application for Any Platforms and Cloud environments. With popularity of Helm, Bitnami developers were among the core contributors who designed the Helm repository system. They have contributed to the establishment of Helmâ€™s best practices for chart development and have written many of the most widely used charts. Bitnami is now part of VMware, provides IT organizations with an enterprise offering that is secure, compliant, continuously maintained and customizable to your organizational policies.</p>
</div>
<p><strong>Step 2:</strong> Now, we can verify that the Bitnami repository exists by running a <code>helm repo list</code> command:</p>
<div class="codehilite"><pre><span></span><code>helm repo list
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME    URL                               
bitnami https://charts.bitnami.com/bitnami
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>This command shows us all of the repositories installed for Helm. Right now, we see only the Bitnami repository that we just added.</p>
</div>
<h3 id="23-helm-chart-installation">2.3 Helm Chart Installation<a class="headerlink" href="#23-helm-chart-installation" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> At very minimum, installing a chart in Helm requires just 2 pieces of information: the <code>name</code> of the installation and the <code>chart</code> you want to install:</p>
<div class="codehilite"><pre><span></span><code>helm install mywebsite bitnami/drupal
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME: mywebsite
LAST DEPLOYED: Sun Aug  8 08:25:29 2021
NAMESPACE: prometheus
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
*******************************************************************
*** PLEASE BE PATIENT: Drupal may take a few minutes to install ***
*******************************************************************

1. Get the Drupal URL:

  NOTE: It may take a few minutes for the LoadBalancer IP to be available.
        Watch the status with: &#39;kubectl get svc --namespace prometheus -w mywebsite-drupal&#39;

  export SERVICE_IP=$(kubectl get svc --namespace prometheus mywebsite-drupal --template &quot;{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}&quot;)
  echo &quot;Drupal URL: http://$SERVICE_IP/&quot;

2. Get your Drupal login credentials by running:

  echo Username: user
  echo Password: $(kubectl get secret --namespace prometheus mywebsite-drupal -o jsonpath=&quot;{.data.drupal-password}&quot; | base64 --decode)
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>When using Helm, you will see that output for each installation. A good chart would provide helpful <code>notes</code> on how to connect to the deployed solution.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can get <code>notes</code> information any time after helm installation using <code>helm get notes mywebsite</code> command.</p>
</div>
<p><strong>Step 2:</strong> Follow your Drupal Helm Chart <code>notes</code> Instruction to access Website</p>
<div class="codehilite"><pre><span></span><code>1. Get the Drupal URL:

  NOTE: It may take a few minutes for the LoadBalancer IP to be available.
        Watch the status with: &#39;kubectl get svc --namespace test -w mywebsite-drupal&#39;

  export SERVICE_IP=$(kubectl get svc --namespace test mywebsite-drupal --template &quot;{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}&quot;)
  echo &quot;Drupal URL: http://$SERVICE_IP/&quot;
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>We can access <code>My blog</code> website and login with provider user and password.
You can start your own blog now, that runs on Kubernetes</p>
</div>
<p><strong>Step 3:</strong> List deployed Kubernetes resources:</p>
<div class="codehilite"><pre><span></span><code>kubectl get all --namespace test
kubectl get pvc --namespace test
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Our Drupal website consist of MariaDB <code>statefulset</code>, Drupal <code>deployment</code>, 2 <code>pvc</code>s and 
<code>services</code>. <code>Mywebsite</code> Drupal service is type <code>LoadBalancer</code> and that's how we able to access it.</p>
</div>
<p><strong>Step 4:</strong> List installed chart:</p>
<div class="codehilite"><pre><span></span><code>helm list
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
mywebsite       default         1               2021-08-08 08:25:29.625862 -0400 EDT    deployed        drupal-10.2.30          9.2.3
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Like other commands, helm list is <code>namespace</code> aware. By default, Helm uses the <code>namespace</code> your Kubernetes configuration file sets as the default. Usually this is the namespace named <code>default</code>.</p>
</div>
<p><strong>Step 5:</strong> Deploy same chart in namespace <code>test</code>: </p>
<div class="codehilite"><pre><span></span><code>kubectl create ns test
helm install --namespace test mywebsite bitnami/drupal --create-namespace
</code></pre></div>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>By adding <code>--create-namespace</code>, indicates to Helm that we acknowledge that there may not be a namespace with that name already, and we just want one to be created.</p>
</div>
<p>List deployed chart in namespace <code>test</code>: </p>
<div class="codehilite"><pre><span></span><code>helm list --namespace test
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>In Helm 2, instance names were cluster-wide. You could only have an instance named <code>mywebsite</code> once per cluster. </p>
<p>In Helm 3, naming has been changed. Now instance names are scoped to Kubernetes namespaces. We could install 2 instances named <code>mywebsite</code> as long as they each lived in a different namespace.</p>
</div>
<p><strong>Step 5:</strong> Cleanup Helm Drupal deployments using <code>helm uninstall</code> command:</p>
<div class="codehilite"><pre><span></span><code>helm uninstall mywebsite
helm uninstall mywebsite -n test 
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl delete ns test
</code></pre></div>

<h2 id="3-advanced-helm-chart-installation">3 Advanced Helm Chart Installation<a class="headerlink" href="#3-advanced-helm-chart-installation" title="Permanent link">&para;</a></h2>
<h3 id="321-deploy-nginx-ingress-chart-with-custom-configuration">3.2.1 Deploy NGINX Ingress Chart with Custom Configuration<a class="headerlink" href="#321-deploy-nginx-ingress-chart-with-custom-configuration" title="Permanent link">&para;</a></h3>
<p>Let's deploy another Helm application on our Kubernetes cluster: <a href="https://kubernetes.github.io/ingress-nginx/">Ingress Nginx</a> - is an Ingress controller for Kubernetes using NGINX as a
reverse proxy and load balancer.</p>
<p>In the previous classes we used Google implementation of Ingress - <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/ingress">GKE Ingress for HTTP(S) Load Balancing</a>.
While this solutions provides managed Ingress experience and advanced features like Cloud Armor, DDoS protection and Identity aware proxy.</p>
<p>Ingress Nginx Controller is popular solution and has a lot of features and integrations. If you want to deploy Kubernetes Application on different cloud providers or
On-prem the same way, Nginx Ingress Controller becomes a default option.</p>
<p>Our task is to configure Ingress Nginx using <code>type:LoadBalancer</code> with Regional Static IP configured in the section <a href="#reserve-static-ip-addresses">### Reserve Static IP addresses</a>.
Additionally we want to <strong>enable metrics</strong> service that will fetch Prometheus monitoring metrics from ingress and <strong>disable admissionWebhooks</strong> configuration.</p>
<p><strong>Step 1:</strong> Let's search <code>ingress-nginx</code> in <a href="artifacthub.io">artifacthub.io</a></p>
<div class="codehilite"><pre><span></span><code>helm search hub ingress-nginx
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>URL                                                                  CHART VERSION   APP VERSION     DESCRIPTION                                       
https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx      4.0.0           1.0.0-beta.1    Ingress controller for Kubernetes using NGINX 
https://artifacthub.io/packages/helm/api/ingress-nginx                3.29.1          0.45.0          Ingress controller for Kubernetes using NGINX 
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We going to select the first <code>ingress-nginx</code> chart that is maintained by Kubernetes Community</p>
</div>
<p><strong>Step 2:</strong> Review Hub Page details about this chart and locate information how to add repository:</p>
<div class="codehilite"><pre><span></span><code>https://artifacthub.io/packages/helm/ingress-nginx/ingress-nginx
</code></pre></div>

<p><strong>Result:</strong> The Artifact Page opened with information about the chart, it's parameters, and how to use the chart itself</p>
<p><strong>Step 3:</strong> Add <code>ingress-nginx</code>  Repo:</p>
<div class="codehilite"><pre><span></span><code>helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update  
</code></pre></div>

<p><strong>Step 4:</strong> Oftentimes, searching is a useful way to find not only what <code>charts</code> can be installed, but what <code>versions</code> are available:</p>
<div class="codehilite"><pre><span></span><code>helm search repo ingress-nginx --versions | head
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                            CHART VERSION   APP VERSION     DESCRIPTION                                       
ingress-nginx/ingress-nginx     3.35.0          0.48.1          Ingress controller for Kubernetes using NGINX a...
ingress-nginx/ingress-nginx     3.34.0          0.47.0          Ingress controller for Kubernetes using NGINX a...
ingress-nginx/ingress-nginx     3.33.0          0.47.0          Ingress controller for Kubernetes using NGINX a...
....
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, Helm tries to install the latest <code>stable</code> release of a chart, but you can override this behavior and install a specific version of a chart. Thus it is often useful to see not just the summary info for a chart, but exactly which versions exist for a chart. Every new version of the chart can be bring fixes and new changes, so for production use it's better to go with tested version and pin installation version.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We going with latest listed official version of the chart <code>3.35.0</code> of <code>ingress-nginx</code> Chart.</p>
</div>
<h3 id="322-download-and-inspect-chart-locally">3.2.2 Download and inspect Chart locally<a class="headerlink" href="#322-download-and-inspect-chart-locally" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> Pull <code>ingress-nginx</code> Helm Chart of specific version to Local filesystem:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure/helm
helm pull ingress-nginx/ingress-nginx --version 3.35.0
tar -xvzf  ingress-nginx-3.35.0.tgz
</code></pre></div>

<p><strong>Step 2:</strong>  See the tree structure of the chart</p>
<div class="codehilite"><pre><span></span><code>sudo apt-get install tree
tree -L 2 ingress-nginx
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>ingress-nginx
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ OWNERS
â”œâ”€â”€ README.md
â”œâ”€â”€ ci
â”œâ”€â”€ templates
â”‚   â”œâ”€â”€ NOTES.txt
â”‚   â”œâ”€â”€ _helpers.tpl
â”‚   â”œâ”€â”€ admission-webhooks
â”‚   â”œâ”€â”€ clusterrole.yaml
â”‚   â”œâ”€â”€ clusterrolebinding.yaml
â”‚   â”œâ”€â”€ controller-configmap-addheaders.yaml
â”‚   â”œâ”€â”€ controller-configmap-proxyheaders.yaml
â”‚   â”œâ”€â”€ controller-configmap-tcp.yaml
â”‚   â”œâ”€â”€ controller-configmap-udp.yaml
â”‚   â”œâ”€â”€ controller-configmap.yaml
â”‚   â”œâ”€â”€ controller-daemonset.yaml
â”‚   â”œâ”€â”€ controller-deployment.yaml
â”‚   â”œâ”€â”€ controller-hpa.yaml
â”‚   â”œâ”€â”€ controller-ingressclass.yaml
â”‚   â”œâ”€â”€ controller-keda.yaml
â”‚   â”œâ”€â”€ controller-poddisruptionbudget.yaml
â”‚   â”œâ”€â”€ controller-prometheusrules.yaml
â”‚   â”œâ”€â”€ controller-psp.yaml
â”‚   â”œâ”€â”€ controller-role.yaml
â”‚   â”œâ”€â”€ controller-rolebinding.yaml
â”‚   â”œâ”€â”€ controller-service-internal.yaml
â”‚   â”œâ”€â”€ controller-service-metrics.yaml
â”‚   â”œâ”€â”€ controller-service-webhook.yaml
â”‚   â”œâ”€â”€ controller-service.yaml
â”‚   â”œâ”€â”€ controller-serviceaccount.yaml
â”‚   â”œâ”€â”€ controller-servicemonitor.yaml
â”‚   â”œâ”€â”€ default-backend-deployment.yaml
â”‚   â”œâ”€â”€ default-backend-hpa.yaml
â”‚   â”œâ”€â”€ default-backend-poddisruptionbudget.yaml
â”‚   â”œâ”€â”€ default-backend-psp.yaml
â”‚   â”œâ”€â”€ default-backend-role.yaml
â”‚   â”œâ”€â”€ default-backend-rolebinding.yaml
â”‚   â”œâ”€â”€ default-backend-service.yaml
â”‚   â”œâ”€â”€ default-backend-serviceaccount.yaml
â”‚   â””â”€â”€ dh-param-secret.yaml
â””â”€â”€ values.yaml
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Typical structure of the helm chart, where:</p>
<ul>
<li>The <code>Chart.yaml</code> file contains metadata and some functionality controls for the chart</li>
<li><code>templates</code> folder contains all <code>yaml</code> manifests in <a href="https://pkg.go.dev/text/template">Go templates</a> and used to generate Kubernetes manifests</li>
<li><code>values.yaml</code> contains <code>default</code> values applied during the rendering.</li>
<li>The <code>NOTES.txt</code> file is a special template. When a chart is installed, the NOTES.txt template is rendered and displayed rather than being installed into a cluster.</li>
</ul>
</div>
<h3 id="322-helm-template">3.2.2 Helm Template<a class="headerlink" href="#322-helm-template" title="Permanent link">&para;</a></h3>
<p>As a reminder our goal it customize Nginx deployment to configure Ingress Nginx using <code>type:LoadBalancer</code> with Regional Static IP configured in the section <a href="#reserve-static-ip-addresses">### Reserve Static IP addresses</a>.
Additionally we want to <strong>enable metrics</strong> service that will fetch Prometheus monitoring metrics from ingress and <strong>disable admissionWebhooks</strong> configuration.</p>
<p><strong>Step 1:</strong> Review <code>values.yaml</code></p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure/helm/ingress-nginx
edit values.yaml
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>It is pretty confusing at this point to understand what this chart is going to deploy,
it would of been great to render to YAML format first.</p>
</div>
<p><strong>Step 2:</strong> Execute <code>helm template</code> command and store output in <code>render.yaml</code></p>
<div class="codehilite"><pre><span></span><code>helm template ingress-nginx/ingress-nginx --version 3.35.0  &gt; render.yaml
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>During helm template, Helm never contacts a remote Kubernetes server, hence the chart only has access to default Kubernetes kinds.
The template command always acts like an installation.</p>
</div>
<p>Review rendered values:</p>
<div class="codehilite"><pre><span></span><code>edit render.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>grep &quot;Source&quot; render.yaml
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p><code>helm template</code> designed to isolate the template rendering process of Helm from the installation. 
The template command performs following phases of Helm Lifecycle:</p>
<ul>
<li>loads the chart</li>
<li>determines the values</li>
<li>renders the templates</li>
<li>formats to YAML</li>
</ul>
</div>
<p><strong>Step 3:</strong> Let's first create a configuration that will disable <code>admissionWebhooks</code>.
Review looking in <code>values.yaml</code> for admissionWebhooks configuration: </p>
<div class="codehilite"><pre><span></span><code>grep -A10 admissionWebhooks values.yaml
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>  admissionWebhooks:
    annotations: {}
    enabled: true
    failurePolicy: Fail
    # timeoutSeconds: 10
    port: 8443
    certificate: &quot;/usr/local/certificates/cert&quot;
    key: &quot;/usr/local/certificates/key&quot;
    namespaceSelector: {}
    objectSelector: {}
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>admissionWebhooks <code>enabled: true</code></p>
</div>
<p><strong>Step 3:</strong> Let's create <code>custom_values.yaml</code> file with  admissionWebhooks disabled</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; custom_values.yaml
controller:
  admissionWebhooks:
    enabled: false
EOF
</code></pre></div>

<p>Execute <code>helm template</code> and store output in new file <code>render2.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>helm template ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0  &gt; render2.yaml
</code></pre></div>

<p>Now comparing this 2 render files you can see the what change in configuration has resulted in the rendered file:</p>
<div class="codehilite"><pre><span></span><code>diff render.yaml render2.yaml
</code></pre></div>

<p>This is the YAML files that will be generated after this change:</p>
<div class="codehilite"><pre><span></span><code>grep &quot;Source&quot; render2.yaml
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code># Source: ingress-nginx/templates/controller-serviceaccount.yaml
# Source: ingress-nginx/templates/controller-configmap.yaml
# Source: ingress-nginx/templates/clusterrole.yaml
# Source: ingress-nginx/templates/clusterrolebinding.yaml
# Source: ingress-nginx/templates/controller-role.yaml
# Source: ingress-nginx/templates/controller-rolebinding.yaml
# Source: ingress-nginx/templates/controller-service.yaml
# Source: ingress-nginx/templates/controller-deployment.yaml
</code></pre></div>

<p><strong>Step 4:</strong> Now, let's add a custom Configuration to <code>controller-service.yaml</code> to use Static <code>loadBalancerIP</code>, 
we've configured in step <a href="#reserve-static-ip-addresses">### Reserve Static IP addresses</a>. First we need to locate 
the correct service parameters:</p>
<div class="codehilite"><pre><span></span><code>grep -A20 &quot;service:&quot; values.yaml 
</code></pre></div>

<div class="admonition output">
<p class="admonition-title">Output</p>
<p>Shows that we have 4 different services in values file</p>
</div>
<p>Let's narrow our search:</p>
<div class="codehilite"><pre><span></span><code>grep -A20 &quot;service:&quot; values.yaml | grep  &quot;List of IP address&quot;
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>    ## List of IP addresses at which the controller services are available
      ## List of IP addresses at which the stats-exporter service is available
    ## List of IP addresses at which the default backend service is available
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>  service:
    enabled: true

    annotations: {}
    labels: {}
    # clusterIP: &quot;&quot;

    ## List of IP addresses at which the controller services are available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    # loadBalancerIP: &quot;&quot;
    loadBalancerSourceRanges: []
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>It seems controller is first <code>service:</code> in values.yaml and currently is  it has <code>loadBalancerIP</code> section commented</p>
</div>
<p><strong>Step 5:</strong> Let's add <code>loadBalancerIP</code> IP configuration to <code>custom_values.yaml</code></p>
<p>Set variable:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/ip-infrastructure
export STATIC_IP_ADDRESS=$(terraform output | grep &#39;addresses&#39; |awk &#39;{ print $3}&#39;)
echo $STATIC_IP_ADDRESS
</code></pre></div>

<p>Add custom values:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure/helm/ingress-nginx
cat &lt;&lt; EOF&gt;&gt; custom_values.yaml
  service:
    loadBalancerIP: $STATIC_IP_ADDRESS
EOF
</code></pre></div>

<p>Our final <code>custom_values.yaml</code> should look as following:</p>
<div class="codehilite"><pre><span></span><code>controller:
  admissionWebhooks:
    enabled: false
  service:
    loadBalancerIP: 35.X.X.X
  metrics:
    enabled: true
</code></pre></div>

<p>Execute <code>helm template</code> and store output in new file <code>render3.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>helm template ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0  &gt; render3.yaml
</code></pre></div>

<p>Show the difference in rendered file:</p>
<div class="codehilite"><pre><span></span><code>diff render2.yaml render3.yaml
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>&gt;   loadBalancerIP: 35.X.X.X
</code></pre></div>

<p>Ensure that this change is in fact belongs to <code>controller-service.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>grep -C16  &quot;loadBalancerIP:&quot; render3.yaml
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We configured correct service that will Ingress Controller service with <code>type: Loadbalancer</code> and 
static IP with previously generated with terraform.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p><code>helm template</code> is great tool to render you charts to YAML.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can use Helm as packaging you charts only. And then use  <code>helm template</code> to generate actual YAMLs and apply them with <code>kubectl apply</code></p>
</div>
<h3 id="323-dry-runs">3.2.3 Dry-Runs<a class="headerlink" href="#323-dry-runs" title="Permanent link">&para;</a></h3>
<p>Before applying configuration to Kubernetes Cluster it is good idea to Dry-Run it for Errors. This is especially important if you doing Upgrades.</p>
<p>The dry-run feature provides Helm users a way to debug the output of a chart before it is sent on to Kubernetes. With all of the templates rendered, 
you can inspect exactly what would have been submitted to your cluster. And with the release data, you can verify that the release would have been created as you expected.</p>
<p>Here is some of the <code>dry-run</code> working principals:</p>
<ul>
<li><code>--dry-run</code> mixes non-YAML information with the rendered templates. This means the data has to be cleaned up before being sent to tools like kubectl.</li>
<li>A <code>--dry-run</code> on upgrade can produce different YAML output than a --dry-run on install, and this can be confusing.</li>
<li>It contacts the Kubernetes API server for validation, which means Helm has to have Kubernetes credentials even if it is just used to --dry-run a release.</li>
<li>It also inserts information into the template engine that is cluster-specific. Because of this, the output of some rendering processes may be cluster-specific.</li>
</ul>
<p>Difference between <code>dry-run</code> and <code>template</code> is that the <code>dry-run</code> contacts Kubernetes API. It is good idea to use <code>dry-run</code> prior deployment and upgrade as it creates mutated output, while <code>template</code>
doesn't contacts API and can to pure rendering.</p>
<p><strong>Step 1:</strong> Execute our deployment with <code>dry-run</code> command:</p>
<div class="codehilite"><pre><span></span><code>helm install ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --dry-run
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME: ingress-nginx
LAST DEPLOYED: Tue Aug 10 07:22:56 2021
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: ingress-nginx/templates/controller-serviceaccount.yaml
........
NOTES:
The ingress-nginx controller has been installed.
It may take a few minutes for the LoadBalancer IP to be available.
You can watch the status by running &#39;kubectl --namespace default get services -o wide -w ingress-nginx-controller&#39;

An example Ingress that makes use of the controller:
...
If TLS is enabled for the Ingress, a Secret containing the certificate and key must also be provided:

  apiVersion: v1
  kind: Secret
  metadata:
    name: example-tls
    namespace: foo
  data:
    tls.crt: &lt;base64 encoded cert&gt;
    tls.key: &lt;base64 encoded key&gt;
  type: kubernetes.io/tls
</code></pre></div>

<p>At the top of the output, it will print some information about the release in our case it tells what phase of the release it is in (pending-install),
and the revision number. Next, after the informational block, all of the rendered templates are dumped to standard output. Finally, at the bottom of the dry-run output,
Helm prints the user-oriented release notes:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>--dry-run</code> dumps the output validates, but doesn't deploy actual chart.</p>
</div>
<p><strong>Step 2:</strong> Finally let's deploy Nginx Ingress Charts with our parameters in <code>ingress-nginx</code> namespace</p>
<div class="codehilite"><pre><span></span><code>kubectl create ns ingress-nginx
helm install ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx
</code></pre></div>

<p><strong>Step 3:</strong> Verify Helm Deployment:</p>
<div class="codehilite"><pre><span></span><code>helm list
</code></pre></div>

<p>Follow Installation note and verify Ingress-Controller Service:</p>
<div class="codehilite"><pre><span></span><code>kubectl --namespace ingress-nginx get services -o wide ingress-nginx-controller
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                       TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)                      AGE
ingress-nginx-controller   LoadBalancer   172.10.0.213   35.192.101.76   80:30930/TCP,443:30360/TCP   3m9s
</code></pre></div>

<h3 id="324-deploy-drupal-using-nginx-ingress-controller">3.2.4 Deploy Drupal using Nginx Ingress Controller<a class="headerlink" href="#324-deploy-drupal-using-nginx-ingress-controller" title="Permanent link">&para;</a></h3>
<p>Let's test our newly configured <code>ingress-nginx-controller</code> and expose <code>drupal</code> application using ingress instead of <code>LoadBalancer</code>. </p>
<p>Check if STATIC_IP_ADDRESS variable is set:</p>
<div class="codehilite"><pre><span></span><code>echo $STATIC_IP_ADDRESS
</code></pre></div>

<p>If not set it with you Static IP address value.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure/helm/
kubectl delete pvc data-mywebsite-mariadb-0
cat &lt;&lt; EOF&gt;&gt; drupal_ing_values.yaml
ingress:
  annotations: {kubernetes.io/ingress.class: &quot;nginx&quot;}
  enabled: true
  hostname: $STATIC_IP_ADDRESS.nip.io
  path: /
  pathType: ImplementationSpecific
EOF
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Here we using <code>nip.io</code> domain that provides simple wildcard DNS for any IP Address,
however if you provided you STATIC_IP to teacher, they will generate following DNS,
and you can replace <code>hostname:</code> with value <code>$student-name.cloud-montreal.ca</code></p>
</div>
<div class="codehilite"><pre><span></span><code>helm install  mywebsite bitnami/drupal --values drupal_ing_values.yaml 
</code></pre></div>

<div class="codehilite"><pre><span></span><code>1. Get the Drupal URL:

  You should be able to access your new Drupal installation through

  http://35.X.X.X.nip.io/
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Drupal site is now accessible via Ingress. Our Nginx Ingress Controller has been setup correctly!</p>
</div>
<p>Uninstall Drupal:</p>
<div class="codehilite"><pre><span></span><code>helm uninstall mywebsite
kubectl delete pvc data-mywebsite-mariadb-0
</code></pre></div>

<h3 id="325-using-set-values-and-upgrading-charts">3.2.5  Using  <code>--set</code> values and Upgrading Charts<a class="headerlink" href="#325-using-set-values-and-upgrading-charts" title="Permanent link">&para;</a></h3>
<p>In addition to <code>--value</code> option, there is a second flag that can be used to add individual parameters to an <code>install</code> or <code>upgrade</code>. 
The <code>--set</code> flag takes one or more values directly. They do not need to be stored in a YAML file.</p>
<p><strong>Step 1:</strong> Let's update our <code>ingress-nginx</code> release with new parameter <code>--set controller.image.pullPolicy=Always</code>, but first we want to render template with and without parameter to see what the change will be applied:</p>
<div class="codehilite"><pre><span></span><code>helm template ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx  &gt; render4.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm template ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx --set controller.image.pullPolicy=Always &gt; render5.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>diff render4.yaml render5.yaml
</code></pre></div>

<p>Output:</p>
<div class="codehilite"><pre><span></span><code>&lt;           imagePullPolicy: IfNotPresent
---
&gt;           imagePullPolicy: Always
</code></pre></div>

<p><strong>Step 2:</strong> Let's apply update to our <code>ingress-nginx</code> release. For that we going to use <code>helm upgrade</code> command:</p>
<div class="codehilite"><pre><span></span><code>helm upgrade ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx --set controller.image.pullPolicy=Always 
</code></pre></div>

<p>Verify that upgrade was successful:</p>
<div class="codehilite"><pre><span></span><code>helm list --namespace ingress-nginx
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                APP VERSION
ingress-nginx   ingress-nginx   2               2021-08-10 10:48:35.265506 -0400 EDT    deployed        ingress-nginx-3.35.0 0.48.1 
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We can see that Revision change to <code>2</code></p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When we talk about upgrading in Helm, we talk about upgrading an installation, not a chart. An installation is a particular instance of a chart in your cluster. 
When you run <code>helm install</code>, it creates the installation. To modify that installation, use <code>helm upgrade</code>.
This is an important distinction to make in the present context because upgrading an installation can consist of two different kinds of changes:</p>
<div class="codehilite"><pre><span></span><code>* You can upgrade the version of the chart

* You can upgrade the configuration of the installation
</code></pre></div>

<p>In this case we upgrading the configuration of the installation.</p>
</div>
<div class="admonition extra">
<p class="admonition-title">Extra</p>
<p>If you interested upgrade chart version of ingress-nginx to the next available release or <code>3.34.0</code>, give it a try.</p>
</div>
<h3 id="325-listing-releases-history-rollbacks">3.2.5  Listing Releases, History, Rollbacks<a class="headerlink" href="#325-listing-releases-history-rollbacks" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> Let's see if we can upgrade our release with wrong value <code>pullPolicy=NoSuchPolicy</code> that doesn't exist on Kubernetes.
We will first run in <code>dry-run</code> mode</p>
<div class="codehilite"><pre><span></span><code>helm upgrade ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx --set controller.image.pullPolicy=NoSuchPolicy --dry-run
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Release "ingress-nginx" has been upgraded. Happy Helming!</p>
</div>
<p>Let's now apply same config without <code>--dry-run</code> mode:</p>
<div class="codehilite"><pre><span></span><code>helm upgrade ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx --set controller.image.pullPolicy=NoSuchPolicy
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>Error: UPGRADE FAILED: cannot patch &quot;ingress-nginx-controller&quot; with kind Deployment: Deployment.apps &quot;ingress-nginx-controller&quot; is invalid: spec.template.spec.containers[0].imagePullPolicy: Unsupported value: &quot;NoSuchPolicy&quot;: supported values: &quot;Always&quot;, &quot;IfNotPresent&quot;, &quot;Never&quot;
</code></pre></div>

<div class="admonition failed">
<p class="admonition-title">Failed</p>
<p>As the error message indicates, a pull policy cannot be set to NoSuchPolicy. This error came from the Kubernetes API server, which means Helm submitted the manifest, 
and Kubernetes rejected it. So our release should be in a failed state.</p>
</div>
<p>Verify with <code>helm list</code> to confirm <code>failed</code> state:</p>
<div class="codehilite"><pre><span></span><code>helm list
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME            NAMESPACE       REVISION        UPDATED                                 STATUS  CHART                APP VERSION
ingress-nginx   ingress-nginx   3               2021-08-10 11:03:05.224405 -0400 EDT    failed  ingress-nginx-3.35.0 0.48.1   
</code></pre></div>

<p><strong>Step 2:</strong> List all releases with <code>helm history</code>:</p>
<div class="codehilite"><pre><span></span><code>helm history ingress-nginx -n ingress-nginx
</code></pre></div>

<div class="codehilite"><pre><span></span><code>REVISION        UPDATED                         STATUS          CHART                   APP VERSION     DESCRIPTION     
1               Tue Aug 10 08:47:32 2021        superseded      ingress-nginx-3.35.0    0.48.1          Install complete
2               Tue Aug 10 10:48:35 2021        deployed        ingress-nginx-3.35.0    0.48.1          Upgrade complete
3               Tue Aug 10 11:03:05 2021        failed          ingress-nginx-3.35.0    0.48.1          Upgrade &quot;ingress-nginx&quot; failed: cannot patch &quot;ingress-nginx-controller&quot; with kind Deployment: Deployment.apps &quot;ingress-nginx-controller&quot; is invalid: spec.template.spec.containers[0].imagePullPolicy: Unsupported value: &quot;NoSuchPolicy&quot;: supported values: &quot;Always&quot;, &quot;IfNotPresent&quot;, &quot;Never&quot;
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>During the life cycle of a release, it can pass through several different statuses. Here they are, approximately in the order you would likely see them:</p>
<ul>
<li>
<p><code>pending-install</code> Before sending the manifests to Kubernetes, Helm claims the installation by creating a release (marked version 1) whose status is set to pending-install.</p>
</li>
<li>
<p><code>deployed</code> As soon as Kubernetes accepts the manifest from Helm, Helm updates the release record, marking it as deployed.</p>
</li>
<li>
<p><code>pending-upgrade</code> When a Helm upgrade is begun, a new release is created for an installation (e.g., v2), and its status is set to pending-upgrade.</p>
</li>
<li>
<p><code>superseded</code> When an upgrade is run, the last deployed release is updated, marked as superseded, and the newly upgraded release is changed from pending-upgrade to deployed.</p>
</li>
<li>
<p><code>pending-rollback</code> If a rollback is created, a new release (e.g., v3) is created, and its status is set to pending-rollback until Kubernetes accepts the release manifest. Then it is marked deployed and the last release is marked superseded.</p>
</li>
<li>
<p><code>uninstalling</code> When a helm uninstall is executed, the most recent release is read and then its status is changed to uninstalling.</p>
</li>
<li>
<p><code>uninstalled</code> If history is preserved during deletion, then when the helm uninstall is complete, the last releaseâ€™s status is changed to uninstalled.</p>
</li>
<li>
<p><code>failed</code> Finally, if during any operation, Kubernetes rejects a manifest submitted by Helm, Helm will mark that release failed.</p>
</li>
</ul>
</div>
<p><strong>Step 3:</strong> Rollback release with <code>helm rollback</code>.</p>
<p>From the error, we know that the release failed because we supplied an invalid image pull policy. So of course we could correct this by simply running another helm upgrade. 
But imagine a case where the cause of error was not readily available. Rather than leave the application in a failed state while diagnosing the problem, it would be nice to 
simply revert back to the release that worked before.</p>
<div class="codehilite"><pre><span></span><code>helm rollback ingress-nginx 2 -n ingress-nginx
helm history ingress-nginx -n ingress-nginx
helm list
</code></pre></div>

<div class="codehilite"><pre><span></span><code>4               Tue Aug 10 11:16:24 2021        deployed        ingress-nginx-3.35.0    0.48.1          Rollback to 2  
---
ingress-nginx   ingress-nginx   4               2021-08-10 11:16:24.424371 -0400 EDT    deployed        ingress-nginx-3.35.0    0.48.1  
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Rollback was a success! Happy Helming!
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>This command tells Helm to fetch the ingress-nginx version 2 release, and resubmit that manifest to Kubernetes. 
A rollback does not restore to a previous snapshot of the cluster. Helm does not track enough information to do that. What it does is resubmit the previous configuration, 
and Kubernetes attempts to reset the resources to match.</p>
</div>
<h3 id="325-upgrade-release-with-helm-diff-plugin">3.2.5  Upgrade Release with Helm <code>Diff</code> Plugin<a class="headerlink" href="#325-upgrade-release-with-helm-diff-plugin" title="Permanent link">&para;</a></h3>
<p>While Helm provides a lot of functionality out of the box. Community contributes a lot of great functionality via helm plugins.</p>
<p>Plugins allow you to add extra functionality to Helm and integrate seamlessly with the CLI, making them a popular choice for users with unique workflow requirements. 
There are a number of third-party plugins available online for common use cases, such as secrets management. In addition, plugins are incredibly easy to build on your own for unique, one-off tasks.</p>
<p>Helm plugins are external tools that are accessible directly from the Helm CLI. They allow you to add custom subcommands to Helm without making any modifications to Helmâ€™s Go source code.</p>
<p>Many third-party plugins are made open source and publicly available on GitHub. Many of these plugins use the â€œhelm-pluginâ€ tag/topic to make them easy to find. Refer to the documentation for <a href="https://github.com/topics/helm-plugin">Helm plugins on GitHub</a></p>
<p>Let's Upgrade our running Ingress Nginx chart with metrics service that will enable Prometheus to scrape metrics from our Nginx.</p>
<p><strong>Step 1:</strong> Update <code>custom_values.yaml</code> with following information:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; custom_values.yaml
  metrics:
    enabled: true
EOF
</code></pre></div>

<p><strong>Step 2:</strong> So far we've used <code>helm template</code> to render and compare manifests. However most of the time you might not be able to do it during upgrades.
However you want to have a clear understanding what will be upgraded if you change something.</p>
<p>That's where <a href="https://github.com/databus23/helm-diff">Helm Diff Plugin</a> can be handy. 
Helm Diff plugin giving your a preview of what a helm upgrade would change. It basically generates a diff between the latest deployed version of a release and a <code>helm upgrade --dry-run</code></p>
<p>Install Helm Diff Plugin:</p>
<div class="codehilite"><pre><span></span><code>helm plugin install https://github.com/databus23/helm-diff
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm diff upgrade ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>-           imagePullPolicy: Always
+           imagePullPolicy: IfNotPresent
+               protocol: TCP
+             - name: metrics
+               containerPort: 1025
+ # Source: ingress-nginx/templates/controller-service-metrics.yaml
+ apiVersion: v1
+ kind: Service
...
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Amazing! This looks like <code>terraform plan</code> but for helm :) </p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Another discovery from above printout is that since we forgot to add <code>--set imagePullPolicy</code> command, our value will be reverted with upgrade.
This is really important to understand as you configuration maybe lost if you use <code>--set</code></p>
</div>
<p><strong>Step 3:</strong> Let's upgrade our <code>ingress-nginx</code> release:</p>
<div class="codehilite"><pre><span></span><code>helm  upgrade ingress-nginx ingress-nginx/ingress-nginx --values custom_values.yaml --version 3.35.0 --namespace ingress-nginx
 helm list -n ingress-nginx
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Our <code>ingress-nginx</code> is ready to run. Going forward we going to always deploy this chart.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>So far we've learned:</p>
<ul>
<li>
<p>How to customize helm chart deployment using <code>--set</code> and <code>--values</code> using values.yaml</p>
</li>
<li>
<p>Using <code>values.yaml</code> preferable mehtod in order to achieve reproducible deployments</p>
</li>
<li>
<p>How to upgrade and rollback releases</p>
</li>
<li>
<p>Helm template and dry-run</p>
</li>
<li>
<p>Helm Diff Plugin</p>
</li>
</ul>
</div>
<h3 id="326-install-minio-with-helm">3.2.6 Install Minio with Helm<a class="headerlink" href="#326-install-minio-with-helm" title="Permanent link">&para;</a></h3>
<p>Let's deploy another Helm application on our Kubernetes cluster: <a href="https://min.io/">Minio</a> - high-performance, S3 compatible object storage.</p>
<div class="codehilite"><pre><span></span><code>helm install myminio bitnami/minio
</code></pre></div>

<p>Follow your <code>Minio</code> Helm Chart <code>notes</code> Instruction to access Website:</p>
<div class="codehilite"><pre><span></span><code>To access the MinIO&amp;reg; web UI:

- Get the MinIO&amp;reg; URL:

   echo &quot;MinIO&amp;reg; web URL: http://127.0.0.1:9000/minio&quot;
   kubectl port-forward --namespace default svc/myminio 8080:9000
</code></pre></div>

<p>In Gcloud console execute <code>kubectl port-forward</code>:</p>
<div class="codehilite"><pre><span></span><code>kubectl port-forward --namespace default svc/myminio 8080:9000
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We can access Minio UI using private IP via tunnel and we have to use autogenerated ACCESS_KEY and SECRET_KEY.</p>
</div>
<p>Uninstall the Minio chart:</p>
<div class="codehilite"><pre><span></span><code>helm uninstall myminio bitnami/minio
</code></pre></div>

<p>While it looks easy to start with helm and deploy any charts, most of the time you want to have a full control of the deployment process.
You want to specify, tested version, safe values or configurations that make sense for you or your organization.</p>
<h3 id="327-customize-minio-installation-task">3.2.7 Customize Minio Installation Task<a class="headerlink" href="#327-customize-minio-installation-task" title="Permanent link">&para;</a></h3>
<p><strong>Task N1:</strong> Customize Minio Installation with following values:</p>
<div class="codehilite"><pre><span></span><code>* Deploy `Minio` of specific version: `7.1.7`
* Expose Minio using `Ingress` resource:
    * ingress.class: &quot;nginx&quot;
    * path: &quot;/&quot;
    * pathType: &quot;ImplementationSpecific&quot;
    * hostname: $STATIC_IP_ADDRESS.nip.io
* Specify custom `ACCESS_KEY` for `Minio` frontend: `myaccesskey`    
* Specify custom `SECRET_KEY` for `Minio` frontend: `mysecretkey`
</code></pre></div>

<p><strong>Step 1:</strong> Use the following Minio Chart:</p>
<div class="codehilite"><pre><span></span><code>helm search hub minio
</code></pre></div>

<div class="codehilite"><pre><span></span><code>URL                                                     CHART VERSION   APP VERSION                                     DESCRIPTION                                       
https://artifacthub.io/packages/helm/bitnami/minio      7.1.7           2021.6.17                                       Bitnami Object Storage based on MinIO&amp;reg
.....
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We going to choose <code>bitnami</code> package again as it's top of the list and seems maintained the most.</p>
</div>
<p><strong>Step 2:</strong> Since we already added <code>bitnami</code> repository locally, let's verify if we can list <code>minio</code> in it:</p>
<div class="codehilite"><pre><span></span><code>helm search repo minio
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We can now go ahead and install <code>minio</code> </p>
</div>
<p><strong>Step 4:</strong> Pull <code>Minio</code> Helm Chart of specific version to Local filesystem to work with values file.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure/helm
helm pull bitnami/minio --version 7.1.7
</code></pre></div>

<p>cd minio</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; custom_values.yaml
TODO: Finish the remaining steps
EOF
</code></pre></div>

<p><strong>TODO:</strong> Complete <code>custom_values.yaml</code> and test deployment of <code>Minio</code>. Test Minio by creating <code>bucket</code> and uploading <code>object</code> to it. </p>
<p><strong>Step 5:</strong> Test and Install Minio Chart with Custom Configuration</p>
<div class="codehilite"><pre><span></span><code>helm install myminio bitnami/minio --values custom_values.yaml --version 7.1.6
</code></pre></div>

<p>Follow your <code>Minio</code> Helm Chart <code>notes</code> Instruction to access Website.</p>
<p><strong>Step 6</strong> Commit <code>deploy_ycit020_a4/helm</code> and <code>notepad-infrastructure/helm</code> folder using the following Git commands:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
</code></pre></div>

<div class="codehilite"><pre><span></span><code>git add .
git commit -m &quot;Helm values for Minio&quot;
</code></pre></div>

<p><strong>Step 7</strong> Push commit to the Cloud Source Repositories:</p>
<div class="codehilite"><pre><span></span><code>git push origin master
</code></pre></div>

<p><strong>Step 8</strong>  Uninstall the Minio chart:</p>
<div class="codehilite"><pre><span></span><code>helm uninstall myminio bitnami/minio
</code></pre></div>

<h2 id="4-creating-notepad-helm-charts">4 Creating NotePad Helm Charts<a class="headerlink" href="#4-creating-notepad-helm-charts" title="Permanent link">&para;</a></h2>
<p>So far with learned how to deploy existing charts from the Artifact Hub.</p>
<p>However sometimes you or your company needs to build software that require's to be distributed and shared externally,
as well as have lifecycle and release management. Helm Charts becomes are valuable option for that, specifically if you application is based
of containers!</p>
<p>Imagine that our solution is Go-based NotePad has first customer that wants to deploy it on their system and they requested delivery via
Helm Charts that available on GCP based Helm Repository. To achieve such task we going to create 2 Charts:</p>
<div class="codehilite"><pre><span></span><code>* `gowebapp-mysql` chart
* `gowebapp` chart
</code></pre></div>

<p>And store them in <a href="https://cloud.google.com/artifact-registry/docs/helm/manage-charts">Google Artifact Registry</a> that provides Helm 3 OCI Repository.</p>
<h3 id="41-design-gowebapp-mysql-chart">4.1 Design <code>gowebapp-mysql</code> chart<a class="headerlink" href="#41-design-gowebapp-mysql-chart" title="Permanent link">&para;</a></h3>
<h4 id="411-create-gowebapp-mysql-chart">4.1.1  Create <code>gowebapp-mysql</code> chart<a class="headerlink" href="#411-create-gowebapp-mysql-chart" title="Permanent link">&para;</a></h4>
<p>As scary as it sounds creating a new basic helm chart is 5 minute thing! We going to learn 2 quick methods to create helm charts, that will help you to save time and get started with helm quickly.</p>
<p>Helm includes the <code>helm create</code> command to make it easy for you to create a chart of your own, and itâ€™s a great way to get started.</p>
<p>The create command creates a chart for you, with all the required chart structure and files. These files are documented to help you understand what is needed, and the templates it provides 
showcase multiple Kubernetes manifests working together to deploy an application. In addition, you can install and test this chart right out of the box.</p>
<p><strong>Step 1:</strong> Create a new chart:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm create gowebapp-mysql
</code></pre></div>

<div class="codehilite"><pre><span></span><code>cd gowebapp-mysql
tree
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ charts
â”œâ”€â”€ templates
â”‚   â”œâ”€â”€ NOTES.txt
â”‚   â”œâ”€â”€ _helpers.tpl
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ hpa.yaml
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ serviceaccount.yaml
â”‚   â””â”€â”€ tests
â”‚       â””â”€â”€ test-connection.yaml
â””â”€â”€ values.yaml
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>This command creates a new Nginx chart, with a name of your choice, following best practices for a chart layout. Since Kubernetes clusters can have different methods to expose an application, this chart makes the way Nginx is exposed to network traffic configurable so it can be exposed in a wide variety of clusters. The chart has following structure:</p>
<ul>
<li>The <code>Chart.yaml</code> file contains metadata and some functionality controls for the chart</li>
<li>The <code>charts</code> folder currently empty may container charts dependency of the top level chart. For example we could of make our <code>gowebapp-mysql</code> as dependency chart for <code>gowebapp</code></li>
<li><code>templates</code> folder contains all <code>yaml</code> manifests in <a href="https://pkg.go.dev/text/template">Go templates</a> and used to generate Kubernetes manifests</li>
<li><code>values.yaml</code> contains <code>default</code> values applied during the rendering.</li>
<li>The <code>NOTES.txt</code> file is a special template. When a chart is installed, the NOTES.txt template is rendered and displayed rather than being installed into a cluster.</li>
<li><code>_helpers.tpl</code> - helper templates for your other templates (e.g creating same labers across all charts). Files with <code>_</code> are not rendered to Kubernetes object definitions, but are available everywhere within other chart templates for use.</li>
</ul>
</div>
<p>Here we going to show a quick way to create a Helm chart without adding any templating.</p>
<p><strong>Step 2:</strong> Delete <code>templates</code> folder and create empty one:</p>
<div class="codehilite"><pre><span></span><code>rm -rf templates
mkdir templates
cd templates
</code></pre></div>

<p><strong>Step 3:</strong> Copy existing <code>gowebapp-mysql</code> manifests to <code>templates</code> folder:</p>
<div class="codehilite"><pre><span></span><code>cp -r ~/$MY_REPO/deploy_ycit020_a4/k8s-manifests/gowebapp-mysql-pvc.yaml  .         # PVC
cp -r ~/$MY_REPO/deploy_ycit020_a4/k8s-manifests/secret-mysql.yaml   .              # Secret
cp -r ~/$MY_REPO/deploy_ycit020_a4/k8s-manifests/gowebapp-mysql-service.yaml .      # Service
cp -r ~/$MY_REPO/deploy_ycit020_a4/k8s-manifests/gowebapp-mysql-deployment.yaml .   # Deployment
</code></pre></div>

<p><strong>Step 4:</strong> Lint Helm Chart:</p>
<p>When developing charts, especially when working with YAML templates, it can be easy to make a mistake or miss something. 
To help you catch errors, bugs, style issues, and other suspicious elements, the Helm client includes a linter. 
This linter can be used during chart development and as part of any testing processes.</p>
<p>To use the linter, use the <code>lint</code> command on a chart as a directory or a packaged archive:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
helm lint gowebapp-mysql
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>==&gt; Linting gowebapp-mysql
[INFO] Chart.yaml: icon is recommended

1 chart(s) linted, 0 chart(s) failed
</code></pre></div>

<p><strong>Step 5:</strong>  Install Helm Chart locally:</p>
<p>Create <code>dev</code> namespace:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/gowebapp-mysql
kubectl create ns dev
kubectl config set-context --current --namespace=dev
</code></pre></div>

<p>Render the manifest locally and compare to original manifests:</p>
<div class="codehilite"><pre><span></span><code>helm template gowebapp-mysql . &gt; render.yaml
</code></pre></div>

<p>Install the chart:</p>
<div class="codehilite"><pre><span></span><code>helm install gowebapp-mysql .
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME: gowebapp-mysql
LAST DEPLOYED: Tue Aug 10 15:25:44 2021
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm list
kubectl get all
kubectl get pvc
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>We've deployed our own helm chart locally. While we haven't used templating of the chart at all, we have a helm chart that can be installed and upgraded using helm release features.</p>
</div>
<h3 id="42-design-gowebapp-chart">4.2  Design <code>gowebapp</code> chart.<a class="headerlink" href="#42-design-gowebapp-chart" title="Permanent link">&para;</a></h3>
<h4 id="421-create-gowebapp-chart">4.2.1  Create <code>gowebapp</code> chart<a class="headerlink" href="#421-create-gowebapp-chart" title="Permanent link">&para;</a></h4>
<p>We going to use another method to deploy our second chart <code>gowebapp</code>. In this case we going to use <code>nginx</code> template provided by help team. </p>
<p><strong>Task N2:</strong> Create <code>gowebapp</code> Helm chart:</p>
<div class="codehilite"><pre><span></span><code>* Configure `Deployment` template in `values.yaml`
* Configure `Service` template in `values.yaml`
* Disable `Service account` template in `values.yaml`
* Configure `Ingress` template in `values.yaml`:
    * ingress.class: &quot;nginx&quot;
    * path: &quot;/&quot;
    * pathType: &quot;ImplementationSpecific&quot;
    * host: $STATIC_IP_ADDRESS.nip.io
* Templatize the ConfigMap Resource
* Ensure the chart is deployable
* Ensure `gowebapp` in browser
</code></pre></div>

<p><strong>Step 1</strong> Create a new chart:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm create gowebapp
</code></pre></div>

<div class="codehilite"><pre><span></span><code>cd gowebapp
tree
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ charts
â”œâ”€â”€ templates
â”‚   â”œâ”€â”€ NOTES.txt
â”‚   â”œâ”€â”€ _helpers.tpl
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ hpa.yaml
â”‚   â”œâ”€â”€ ingress.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ serviceaccount.yaml
â”‚   â””â”€â”€ tests
â”‚       â””â”€â”€ test-connection.yaml
â””â”€â”€ values.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>edit values.yaml
</code></pre></div>

<h4 id="422-template-the-deployment">4.2.2 Template the Deployment<a class="headerlink" href="#422-template-the-deployment" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Update the replicaCount value to 2 in the <code>values.yaml</code> file:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/values.yaml
</code></pre></div>

<p><strong>Step 2</strong> Update the repository and tag section to point to your <code>gowebapp</code> docker image in the <code>values.yaml</code> file:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/values.yaml
</code></pre></div>

<p><strong>Step 3</strong> Update the resources section in the <code>values.yaml</code> file to include the resource <code>requests</code> and <code>limits</code> the gowebapp application needs:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/values.yaml
</code></pre></div>

<p>See the reference <code>gowebapp-deployment.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>cat ~/$MY_REPO/deploy_ycit020_a4/k8s-manifests/gowebapp-deployment.yaml
</code></pre></div>

<p><strong>Step 4</strong> Update the livness and readiness sections to match what you have in the <code>gowebapp</code> <code>deployment.yaml</code></p>
<p>See the reference <code>gowebapp-deployment.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>cat ~/$MY_REPO/deploy_ycit020_a4/k8s-manifests/gowebapp-deployment.yaml
</code></pre></div>

<p>Update livness and readiness sections for template <code>deployment.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/templates/deployment.yaml
</code></pre></div>

<p><strong>Step 5</strong> Notice that the <code>deployment.yaml</code> file does not have an environment variable section for <code>secrets</code>, so let's add one. For this chart we will assume that this section is optional based on whether or not a secrets section exist in the Values.yaml file.</p>
<p><strong>Step 5-a</strong> Include the following in the deployment template:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/templates/deployment.yaml
</code></pre></div>

<p>And add following code snippet in the appropriate location:</p>
<div class="codehilite"><pre><span></span><code>{{- if .Values.secrets }}
- env:
  - name: {{.Values.secrets.name}}
    valueFrom:
      secretKeyRef:
        name: {{.Values.secrets.secretReference.name}}
        key: {{.Values.secrets.secretReference.key}}
{{- end}}
</code></pre></div>

<p><strong>Step 5-b</strong> Include a section in the <code>values.yaml</code> file:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/values.yaml
</code></pre></div>

<p>Add following snippet:</p>
<div class="codehilite"><pre><span></span><code>secrets:
  enabled: true
  name: DB_PASSWORD
  secretReference:
    name: mysql
    key: password
</code></pre></div>

<p><strong>Step 6</strong> For this lab, we will include the <code>volumes</code> and <code>volumeMounts</code> sections without templating, so just copy the required sections to the appropriate location in the <code>deployment.yaml</code> template.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/templates/deployment.yaml
</code></pre></div>

<p>See the reference <code>gowebapp-deployment.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>cat ~/$MY_REPO/deploy_ycit020_a4/k8s-manifests/gowebapp-deployment.yaml
</code></pre></div>

<p><strong>Step 7</strong>  Render the Chart locally and compare Deployment to original <code>gowebapp-deployment.yaml</code> manifests:</p>
<div class="codehilite"><pre><span></span><code>helm template gowebapp-mysql . &gt; render.yaml
</code></pre></div>

<h4 id="423-template-the-service">4.2.3 Template the Service<a class="headerlink" href="#423-template-the-service" title="Permanent link">&para;</a></h4>
<p><strong>Step 1:</strong> The <code>service.yaml</code> template doesn't have an <code>annotation</code> section, so modify the template to add an <code>annotation</code> section, that looks following:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/templates/service.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>      {{- with .Values.annotations }}
      annotations:
        {{- toYaml . | nindent 4 }}
      {{- end }}
</code></pre></div>

<p><strong>TODO:</strong> Next, modify the <code>values.yaml</code> file to allow chart users to add annotations for the service. Make sure to use the right section in the <code>values.yaml</code> file, based on how you modified your <code>/templates/service.yaml</code> file.</p>
<p>Reference documentation: </p>
<div class="codehilite"><pre><span></span><code>* https://helm.sh/docs/chart_template_guide/control_structures/#modifying-scope-using-with
</code></pre></div>

<p><strong>Step 2:</strong> Under the <code>service:</code> section in the <code>values.yaml</code> file, update the service <code>port:</code> to 9000.</p>
<p><strong>Step 3</strong> In the <code>values.yaml</code> file, update the service type to <code>NodePort</code></p>
<p><strong>Step 4</strong>  Render the Chart locally and compare Service to original <code>gowebapp-service.yaml</code> manifests:</p>
<div class="codehilite"><pre><span></span><code>helm template gowebapp-mysql . &gt; render.yaml
</code></pre></div>

<h4 id="424-disable-the-service-account">4.2.4 Disable the Service account<a class="headerlink" href="#424-disable-the-service-account" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Update the <code>values.yaml</code> file to <code>disable</code> the service account creation for the <code>gowebapp</code> deployment.</p>
<h4 id="425-template-the-ingress-resource">4.2.5 Template the Ingress Resource<a class="headerlink" href="#425-template-the-ingress-resource" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> <code>enable</code> the ingress the <code>values.yaml</code> file and configur according requirements: :</p>
<div class="codehilite"><pre><span></span><code>* Expose `gowebapp` using `Ingress` resource:
    * ingress.class: &quot;nginx&quot;
    * path: &quot;/&quot;
    * pathType: &quot;ImplementationSpecific&quot;
    * host: $STATIC_IP_ADDRESS.nip.io
</code></pre></div>

<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
edit gowebapp/values.yaml
</code></pre></div>

<p><strong>Step 2</strong>  Render the Chart locally and verify if any issues:</p>
<div class="codehilite"><pre><span></span><code>helm template gowebapp-mysql . &gt; render.yaml
</code></pre></div>

<h4 id="425-templatize-the-configmap-resource">4.2.5 Templatize the ConfigMap Resource<a class="headerlink" href="#425-templatize-the-configmap-resource" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong>  Create and templatize <code>configmap</code> resource for our <code>gowebapp</code> that provides connection to Mysql:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/gowebapp/templates/
cat &lt;&lt;EOF&gt;&gt; configmap.yaml
kind: ConfigMap 
apiVersion: v1 
metadata:
  name: {{ .Values.configMap.name }}
data:
  webapp-config-json: |-
{{ .Files.Get &quot;config.json&quot; | indent 4 }}
EOF
</code></pre></div>

<p>Store the <code>config.json</code> inside the chart repository:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/gowebapp
cat &lt;&lt;EOF&gt;&gt; config.json
{
    &quot;Database&quot;: {
        &quot;Type&quot;: &quot;MySQL&quot;,
        &quot;Bolt&quot;: {
            &quot;Path&quot;: &quot;gowebapp.db&quot;
        },
        &quot;MongoDB&quot;: {
            &quot;URL&quot;: &quot;127.0.0.1&quot;,
            &quot;Database&quot;: &quot;gowebapp&quot;
        },
        &quot;MySQL&quot;: {
            &quot;Username&quot;: &quot;root&quot;,
            &quot;Password&quot;: &quot;rootpasswd&quot;,
            &quot;Name&quot;: &quot;gowebapp&quot;,
            &quot;Hostname&quot;: &quot;gowebapp-mysql&quot;,
            &quot;Port&quot;: 3306,
            &quot;Parameter&quot;: &quot;?parseTime=true&quot;
        }
    },
    &quot;Email&quot;: {
        &quot;Username&quot;: &quot;&quot;,
        &quot;Password&quot;: &quot;&quot;,
        &quot;Hostname&quot;: &quot;&quot;,
        &quot;Port&quot;: 25,
        &quot;From&quot;: &quot;&quot;
    },
    &quot;Recaptcha&quot;: {
        &quot;Enabled&quot;: false,
        &quot;Secret&quot;: &quot;&quot;,
        &quot;SiteKey&quot;: &quot;&quot;
    },
    &quot;Server&quot;: {
        &quot;Hostname&quot;: &quot;&quot;,
        &quot;UseHTTP&quot;: true,
        &quot;UseHTTPS&quot;: false,
        &quot;HTTPPort&quot;: 80,
        &quot;HTTPSPort&quot;: 443,
        &quot;CertFile&quot;: &quot;tls/server.crt&quot;,
        &quot;KeyFile&quot;: &quot;tls/server.key&quot;
    },
    &quot;Session&quot;: {
        &quot;SecretKey&quot;: &quot;@r4B?EThaSEh_drudR7P_hub=s#s2Pah&quot;,
        &quot;Name&quot;: &quot;gosess&quot;,
        &quot;Options&quot;: {
            &quot;Path&quot;: &quot;/&quot;,
            &quot;Domain&quot;: &quot;&quot;,
            &quot;MaxAge&quot;: 28800,
            &quot;Secure&quot;: false,
            &quot;HttpOnly&quot;: true
        }
    },
    &quot;Template&quot;: {
        &quot;Root&quot;: &quot;base&quot;,
        &quot;Children&quot;: [
            &quot;partial/menu&quot;,
            &quot;partial/footer&quot;
        ]
    },
    &quot;View&quot;: {
        &quot;BaseURI&quot;: &quot;/&quot;,
        &quot;Extension&quot;: &quot;tmpl&quot;,
        &quot;Folder&quot;: &quot;template&quot;,
        &quot;Name&quot;: &quot;blank&quot;,
        &quot;Caching&quot;: true
    }
}
EOF
</code></pre></div>

<p>And finally add following snippet inside <code>values.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code>edit gowebapp/values.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>configMap:
  name: gowebapp
</code></pre></div>

<p><strong>Step 2</strong>  Render the Chart locally and verify if any issues:</p>
<div class="codehilite"><pre><span></span><code>helm template gowebapp-mysql . &gt; render.yaml
</code></pre></div>

<h4 id="426-deploy-gowebapp">4.2.6 Deploy <code>gowebapp</code><a class="headerlink" href="#426-deploy-gowebapp" title="Permanent link">&para;</a></h4>
<p>Before deployment make sure test chart with <code>dry-run</code>, <code>template</code> and <code>lint</code> the chart</p>
<p>Lint: </p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/
helm lint gowebapp
</code></pre></div>

<p>Install:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/deploy_ycit020_a4/helm/gowebapp
helm install gowebapp .
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME: gowebapp
LAST DEPLOYED: Tue Aug 10 15:25:44 2021
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm ls
kubectl get all
kubectl get pvc
kubectl get ing
</code></pre></div>

<p>Access <code>gowebapp</code> with Ingress</p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>You've now became a chart developer! And learned, how to create basic helm charts with 2 methods.
You can farther customize the chart as needed and add more templates as you go.
The next step would be to look contribute back to Helm community, use charts in Artificatory, find issue or add missing feature,
help grow help project!</p>
</div>
<h4 id="427-submit-assignement">4.2.7 Submit assignement<a class="headerlink" href="#427-submit-assignement" title="Permanent link">&para;</a></h4>
<p><strong>Step 1</strong> Commit chart configuration in <code>deploy_ycit020_a4/helm</code> folder using the following Git commands:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
</code></pre></div>

<div class="codehilite"><pre><span></span><code>git add .
git commit -m &quot;Gowebapp Helm Chart&quot;
</code></pre></div>

<p><strong>Step 2</strong> Push commit to the Cloud Source Repositories:</p>
<div class="codehilite"><pre><span></span><code>git push origin master
</code></pre></div>

<p><strong>Step 3</strong> Uninstall chart <code>gowebapp</code> and <code>gowebapp-mysql</code> chart</p>
<div class="codehilite"><pre><span></span><code>helm install gowebapp
helm uninstall gowebapp-mysql
</code></pre></div>

<p><strong>Step 4</strong> Resize GKE Cluster to <code>0</code> nodes, to avoid charges:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
</code></pre></div>

<div class="codehilite"><pre><span></span><code>edit terraform.tfvars
</code></pre></div>

<p>And set <code>gke_pool_node_count</code>   = "0"</p>
<p><strong>Step 3:</strong> Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p><strong>Step 4:</strong> Shutdown all Nodes in GKE Cluster Node Pool:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>GKE Clusters has been scale down to 0 nodes.</p>
</div>
<h1 id="part-2-wip">Part 2 WIP<a class="headerlink" href="#part-2-wip" title="Permanent link">&para;</a></h1>
<h2 id="5-chart-repositories">5 Chart Repositories<a class="headerlink" href="#5-chart-repositories" title="Permanent link">&para;</a></h2>
<h2 id="6-helmfile">6 HelmFile<a class="headerlink" href="#6-helmfile" title="Permanent link">&para;</a></h2>
<h2 id="7-install-istio-on-gke">7 Install Istio on GKE<a class="headerlink" href="#7-install-istio-on-gke" title="Permanent link">&para;</a></h2>
<p>Currently Istio community developing following options of Istio deployment on Kubernetes Clusters:</p>
<ul>
<li><strong>Install with Istioctl</strong> installation via <code>istioctl</code> command line tool used to showcase Istio functionality. Using the CLI, we generate a YAML file with all Istio resources and then deploy it to the Kubernetes cluster</li>
<li><strong>Istio Operator Install</strong> Takes installation of Istio to the next level as it's managing not only Istio installation but overall lifecicle of the Istio deployment including Upgrades and configurations.</li>
<li><strong>Install with Helm (alpha)</strong> Allows to farther simplify Istio deployment and it's customization.  </li>
</ul>
<h3 id="70-prerequisite">7.0 Prerequisite<a class="headerlink" href="#70-prerequisite" title="Permanent link">&para;</a></h3>
<p>Scaleup cluster back to 3 nodes and Update VPC firewall rules to enable <code>auto-injection</code> and the <code>istioctl version</code> and <code>istioctl ps</code> commands.</p>
<p>References:</p>
<ol>
<li><a href="https://cloud.google.com/service-mesh/v1.7/docs/private-cluster-open-port">Opening ports on a private cluster</a></li>
<li>Istio deployment on <a href="https://istio.io/latest/docs/setup/platform-setup/gke/">GKE Private Clusters</a></li>
</ol>
<p><strong>Step 1:</strong> Locate Terraform Configuration directory.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
</code></pre></div>

<p><strong>Step 2:</strong> Configure GKE Cluster to Scale back to <code>1</code> node per zone in a region.</p>
<div class="codehilite"><pre><span></span><code>edit terraform.tfvars
</code></pre></div>

<p>And set <code>gke_pool_node_count</code>   = "1"</p>
<p><strong>Step 3:</strong>  Create new firewall rule for source range (master-ipv4-cidr) of the cluster, that will open required ports for Istio installation:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; istio_firewall.tf
resource &quot;google_compute_firewall&quot; &quot;istio_specific&quot; {
  name =   format(&quot;allow-istio-in-privategke-%s-%s-%s&quot;, var.org, var.product, var.environment)
  network = google_compute_network.vpc_network.self_link
  source_ranges = [&quot;172.16.0.0/28&quot;]
  allow {
    protocol = &quot;tcp&quot;
    ports = [&quot;10250&quot;, &quot;443&quot;, &quot;15017&quot;, &quot;15014&quot;, &quot;8080&quot;]
  }
}
EOF
</code></pre></div>

<p><strong>Step 4:</strong> Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p><strong>Step 5:</strong> Scale up GKE Cluster Node Pool and update firewall rules for required range:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>GKE Clusters has been scalled to 3 nodes and has firewall rules opened</p>
</div>
<p><strong>Step 6:</strong> Verify firewall rule:</p>
<div class="codehilite"><pre><span></span><code>gcloud compute firewall-rules list --filter=&quot;name~allow-istio-in-privategke*&quot;
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                                            NETWORK                   DIRECTION  PRIORITY  ALLOW                                           DENY  DISABLED
allow-istio-in-privategke-$student-notepad-dev  vpc-$student-notepad-dev  INGRESS    1000      tcp:10250,tcp:443,tcp:15017,tcp:15014,tcp:8080        False
</code></pre></div>

<h3 id="71-deploy-istio-using-custom-resources">7.1 Deploy Istio using Custom Resources<a class="headerlink" href="#71-deploy-istio-using-custom-resources" title="Permanent link">&para;</a></h3>
<p>This installation guide uses the istioctl command line tool to provide rich customization of the Istio control plane and of the sidecars for the Istio data plane.</p>
<p>Download and extract the latest release:</p>
<div class="codehilite"><pre><span></span><code>curl -L https://istio.io/downloadIstio | sh -
cd istio-1.11.0
export PATH=$PWD/bin:$PATH
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>The above command will fetch Istio packages and untar them in the same folder.</p>
</div>
<div class="codehilite"><pre><span></span><code>tree -L 1
</code></pre></div>

<div class="codehilite"><pre><span></span><code>.
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ bin
â”œâ”€â”€ manifest.yaml
â”œâ”€â”€ manifests
â”œâ”€â”€ samples
â””â”€â”€ tools
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Istio installation directory contains:</p>
<ul>
<li><code>bin</code> directory contains <code>istioctl</code> client binary</li>
<li><code>manifests</code> Installation Profiles, configurations and Helm Charts</li>
<li><code>samples</code> directory contains sample applications deployment</li>
<li><code>tools</code>  directory contains auto-completion tooling and etc.</li>
</ul>
</div>
<p><strong>Step 2</strong> Deploy Istio Custom Resource Definitions (CRDs)</p>
<p>Istio extends Kubernetes using Custom Resource Definitions (CRDs). 
CRDs allow registration of new/non-default Kubernetes resources. When Istio CRDs are deployed, Istioâ€™s objects are registered as Kubernetes objects, providing a highly integrated experience with 
Kubernetes as a deployment platform and thus allowing Kubernetes to store configuration of Istio features such as routing, security and telemetry and etc.</p>
<p>We going to install using using <code>demo</code> configuration profile. The <code>demo</code> configuration profile allows to experiment with most of Istio features with modest resource requirements. 
Since it enables high levels of tracing and access logging, it is not suitable for production use cases.</p>
<div class="codehilite"><pre><span></span><code>istioctl install --set profile=demo -y
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>âœ” Istio core installed
âœ” Istiod installed
âœ” Egress gateways installed
âœ” Ingress gateways installed
âœ” Installation complete
Thank you for installing Istio 1.11.  Please take a few minutes to tell us about your install/upgrade experience!  
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Wait a few seconds for the CRDs to be committed in the Kubernetes API-server.</p>
</div>
<p><strong>Step 3</strong> Verify Istio CRDs successfully applied to Kubernetes Cluster.</p>
<div class="codehilite"><pre><span></span><code>kubectl get crds | grep istio
</code></pre></div>

<div class="codehilite"><pre><span></span><code>authorizationpolicies.security.istio.io          2021-08-16T19:38:16Z
destinationrules.networking.istio.io             2021-08-16T19:38:16Z
envoyfilters.networking.istio.io                 2021-08-16T19:38:16Z
gateways.networking.istio.io                     2021-08-16T19:38:17Z
istiooperators.install.istio.io                  2021-08-16T19:38:17Z
peerauthentications.security.istio.io            2021-08-16T19:38:17Z
requestauthentications.security.istio.io         2021-08-16T19:38:17Z
serviceentries.networking.istio.io               2021-08-16T19:38:17Z
sidecars.networking.istio.io                     2021-08-16T19:38:17Z
telemetries.telemetry.istio.io                   2021-08-16T19:38:18Z
virtualservices.networking.istio.io              2021-08-16T19:38:18Z
workloadentries.networking.istio.io              2021-08-16T19:38:18Z
workloadgroups.networking.istio.io               2021-08-16T19:38:19Z
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Above CRDs will be avaialable as a new Kubernetes Resources and stored in Kubernetes ETCD database. The Kubernetes API will represent these new resources as endpoints that 
can be used as other native Kubernetes object (such as Pod, Services) levereging  kubectl, RBAC and other features and  admission controllers of Kubernetes.</p>
</div>
<p><strong>Step 4</strong> Count total number of Installed CRDs:</p>
<div class="codehilite"><pre><span></span><code>kubectl get crds | grep istio | wc -l
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CRDs count will vary based on Istio version and profile deployed.</p>
</div>
<p><strong>Step 5</strong> Verify that Istio control plane has been installed successfully.</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods -n istio-system
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>istio-egressgateway-9dc6cbc49-5wkqt     1/1     Running   0          2m54s
istio-ingressgateway-7975cdb749-xjc5g   1/1     Running   0          2m54s
istiod-77b4d7b55d-j6kb5                 1/1     Running   0          3m9s
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Istio control-plane include following components:</p>
<ul>
<li><code>istiod</code> - contains components such as <code>Citadel</code> and <code>Pilot</code></li>
<li><code>istio-ingressgateway</code> Istio Ingress Gateway</li>
<li><code>istio-ingressgateway</code> Istio Egress Gateway</li>
</ul>
</div>
<p><strong>Step 6</strong> Verify installation with <code>istioctl</code> CLI:</p>
<div class="codehilite"><pre><span></span><code>istioctl version
</code></pre></div>

<div class="codehilite"><pre><span></span><code>istioctl verify-install
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>Checked 13 custom resource definitions
Checked 3 Istio Deployments
âœ” Istio is installed and verified successfully
</code></pre></div>

<p><strong>Step 5</strong>  Deploy  <code>Bookinfo</code> sample application:</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get pods
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                              READY   STATUS    RESTARTS   AGE
details-v1-79f774bdb9-cjj5b       1/1     Running   0          12s
productpage-v1-6b746f74dc-sxdxz   1/1     Running   0          10s
ratings-v1-b6994bb9-jd985         1/1     Running   0          11s
reviews-v1-545db77b95-5kjr4       1/1     Running   0          11s
reviews-v2-7bf8c9648f-5v2s9       1/1     Running   0          11s
reviews-v3-84779c7bbc-5khlt       1/1     Running   0          11s
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a typical Kubernetes deployment, and has nothing specific to Istio. Each Pod has 1 container.</p>
</div>
<p><strong>Step 6</strong> Remove <code>Bookinfo</code> sample application:</p>
<div class="codehilite"><pre><span></span><code>kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div>

<p><strong>Step 7</strong> Enable automatic Envoy sidecar injection.</p>
<p>Currently there are 2 method to inject <code>Envoy</code> sidecar inside Istio Mesh:</p>
<ul>
<li>Manual sidecar injection - modifies the controller configuration, e.g. deployment. It does this by modifying the pod template spec such that all pods for that deployment are created with the injected sidecar. Adding/Updating/Removing the sidecar requires modifying the entire deployment.</li>
<li>Automatic sidecar injection via a Mutating Admission Webhook - The Deployment resource is unmodified. Sidecars can be updated selectively by manually deleting a pods or systematically with a deployment rolling update.</li>
</ul>
<p>Add a namespace label to instruct Istio to automatically inject Envoy sidecar proxies when you deploy your application later:</p>
<div class="codehilite"><pre><span></span><code>kubectl label namespace default istio-injection=enabled
</code></pre></div>

<p><strong>Step 8</strong> Deploy  <code>Bookinfo</code> sample application on Istio with Auto Sidecar Injection</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div>

<p><strong>Step 8</strong> Verify deployed application:</p>
<p>The application will start. As each pod becomes ready, the Istio sidecar will be deployed along with it.</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                              READY   STATUS    RESTARTS   AGE
details-v1-79f774bdb9-zqjbg       2/2     Running   0          13m
productpage-v1-6b746f74dc-dj959   2/2     Running   0          12m
ratings-v1-b6994bb9-29n4w         2/2     Running   0          12m
reviews-v1-545db77b95-p9pgf       2/2     Running   0          12m
reviews-v2-7bf8c9648f-4ltkg       2/2     Running   0          12m
reviews-v3-84779c7bbc-vhsmw       2/2     Running   0          12m
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each Pod  has now 2 containers. One application container and another is <code>istio-proxy</code> sidecar container.</p>
</div>
<p><strong>Step 9</strong> Access UI <code>productpage</code> via console:</p>
<div class="codehilite"><pre><span></span><code>kubectl get services
</code></pre></div>

<p>In Gcloud console execute <code>kubectl port-forward</code>:</p>
<div class="codehilite"><pre><span></span><code>kubectl port-forward --namespace default svc/productpage 8080:9080
</code></pre></div>

<p>Click <code>Web-Preview</code> button in Gcloud, and select preview on port <code>8080</code>
Click <code>Normal user</code> URL.</p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>We can access <code>Bookinfo</code> application configured with Istio and Envoy sidecar using private IP via tunnel</p>
</div>
<p><strong>Step 10</strong> Remove <code>Bookinfo</code> sample application:</p>
<div class="codehilite"><pre><span></span><code>kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div>

<p><strong>Step 11</strong> Uninstall Istio</p>
<div class="codehilite"><pre><span></span><code>istioctl manifest generate --set profile=demo | kubectl delete --ignore-not-found=true -f -
kubectl delete namespace istio-system
kubectl label namespace default istio-injection-
</code></pre></div>

<h3 id="72-deploy-istio-using-istio-operator">7.2 Deploy Istio using Istio Operator<a class="headerlink" href="#72-deploy-istio-using-istio-operator" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> Deploy the Istio operator:</p>
<div class="codehilite"><pre><span></span><code>istioctl operator init
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This command runs the operator by creating the following resources in the <code>istio-operator</code> namespace:</p>
<ul>
<li>The operator custom resource definition</li>
<li>The operator controller deployment</li>
<li>A service to access operator metrics</li>
<li>Necessary Istio operator RBAC rules</li>
</ul>
</div>
<p><strong>Step 2:</strong> To install the Istio demo configuration profile using the operator, run the following command:</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f - &lt;&lt;EOF
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  namespace: istio-system
  name: example-istiocontrolplane
spec:
  profile: demo
EOF
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Istio operator controller begins the process of installing Istio within 90 seconds of the creation of the IstioOperator resource. The Istio installation completes within 120 seconds.</p>
</div>
<p><strong>Step 3</strong> Verify Operator resource status on Kubernetes Cluster:</p>
<div class="codehilite"><pre><span></span><code>kubectl get istiooperators  -n istio-system 
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAMESPACE      NAME                        REVISION   STATUS    AGE
istio-system   example-istiocontrolplane              HEALTHY   25m
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl describe istiooperators example-istiocontrolplane -n istio-system
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Spec:
  Profile:  demo
Status:
  Component Status:
    Base:
      Status:  HEALTHY
    Egress Gateways:
      Status:  HEALTHY
    Ingress Gateways:
      Status:  HEALTHY
    Pilot:
      Status:  HEALTHY
  Status:      HEALTHY
Events:        &lt;none&gt;
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get pods -n istio-system
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>istio-egressgateway-9dc6cbc49-5wkqt     1/1     Running   0          2m54s
istio-ingressgateway-7975cdb749-xjc5g   1/1     Running   0          2m54s
istiod-77b4d7b55d-j6kb5                 1/1     Running   0          3m9s
</code></pre></div>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Istio control-plane include following components:</p>
<ul>
<li><code>istiod</code> - contains components such as <code>Citadel</code> and <code>Pilot</code></li>
<li><code>istio-ingressgateway</code> Istio Ingress Gateway</li>
<li><code>istio-ingressgateway</code> Istio Egress Gateway</li>
</ul>
</div>
<p>Verify installation with <code>istioctl</code> CLI:</p>
<div class="codehilite"><pre><span></span><code>istioctl verify-install
</code></pre></div>

<p><strong>Step 5</strong> Enable automatic Envoy sidecar injection.</p>
<p>Currently there are 2 method to inject <code>Envoy</code> sidecar inside Istio Mesh:</p>
<ul>
<li>Manual sidecar injection - modifies the controller configuration, e.g. deployment. It does this by modifying the pod template spec such that all pods for that deployment are created with the injected sidecar. Adding/Updating/Removing the sidecar requires modifying the entire deployment.</li>
<li>Automatic sidecar injection via a Mutating Admission Webhook - The Deployment resource is unmodified. Sidecars can be updated selectively by manually deleting a pods or systematically with a deployment rolling update.</li>
</ul>
<p>Add a namespace label to instruct Istio to automatically inject Envoy sidecar proxies when you deploy your application later:</p>
<div class="codehilite"><pre><span></span><code>kubectl label namespace default istio-injection=enabled
</code></pre></div>

<p><strong>Step 8</strong> Deploy  <code>Bookinfo</code> sample application on Istio with Auto Sidecar Injection</p>
<div class="codehilite"><pre><span></span><code>kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div>

<p><strong>Step 8</strong> Verify deployed application:</p>
<p>The application will start. As each pod becomes ready, the Istio sidecar will be deployed along with it.</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>NAME                              READY   STATUS    RESTARTS   AGE
details-v1-79f774bdb9-zqjbg       2/2     Running   0          13m
productpage-v1-6b746f74dc-dj959   2/2     Running   0          12m
ratings-v1-b6994bb9-29n4w         2/2     Running   0          12m
reviews-v1-545db77b95-p9pgf       2/2     Running   0          12m
reviews-v2-7bf8c9648f-4ltkg       2/2     Running   0          12m
reviews-v3-84779c7bbc-vhsmw       2/2     Running   0          12m
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've leaned to deploy Istio Control plane using <code>istioctl</code> cli and using Istio Operator. We also deployed regular k8s application on the namespace marked with auto injection!</p>
</div>
<p><strong>Step 9</strong> Cleanup  Uninstall Istio Operator</p>
<div class="codehilite"><pre><span></span><code>kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre></div>

<p><strong>Step 10</strong>  Uninstall Istio Operator</p>
<div class="codehilite"><pre><span></span><code>kubectl delete istiooperators.install.istio.io -n istio-system example-istiocontrolplane
istioctl operator remove
kubectl delete ns istio-system --grace-period=0 --force
</code></pre></div>

<h2 id="8-commit-readme-doc-to-repository-and-share-it-with-instructorteacher">8 Commit Readme doc to repository and share it with Instructor/Teacher<a class="headerlink" href="#8-commit-readme-doc-to-repository-and-share-it-with-instructorteacher" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Commit <code>deploy_ycit020_a4/helm</code> and <code>notepad-infrastructure/helm</code> folder using the following Git commands:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
</code></pre></div>

<div class="codehilite"><pre><span></span><code>git add .
git commit -m &quot;HelmFile Configuration to deploy NotePad and Suppporting Applications&quot;
</code></pre></div>

<p><strong>Step 2</strong> Push commit to the Cloud Source Repositories:</p>
<div class="codehilite"><pre><span></span><code>git push origin master
</code></pre></div>

<h2 id="9-cleanup">9 Cleanup<a class="headerlink" href="#9-cleanup" title="Permanent link">&para;</a></h2>
<p>We going to cleanup GCP Service foundation layer with GKE Cluster to avoid excessive cost.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
terraform destroy -var-file terraform.tfvars
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>