
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.3">
    
    
      
        <title>020 Module 4 Assignment Production GKE - Cloud Architecture</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-creating-production-gke-cluster" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Architecture" class="md-header__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Architecture
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              020 Module 4 Assignment Production GKE
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Architecture" class="md-nav__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Architecture
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          YCIT020
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="md-nav__link">
        Module 2 Terraform Fundamentals
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="md-nav__link">
        Module 2 Terraforming GCP Foundation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_3_Assignment_Production_GKE/" class="md-nav__link">
        Module 3 Deploying Production GKE with gcloud
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          YCIT019
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_5_Lab_Docker_basics/" class="md-nav__link">
        Module 5 Lab - Docker Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="md-nav__link">
        Module 6 Lab - Advanced Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="md-nav__link">
        Module 8 Lab - Kuberenetes Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_9_Kubernetes_Features/" class="md-nav__link">
        Module 9 Lab - Kubernetes Features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="md-nav__link">
        Module 9 Part 2 Lab Kubernetes Autoscaling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Module 10 Lab - Kubernetes Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Module 11 Lab - Kubernetes Storage
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Module 5 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Module 5 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Module 6 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Module 6 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Module 8 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Module 8 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_2022/" class="md-nav__link">
        Module 9 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Module 9 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass7/" class="md-nav__link">
        Module 10 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Module 10 Assignment Solution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-creating-production-gke-cluster" class="md-nav__link">
    1 Creating Production GKE Cluster
  </a>
  
    <nav class="md-nav" aria-label="1 Creating Production GKE Cluster">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-locate-assignment-2" class="md-nav__link">
    1.1 Locate Assignment 2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-create-a-user-managed-subnet-with-terraform" class="md-nav__link">
    2.4 Create a user-managed subnet with terraform
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-create-a-cloud-router" class="md-nav__link">
    2.5 Create a Cloud router
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#26-create-a-cloud-nat" class="md-nav__link">
    2.6 Create a Cloud Nat
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#27-create-ssh-firewall-rules-default-allow-internal-and-default-allow-ssh" class="md-nav__link">
    2.7 Create SSH Firewall rules default-allow-internal and default-allow-ssh
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#28-create-a-private-gke-cluster-and-delete-default-node-pool" class="md-nav__link">
    2.8 Create a Private GKE Cluster and delete default node pool
  </a>
  
    <nav class="md-nav" aria-label="2.8 Create a Private GKE Cluster and delete default node pool">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#281-enable-gcp-beta-provider" class="md-nav__link">
    2.8.1 Enable GCP Beta Provider
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#282-enable-kubernetes-engine-api" class="md-nav__link">
    2.8.2 Enable Kubernetes Engine API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#283-create-a-private-gke-cluster-and-delete-default-node-pool" class="md-nav__link">
    2.8.3 Create a Private GKE Cluster and delete default node pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#284-create-a-gke-custom-node-pool" class="md-nav__link">
    2.8.4 Create a GKE custom Node pool
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#285-update-gke-node-pool-to-support-auto-upgrade-and-auto-recovery-features" class="md-nav__link">
    2.8.5 Update GKE Node Pool to support Auto Upgrade and Auto Recovery features
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#29-optional-repeatable-infrastructure" class="md-nav__link">
    2.9 (Optional) Repeatable Infrastructure
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-create-documentation-for-terraform-code" class="md-nav__link">
    3. Create Documentation for terraform code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-workaround-for-project-quota-issue" class="md-nav__link">
    4. Workaround for Project Quota issue
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-commit-readme-doc-to-repository-and-share-it-with-instructorteacher" class="md-nav__link">
    5 Commit Readme doc to repository and share it with Instructor/Teacher
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-cleanup" class="md-nav__link">
    6 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<p>Lab 2 Creating Production GKE Cluster</p>
<p><strong>Objective:</strong></p>
<h2 id="1-creating-production-gke-cluster">1 Creating Production GKE Cluster<a class="headerlink" href="#1-creating-production-gke-cluster" title="Permanent link">&para;</a></h2>
<h3 id="11-locate-assignment-2">1.1 Locate Assignment 2<a class="headerlink" href="#11-locate-assignment-2" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong>  Clone <code>ycit020</code> repo with Kubernetes manifests, which going to use for our work:</p>
<div class="codehilite"><pre><span></span><code>cd ~
git clone https://github.com/Cloud-Architects-Program/ycit020
cd ~/ycit020/Assignment2/
ls
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You can see Kubernetes manifests with Assignment tasks.</p>
</div>
<p><strong>Step 2</strong> Go into your personal Google Cloud Source Repository:</p>
<div class="codehilite"><pre><span></span><code>MY_REPO=your_student_id-notepad
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Replace $student_id with your ID</p>
</div>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
</code></pre></div>

<div class="codehilite"><pre><span></span><code>git pull                              # Pull latest code from you repo
</code></pre></div>

<p><strong>Step 3</strong> Copy Assignment 2 <code>deploy_a2</code> folder to your repo:</p>
<div class="codehilite"><pre><span></span><code>cp -r ~/ycit020/Assignment2/deploy_a2 deploy_ycit020_a2
</code></pre></div>

<h3 id="24-create-a-user-managed-subnet-with-terraform">2.4 Create a <code>user-managed</code> subnet with terraform<a class="headerlink" href="#24-create-a-user-managed-subnet-with-terraform" title="Permanent link">&para;</a></h3>
<p>Using <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_subnetwork">google_compute_subnetwork</a> resource create a <code>user-managed</code> subnet with terraform.</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; subnet.tf
resource &quot;google_compute_subnetwork&quot; &quot;gke_private_subnet&quot; {
  name                     = format(&quot;subnet-%s-%s-%s&quot;, var.org, var.product, var.environment)
  network                  = google_compute_network.vpc_network.self_link
  region                   = var.gcp_region
  project                  = var.gcp_project_id
  ip_cidr_range            = var.network_cidr
  secondary_ip_range {
    range_name    = var.pods_cidr_name
    ip_cidr_range = var.pods_cidr
  }
  secondary_ip_range {
    range_name    = var.services_cidr_name
    ip_cidr_range = var.services_cidr
  }
}
EOF
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Notice power of terraform outputs. Here we link <code>subnet</code> with our VPC <code>network</code> using <code>google_compute_network.vpc_network.self_link</code> <code>output</code> value of created <code>network</code> in previous step.</p>
</div>
<p>Define variables:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; variables.tf

# variables used to create VPC

variable &quot;network_cidr&quot; {
  type = string
}
variable &quot;pods_cidr&quot; {
  type = string
}
variable &quot;pods_cidr_name&quot; {
  type = string
}
variable &quot;services_cidr&quot; {
  type = string
}
variable &quot;services_cidr_name&quot; {
  type = string
}
EOF
</code></pre></div>

<p>Define outputs:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; outputs.tf
output &quot;subnet_selflink&quot; {
  value = &quot;\${google_compute_subnetwork.gke_private_subnet.self_link}&quot;
}
EOF
</code></pre></div>

<p><strong>Task N4:</strong> Update <code>terraform.tfvars</code> file values with following information:</p>
<ul>
<li>Node Range: See column <code>subnet</code> in above table for <code>dev</code> cluster</li>
<li>Secondary service range with name: <code>services</code></li>
<li>Secondary Ranges:<ul>
<li>Service range name: <code>services</code></li>
<li>Service range CIDR: See column <code>srv range</code> in above table for <code>dev</code> cluster</li>
<li>Pods range name: <code>pods</code></li>
<li>Pods range CIDR: See column <code>pod range</code> in above table for <code>dev</code> cluster</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>env |   subnet      | pod range        | srv range      | kubectl api range
dev | 10.128.1.0/26 | 172.0.0.0/18    | 172.10.0.0/21   | 172.16.0.0/28
stg | 10.128.2.0/26 | 172.1.0.0/18    | 172.11.0.0/21   | 172.16.0.16/28
prd | 10.128.3.0/26 | 172.2.0.0/18    | 172.12.0.0/21   |  172.16.0.32/28
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ranges must be with in Private (RFC1918) <a href="https://en.wikipedia.org/wiki/Private_network">Address Space</a></p>
</div>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; terraform.tfvars
#subnet vars
network_cidr       = &quot;TODO&quot;
pods_cidr          = &quot;TODO&quot;
pods_cidr_name     = &quot;TODO&quot;
services_cidr      = &quot;TODO&quot;
services_cidr_name = &quot;TODO&quot;
EOF
</code></pre></div>

<p>Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p>Create VPC:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<p>Review created subnet:</p>
<div class="codehilite"><pre><span></span><code>gcloud compute networks subnets list
gcloud compute networks subnets describe $(gcloud compute networks subnets list | grep us-central1 |awk &#39;{ print $1 }&#39;)  --region us-central1
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>enableFlowLogs: false
gatewayAddress: 10.128.1.1
ipCidrRange: 10.128.1.0/26
kind: compute#subnetwork
logConfig:
  enable: false
name: subnet-student_name-notepad-dev
privateIpGoogleAccess: false
privateIpv6GoogleAccess: DISABLE_GOOGLE_ACCESS
purpose: PRIVATE
secondaryIpRanges:
- ipCidrRange: 172.0.0.0/18
  rangeName: pods
- ipCidrRange: 172.10.0.0/21
  rangeName: services
stackType: IPV4_ONLY
</code></pre></div>

<p>Also check in Google cloud UI:</p>
<div class="codehilite"><pre><span></span><code>Networking-&gt;VPC Networks -&gt; Click VPC network and check `Subnet` tab
</code></pre></div>

<p><strong>Task N5:</strong> Update  <code>subnet.tf</code> so that  <code>google_compute_subnetwork</code> resource supports following features:</p>
<div class="codehilite"><pre><span></span><code>* Flow Logs
  * Aggregation interval: 15 min
  * Flow sampling: 0.1
  * Metadata: &quot;INCLUDE_ALL_METADATA&quot;
* Private IP Google Access
</code></pre></div>

<div class="codehilite"><pre><span></span><code>edit subnet.tf
TODO
</code></pre></div>

<p>Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p>Create VPC:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<h3 id="25-create-a-cloud-router">2.5 Create a Cloud router<a class="headerlink" href="#25-create-a-cloud-router" title="Permanent link">&para;</a></h3>
<p>Create Cloud Router for <code>custom mode</code> network (VPC), in the same region as the instances that will use Cloud NAT. Cloud NAT is only used to place NAT information onto the VMs. It is not used as part of the actual NAT gateway.</p>
<p><strong>Task N6:</strong> Define a <code>google_compute_router</code> inside <code>router.tf</code> that will be able to create a NAT router so the nodes can reach DockerHub and external APIs from private cluster, using following parameters:</p>
<ul>
<li>Create router for custom <code>vpc_network</code> created above with terraform</li>
<li>Same project as VPC</li>
<li>Same region as VPC</li>
<li>Router name: <code>gke-net-router</code></li>
<li>Local BGP Autonomous System Number (ASN): 64514</li>
</ul>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>You can automatically recover vpc name from terraform output like this: <code>google_compute_network.vpc_network.self_link</code>.</p>
</div>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; router.tf
TODO
EOF
</code></pre></div>

<p>Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p>Create Cloud Router:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<p>Verify created Cloud Router:</p>
<p>CLI:</p>
<div class="codehilite"><pre><span></span><code>gcloud compute routers list
gcloud compute routers describe $(gcloud compute routers list | grep gke-net-router |awk &#39;{ print $1 }&#39;)  --region us-central1
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>bgp:
  advertiseMode: DEFAULT
  asn: 64514
  keepaliveInterval: 20
kind: compute#router
name: gke-net-router
</code></pre></div>

<p>UI:</p>
<div class="codehilite"><pre><span></span><code>Networking -&gt; Hybrid Connectivity -&gt; Cloud Routers
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Router resource has been created for VPC Network</p>
</div>
<h3 id="26-create-a-cloud-nat">2.6 Create a Cloud Nat<a class="headerlink" href="#26-create-a-cloud-nat" title="Permanent link">&para;</a></h3>
<p>Set up a simple Cloud Nat configuration using <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_router_nat">google_compute_router_nat</a> resource, which will <code>automatically</code> allocates the necessary external IP addresses to provide NAT services to a region. </p>
<p>When you use auto-allocation, Google Cloud reserves IP addresses in your project automatically. </p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; cloudnat.tf
resource &quot;google_compute_router_nat&quot; &quot;gke_cloud_nat&quot; {
  project                = var.gcp_project_id
  name                   = &quot;gke-cloud-nat&quot;
  router                 = google_compute_router.gke_net_router.name
  region                 = var.gcp_region
  nat_ip_allocate_option = &quot;AUTO_ONLY&quot;
  source_subnetwork_ip_ranges_to_nat = &quot;ALL_SUBNETWORKS_ALL_IP_RANGES&quot;
}
EOF
</code></pre></div>

<p>Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p>Create Cloud Router:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<p>Verify created <code>Cloud Nat</code>:</p>
<p>CLI:</p>
<div class="codehilite"><pre><span></span><code># List available Cloud Nat Routers
gcloud compute routers nats list --router gke-net-router --router-region us-central1
# Describe Cloud Nat Routers `gke-cloud-nat`:
gcloud compute routers nats describe gke-cloud-nat --router gke-net-router --router-region us-central1
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>enableEndpointIndependentMapping: true
icmpIdleTimeoutSec: 30
name: gke-cloud-nat
natIpAllocateOption: AUTO_ONLY
sourceSubnetworkIpRangesToNat: ALL_SUBNETWORKS_ALL_IP_RANGES
tcpEstablishedIdleTimeoutSec: 1200
tcpTransitoryIdleTimeoutSec: 30
udpIdleTimeoutSec: 30
</code></pre></div>

<p>UI:</p>
<div class="codehilite"><pre><span></span><code>Networking -&gt; Network Services -&gt; Cloud NAT
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>A NAT service created in a router</p>
</div>
<p><strong>Task N7:</strong> Additionally turn <code>ON</code> logging feature for <code>ALL</code> log types of communication for Cloud Nat</p>
<div class="codehilite"><pre><span></span><code>edit cloudnat.tf
TODO
</code></pre></div>

<p>Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p>Update Cloud Nat Configuration:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
</code></pre></div>

<div class="codehilite"><pre><span></span><code>gcloud compute routers nats describe gke-cloud-nat --router gke-net-router --router-region us-central1
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Cloud Nat now supports Logging. Cloud NAT logging allows you to log NAT connections and errors. When Cloud NAT logging is enabled, one log entry can be generated for each of the following scenarios:</p>
<ul>
<li>When a network connection using NAT is created.</li>
<li>When a packet is dropped because no port was available for NAT.</li>
</ul>
</div>
<h3 id="27-create-ssh-firewall-rules-default-allow-internal-and-default-allow-ssh">2.7 Create SSH Firewall rules <code>default-allow-internal</code> and <code>default-allow-ssh</code><a class="headerlink" href="#27-create-ssh-firewall-rules-default-allow-internal-and-default-allow-ssh" title="Permanent link">&para;</a></h3>
<p>Let's create SSH Firewall rule with name <code>allow-tcp-ssh-icmp-$ORG-$PRODUCT-$ENV</code> to allow SSH, ping, using <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall">google_compute_firewall</a> resource.</p>
<p>Reference: </p>
<ul>
<li>https://cloud.google.com/kubernetes-engine/docs/concepts/firewall-rules</li>
<li>https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall</li>
</ul>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt;&gt; firewall.tf
resource &quot;google_compute_firewall&quot; &quot;ssh-rule&quot; {
  name =   format(&quot;allow-tcp-ssh-icmp-%s-%s-%s&quot;, var.org, var.product, var.environment)
  network = google_compute_network.vpc_network.self_link
  allow {
    protocol = &quot;tcp&quot;
    ports = [&quot;22&quot;]
  }
  allow {
    protocol = &quot;icmp&quot;
  }
}
EOF
</code></pre></div>

<p>Review created firewall rules:</p>
<div class="codehilite"><pre><span></span><code>gcloud compute firewall-rules list
</code></pre></div>

<p>Also check in Google cloud UI:</p>
<div class="codehilite"><pre><span></span><code>Networking-&gt;Firewalls
</code></pre></div>

<h3 id="28-create-a-private-gke-cluster-and-delete-default-node-pool">2.8 Create a Private GKE Cluster and delete default node pool<a class="headerlink" href="#28-create-a-private-gke-cluster-and-delete-default-node-pool" title="Permanent link">&para;</a></h3>
<h4 id="281-enable-gcp-beta-provider">2.8.1 Enable GCP Beta Provider<a class="headerlink" href="#281-enable-gcp-beta-provider" title="Permanent link">&para;</a></h4>
<p>In order to create a GKE cluster with terraform we will be leveraging <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster">google_container_cluster</a> resource.</p>
<p>Some of  <code>google_container_cluster</code> arguments, such VPC-Native networking mode, VPA, Istio, CSI Driver add-ons, requires  <code>google-beta</code> Provider.</p>
<p>The <code>google-beta</code> provider is distinct from the <code>google</code> provider in that it supports GCP products and features that are in beta, while google does not. Fields and resources that are only present in google-beta will be marked as such in the shared provider documentation.</p>
<p><strong>Task N8:</strong> Configure and Initialize <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/provider_versions">GCP Beta Provider</a>, similar to how we did it for GCP Provider in <a href="#133-initialize-terraform">1.3.3 Initialize Terraform</a> update <code>provider.tf</code> and <code>main.tf</code> configuration files.</p>
<div class="codehilite"><pre><span></span><code>edit provider.tf
TODO
</code></pre></div>

<div class="codehilite"><pre><span></span><code>edit main.tf
TODO
</code></pre></div>

<p>Initialize <code>google-beta</code> provider plugin:</p>
<div class="codehilite"><pre><span></span><code>terraform init
</code></pre></div>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Terraform has been successfully initialized!</p>
</div>
<h4 id="282-enable-kubernetes-engine-api">2.8.2 Enable Kubernetes Engine API<a class="headerlink" href="#282-enable-kubernetes-engine-api" title="Permanent link">&para;</a></h4>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/reference/rest">Kubernetes Engine API</a> used to build and manages container-based applications, powered by the open source Kubernetes technology. Before starting  GKE cluster creation it is required to enable it.</p>
<p><strong>Task N9:</strong> Enable <code>container.googleapis.com</code> in <code>services.tf</code> file similar to what we already did in <a href="#22-enable-required-gcp-services-api">2.2 Enable required GCP Services API</a>.</p>
<div class="codehilite"><pre><span></span><code>edit services.tf
TODO
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Adding <code>disable_on_destroy=false</code> helps to prevent errors during redeployments of the system.</p>
</div>
<p>Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p>Update Cloud Nat Configuration:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<h4 id="283-create-a-private-gke-cluster-and-delete-default-node-pool">2.8.3 Create a Private GKE Cluster and delete default node pool<a class="headerlink" href="#283-create-a-private-gke-cluster-and-delete-default-node-pool" title="Permanent link">&para;</a></h4>
<p>Using <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_cluster">google_container_cluster</a> resource create a Regional, Private GKE cluster, with following characteristics:</p>
<p>Cluster Configuration:</p>
<ul>
<li>Cluster name: <code>gke-$ORG-$PRODUCT-$ENV</code></li>
<li>GKE Control plane is replicated across three zones of a region: <code>us-central1</code></li>
<li>Private cluster with unrestricted access to the public endpoint:<ul>
<li>Cluster Nodes access: <em>Private</em> Node GKE Cluster with <em>Public API</em> endpoint</li>
<li>Cluster K8s API access: <em>with unrestricted access to the public endpoint</em></li>
</ul>
</li>
<li>Cluster Node Communication: <code>VPC Native</code></li>
<li>Secondary pod range with name: <code>pods</code></li>
<li>Secondary service range with name: <code>services</code></li>
<li>GKE master and node version: "1.20.8-gke.700"</li>
<li>Terraform Provider: <code>google-beta</code></li>
<li>Timeouts: 30M</li>
</ul>
<p>Node Pool Configuration:</p>
<ul>
<li>VM size: <code>e2-small</code></li>
<li>Node count: 1 per zone</li>
<li>Node images: Container-Optimized OS</li>
<li>The name of a GCE machine (VM) type: e2-small</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Why delete default node pool?</strong> The <code>default</code> node pools cause trouble with managing the cluster, when created with terraform as it is not part of the terraform lifecycle. GKE Architecture Best Practice recommends to delete <code>default</code> node pool and create a <code>custom</code> one instead and manage the node pools explicitly.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Why define <code>Timeouts</code> for gke resource?</strong> Normally GKE creation takes few minutes. However, in our case we creating GKE Cluster, and then system cordon, drain and then destroy default node pool. This process may take 10-20 minutes and we want to make sure terraform will not time out during this time.</p>
</div>
<p><strong>Step 1:</strong> Let's define GKE resource first:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; gke.tf
resource &quot;google_container_cluster&quot; &quot;primary_cluster&quot; {
  provider = google-beta

  project = var.gcp_project_id

  name               = format(&quot;gke-%s-%s-%s&quot;, var.org, var.product, var.environment)
  min_master_version = var.kubernetes_version
  network            = google_compute_network.vpc_network.self_link
  subnetwork         = google_compute_subnetwork.gke_private_subnet.self_link

  location                    = var.gcp_region
  logging_service             = var.logging_service
  monitoring_service          = var.monitoring_service

  remove_default_node_pool = true
  initial_node_count       = 1

  private_cluster_config {
    enable_private_nodes   = var.enable_private_nodes
    enable_private_endpoint = var.enable_private_endpoint
    master_ipv4_cidr_block = var.master_ipv4_cidr_block
  }

  network_policy {
    enabled  = var.network_policy
    provider = var.network_policy ? &quot;CALICO&quot; : &quot;PROVIDER_UNSPECIFIED&quot;
  }

  addons_config {
    http_load_balancing {
      disabled = var.disable_http_load_balancing
    }

    network_policy_config {
      disabled = var.network_policy ? false : true
    }
  }

  ip_allocation_policy {
    cluster_secondary_range_name  = var.pods_range_name
    services_secondary_range_name = var.services_range_name
  }

  timeouts {
    create = &quot;30m&quot;
    update = &quot;30m&quot;
    delete = &quot;30m&quot;
  }

  workload_identity_config {
    identity_namespace = &quot;${var.gcp_project_id}.svc.id.goog&quot;
  }
}
EOF
</code></pre></div>

<p><strong>Step 2:</strong> Next define GKE cluster specific variables:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; gke_variables.tf

variable &quot;kubernetes_version&quot; {
  default     = &quot;&quot;
  type        = string
  description = &quot;The GKE version of Kubernetes&quot;
}

variable &quot;logging_service&quot; {
  description = &quot;The logging service that the cluster should write logs to.&quot;
  default     = &quot;logging.googleapis.com/kubernetes&quot;
}

variable &quot;monitoring_service&quot; {
  default     = &quot;monitoring.googleapis.com/kubernetes&quot;
  description = &quot;The GCP monitoring service scope&quot;
}

variable &quot;disable_http_load_balancing&quot; {
  default     = false
  description = &quot;Enable HTTP Load balancing GCP integration&quot;
}

variable &quot;network_policy&quot; {
  description = &quot;Enable network policy addon&quot;
  default     = true
}

variable &quot;pods_range_name&quot; {
  description = &quot;The pre-defined IP Range the Cluster should use to provide IP addresses to pods&quot;
  default     = &quot;&quot;
}

variable &quot;services_range_name&quot; {
  description = &quot;The pre-defined IP Range the Cluster should use to provide IP addresses to services&quot;
  default     = &quot;&quot;
}

variable &quot;enable_private_nodes&quot; {
  default     = false
  description = &quot;Enable Private-IP Only GKE Nodes&quot;
}

variable &quot;enable_private_endpoint&quot; {
  default     = false
  description = &quot;When true, the cluster&#39;s private endpoint is used as the cluster endpoint and access through the public endpoint is disabled.&quot;
}

variable &quot;master_ipv4_cidr_block&quot; {
  description = &quot;The ipv4 cidr block that the GKE masters use&quot;
}
EOF
</code></pre></div>

<p><strong>Step 3:</strong> Define GKE cluster specific outputs:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; outputs.tf
output &quot;id&quot; {
  value = &quot;${google_container_cluster.primary_cluster.id}&quot;
}
output &quot;endpoint&quot; {
  value = &quot;${google_container_cluster.primary_cluster.endpoint}&quot;
}
output &quot;master_version&quot; {
  value = &quot;${google_container_cluster.primary_cluster.master_version}&quot;
}
EOF
</code></pre></div>

<p><strong>Task N9:</strong> Complete <code>terraform.tfvars</code> with required values to GKE Cluster specified above:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; terraform.tfvars
//gke specific
enable_private_nodes   = &quot;TODO&quot;
master_ipv4_cidr_block = &quot;TODO&quot;
pods_range_name        = &quot;TODO&quot;
services_range_name    = &quot;TODO&quot;
kubernetes_version     = &quot;TODO&quot;
EOF
</code></pre></div>

<p>In the next step, we going to create a <code>custom</code> GKE Node Pool.</p>
<h4 id="284-create-a-gke-custom-node-pool">2.8.4 Create a GKE <code>custom</code> Node pool<a class="headerlink" href="#284-create-a-gke-custom-node-pool" title="Permanent link">&para;</a></h4>
<p>Using <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_node_pool">google_container_node_pool</a> resource create a <code>custom</code> GKE Node Pool with following characteristics:</p>
<p>Node Pool Configuration:</p>
<ul>
<li>VM size: <code>e2-small</code></li>
<li>Node count: 1 per zone</li>
<li>Node images: Container-Optimized OS</li>
<li>The name of a GCE machine (VM) type: e2-small</li>
</ul>
<p><strong>Step 1:</strong> Let's define GKE resource first:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; gke.tf
#Node Pool Resource
resource &quot;google_container_node_pool&quot; &quot;custom-node_pool&quot; {
  provider = google-beta

  name       = &quot;main-pool&quot;
  location = var.gcp_region
  project  = var.gcp_project_id
  cluster    = google_container_cluster.primary_cluster.name
  node_count = var.gke_pool_node_count
  version    = var.kubernetes_version

  node_config {
    image_type   = var.gke_pool_image_type
    disk_size_gb = var.gke_pool_disk_size_gb
    disk_type    = var.gke_pool_disk_type
    machine_type = var.gke_pool_machine_type
  }

  timeouts {
    create = &quot;10m&quot;
    delete = &quot;10m&quot;
  }

  lifecycle {
    ignore_changes = [
      node_count
    ]
  }
}
EOF
</code></pre></div>

<p><strong>Step 2:</strong> Next define GKE cluster specific variables:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; gke_variables.tf

#Node Pool specific variables
variable &quot;gke_pool_machine_type&quot; {
  type = string
}
variable &quot;gke_pool_node_count&quot; {
  type = number
}
variable &quot;gke_pool_disk_type&quot; {
  type = string
  default = &quot;pd-standard&quot;
}
variable &quot;gke_pool_disk_size_gb&quot; {
  type = string
}
variable &quot;gke_pool_image_type&quot; {
  type = string
}
EOF
</code></pre></div>

<p><strong>Task 9 (Continued):</strong> Complete <code>terraform.tfvars</code> with required values to GKE Node Pool values specified above:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF &gt;&gt; terraform.tfvars
#pool specific
gke_pool_node_count   = &quot;TODO&quot;
gke_pool_image_type   = &quot;TODO&quot;
gke_pool_disk_size_gb = &quot;TODO&quot;
gke_pool_machine_type = &quot;TODO&quot;
EOF
</code></pre></div>

<p><strong>Step 3:</strong> Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p><strong>Step 4:</strong> Create GKE Cluster and Node Pool:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>google_container_cluster.primary_cluster: Creating...
...
google_container_cluster.primary_cluster: Creation complete after 20m9s 
google_container_node_pool.custom-node_pool: Creating...
google_container_node_pool.custom-node_pool: Creation complete after 2m10s
</code></pre></div>

<h4 id="285-update-gke-node-pool-to-support-auto-upgrade-and-auto-recovery-features">2.8.5 Update GKE Node Pool to support Auto Upgrade and Auto Recovery features<a class="headerlink" href="#285-update-gke-node-pool-to-support-auto-upgrade-and-auto-recovery-features" title="Permanent link">&para;</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>GKE Master Nodes are managed by Google and get's upgraded automatically. Users can only specify Maintenance Window if they have preference for that process to occur (e.g. after busy hours). Users can however control Node Pool upgrade lifecycle. The can choose to do it themselves or with Auto Upgrade.</p>
</div>
<p><strong>Task N10:</strong> Using <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/container_node_pool">google_container_node_pool</a> resource update node pool to support Auto Upgrade and Auto Recovery features.</p>
<div class="codehilite"><pre><span></span><code>edit gke.tf
TODO
</code></pre></div>

<p><strong>Step 3:</strong> Review TF Plan:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
</code></pre></div>

<p>No errors.</p>
<p><strong>Step 4:</strong> Update GKE Cluster Node Pool configuration:</p>
<div class="codehilite"><pre><span></span><code>terraform apply -var-file terraform.tfvars
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Congrats! You've now learned how to deploy production grade GKE clusters.</p>
</div>
<h3 id="29-optional-repeatable-infrastructure">2.9 (Optional) Repeatable Infrastructure<a class="headerlink" href="#29-optional-repeatable-infrastructure" title="Permanent link">&para;</a></h3>
<p>When you doing IaC it is important to insure that you can both create and destroy resources consistently.
This is especially important when doing CI/CD testing.</p>
<p><strong>Step 3:</strong> Destroy all resources:</p>
<div class="codehilite"><pre><span></span><code>terraform destroy -var-file terraform.tfvars
</code></pre></div>

<p>No errors.</p>
<p><strong>Step 4:</strong> Recreate all resources:</p>
<div class="codehilite"><pre><span></span><code>terraform plan -var-file terraform.tfvars
terraform apply -var-file terraform.tfvars
</code></pre></div>

<h1 id="3-create-documentation-for-terraform-code">3. Create Documentation for terraform code<a class="headerlink" href="#3-create-documentation-for-terraform-code" title="Permanent link">&para;</a></h1>
<p>Documentation for your terraform code is an important part of IaC. Make sure all your variables have a good description!</p>
<p>There are community tools that have been developed to make the documentation process smoother, in terms of documenting
Terraform resources and requirements.Its good practice to also include a usage example snippet.</p>
<p><a href="https://terraform-docs.io/user-guide/introduction/">Terraform-Docs</a> is a good example of one tool that can generate some documentation based on the description argument of your Input Variables, Output Values, and from your required_providers configurations.</p>
<p><strong>Step 1</strong> Install the terraform-docs cli to your Google CloudShell environment: </p>
<div class="codehilite"><pre><span></span><code>curl -Lo ./terraform-docs.tar.gz https://github.com/terraform-docs/terraform-docs/releases/download/v0.14.1/terraform-docs-v0.14.1-$(uname)-amd64.tar.gz
tar -xzf terraform-docs.tar.gz
rm terraform-docs.tar.gz
chmod +x terraform-docs
sudo mv terraform-docs /usr/local/bin/
terraform-docs
</code></pre></div>

<p>Generating terraform documentation with Terraform Docs:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
cd foundation-infrastructure
terraform-docs markdown . &gt; README.md
cd ../notepad-infrastructure
terraform-docs markdown . &gt; README.md
</code></pre></div>

<p>Verify created documentation:</p>
<div class="codehilite"><pre><span></span><code>edit README.md
</code></pre></div>

<h1 id="4-workaround-for-project-quota-issue">4. Workaround for Project Quota issue<a class="headerlink" href="#4-workaround-for-project-quota-issue" title="Permanent link">&para;</a></h1>
<p>If you see following error during project creation in foundation layer:</p>
<div class="codehilite"><pre><span></span><code>Error: Error setting billing account &quot;010BE6-CA1129-195D77&quot; for project &quot;projects/ayrat-notepad-dev-244&quot;: googleapi: Error 400: Precondition check failed., failedPrecondition
</code></pre></div>

<p>This is due to our Billing account has quota of 5 projects per account.</p>
<p>To solve this issue find all unused accounts:</p>
<div class="codehilite"><pre><span></span><code>gcloud beta billing projects list --billing-account $ACCOUNT_ID
</code></pre></div>

<p>And unlink them, so you have less then 5 projects per account:</p>
<div class="codehilite"><pre><span></span><code>gcloud beta billing projects unlink $PROJECT_ID
</code></pre></div>

<h1 id="5-commit-readme-doc-to-repository-and-share-it-with-instructorteacher">5 Commit Readme doc to repository and share it with Instructor/Teacher<a class="headerlink" href="#5-commit-readme-doc-to-repository-and-share-it-with-instructorteacher" title="Permanent link">&para;</a></h1>
<p><strong>Step 1</strong> Commit <code>docs</code> folder using the following Git commands:</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO
</code></pre></div>

<div class="codehilite"><pre><span></span><code>git add .
git commit -m &quot;Readme doc for Production GKE Creation using gcloud&quot;
</code></pre></div>

<p><strong>Step 2</strong> Push commit to the Cloud Source Repositories:</p>
<div class="codehilite"><pre><span></span><code>git push origin master
</code></pre></div>

<h1 id="6-cleanup">6 Cleanup<a class="headerlink" href="#6-cleanup" title="Permanent link">&para;</a></h1>
<p>We only going to cleanup GCP Service foundation layer, as we going to use GCP project in future.</p>
<div class="codehilite"><pre><span></span><code>cd ~/$MY_REPO/notepad-infrastructure
terraform destroy -var-file terraform.tfvars
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>