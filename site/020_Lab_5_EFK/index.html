
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.5.3">
    
    
      
        <title>Lab 5 Logging with EFK Stack - Cloud Architecture</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7a952b86.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-5-logging-with-efk-stack" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Architecture" class="md-header__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Architecture
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 5 Logging with EFK Stack
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Architecture" class="md-nav__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Architecture
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          YCIT020
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="md-nav__link">
        Module 2 Terraform Fundamentals
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="md-nav__link">
        Module 2 Terraforming GCP Foundation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_3_Assignment_Production_GKE/" class="md-nav__link">
        Module 3 Deploying Production GKE with gcloud
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          YCIT019
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_5_Lab_Docker_basics/" class="md-nav__link">
        Module 5 Lab - Docker Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="md-nav__link">
        Module 6 Lab - Advanced Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="md-nav__link">
        Module 8 Lab - Kuberenetes Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_9_Kubernetes_Features/" class="md-nav__link">
        Module 9 Lab - Kubernetes Features
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="md-nav__link">
        Module 9 Part 2 Lab Kubernetes Autoscaling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Module 10 Lab - Kubernetes Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Module 11 Lab - Kubernetes Storage
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          Assignments
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Module 5 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Module 5 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Module 6 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Module 6 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Module 8 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Module 8 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_2022/" class="md-nav__link">
        Module 9 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Module 9 Assignment Solution
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass7/" class="md-nav__link">
        Module 10 Assignment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Module 10 Assignment Solution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-create-regional-gke-cluster-on-gcp" class="md-nav__link">
    0 Create Regional GKE Cluster on GCP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-install-elasticsearch-kibana-fluentd-helm-charts" class="md-nav__link">
    1 Install Elasticsearch, Kibana, Fluentd Helm Charts
  </a>
  
    <nav class="md-nav" aria-label="1 Install Elasticsearch, Kibana, Fluentd Helm Charts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-elasticsearch-installation" class="md-nav__link">
    1.1 Elasticsearch Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-kibana-installation" class="md-nav__link">
    1.2 Kibana installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-fluentd-installation" class="md-nav__link">
    1.3 Fluentd installation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-configure-kibana-and-create-index" class="md-nav__link">
    2 Configure Kibana and Create Index:
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-deploy-onlineboutique-application" class="md-nav__link">
    3 Deploy onlineboutique application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-observe-onlineboutique-logs" class="md-nav__link">
    4 Observe onlineboutique logs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-review-fluentd-configuration" class="md-nav__link">
    5 Review Fluentd configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-configure-fluentd-to-specific-logs" class="md-nav__link">
    6 Configure Fluentd to specific logs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-cleanup" class="md-nav__link">
    7 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="lab-5-logging-with-efk-stack">Lab 5 Logging with EFK Stack<a class="headerlink" href="#lab-5-logging-with-efk-stack" title="Permanent link">&para;</a></h1>
<p>In a complicated distributed system such as Kubernetes, we will have different logs for different components, and extracting insights from logs can be a daunting task. The EFK stack (ElasticSearch, FluentD, Kibana) can help make this task easier.
In this Lab, we are going to deploy EFK stack.</p>
<p>Deploy <code>online-boutique</code> app that emits logs to stdout in JSON format.</p>
<p>We will then deploy Cloud Native FluentD logging agent and configure:</p>
<ul>
<li>
<p><strong>source</strong> directive (input) that will use logs from <code>/var/log/containers</code> folder (location used by docker daemon on a Kubernetes node to store stdout from running containers).  This events will be tailed read from text file using  <code>in_tail</code> <a href="https://docs.fluentd.org/input/tail">Input Plugin</a>. And parsed using <code>multi_format</code> plugin.</p>
</li>
<li>
<p><strong>filter</strong> directive that will use <a href="https://github.com/fabric8io/fluent-plugin-kubernetes_metadata_filter">kubernetes metadata</a> plugin to add metadata to the log and parse all kubernetes logs in specific format.</p>
</li>
<li>
<p><strong>match</strong> directive (output) that will use <code>out_elasticsearch</code> Output Plugin and send all logs to ElasticSearch
under <code>fluentd-*</code> prefix.</p>
</li>
</ul>
<p><strong>Objective:</strong></p>
<ul>
<li>Install Elasticsearch and Kibanna</li>
<li>Deploy online boutique Application</li>
<li>Install and Configure FluentD</li>
<li>Configure ElastackSearch with FluentD</li>
</ul>
<h2 id="0-create-regional-gke-cluster-on-gcp">0 Create Regional GKE Cluster on GCP<a class="headerlink" href="#0-create-regional-gke-cluster-on-gcp" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<div class="codehilite"><pre><span></span><code>gcloud services enable container.googleapis.com
</code></pre></div>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters create k8s-efk-lab \
--region us-central1 \
--enable-ip-alias \
--enable-network-policy \
--num-nodes 1 \
--machine-type &quot;e2-standard-4&quot; \
--release-channel stable
</code></pre></div>

<div class="codehilite"><pre><span></span><code>gcloud container clusters get-credentials k8s-efk-lab --region us-central1
</code></pre></div>

<h2 id="1-install-elasticsearch-kibana-fluentd-helm-charts">1 Install Elasticsearch, Kibana, Fluentd Helm Charts<a class="headerlink" href="#1-install-elasticsearch-kibana-fluentd-helm-charts" title="Permanent link">&para;</a></h2>
<h3 id="11-elasticsearch-installation">1.1 Elasticsearch Installation<a class="headerlink" href="#11-elasticsearch-installation" title="Permanent link">&para;</a></h3>
<p>Create a new namespace for EFK stack:</p>
<div class="codehilite"><pre><span></span><code>kubectl create ns efk
</code></pre></div>

<p>Install Elasticsearch using Helm:</p>
<div class="codehilite"><pre><span></span><code>helm repo add elastic https://helm.elastic.co
helm install elasticsearch elastic/elasticsearch -n efk
</code></pre></div>

<p>Check the status of deployment:</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods --namespace=efk -l app=elasticsearch-master -w
</code></pre></div>

<h3 id="12-kibana-installation">1.2 Kibana installation<a class="headerlink" href="#12-kibana-installation" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> Create custom Kibana configuration, that will allow to expose Kibana Dashboard:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; kibana_values.yaml
service:
  type: LoadBalancer
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>cat kibana_values.yaml  
</code></pre></div>

<p>Make sure values are correct</p>
<p><strong>Step 3:</strong> Deploy Kibana Ingress Charts with custom parameters in <code>efk</code> namespace:</p>
<div class="codehilite"><pre><span></span><code>helm install kibana elastic/kibana -n efk --values kibana_values.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>helm list -n efk
</code></pre></div>

<!-- 
Set up port forwarding for temporary access to Kibanna:


<div class="codehilite"><pre><span></span><code>kubectl port-forward deployment/kibana-kibana 5601 -n efk
</code></pre></div>



Access Kibana from your browser at `http://localhost:5601` or from cloud shell `Web Preview` (Make sure the port number matches)

For permanent access to Kibana, modify the service type form `ClusterIP` to `LoadBalancer`:


<div class="codehilite"><pre><span></span><code>kubectl patch svc kibana-kibana -p &#39;{&quot;spec&quot;: {&quot;type&quot;: &quot;LoadBalancer&quot;}}&#39;
</code></pre></div>


-->

<p>Access Kibana from your browser using <code>LoadBalancer</code> IP on port 5601:</p>
<div class="codehilite"><pre><span></span><code>kubectl get svc -n efk
</code></pre></div>

<h3 id="13-fluentd-installation">1.3 Fluentd installation<a class="headerlink" href="#13-fluentd-installation" title="Permanent link">&para;</a></h3>
<p><strong>Step 1:</strong> Create custom Fluentd configuration, below snippet is updating existing <code>configmap</code> with some parameters:</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt; EOF&gt;&gt; fluentd_values.yaml
fileConfigs:
# here we read the logs from Docker&#39;s containers and parse them
  01_sources.conf: |-
    ## logs from podman
    &lt;source&gt;
      @type tail
      @id in_tail_container_logs
      @label @KUBERNETES
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      &lt;parse&gt;
        @type multi_format
        &lt;pattern&gt;
          format json
          time_key time
          time_type string
          time_format &quot;%Y-%m-%dT%H:%M:%S.%NZ&quot;
          keep_time_key true
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format regexp
          expression /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr)( (.))? (?&lt;log&gt;.*)$/
          time_format &#39;%Y-%m-%dT%H:%M:%S.%NZ&#39;
          keep_time_key true
        &lt;/pattern&gt;
      &lt;/parse&gt;
      emit_unmatched_lines true
    &lt;/source&gt;

# we use kubernetes metadata plugin to add metadata to the log
  02_filters.conf: |-
    &lt;label @KUBERNETES&gt;
      &lt;match kubernetes.var.log.containers.fluentd**&gt;
        @type relabel
        @label @FLUENT_LOG
      &lt;/match&gt;

      # &lt;match kubernetes.var.log.containers.**_kube-system_**&gt;
      #   @type null
      #   @id ignore_kube_system_logs
      # &lt;/match&gt;

      &lt;filter kubernetes.**&gt;
        @type kubernetes_metadata
        @id filter_kube_metadata
        skip_labels false
        skip_container_metadata false
        skip_namespace_metadata true
        skip_master_url true
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @DISPATCH
      &lt;/match&gt;
    &lt;/label&gt;
 # We filtering what logs will be send
  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
# we send the logs to Elasticsearch
  04_outputs.conf: |-
    &lt;label @OUTPUT&gt;
      &lt;match **&gt;
        @type elasticsearch
        host &quot;elasticsearch-master&quot;
        port 9200
        path &quot;&quot;
        user elastic
        password changeme
      &lt;/match&gt;
    &lt;/label&gt;
EOF
</code></pre></div>

<p><strong>Step 2:</strong> Deploy <code>Fluentd</code> Chart with custom parameters in <code>efk</code> namespace:</p>
<p>Deploy <code>Fluentd</code> with Helm:</p>
<div class="codehilite"><pre><span></span><code>helm repo add fluent https://fluent.github.io/helm-charts
helm repo update
helm install fluentd fluent/fluentd -n efk --values fluentd_values.yaml
</code></pre></div>

<h2 id="2-configure-kibana-and-create-index">2 Configure Kibana and Create Index:<a class="headerlink" href="#2-configure-kibana-and-create-index" title="Permanent link">&para;</a></h2>
<p>Kibana requires an index pattern to access the Elasticsearch data that you want to explore.
An index pattern selects the data to use and allows you to define properties of the fields.</p>
<p>In our case we configured <code>fluentd</code> index, that should be populated at <code>Elasticsearch</code></p>
<p><strong>Step 1:</strong> Locate Kibana URL:</p>
<div class="codehilite"><pre><span></span><code>kubectl get svc -n efk
</code></pre></div>

<p><strong>Step 2:</strong> Launch the Kibana web interface:</p>
<div class="codehilite"><pre><span></span><code>loadbalancer_ip:5601
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You should see your Kibana interface</p>
</div>
<p><img alt="alt text" src="../images/kibana_validation.png" /></p>
<p><strong>Step 3:</strong> Update Kibana Configuration to support <code>time</code> Meta fields:</p>
<p>In UI Go to: Management - Stack Management:</p>
<p><img alt="alt text" src="../images/kibana_mgm.jpg" /></p>
<p><strong>Step 4:</strong> Then Kibana - Advanced Setting:</p>
<p><img alt="alt text" src="../images/kibana_advanced.png" /></p>
<p><strong>Step 5:</strong> Find field: <code>Meta fields</code>, and add <code>time</code> field as following:</p>
<p><img alt="alt text" src="../images/kibana_meta.jpg" /></p>
<p><strong>Step 7:</strong> Create an index pattern. </p>
<p>In UI  Click: Discover (under analytics)</p>
<p><img alt="alt text" src="../images/kibana_anal_discover.png" /></p>
<p><img alt="alt text" src="../images/kibana_discover.png" /></p>
<p>Click <code>Create Index Pattern</code> button.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>alternative path: <code>Management - Stack Management -&gt; Kibana Index Patterns</code></p>
</div>
<p><strong>Step 8:</strong> In <code>Create index pattern</code> window. Type inside <code>Index pattern name</code>: <code>fluentd*</code> as the index pattern name. More documentation can be found <a href="https://www.elastic.co/guide/en/kibana/7.14/index-patterns.html">here</a></p>
<p><img alt="alt text" src="../images/kibana_index.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Your index pattern matches 1 source</p>
</div>
<div class="codehilite"><pre><span></span><code>Click Next Step &gt;
</code></pre></div>

<p><strong>Step 9:</strong> Configure which field <code>Kibana</code> will use to filter log data by time. In the dropdown, select the <code>@time</code> field, and hit <code>Create index pattern</code>.</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Our ElasticSearch and Kibana fully configured. You should be able now see some cluster logs in Kibana.</p>
</div>
<p><strong>Step 10:</strong> View Kibana Logs from our GKE cluster:</p>
<p>In UI  Click: Discover (under analytics)</p>
<div class="codehilite"><pre><span></span><code>In Query search field paste: `kubernetes.namespace_name: kube-system`
In Range field paste: Select last 15 minutes
Click Refresh
</code></pre></div>

<p><img alt="alt text" src="../images/kibana_query.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>you can see logs from <code>kube-system</code> namespace</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can save you Query for future use</p>
</div>
<h2 id="3-deploy-onlineboutique-application">3 Deploy onlineboutique application<a class="headerlink" href="#3-deploy-onlineboutique-application" title="Permanent link">&para;</a></h2>
<p>Deploy microservices application <code>onlineboutique</code>:</p>
<p>Create Namespace <code>onlineboutique</code></p>
<div class="codehilite"><pre><span></span><code>kubectl create ns onlineboutique
</code></pre></div>

<p>Deploy Microservice application</p>
<div class="codehilite"><pre><span></span><code>git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
cd microservices-demo
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f ./release/kubernetes-manifests.yaml -n onlineboutique
</code></pre></div>

<p>Verify Deployment:</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods -n onlineboutique
</code></pre></div>

<h2 id="4-observe-onlineboutique-logs">4 Observe <code>onlineboutique</code> logs<a class="headerlink" href="#4-observe-onlineboutique-logs" title="Permanent link">&para;</a></h2>
<p><strong>Step 1:</strong> First let's review the logs using <code>kubectl logs</code> command locally on the cluster.
We going to check <code>paymentservice</code> pod logs</p>
<div class="codehilite"><pre><span></span><code>export PAYMENTSERVICE_POD=$(kubectl get pods -n onlineboutique | grep paymentservice |awk &#39;{ print $1}&#39;)
kubectl logs $PAYMENTSERVICE_POD -n onlineboutique
</code></pre></div>

<p><strong>Step 2:</strong> Now let's review Kibana Logs from our GKE cluster on <code>onlineboutique</code> namespace:</p>
<div class="codehilite"><pre><span></span><code>In Query search field paste: `kubernetes.namespace_name: onlineboutique`
In Range field paste: Select last 15 minutes
Click Refresh
</code></pre></div>

<p><img alt="alt text" src="../images/kibana_query.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We can see all logs from <code>onlineboutique</code> namespace</p>
</div>
<p><strong>Step 2:</strong> Now let's review Kibana Logs from <code>paymentservice</code> pod only</p>
<p>echo $PAYMENTSERVICE_POD</p>
<div class="codehilite"><pre><span></span><code>In Query search field paste: `kubernetes.namespace_name: onlineboutique`
In Range field paste: Select last 15 minutes
Click Refresh
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>Developers should not have access to Kubernetes CLI, however they can get access to Observability tools like Kibana to allow them troubleshooting!</p>
</div>
<h2 id="5-review-fluentd-configuration">5 Review <code>Fluentd</code> configuration<a class="headerlink" href="#5-review-fluentd-configuration" title="Permanent link">&para;</a></h2>
<p>In some cases, you want to filter logs from only your applications to be seen by your team. To achieve this, Fluentd should be configured to only intake specific logs so that no resources are wasted. </p>
<p>Review <code>sources</code> configuration:</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 01_sources.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  01_sources.conf: |-
    &lt;source&gt;
      @type tail
      @id in_tail_container_logs
      @label @KUBERNETES
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      &lt;parse&gt;
        @type multi_format
        &lt;pattern&gt;
          format json
          time_key time
          time_type string
          time_format &quot;%Y-%m-%dT%H:%M:%S.%NZ&quot;
          keep_time_key false
        &lt;/pattern&gt;
        &lt;pattern&gt;
          format regexp
          expression /^(?&lt;time&gt;.+) (?&lt;stream&gt;stdout|stderr)( (.))? (?&lt;log&gt;.*)$/
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>id</code>: A unique identifier to reference this source. This can be used for further filtering and routing of structured log data</p>
<p><code>type</code>: Inbuilt directive understood by fluentd. In this case, “tail” instructs fluentd to gather data by tailing logs from a given location. Another example is “http” which instructs fluentd to collect data by using GET on http endpoint. </p>
<p><code>path</code>: Specific to type “tail”. Instructs fluentd to collect all logs under /var/log/containers directory. This is the location used by docker daemon on a Kubernetes node to store stdout from running containers</p>
<p><code>pos_file</code>: Used as a checkpoint. In case the fluentd process restarts, it uses the position from this file to resume log data collection</p>
<p><code>tag</code>: A custom string for matching source to destination/filters. fluentd matches source/destination tags to route log data</p>
</div>
<p><strong>Step 2</strong> Review <code>Filter</code> configuration</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 03_dispatch.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  02_filters.conf: |-
    &lt;label @KUBERNETES&gt;
      &lt;match kubernetes.var.log.containers.fluentd**&gt;
        @type relabel
        @label @FLUENT_LOG
      &lt;/match&gt;


      &lt;filter kubernetes.**&gt;
        @type kubernetes_metadata
        @id filter_kube_metadata
        skip_labels false
        skip_container_metadata false
        skip_namespace_metadata true
        skip_master_url true
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @DISPATCH
      &lt;/match&gt;
</code></pre></div>

<p><strong>Step 3</strong> Review <code>Dispatch</code> configuration</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A20 03_dispatch.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match **&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre></div>

<p><strong>Step 4</strong> Review <code>Output Plugin</code> configuration</p>
<div class="codehilite"><pre><span></span><code>kubectl get configmap  -n efk fluentd-config -oyaml | grep -v &quot;#&quot; |  grep -A10 04_outputs.conf
</code></pre></div>

<div class="codehilite"><pre><span></span><code>  04_outputs.conf: |-
    &lt;label @OUTPUT&gt;
      &lt;match **&gt;
        @type elasticsearch
        host &quot;elasticsearch-master&quot;
        port 9200
        path &quot;&quot;
        user elastic
        password changeme
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>match</code>: tag indicates a destination. It is followed by a regular expression for matching the source. In this case, we want to capture all logs and send them to Elasticsearch, so simply use **</p>
<p><code>type</code>: Supported output plugin identifier. In this case, we are using ElasticSearch which is a built-in plugin of fluentd.</p>
<p><code>host/port</code>: ElasticSearch host/port. Credentials can be configured as well, but not shown here.</p>
</div>
<h2 id="6-configure-fluentd-to-specific-logs">6 Configure <code>Fluentd</code> to specific logs<a class="headerlink" href="#6-configure-fluentd-to-specific-logs" title="Permanent link">&para;</a></h2>
<p>Let's configure Fluentd to only send <code>onlineboutique</code> namespace logs to elasticsearch:</p>
<p><strong>Step 1:</strong> Modify helm <code>fluentd_values.yaml</code> values file for <code>03_dispatch.conf</code> config so that only log files that matches <code>onlineboutique</code> namespace is labeled to be sent:</p>
<div class="codehilite"><pre><span></span><code>cd ../
edit fluentd_values.yaml
</code></pre></div>

<p>Replace line under <code>03_dispatch.conf: |-</code> config:</p>
<div class="codehilite"><pre><span></span><code>&lt;match **&gt; # Send all logs
</code></pre></div>

<p>To: </p>
<div class="codehilite"><pre><span></span><code>&lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;
</code></pre></div>

<p>So it looks as following:</p>
<div class="codehilite"><pre><span></span><code>  03_dispatch.conf: |-
    &lt;label @DISPATCH&gt;
      &lt;filter **&gt;
        @type prometheus
        &lt;metric&gt;
          name fluentd_input_status_num_records_total
          type counter
          desc The total number of incoming records
          &lt;labels&gt;
            tag ${tag}
            hostname ${hostname}
          &lt;/labels&gt;
        &lt;/metric&gt;
      &lt;/filter&gt;

      &lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;
        @type relabel
        @label @OUTPUT
      &lt;/match&gt;
    &lt;/label&gt;
</code></pre></div>

<p><code>&lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;</code> will filter out logs with <code>_onlineboutique_</code>. This configuration will only relabel the logs that matches the configuration as <code>@OUTPUT</code>. As specified in <code>04_outputs.conf</code>, only logs labelled as <code>@OUTPUT</code> will be sent to elasticsearch. </p>
<p>Note that this is not the only way to configure fluentd to send one namespace's logs. </p>
<p><strong>Step 2:</strong> Install helm diff plugin</p>
<div class="codehilite"><pre><span></span><code>helm plugin install https://github.com/databus23/helm-diff
</code></pre></div>

<p><strong>Step 3:</strong> Verify diff</p>
<div class="codehilite"><pre><span></span><code>helm diff upgrade fluentd fluent/fluentd -n efk  --values fluentd_values.yaml
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>-       &lt;match **&gt;
+       &lt;match kubernetes.var.log.containers.**_onlineboutique_**&gt;
</code></pre></div>

<p><strong>Step 4:</strong> Update fluentd <code>configmap</code> via Helm Upgrade</p>
<div class="codehilite"><pre><span></span><code>helm upgrade fluentd fluent/fluentd -n efk  --values fluentd_values.yaml
</code></pre></div>

<p><strong>Step 5:</strong> Observe that fluentd stop sending logs for other namespaces than <code>_onlineboutique_</code></p>
<div class="codehilite"><pre><span></span><code>In Query search field paste: `kubernetes.namespace_name: kube-system`
In Range field paste: Select last 15 minute
Click Refresh
</code></pre></div>

<p><img alt="alt text" src="../images/kibana_query.png" /></p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>No more <code>kube-system</code> logs send to the ElasticSearch and hence Kibana can't display them.
However we can see all historical logs!!! Prior we disabled the logging for all namespaces.</p>
</div>
<h2 id="7-cleanup">7 Cleanup<a class="headerlink" href="#7-cleanup" title="Permanent link">&para;</a></h2>
<p>Uninstall Helm Charts:</p>
<div class="codehilite"><pre><span></span><code>helm uninstall fluentd -n efk
helm uninstall kibana -n efk
helm uninstall elasticsearch -n efk
</code></pre></div>

<p>Delete GKE cluster:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters delete k8s-efk-lab --region us-central1
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.37e9125f.min.js"></script>
      
    
  </body>
</html>