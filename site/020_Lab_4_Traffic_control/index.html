<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Module 8 Traffic Management - Cloud Architecture</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../css/extra.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Cloud Architecture</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT020 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="dropdown-item">Module 2 Terraform Fundamentals</a>
</li>
            
<li>
    <a href="./" class="dropdown-item active">Module 8 Traffic Management</a>
</li>
            
<li>
    <a href="../020_Lab_5_EFK/" class="dropdown-item">Module 9 EFK Stack</a>
</li>
            
<li>
    <a href="../020_Lab_6_Prometheus/" class="dropdown-item">Module 10 Monitoring with Prometheus</a>
</li>
            
<li>
    <a href="../020_Lab_6_GMP/" class="dropdown-item">Module 10 Monitoring with GMP</a>
</li>
            
<li>
    <a href="../020_Lab_9_GitOps/" class="dropdown-item">Module 11 GitOps with Flux</a>
</li>
            
<li>
    <a href="../020_Lab_10_cloudrun/" class="dropdown-item">Module 12 SERVERless Cloud Run</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="dropdown-item">Module 2</a>
</li>
            
<li>
    <a href="../020_Module_3_Assignment_Production_GKE/" class="dropdown-item">Module 3</a>
</li>
            
<li>
    <a href="../020_Module_4_Assignment_Production_GKE/" class="dropdown-item">Module 4</a>
</li>
            
<li>
    <a href="../020_Module_6_Assignment_Helm_Foundation/" class="dropdown-item">Module 6</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">YCIT019 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Labs</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_Module_5_Lab_Docker_basics/" class="dropdown-item">Module 5 Lab - Docker Basics</a>
</li>
            
<li>
    <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="dropdown-item">Module 6 Lab - Advanced Docker</a>
</li>
            
<li>
    <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="dropdown-item">Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm</a>
</li>
            
<li>
    <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="dropdown-item">Module 8 Lab - Kuberenetes Concepts</a>
</li>
            
<li>
    <a href="../ycit019_Module_9_Kubernetes_Features/" class="dropdown-item">Module 9 Lab - Kubernetes Features</a>
</li>
            
<li>
    <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="dropdown-item">Module 9 Part 2 Lab Kubernetes Autoscaling</a>
</li>
            
<li>
    <a href="../ycit019_Lab_10_Networking/" class="dropdown-item">Module 10 Lab - Kubernetes Networking</a>
</li>
            
<li>
    <a href="../ycit019_Lab_11_Storage/" class="dropdown-item">Module 11 Lab - Kubernetes Storage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Assignments</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../ycit019_ass1/" class="dropdown-item">Module 5 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass1_sol/" class="dropdown-item">Module 5 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass2/" class="dropdown-item">Module 6 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass2_solution/" class="dropdown-item">Module 6 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass3/" class="dropdown-item">Module 8 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass3_solution/" class="dropdown-item">Module 8 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass4_2022/" class="dropdown-item">Module 9 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass4_sol/" class="dropdown-item">Module 9 Assignment Solution</a>
</li>
            
<li>
    <a href="../ycit019_ass7/" class="dropdown-item">Module 10 Assignment</a>
</li>
            
<li>
    <a href="../ycit019_ass6_solution/" class="dropdown-item">Module 10 Assignment Solution</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href=".." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../020_Lab_5_EFK/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#istio-traffic-control-canary-deployments" class="nav-link">Istio Traffic Control - Canary Deployments</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#prerequisite-delete-private-cluster" class="nav-link">Prerequisite  Delete Private Cluster</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#0-create-regional-gke-cluster-on-gcp" class="nav-link">0 Create Regional GKE Cluster on GCP</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#1-deploy-istio-using-custom-resources" class="nav-link">1  Deploy Istio using Custom Resources</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-deploy-an-micorservices-application" class="nav-link">2 Deploy an Micorservices Application</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3-allow-external-traffic-to-online-boutique-application" class="nav-link">3 Allow External traffic to Online Boutique Application</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#4-routing-traffic-to-services-outside-of-the-mesh" class="nav-link">4 Routing traffic to services outside of the Mesh</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#4-canary-deployments-with-istio" class="nav-link">4 Canary Deployments with Istio</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#5-cleanup" class="nav-link">5 Cleanup</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="istio-traffic-control-canary-deployments">Istio Traffic Control - Canary Deployments<a class="headerlink" href="#istio-traffic-control-canary-deployments" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Install Istio</li>
<li>Deploy an application and enable automatic sidecar injection</li>
<li>Deploy a canary service and use Istio to route some traffic to the new service</li>
</ul>
<h2 id="prerequisite-delete-private-cluster">Prerequisite  Delete Private Cluster<a class="headerlink" href="#prerequisite-delete-private-cluster" title="Permanent link">&para;</a></h2>
<p><strong>Step 1:</strong> Locate Terraform Configuration directory:</p>
<pre class="codehilite"><code>cd ~/$MY_REPO/notepad-infrastructure
</code></pre>

<p><strong>Step 2:</strong> Delete Private Cluster that we've deployed with terraform:</p>
<pre class="codehilite"><code>terraform destroy -var-file terraform.tfvars
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Private GKE Cluster, VPC and Subnets has been deleted</p>
</div>
<h2 id="0-create-regional-gke-cluster-on-gcp">0 Create Regional GKE Cluster on GCP<a class="headerlink" href="#0-create-regional-gke-cluster-on-gcp" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<pre class="codehilite"><code>gcloud services enable container.googleapis.com
</code></pre>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<pre class="codehilite"><code>gcloud compute networks create default \
    --subnet-mode=auto \
    --bgp-routing-mode=regional \
    --mtu=1460
</code></pre>

<pre class="codehilite"><code>gcloud container clusters create istio-traffic-lab \
--region us-central1 \
--enable-ip-alias \
--enable-network-policy \
--num-nodes 1 \
--machine-type &quot;e2-standard-2&quot; \
--release-channel stable
</code></pre>

<pre class="codehilite"><code>gcloud container clusters get-credentials istio-traffic-lab --region us-central1
</code></pre>

<p><strong>Step 3:</strong> Setup kubectx</p>
<pre class="codehilite"><code>sudo apt install kubectx
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>we've installed <code>kubectx</code> + <code>kubens</code>: Power tools for <code>kubectl</code>:
- <code>kubectx</code> helps you switch between clusters back and forth
- <code>kubens</code> helps you switch between Kubernetes namespaces smoothly</p>
</div>
<h2 id="1-deploy-istio-using-custom-resources">1  Deploy Istio using Custom Resources<a class="headerlink" href="#1-deploy-istio-using-custom-resources" title="Permanent link">&para;</a></h2>
<p>This installation guide uses the istioctl command line tool to provide rich customization of the Istio control plane and of the sidecars for the Istio data plane.</p>
<p>Download and extract the latest release:</p>
<pre class="codehilite"><code>curl -L https://istio.io/downloadIstio | sh -\
cd istio-1.11.1
export PATH=$PWD/bin:$PATH
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>The above command will fetch Istio packages and untar them in the same folder.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Istio installation directory contains:</p>
<ul>
<li><code>bin</code> directory contains <code>istioctl</code> client binary</li>
<li><code>manifests</code> Installation Profiles, configurations and Helm Charts</li>
<li><code>samples</code> directory contains sample applications deployment</li>
<li><code>tools</code>  directory contains auto-completion tooling and etc.</li>
</ul>
</div>
<p><strong>Step 2</strong> Deploy Istio Custom Resource Definitions (CRDs)</p>
<p>Istio extends Kubernetes using Custom Resource Definitions (CRDs). 
CRDs allow registration of new/non-default Kubernetes resources. When Istio CRDs are deployed, Istio’s objects are registered as Kubernetes objects, providing a highly integrated experience with 
Kubernetes as a deployment platform and thus allowing Kubernetes to store configuration of Istio features such as routing, security and telemetry and etc.</p>
<p>We going to install using using <code>demo</code> configuration profile. The <code>demo</code> configuration profile allows to experiment with most of Istio features with modest resource requirements. 
Since it enables high levels of tracing and access logging, it is not suitable for production use cases.</p>
<pre class="codehilite"><code>export STATIC_IP=&lt;set your Static IP&gt;
</code></pre>

<pre class="codehilite"><code>istioctl install --set profile=demo --set values.gateways.istio-ingressgateway.loadBalancerIP=$STATIC_IP
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>✔ Istio core installed
✔ Istiod installed
✔ Egress gateways installed
✔ Ingress gateways installed
✔ Installation complete
Thank you for installing Istio 1.11.  Please take a few minutes to tell us about your install/upgrade experience!  
</code></pre>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Wait a few seconds for the CRDs to be committed in the Kubernetes API-server.</p>
</div>
<p><strong>Step 3</strong> Verify Istio CRDs successfully applied to Kubernetes Cluster.</p>
<pre class="codehilite"><code>kubectl get crds | grep istio
</code></pre>

<p><strong>Step 3</strong> Verify that Istio Ingressgateway is setup using STATIC_IP Load Balancer:</p>
<p>List <code>STATIC_IP</code> Load Balancer</p>
<pre class="codehilite"><code>gcloud compute addresses list
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME              ADDRESS/RANGE  TYPE      PURPOSE  NETWORK  REGION       SUBNET  STATUS
static-ingres-ip  35.192.101.76  EXTERNAL                    us-central1          IN_USE
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Our static IP showed as in use</p>
</div>
<p>Verify that Istio Ingressgateway using STATIC_IP:</p>
<pre class="codehilite"><code>kubectl get svc istio-ingressgateway -n istio-system
</code></pre>

<pre class="codehilite"><code>NAME                   TYPE           CLUSTER-IP    EXTERNAL-IP     Ports
istio-ingressgateway   LoadBalancer   10.32.1.153   35.192.101.76   15021:32714/TCP,80:30042/TCP,443:31889/TCP,...  62s
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Istio Gateway using </p>
</div>
<h2 id="2-deploy-an-micorservices-application">2 Deploy an Micorservices Application<a class="headerlink" href="#2-deploy-an-micorservices-application" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Get the source code for a sample application. For this lab, we will use the Online Boutique sample app.</p>
<pre class="codehilite"><code>cd ~
git clone https://github.com/GoogleCloudPlatform/microservices-demo.git
cd microservices-demo
</code></pre>

<p><strong>Step 2</strong> Create a namespace <code>online-boutique</code> for example</p>
<pre class="codehilite"><code>kubectl create namespace online-boutique
</code></pre>

<p><strong>Step 3</strong> Enable automatic sidecar injection for the online-boutique namespace</p>
<pre class="codehilite"><code>kubectl label namespace online-boutique istio-injection=enabled --overwrite
</code></pre>

<p>Check namespace:</p>
<pre class="codehilite"><code>kubectl get ns online-boutique --show-labels
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME              STATUS   AGE     LABELS
online-boutique   Active   4m30s   istio-injection=enabled
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We've enabled Automatic Sidecar Injection on <code>online-boutique</code> namespace</p>
</div>
<p><strong>Step 5</strong> Switch to <code>online-boutique</code> namespace:</p>
<p>List namespaces:</p>
<pre class="codehilite"><code>kubens
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>**default**
istio-system
kube-node-lease
kube-public
kube-system
online-boutique
</code></pre>

<p>!!! result we listed all namespaces and we see that active namespace is <code>default</code></p>
<p>Switch to <code>online-boutique</code> namespace and make it active:</p>
<pre class="codehilite"><code>kubens online-boutique
</code></pre>

<pre class="codehilite"><code>kubens
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>**default**
istio-system
kube-node-lease
kube-public
kube-system
**online-boutique**
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We switched context to <code>online-boutique</code> and it's now became active </p>
</div>
<p><strong>Step 4</strong> Deploy the application by creating the kubernetes manifests</p>
<pre class="codehilite"><code>kubectl apply -f ./release/kubernetes-manifests.yaml
</code></pre>

<p><strong>Step 5</strong> Watch the pods and verify that all pods were started successfully with the sidecar injected</p>
<pre class="codehilite"><code>watch kubectl get pods
</code></pre>

<p>We can see containers starting as <code>Init:0/1</code> in this phase pod firewall rules gets update to establish communication with future Envoy Sidecar. Than <code>PodInitializing</code> start <code>Envoy</code> and application container.</p>
<p><strong>Output:</strong></p>
<pre class="codehilite"><code>NAME                                     READY   STATUS    RESTARTS   AGE
adservice-5844cffbd4-h7lkk               2/2     Running   0          84s
cartservice-fdc659ddc-fzmn9              2/2     Running   0          86s
checkoutservice-64db75877d-hk25l         2/2     Running   0          88s
currencyservice-9b7cdb45b-9xzhl          2/2     Running   0          85s
emailservice-64d98b6f9d-v44rm            2/2     Running   0          89s
frontend-76ff9556-p62g9                  2/2     Running   0          87s
loadgenerator-589648f87f-4dfkp           2/2     Running   0          85s
paymentservice-65bdf6757d-zd4w4          2/2     Running   0          87s
productcatalogservice-5cd47f8cc8-c6hdn   2/2     Running   0          86s
recommendationservice-b75687c5b-clcbt    2/2     Running   0          88s
redis-cart-74594bd569-9gpjt              2/2     Running   0          84s
shippingservice-778554994-ttwf2          2/2     Running   0          85s
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Pods Started with sidecar auto-injected</p>
</div>
<h2 id="3-allow-external-traffic-to-online-boutique-application">3 Allow External traffic to Online Boutique Application<a class="headerlink" href="#3-allow-external-traffic-to-online-boutique-application" title="Permanent link">&para;</a></h2>
<h3 id="31-create-gateway-resource">3.1 Create Gateway resource<a class="headerlink" href="#31-create-gateway-resource" title="Permanent link">&para;</a></h3>
<p>In order for traffic to flow to the frontend of the application, we need to create an ingress gateway and a virtual service attached to it.</p>
<p><strong>Step 1</strong> Apply the istio manifests to configure the Istio <code>Gateway</code>:</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF&gt; frontend-gateway.yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: frontend-gateway
spec:
  selector:
    istio: ingressgateway # use Istio default gateway implementation
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - &quot;*&quot;
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f frontend-gateway.yaml
</code></pre>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Gateway resource important fields:</p>
<ul>
<li><code>name</code> - name of gateway</li>
<li><code>spec.selector.istio</code> - which gateway to use (can be several)</li>
<li><code>spec.servers</code> - defines which hosts will use this gateway proxy</li>
<li><code>spec.servers.port.number</code> - ports to expose</li>
<li><code>spec.servers.port.host</code> - host(s) for this port</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this point our gateway is listening for request that match any host  on port 80 and it's accessible on the public internet.</p>
</div>
<p>Check the created gateway:</p>
<pre class="codehilite"><code>kubectl get gateway
kubectl get gateway -o yaml
</code></pre>

<p>Check the Envoy listeners been created:</p>
<pre class="codehilite"><code>export INGRESS_POD=$(kubectl get pods -n istio-system | grep 'ingress' |awk '{ print $1}')
istioctl proxy-config listener $INGRESS_POD  -n istio-system
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>ADDRESS PORT  MATCH DESTINATION
0.0.0.0 8080  ALL   Route: http.8080
0.0.0.0 15021 ALL   Inline Route: /healthz/ready*
0.0.0.0 15090 ALL   Inline Route: /stats/prometheus*
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>HTTP port correctly exposed correctly</p>
</div>
<p>Verify what Ingress Gateway spec.selector.istio selects for use:</p>
<pre class="codehilite"><code>kubectl get pod --selector=&quot;istio=ingressgateway&quot; --all-namespaces
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>istio-ingressgateway-xxx pod in istio-system (our edge envoy pod) will proxy traffic further to Kubernetes services.</p>
</div>
<p>Try to connect to the Istio Ingress IP:</p>
<pre class="codehilite"><code>curl -i 35.192.101.76
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>HTTP/1.1 404 Not Found
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>It's returning 404 error.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've create gateway resource that is listening for request that match any host on port 80 and it's accessible on the public internet, however it's returning 404 error because once the gateway receives the request it doesn't know where it needs to send it.</p>
<p>In order to tell <code>Gateway</code> which Kubernets <code>service</code> it is supposed to receive the requests from  it is require to attach <code>Gateway</code> to <code>VirtualService</code>.</p>
</div>
<h3 id="32-create-virtualservice-resource">3.2 Create VirtualService resource<a class="headerlink" href="#32-create-virtualservice-resource" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Apply the <code>istio</code> manifests to configure <code>VirtualService</code> to allow external traffic into the mesh and route it to the frontend service.</p>
<p>When traffic comes into the <code>gateway</code>, it is required to get it to a specific service within the <code>service</code> mesh and to do that, we’ll use the <code>VirtualService</code> resource.</p>
<p>In Istio, a <code>VirtualService</code> defines the rules that control how requests for a service are routed within an Istio service mesh. For instance, a <code>VirtualService</code> can route requests to different versions of a <code>service</code>, 
Requests can be routed based on the request source and destination, HTTP paths and header field and weights associated with individual service versions. 
As well as use advanced routing properties such as retries, request timeouts, circuit braking, fault injection and etc.</p>
<p>export STUDENT=<your_name> #Used to configure DNS</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF&gt; frontend-vs.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend-ingress
spec:
  hosts:
  - &quot;$STUDENT.cloud-montreal.ca&quot;
  gateways:
  - frontend-gateway
  http:
  - route:
    - destination:
        host: frontend
        port:
          number: 80
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f frontend-vs.yaml
</code></pre>

<p>Acquire <code>frontend</code> app URL:</p>
<pre class="codehilite"><code>kubectl get virtualservices
</code></pre>

<p>Access <code>frontend</code> app URL from your browser:</p>
<pre class="codehilite"><code>$STUDENT.cloud-montreal.ca
</code></pre>

<div class="admonition success">
<p class="admonition-title">Success</p>
<p>We can access <code>frontend</code> web app via Istio Ingress Gateway</p>
</div>
<ul>
<li>frontend.yaml: defines another virtual service to be used by our load generator to make sure traffic directed to the frontend from within the mesh stays internal, and doesn't go through the gateway.</li>
<li>Whitelist-egress-googleapis.yaml: Used to whitelist various google APIs used by services within the mesh.</li>
</ul>
<p><strong>Step 3</strong> Defines another <code>Virtualservice</code> to be used by our load generator to make sure traffic directed to the frontend from within the mesh stays internal, 
and doesn't go through the gateway.</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF&gt; frontend-load-vs.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: frontend
spec:
  hosts:
  - &quot;frontend.default.svc.cluster.local&quot;
  http:
  - route:
    - destination:
        host: frontend
        port:
          number: 80
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f frontend-load-vs.yaml
</code></pre>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've </p>
</div>
<h2 id="4-routing-traffic-to-services-outside-of-the-mesh">4 Routing traffic to services outside of the Mesh<a class="headerlink" href="#4-routing-traffic-to-services-outside-of-the-mesh" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Create <code>ServiceEntry</code> custom resource to allow access to external APIs <code>googleapis.com</code> and GCE metadata service <code>metadata.google.internal</code> that app is using:</p>
<p>Because all outbound traffic from an Istio-enabled pod is redirected to its sidecar proxy by default, accessibility of URLs outside of the cluster depends on the configuration of the proxy. 
By default, Istio configures the Envoy proxy to passthrough requests for unknown services. 
Although this provides a convenient way to get started with Istio, configuring stricter control is usually preferable in production scenarios.</p>
<p>Istio has an option, <code>global.outboundTrafficPolicy.mode</code>, that configures the sidecar handling of external services, that is, those services that are not defined in Istio’s internal service registry. 
If this option is set to <code>ALLOW_ANY</code>, the Istio proxy lets calls to unknown services pass through. If the option is set to <code>REGISTRY_ONLY</code>, 
then the Istio proxy blocks any host without an HTTP service or service entry defined within the mesh.</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF&gt; allow-egress-googleapis.yaml
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: allow-egress-googleapis
spec:
  hosts:
  - &quot;accounts.google.com&quot; # Used to get token
  - &quot;*.googleapis.com&quot;
  ports:
  - number: 80
    protocol: HTTP
    name: http
  - number: 443
    protocol: HTTPS
    name: https
---
apiVersion: networking.istio.io/v1alpha3
kind: ServiceEntry
metadata:
  name: allow-egress-google-metadata
spec:
  hosts:
  - metadata.google.internal
  addresses:
  - 169.254.169.254 # GCE metadata server
  ports:
  - number: 80
    name: http
    protocol: HTTP
  - number: 443
    name: https
    protocol: HTTPS
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f allow-egress-googleapis.yaml
</code></pre>

<pre class="codehilite"><code>kubectl get serviceentries  
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p><code>ServiceEntry</code> resource inserts an entry into Istio’s service registry which makes explicit that clients within the mesh are allowed to call a <code>metadata.google.internal</code>, <code>accounts.google.com</code>, <code>*.googleapis.com</code> regardless the namespaces</p>
</div>
<h2 id="4-canary-deployments-with-istio">4 Canary Deployments with Istio<a class="headerlink" href="#4-canary-deployments-with-istio" title="Permanent link">&para;</a></h2>
<p>We going to deploy a new version of <code>recommendationservice</code> with <code>canary</code> label.</p>
<p>Once we’ve deployed the new version, we can start releasing it gradually by routing 20% of all incoming requests to the latest version, while the rest of the requests (98%) still goes to the existing version.</p>
<p><strong>Step 1</strong> Patch the Recommendation service deployment to give it a <code>production</code> label</p>
<pre class="codehilite"><code>kubectl patch deployment -n online-boutique recommendationservice --type='json' -p='[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/template/metadata/labels/version&quot;, &quot;value&quot;: &quot;production&quot;}]'
</code></pre>

<p><strong>Step 2</strong> Check the labels on the deployment</p>
<pre class="codehilite"><code>export RECOMMMENDATIONSERVICE=$(kubectl get pods | grep 'recommendationservice' |awk '{ print $1}')
kubectl get pod -n online-boutique $RECOMMMENDATIONSERVICE --show-labels
</code></pre>

<p><strong>Step 3</strong> Create a DestinationRule that defines two subsets <code>production</code> and <code>canary</code></p>
<pre class="codehilite"><code>cat &lt;&lt;EOF&gt;  destinationrule-recommendation.yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: recommendationservice
  namespace: online-boutique
spec:
  host: recommendationservice
  subsets:
  - name: production
    labels:
      version: production
  - name: canary
    labels:
      version: canary
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f  destinationrule-recommendation.yaml
</code></pre>

<pre class="codehilite"><code>kubectl get destinationrules
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We've defined DestinationRule with 2 subsets.</p>
</div>
<p><strong>Step 4</strong> Make a change to the <code>Recommendation</code> service and by modifying it's <code>max_responses</code> parameter from <code>5</code> to <code>2</code>.</p>
<pre class="codehilite"><code>cd ~/microservices-demo
ls
cat src/recommendationservice/Dockerfile
</code></pre>

<pre class="codehilite"><code>sed -i 's/max_responses = 5/max_responses = 2/g' \
   src/recommendationservice/recommendation_server.py
</code></pre>

<p><strong>Step 5</strong> Build a new version of the image</p>
<pre class="codehilite"><code>PROJECT_ID=$(gcloud config list --format &quot;value(core.project)&quot;)

docker build -t \
  gcr.io/${PROJECT_ID}/microservices_demo/recommendationservice:canary \
  src/recommendationservice
</code></pre>

<p><strong>Step 6</strong> Push the image to GCR</p>
<pre class="codehilite"><code>docker push gcr.io/${PROJECT_ID}/microservices_demo/recommendationservice:canary
</code></pre>

<p><strong>Step 7</strong> Deploy the <code>canary</code> version of the Recommendation service:</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF&gt;  recommendation-deployment-vcanary.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: recommendationservice
    version: canary
  name: recommendationservice-canary
  namespace: online-boutique
spec:
  replicas: 1
  selector:
    matchLabels:
      app: recommendationservice
      version: canary
  template:
    metadata:
      labels:
        app: recommendationservice
        version: canary
    spec:
      containers:
      - env:
        - name: PORT
          value: &quot;8080&quot;
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: productcatalogservice:3550
        - name: ENABLE_PROFILER
          value: &quot;0&quot;
        image: gcr.io/$PROJECT_ID/microservices_demo/recommendationservice:canary
        imagePullPolicy: Always
        livenessProbe:
          exec:
            command:
            - /bin/grpc_health_probe
            - -addr=:8080
          failureThreshold: 3
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        name: server
        ports:
        - containerPort: 8080
          protocol: TCP
        readinessProbe:
          exec:
            command:
            - /bin/grpc_health_probe
            - -addr=:8080
          failureThreshold: 3
          periodSeconds: 5
          successThreshold: 1
          timeoutSeconds: 1
        resources:
          limits:
            cpu: 200m
            memory: 450Mi
          requests:
            cpu: 100m
            memory: 220Mi
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f recommendation-deployment-vcanary.yaml
</code></pre>

<pre class="codehilite"><code>kubectl get deploy | grep recommendationservice 
</code></pre>

<p><strong>Output:</strong></p>
<pre class="codehilite"><code>recommendationservice          1/1     1            1           16m
recommendationservice-canary   1/1     1            1           31s
</code></pre>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>2 versions of <code>recommendationservice</code> has been deployed</p>
</div>
<p><strong>Step 8</strong> Create a virtual service to direct 20% of the traffic to the <code>canary</code> version</p>
<pre class="codehilite"><code>cat &lt;&lt;EOF&gt;  vs-recommendation.yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: recommendationservice
  namespace: online-boutique
spec:
  hosts:
  - recommendationservice
  http:
  - route:
    - destination:
        host: recommendationservice
        port:
          number: 8080
        subset: production
      weight: 80
    - destination:
        host: recommendationservice
        port:
          number: 8080
        subset: canary 
      weight: 20
EOF
</code></pre>

<pre class="codehilite"><code>kubectl apply -f vs-recommendation.yaml
</code></pre>

<pre class="codehilite"><code>kubectl get VirtualService
</code></pre>

<p><strong>Step 9</strong> Refresh the page for one of the products where recommendations are shown multiple times, and notice how most of the time you get 5 recommendations while if 20% of the time you get only 2 recommendations.</p>
<h2 id="5-cleanup">5 Cleanup<a class="headerlink" href="#5-cleanup" title="Permanent link">&para;</a></h2>
<p>Delete GKE cluster:</p>
<pre class="codehilite"><code>gcloud container clusters delete istio-traffic-lab --region us-central1
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
