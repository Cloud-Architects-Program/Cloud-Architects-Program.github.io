
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Lab 6 GitOps - Cloud Architecture</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-6-gitops" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Architecture" class="md-header__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Architecture
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 6 GitOps
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Architecture" class="md-nav__button md-logo" aria-label="Cloud Architecture" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Architecture
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        YCIT020
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT020" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          YCIT020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      <label class="md-nav__link" for="__nav_2_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Lab_Terraform_Fundamentals" class="md-nav__link">
        Module 2 Terraform Fundamentals
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      <label class="md-nav__link" for="__nav_2_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Assignment_Terraform_Foundation/" class="md-nav__link">
        Module 2 Terraforming GCP Foundation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_2_Assignment_Terraform_Foundation_solution/" class="md-nav__link">
        SOLUTION Module 2 Terraforming GCP Foundation
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_3_Assignment_Production_GKE/" class="md-nav__link">
        Module 3 Deploying Production GKE with gcloud
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_3_Assignment_Production_GKE_solution/" class="md-nav__link">
        SOLUTION Module 3 Deploying Production GKE with gcloud
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../020_Module_4_Assignment_Production_GKE_terraform/" class="md-nav__link">
        Module 4 Deploying Production GKE with terraform
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        YCIT019
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="YCIT019" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          YCIT019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" >
      
      <label class="md-nav__link" for="__nav_3_1">
        Labs
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Labs" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_5_Lab_Docker_basics/" class="md-nav__link">
        Module 5 Lab - Docker Basics
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_6_Lab_Advanced_Docker/" class="md-nav__link">
        Module 6 Lab - Advanced Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_7_Lab_Deploy_Kubernetes_kubeadm/" class="md-nav__link">
        Module 7 Lab - Deploy Kubernetes Cluster with Kubeadm
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_8_Lab_Kubernetes_Concepts/" class="md-nav__link">
        Module 8 Lab - Kuberenetes Concepts
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_9_Kubernetes_Features/" class="md-nav__link">
        Module 9 Lab - Kubernetes Features
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Module_10_Kubernetes_Scaling/" class="md-nav__link">
        Module 9 Part 2 Lab Kubernetes Autoscaling
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_10_Networking/" class="md-nav__link">
        Module 10 Lab - Kubernetes Networking
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_Lab_11_Storage/" class="md-nav__link">
        Module 11 Lab - Kubernetes Storage
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      <label class="md-nav__link" for="__nav_3_2">
        Assignments
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Assignments" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Assignments
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1/" class="md-nav__link">
        Module 5 Assignment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass1_sol/" class="md-nav__link">
        Module 5 Assignment Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2/" class="md-nav__link">
        Module 6 Assignment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass2_solution/" class="md-nav__link">
        Module 6 Assignment Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3/" class="md-nav__link">
        Module 8 Assignment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass3_solution/" class="md-nav__link">
        Module 8 Assignment Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_2022/" class="md-nav__link">
        Module 9 Assignment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass4_sol/" class="md-nav__link">
        Module 9 Assignment Solution
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass7/" class="md-nav__link">
        Module 10 Assignment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ycit019_ass6_solution/" class="md-nav__link">
        Module 10 Assignment Solution
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-create-regional-gke-cluster-on-gcp" class="md-nav__link">
    0 Create Regional GKE Cluster on GCP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-install-and-configure-flux-with-github-repository" class="md-nav__link">
    1 Install and Configure Flux with GitHub Repository
  </a>
  
    <nav class="md-nav" aria-label="1 Install and Configure Flux with GitHub Repository">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-install-the-flux-cli" class="md-nav__link">
    1.1 Install the Flux CLI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-configure-a-github-personal-access-token-with-repo-permissions" class="md-nav__link">
    1.2 Configure a GitHub personal access token with repo permissions.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-export-your-credentials" class="md-nav__link">
    1.3 Export your credentials
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-install-flux-into-gke-cluster" class="md-nav__link">
    1.4 Install Flux into GKE cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-deploy-microservices-applications-with-gitops-using-kustomize-controller" class="md-nav__link">
    1.5 Deploy microservices applications with GitOps using Kustomize Controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16-deploy-opa-gatekeeper-using-helm-controller" class="md-nav__link">
    1.6 Deploy OPA Gatekeeper using Helm Controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17-deploy-opa-gatekeeper-with-gitops-using-helm-controller" class="md-nav__link">
    1.7 Deploy OPA Gatekeeper with GitOps using Helm Controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#18-deploy-and-test-allowedrepos-policy" class="md-nav__link">
    1.8 Deploy and Test allowedrepos Policy
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#18-extra-deploy-allowedrepos-with-gitops" class="md-nav__link">
    1.8  (Extra) Deploy allowedrepos with Gitops
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#19-extra-deploy-notepad-app-helm-chart-with-gitops" class="md-nav__link">
    1.9 (Extra) Deploy notepad app Helm chart with GitOps
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-cleanup" class="md-nav__link">
    2 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="lab-6-gitops">Lab 6 GitOps<a class="headerlink" href="#lab-6-gitops" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Install <code>Flux</code></li>
<li>Bootstrap <code>Flux</code> with a new <code>flux-infra</code> repository</li>
<li>Add a <code>GitRepository</code> source type to track the <code>microservices-demo</code>Public application repository which also contains the deployment code. Flux should regularly sync the code from it.</li>
<li>Use the <code>Kustomization</code> Controller to set up automated deployment to the Kubernetes environment. Any changes in the source should be automatically reconciled with the cluster.</li>
</ul>
<h2 id="0-create-regional-gke-cluster-on-gcp">0 Create Regional GKE Cluster on GCP<a class="headerlink" href="#0-create-regional-gke-cluster-on-gcp" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<div class="codehilite"><pre><span></span><code>gcloud services enable container.googleapis.com
</code></pre></div>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters create k8s-gitops-lab \
--region us-central1 \
--enable-ip-alias \
--enable-network-policy \
--num-nodes 1 \
--machine-type &quot;e2-standard-2&quot; \
--release-channel stable
</code></pre></div>

<div class="codehilite"><pre><span></span><code>gcloud container clusters get-credentials k8s-gitops-lab --region us-central1
</code></pre></div>

<p><strong>Step 3: (Optional)</strong> Setup kubectx</p>
<div class="codehilite"><pre><span></span><code>sudo apt install kubectx
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>we've installed <code>kubectx</code> + <code>kubens</code>: Power tools for <code>kubectl</code>:
- <code>kubectx</code> helps you switch between clusters back and forth
- <code>kubens</code> helps you switch between Kubernetes namespaces smoothly</p>
</div>
<h2 id="1-install-and-configure-flux-with-github-repository">1 Install and Configure Flux with GitHub Repository<a class="headerlink" href="#1-install-and-configure-flux-with-github-repository" title="Permanent link">&para;</a></h2>
<p>To Install Flux we going to perform following tasks:</p>
<ul>
<li>Create a Personal Access Token on GitHub.</li>
<li>Set up environment variables.</li>
<li>Install flux CLI.</li>
<li>Run pre-flight checks.</li>
<li>Bootstrap the Flux v2 infrastructure.</li>
<li>Validate the Flux installation.</li>
</ul>
<h3 id="11-install-the-flux-cli">1.1 Install the Flux CLI<a class="headerlink" href="#11-install-the-flux-cli" title="Permanent link">&para;</a></h3>
<p>With <code>Bash</code> for macOS and Linux:</p>
<div class="codehilite"><pre><span></span><code>curl -s https://fluxcd.io/install.sh | sudo bash
</code></pre></div>

<p>Reference: <a href="https://fluxcd.io/docs/get-started/">Get Started with Flux</a></p>
<h3 id="12-configure-a-github-personal-access-token-with-repo-permissions">1.2 Configure a GitHub personal access token with repo permissions.<a class="headerlink" href="#12-configure-a-github-personal-access-token-with-repo-permissions" title="Permanent link">&para;</a></h3>
<p>Follow the GitHub documentation on <a href="https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line">creating a personal access token</a>.</p>
<div class="admonition result">
<p class="admonition-title">Result</p>
<p>You've created <code>GITHUB_TOKEN</code> that will be used to boostrap the Flux</p>
</div>
<h3 id="13-export-your-credentials">1.3 Export your credentials<a class="headerlink" href="#13-export-your-credentials" title="Permanent link">&para;</a></h3>
<p>Export your GitHub personal access token, generated in step 1.2 and <code>github</code> username:</p>
<div class="codehilite"><pre><span></span><code>export GITHUB_TOKEN=&lt;your-token&gt;
export GITHUB_USER=&lt;your-username&gt;
</code></pre></div>

<h3 id="14-install-flux-into-gke-cluster">1.4 Install Flux into GKE cluster<a class="headerlink" href="#14-install-flux-into-gke-cluster" title="Permanent link">&para;</a></h3>
<p>Run the bootstrap command:</p>
<div class="codehilite"><pre><span></span><code>flux bootstrap github \
  --owner=$GITHUB_USER \
  --repository=flux-infra \
  --branch=main \
  --path=./clusters/dev \
  --personal \
  --log-level=debug \
  --components=source-controller,kustomize-controller,helm-controller
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>✔ repository &quot;https://github.com/archyufa/flux-infra&quot; created
✔ cloned repository
✔ generated component manifests
✔ committed sync manifests to &quot;main&quot; (&quot;6cd871ba49834e8106884f3c8daad2f75c6b341f&quot;)
✔ installed components
✔ reconciled components
✔ configured deploy key &quot;flux-system-main-flux-system-./clusters/dev&quot; for &quot;https://github.com/archyufa/flux-infra&quot;
✔ reconciled source secret
✔ generated sync manifests
✔ committed sync manifests to &quot;main&quot; (&quot;7d0122f2e4e57ada4f88d7a968528879b07b56e8&quot;)
✔ reconciled sync configuration
✔ Kustomization reconciled successfully
✔ helm-controller: deployment ready
✔ kustomize-controller: deployment ready
✔ source-controller: deployment ready
✔ all components are healthy
</code></pre></div>

<p>Verify Install:</p>
<div class="codehilite"><pre><span></span><code>flux check
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get crd | grep flux
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>buckets.source.toolkit.fluxcd.io                 2021-09-08T18:07:34Z
gitrepositories.source.toolkit.fluxcd.io         2021-09-08T18:07:34Z
helmcharts.source.toolkit.fluxcd.io              2021-09-08T18:07:34Z
helmreleases.helm.toolkit.fluxcd.io              2021-09-08T18:07:34Z
helmrepositories.source.toolkit.fluxcd.io        2021-09-08T18:07:35Z
kustomizations.kustomize.toolkit.fluxcd.io       2021-09-08T18:07:35Z
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl get gitrepositories -n flux-system
</code></pre></div>

<div class="codehilite"><pre><span></span><code>flux get all
</code></pre></div>

<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've <code>flux bootstrap</code> command we've achieved:</p>
<ul>
<li>flux agent components which includes (namespace, CRDs, Sources, Controllers, RBAC) on our cluster<ul>
<li>3 Controllers:</li>
<li>source</li>
<li>kustomize</li>
<li>helm</li>
<li>6 CRDs: </li>
<li>buckets.source</li>
<li>gitrepositories.source</li>
<li>helmcharts.source</li>
<li>helmrepositories.source</li>
<li>helmreleases.helm</li>
<li>kustomizations.kustomize</li>
</ul>
</li>
<li>Created <code>flux-infra</code> Private Github repo with Deploy key</li>
<li><code>flux-infra</code> repo contains flux-infra/clusters/dev/flux-system/ folder</li>
</ul>
</div>
<h3 id="15-deploy-microservices-applications-with-gitops-using-kustomize-controller">1.5 Deploy <code>microservices</code> applications with GitOps using Kustomize Controller<a class="headerlink" href="#15-deploy-microservices-applications-with-gitops-using-kustomize-controller" title="Permanent link">&para;</a></h3>
<p>Create Dev Team Repo that will store Applications Code and Kubernetes Yaml manifests.</p>
<p><strong>Step 1</strong> Fork microservice application</p>
<p>Browse to:</p>
<div class="codehilite"><pre><span></span><code>https://github.com/GoogleCloudPlatform/microservices-demo
</code></pre></div>

<div class="codehilite"><pre><span></span><code>Click: Fork button
Select: Fork to a different account
</code></pre></div>

<p><strong>Step 2</strong> Clone Microservices application from you repo using SSH</p>
<div class="codehilite"><pre><span></span><code>cd ~
git clone git@github.com:&lt;your_repo&gt;/microservices-demo.git
cd microservices-demo
</code></pre></div>

<div class="codehilite"><pre><span></span><code>rm release/istio-manifests.yaml
git add .
git commit -m &quot;removed istio manifests&quot;
git push
</code></pre></div>

<p><strong>Step 3</strong> Create Namespace <code>onlineboutique</code></p>
<div class="codehilite"><pre><span></span><code>kubectl create ns onlineboutique
</code></pre></div>

<p><strong>Step 4</strong> Create a source from a public Git repository master branch:</p>
<div class="codehilite"><pre><span></span><code>flux create source git -h
</code></pre></div>

<div class="codehilite"><pre><span></span><code>flux create source git microservices-demo \
  --url=https://github.com/&lt;your_repo&gt;/microservices-demo-1 \
  --branch=master \
  --interval=30s
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>✚ generating GitRepository source
► applying GitRepository source
✔ GitRepository source created
◎ waiting for GitRepository source reconciliation
✔ GitRepository source reconciliation completed
✔ fetched revision: master/2e55bc94d35d17aa6b690d63353c38718bc31253
</code></pre></div>

<p>Verify:</p>
<div class="codehilite"><pre><span></span><code>flux get sources git microservices-demo
</code></pre></div>

<p><strong>Step 5</strong>  Create a <code>Kustomization</code> resource from a source at a given path</p>
<div class="codehilite"><pre><span></span><code>flux create kustomization -h
</code></pre></div>

<div class="codehilite"><pre><span></span><code>flux create kustomization microservices-demo-dev \
  --source=GitRepository/microservices-demo \
  --path=&quot;./release/&quot; \
  --prune=true \
  --interval=1m \
  --validation=client \
  --target-namespace=onlineboutique
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubens onlineboutique
kubectl get pods
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Onlineboutique pods has been deployed with FluxCD via GitOps</p>
</div>
<div class="codehilite"><pre><span></span><code>kubectl get svc
</code></pre></div>

<p>Access Onlineboutique <code>Frontend</code> via <code>LoadBalancer</code> IP</p>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've deployed microservices onlineboutique application using GitOps</p>
</div>
<h3 id="16-deploy-opa-gatekeeper-using-helm-controller">1.6 Deploy OPA Gatekeeper using Helm Controller<a class="headerlink" href="#16-deploy-opa-gatekeeper-using-helm-controller" title="Permanent link">&para;</a></h3>
<p>Now let's install OPA Gatekeeper using Helm so that we can apply different Kubernetes Policy and set the guardrails on what's allowed to do on our cluster.</p>
<p><strong>Step 1</strong> Configure <code>Helm</code> repository</p>
<div class="codehilite"><pre><span></span><code>helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts
helm repo update
</code></pre></div>

<p><strong>Step 2</strong> Install Helm Chart to <code>monitoring</code> namespace</p>
<div class="codehilite"><pre><span></span><code>kubectl create ns gatekeeper
helm install gatekeeper gatekeeper/gatekeeper -n gatekeeper
kubens gatekeeper
kubectl get deploy
</code></pre></div>

<p><strong>Step 2</strong> Uninstall Gatekeeper</p>
<div class="codehilite"><pre><span></span><code>helm delete gatekeeper
kubectl delete crd -l gatekeeper.sh/system=yes
</code></pre></div>

<h3 id="17-deploy-opa-gatekeeper-with-gitops-using-helm-controller">1.7 Deploy OPA Gatekeeper with GitOps using Helm Controller<a class="headerlink" href="#17-deploy-opa-gatekeeper-with-gitops-using-helm-controller" title="Permanent link">&para;</a></h3>
<p>Now let's install OPA Gatekeeper via GitOps so that we can apply different Kubernetes Policy and set the guardrails on what's allowed to do on our cluster.</p>
<p><strong>Step 1</strong> Create a source for a public Helm repository:</p>
<div class="codehilite"><pre><span></span><code>flux create source helm -h
</code></pre></div>

<div class="codehilite"><pre><span></span><code>flux create source helm gatekeeper \
  --url=https://open-policy-agent.github.io/gatekeeper/charts \
  --interval=1m
</code></pre></div>

<p>Verify:</p>
<div class="codehilite"><pre><span></span><code>flux get sources helm gatekeeper
</code></pre></div>

<p><strong>Step 5</strong>  Create a <code>HelmRelease</code> with a chart from a HelmRepository source</p>
<div class="codehilite"><pre><span></span><code>flux create hr -h
</code></pre></div>

<div class="codehilite"><pre><span></span><code>flux create hr gatekeeper \
  --interval=1m \
  --source=HelmRepository/gatekeeper \
  --chart=gatekeeper \
  --target-namespace=gatekeeper \
  --chart-version=&quot;v3.7.0-beta.1&quot;
</code></pre></div>

<p>Verify:</p>
<div class="codehilite"><pre><span></span><code>flux get hr
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>gatekeeper      True    Release reconciliation succeeded        3.7.0-beta.1    False
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubens gatekeeper
kubectl get deploy
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>We've deployed Gatekeeper to our GKE cluster. It's time to add some policies!</p>
</div>
<p><strong>Step 5</strong>  Store Flux configurations:</p>
<div class="codehilite"><pre><span></span><code>git clone git@github.com:&lt;your-user&gt;/flux-infra.git
cd flux-infra/clusters/dev/
flux export source git microservices-demo &gt;&gt;  source-microservices-demo.yaml
flux export kustomization microservices-demo-dev &gt;&gt; kustomization-microservices-demo.yaml
flux export source helm gatekeeper &gt;&gt; source-helm-gatekeeper.yaml
flux export hr gatekeeper &gt;&gt; helmrelease-gatekeeper.yaml
cat source-microservices-demo.yaml kustomization-microservices-demo.yaml source-helm-gatekeeper.yaml helmrelease-gatekeeper.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>git add .
git commit -m &quot;dev cluster flux config&quot;
git push
</code></pre></div>

<h3 id="18-deploy-and-test-allowedrepos-policy">1.8 Deploy and Test allowedrepos Policy<a class="headerlink" href="#18-deploy-and-test-allowedrepos-policy" title="Permanent link">&para;</a></h3>
<p><strong>Step 1</strong> Let's create a <code>policy</code> folder where we going to store our cluster wide policies:</p>
<div class="codehilite"><pre><span></span><code>cd ~
mkdir -p policy/templates
mkdir -p policy/constraints
</code></pre></div>

<p><strong>Step 2</strong> Download OSS Gatekeeper libraries:</p>
<div class="codehilite"><pre><span></span><code>cd ~
git clone https://github.com/open-policy-agent/gatekeeper-library
</code></pre></div>

<p><strong>Step 3</strong> Review <code>allowedrepos</code> constraint template:</p>
<div class="codehilite"><pre><span></span><code>cd gatekeeper-library/library/general/allowedrepos
cat template.yaml
cp -r template.yaml ~/policy/templates
</code></pre></div>

<div class="codehilite"><pre><span></span><code>cd  ~/policy/templates
kubens gatekeeper
kubectl apply -f template.yaml
</code></pre></div>

<p>Review a <code>ConstraintTemplate</code> CRD and observe created resource:</p>
<div class="codehilite"><pre><span></span><code>kubectl get  ConstraintTemplate
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even if k8sallowedrepos <code>ConstraintTemplate</code> has been deployed in <code>gatekeeper</code> namespace in our case.
The Policy will be applied Cluster Wide.</p>
</div>
<p><strong>Step 3</strong> Let's create a Gatekeeper constraint that will block all Pods, which images are non  <code>gcr.io</code> registries. We first going to test our constraint in a current system and so we going to run it in <code>dryrun</code> enforcementAction mode. We will </p>
<div class="codehilite"><pre><span></span><code>cd  ~/policy/constraints
cat &lt;&lt; EOF&gt;&gt; allowed-repos.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-repos
spec:
  enforcementAction: dryrun
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    excludedNamespaces: [&quot;onlineboutique&quot;]
  parameters:
    repos:
      - &quot;gcr.io&quot;
      - &quot;gke.gcr.io&quot;
      - &quot;k8s.gcr.io&quot;
EOF
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We've added <code>excludedNamespaces</code> clause, as our microservices app has some redis image that is downloaded from dockerhub.</p>
</div>
<div class="codehilite"><pre><span></span><code>kubectl apply -f allowed-repos.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl describe K8sAllowedRepos
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>Total Violations:  12
  Violations:
    Enforcement Action:  dryrun
    Kind:                Pod
    Message:             container &lt;manager&gt; has an invalid image repo &lt;ghcr.io/fluxcd/helm-controller:v0.11.2&gt;, allowed repos are [&quot;gcr.io&quot;, &quot;gke.gcr.io&quot;]
    Name:                helm-controller-5cbd57f468-cr7ht
    Namespace:           flux-system
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can observe ~12 Violations in our cluster. However since our Enforcement Action is <code>dryrun</code>, non the policy will take effect. </p>
</div>
<div class="codehilite"><pre><span></span><code>kubectl describe K8sAllowedRepos | grep Namespace
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>    Namespace:           flux-system
    Namespace:           flux-system
    Namespace:           flux-system
    Namespace:           gatekeeper
    Namespace:           gatekeeper
    Namespace:           gatekeeper
    Namespace:           gatekeeper
    Namespace:           kube-system
    Namespace:           kube-system
    Namespace:           kube-system
    Namespace:           kube-system
    Namespace:           kube-system
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can observe that all violations are for <code>kube-system</code>, <code>flux-system</code> and <code>gatekeeper</code>.
This is due to they using images from following repos <code>k8s.gcr.io</code>, <code>ghcr.io/fluxcd</code>, <code>openpolicyagent/gatekeeper</code> respectively. To workaround this issue we can add above repo's in trusted listed of repos.
Another alternative is to <code>copy</code> required images to your personal <code>gcr</code> repo using tools like <a href="https://github.com/google/go-containerregistry/blob/main/cmd/gcrane/README.md">crane</a>.</p>
</div>
<p><strong>Step 4</strong> Update K8sAllowedRepos constraint to support trusted registries:</p>
<div class="codehilite"><pre><span></span><code>rm allowed-repos.yaml
cat &lt;&lt; EOF&gt;&gt; allowed-repos.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-repos
spec:
  enforcementAction: dryrun
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    excludedNamespaces: [&quot;onlineboutique&quot;]
  parameters:
    repos:
      - &quot;gcr.io&quot;
      - &quot;gke.gcr.io&quot;
      - &quot;k8s.gcr.io&quot;
      - &quot;ghcr.io/fluxcd&quot;
      - &quot;openpolicyagent/gatekeeper&quot;
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f allowed-repos.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl describe K8sAllowedRepos
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All violations has been resolved, however it may take some time until the messages will be cleared in the Events.</p>
</div>
<p><strong>Step 5</strong> Update K8sAllowedRepos constraint and set <code>enforcementAction</code> to <code>deny</code> in order to block all Pods with registry violations:</p>
<div class="codehilite"><pre><span></span><code>rm allowed-repos.yaml
cat &lt;&lt; EOF&gt;&gt; allowed-repos.yaml
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sAllowedRepos
metadata:
  name: allowed-repos
spec:
  enforcementAction: deny
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    excludedNamespaces: [&quot;onlineboutique&quot;]
  parameters:
    repos:
      - &quot;gcr.io&quot;
      - &quot;gke.gcr.io&quot;
      - &quot;k8s.gcr.io&quot;
      - &quot;ghcr.io/fluxcd&quot;
      - &quot;openpolicyagent/gatekeeper&quot;
EOF
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f allowed-repos.yaml
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl describe K8sAllowedRepos
</code></pre></div>

<div class="admonition result">
<p class="admonition-title">Result</p>
<p>Total Violations is 0, as expected.</p>
</div>
<p><strong>Step 6</strong> Deploy <code>nginx</code> Pod from dockerhub in <code>default</code> namespace and thus violate our cluster Policy</p>
<div class="codehilite"><pre><span></span><code>kubectl run nginx --image=nginx -n default
</code></pre></div>

<p><strong>Output:</strong></p>
<div class="codehilite"><pre><span></span><code>Error from server ([allowed-repos] container &lt;nginx&gt; has an invalid image repo &lt;nginx&gt;, allowed repos are [&quot;gcr.io&quot;, &quot;gke.gcr.io&quot;, &quot;k8s.gcr.io&quot;, &quot;ghcr.io/fluxcd&quot;, &quot;openpolicyagent/gatekeeper&quot;]): admissionwebhook &quot;validation.gatekeeper.sh&quot; denied the request: [allowed-repos] container &lt;nginx&gt; has an invalid image repo &lt;nginx&gt;, allowed repos are [&quot;gcr.io&quot;, &quot;gke.gcr.io&quot;, &quot;k8s.gcr.io&quot;, &quot;ghcr.io/fluxcd&quot;, &quot;openpolicyagent/gatekeeper&quot;]
</code></pre></div>

<div class="admonition error">
<p class="admonition-title">Error</p>
<p>Gatekeeper Admission Controller blocked nginx Pod deployment due to it's violating the <code>allowedrepos</code> constraint.</p>
</div>
<div class="admonition summary">
<p class="admonition-title">Summary</p>
<p>We've secured our cluster from deployments of dangerous and unauthorized images</p>
</div>
<h3 id="18-extra-deploy-allowedrepos-with-gitops">1.8  (Extra) Deploy <code>allowedrepos</code> with Gitops<a class="headerlink" href="#18-extra-deploy-allowedrepos-with-gitops" title="Permanent link">&para;</a></h3>
<p>Create Ops/Platform Repo that will store Gatekeeper Policies and Cluster Wide configurations.</p>
<h3 id="19-extra-deploy-notepad-app-helm-chart-with-gitops">1.9 (Extra) Deploy notepad app Helm chart with GitOps<a class="headerlink" href="#19-extra-deploy-notepad-app-helm-chart-with-gitops" title="Permanent link">&para;</a></h3>
<h2 id="2-cleanup">2 Cleanup<a class="headerlink" href="#2-cleanup" title="Permanent link">&para;</a></h2>
<p>You can uninstall Flux with:</p>
<div class="codehilite"><pre><span></span><code>flux delete kustomization microservices-demo-dev
flux delete source git microservices-demo
flux uninstall --namespace=flux-system
</code></pre></div>

<p>The above command performs the following operations:</p>
<ul>
<li>deletes Flux components (deployments and services)</li>
<li>deletes Flux network policies</li>
<li>deletes Flux RBAC (service accounts, cluster roles and cluster role bindings)</li>
<li>removes the Kubernetes finalizers from Flux custom resources</li>
<li>deletes Flux custom resource definitions and custom resources</li>
<li>deletes the namespace where Flux was installed</li>
</ul>
<p>Delete GKE cluster:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters delete k8s-gitops-lab --region us-central1
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>