
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Lab 5 Cloudrun for Anthos - Cloud Native University</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-5-cloudrun-for-anthos" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Cloud Native University" class="md-header__button md-logo" aria-label="Cloud Native University" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cloud Native University
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 5 Cloudrun for Anthos
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Cloud Native University" class="md-nav__button md-logo" aria-label="Cloud Native University" data-md-component="logo">
      
  <img src="../images/k8s.svg" alt="logo">

    </a>
    Cloud Native University
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#0-create-regional-gke-cluster-on-gcp-and-enable-cloudrun" class="md-nav__link">
    0 Create Regional GKE Cluster on GCP and Enable CloudRun
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-deploy-a-knative-service" class="md-nav__link">
    1 Deploy a Knative Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-test-the-knative-service" class="md-nav__link">
    2 Test the Knative Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-knative-serving-api" class="md-nav__link">
    3 Knative Serving API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-cleanup" class="md-nav__link">
    4 Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="lab-5-cloudrun-for-anthos">Lab 5 Cloudrun for Anthos<a class="headerlink" href="#lab-5-cloudrun-for-anthos" title="Permanent link">&para;</a></h1>
<p><strong>Objective:</strong></p>
<ul>
<li>Enable CloudRun on a Kubernetes cluster</li>
<li>Deploy a web application</li>
<li>Autoscale applications from 0-to-1 and back to 0</li>
</ul>
<h2 id="0-create-regional-gke-cluster-on-gcp-and-enable-cloudrun">0 Create Regional GKE Cluster on GCP and Enable CloudRun<a class="headerlink" href="#0-create-regional-gke-cluster-on-gcp-and-enable-cloudrun" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Enable the Google Kubernetes Engine API.</p>
<div class="codehilite"><pre><span></span><code>gcloud services enable \
container.googleapis.com \
containerregistry.googleapis.com
</code></pre></div>

<p><strong>Step 2</strong> From the cloud shell, run the following command to create a cluster with 1 node and enable CloudRun:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters create cloudrun-demo \
  --zone=us-central1-b \
  --num-nodes=1 \
  --machine-type=n1-standard-4 \
  --enable-autoscaling --min-nodes=1 --max-nodes=5 \
  --enable-ip-alias \
  --addons=HttpLoadBalancing,CloudRun \
  --enable-stackdriver-kubernetes \
  --release-channel stable
</code></pre></div>

<p>Enabling CloudRun will install Knative components on the cluster. As we discussed in class, Knative makes it possible to:</p>
<ul>
<li>Deploy and serve applications using Knative API. </li>
<li>Allow applications automatically scale from zero-to-N, and back to zero, based on requests.</li>
<li>Build and package the application code inside the cluster.</li>
<li>Deliver events to your application; However, this feature is not enabled by CloudRun.</li>
</ul>
<p><strong>Step 3</strong> Verify the Knative components are properly installed.</p>
<div class="codehilite"><pre><span></span><code>kubectl get pods --namespace=knative-serving
</code></pre></div>

<h2 id="1-deploy-a-knative-service">1 Deploy a Knative Service<a class="headerlink" href="#1-deploy-a-knative-service" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> deploy a Knatvie service to the cluster you just created. For this example, we will use <code>kubectl</code>; however, you can also use the CloudRun UI. To expose an application on Knative, we need to define a Service object, which is different than the Kubernetes Service type.</p>
<div class="codehilite"><pre><span></span><code>cat &lt;&lt;EOF&gt; helloworld.yaml
apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: helloworld-go
  namespace: default
spec:
  template:
    spec:
      containers:
        - image: gcr.io/cloudrun/hello
          env:
            - name: TARGET
              value: &quot;Go Sample v1&quot;
EOF 
</code></pre></div>

<div class="codehilite"><pre><span></span><code>kubectl apply -f helloworld.yaml
</code></pre></div>

<p><strong>Step 2</strong> Verify the service is deployed by querying "ksvc" (Knative Service) objects</p>
<div class="codehilite"><pre><span></span><code>kubectl get ksvc
</code></pre></div>

<p><strong>Step 3</strong> Although the Knative service is deployed, there are no Pod created yet, given that there are no requests on this service.</p>
<div class="codehilite"><pre><span></span><code>kubectl get pod
</code></pre></div>

<h2 id="2-test-the-knative-service">2 Test the Knative Service<a class="headerlink" href="#2-test-the-knative-service" title="Permanent link">&para;</a></h2>
<p><strong>Step 1</strong> Let's test the service by making a request using <code>curl</code>.</p>
<p>To avoid having to set up DNS, we'll test the deployed service by sending a request to the Istio ingress gateway with the target host that should handle the request as an HTTP header. That hostname should be the URL listed in the previous deployment step and of the form: http://<em>service-name</em>.<em>namespace</em>.example.com</p>
<p><strong>Step 2</strong> Obtain the IP address of the ingress gateway</p>
<div class="codehilite"><pre><span></span><code>kubectl get svc -n gke-system istio-ingress
</code></pre></div>

<p><strong>Step 3</strong> From Cloud Shell, use curl to access the service. Use the URL we obtained in step 5, and replace [YOUR-IP] with the IP address you obtained in the previous step.</p>
<div class="codehilite"><pre><span></span><code>curl -v -H &quot;Host: helloworld-go.default.example.com&quot; http://[YOUR-IP]
</code></pre></div>

<p><strong>Step 4</strong> Verify that a pod was created and that this pod will get termintated if there are no more requests on this service.</p>
<div class="codehilite"><pre><span></span><code>kubectl get pod
</code></pre></div>

<h2 id="3-knative-serving-api">3 Knative Serving API<a class="headerlink" href="#3-knative-serving-api" title="Permanent link">&para;</a></h2>
<p>When we deploy the helloworld Service to Knative, it creates three kinds of objects: Configuration, Route, and Revision.</p>
<div class="codehilite"><pre><span></span><code>kubectl get configuration,revision,route
</code></pre></div>

<ul>
<li><strong>Service</strong> Describes an application on Knative.</li>
<li><strong>Revision</strong> Read-only snapshot of an application's image and other settings</li>
<li><strong>Configuration</strong> Created automatically by the service. It creates a new Revision when the revisionTemplate field changes.</li>
<li><strong>Route</strong> Configures how the traffic coming to the Service should be split between Revisions.</li>
</ul>
<h2 id="4-cleanup">4 Cleanup<a class="headerlink" href="#4-cleanup" title="Permanent link">&para;</a></h2>
<p>Delete the GKE cluster:</p>
<div class="codehilite"><pre><span></span><code>gcloud container clusters delete cloudrun-demo --region us-central1
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://twitter.com/googlecloud" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>